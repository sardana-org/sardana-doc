

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>sardana.taurus.core.tango.sardana.macroserver &mdash; sardana 3.1.2-alpha documentation</title>
  

  
  <link rel="stylesheet" href="../../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../../" src="../../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../../_static/jquery.js"></script>
        <script src="../../../../../../_static/underscore.js"></script>
        <script src="../../../../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../../index.html" class="icon icon-home"> sardana
          

          
            
            <img src="../../../../../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference external" href="http://www.sardana-controls.org">Home Page</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/sardana-org/sardana">Project Page</a></li>
<li class="toctree-l1"><a class="reference external" href="http://pypi.python.org/pypi/sardana">Download from PyPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana-plugins">Plugins Catalogue</a></li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana/wiki">Wiki</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">sardana</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../sardana.html">sardana.taurus.core.tango.sardana</a> &raquo;</li>
        
      <li>sardana.taurus.core.tango.sardana.macroserver</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for sardana.taurus.core.tango.sardana.macroserver</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1">##############################################################################</span>
<span class="c1">##</span>
<span class="c1"># This file is part of Sardana</span>
<span class="c1">##</span>
<span class="c1"># http://www.sardana-controls.org/</span>
<span class="c1">##</span>
<span class="c1"># Copyright 2011 CELLS / ALBA Synchrotron, Bellaterra, Spain</span>
<span class="c1">##</span>
<span class="c1"># Sardana is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Lesser General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">##</span>
<span class="c1"># Sardana is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Lesser General Public License for more details.</span>
<span class="c1">##</span>
<span class="c1"># You should have received a copy of the GNU Lesser General Public License</span>
<span class="c1"># along with Sardana.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">##</span>
<span class="c1">##############################################################################</span>

<span class="sd">&quot;&quot;&quot;The macroserver submodule. It contains specific part of macroserver&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BaseInputHandler&#39;</span><span class="p">,</span> <span class="s1">&#39;BaseDoor&#39;</span><span class="p">,</span> <span class="s1">&#39;BaseMacroServer&#39;</span><span class="p">,</span>
           <span class="s1">&#39;registerExtensions&#39;</span><span class="p">]</span>

<span class="n">__docformat__</span> <span class="o">=</span> <span class="s1">&#39;restructuredtext&#39;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">osp</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">lxml</span> <span class="k">import</span> <span class="n">etree</span>

<span class="kn">import</span> <span class="nn">PyTango</span>

<span class="kn">from</span> <span class="nn">taurus</span> <span class="k">import</span> <span class="n">Device</span><span class="p">,</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">taurus.core.taurusmanager</span> <span class="k">import</span> <span class="n">TaurusManager</span>
<span class="kn">from</span> <span class="nn">taurus.core.taurusbasetypes</span> <span class="k">import</span> <span class="n">TaurusEventType</span><span class="p">,</span> <span class="n">TaurusSWDevState</span><span class="p">,</span> \
    <span class="n">TaurusSerializationMode</span>

<span class="kn">from</span> <span class="nn">taurus.core</span> <span class="k">import</span> <span class="n">TaurusDevState</span>
<span class="kn">from</span> <span class="nn">taurus.core.util.log</span> <span class="k">import</span> <span class="n">Logger</span>
<span class="kn">from</span> <span class="nn">taurus.core.util.containers</span> <span class="k">import</span> <span class="n">CaselessDict</span>
<span class="kn">from</span> <span class="nn">taurus.core.util.codecs</span> <span class="k">import</span> <span class="n">CodecFactory</span>
<span class="kn">from</span> <span class="nn">taurus.core.util.event</span> <span class="k">import</span> <span class="n">EventGenerator</span><span class="p">,</span> <span class="n">AttributeEventWait</span>
<span class="kn">from</span> <span class="nn">taurus.core.tango</span> <span class="k">import</span> <span class="n">TangoDevice</span>


<span class="kn">from</span> <span class="nn">sardana.sardanautils</span> <span class="k">import</span> <span class="n">recur_map</span>
<span class="kn">from</span> <span class="nn">.macro</span> <span class="k">import</span> <span class="n">MacroInfo</span><span class="p">,</span> <span class="n">Macro</span><span class="p">,</span> <span class="n">MacroNode</span><span class="p">,</span> <span class="n">ParamFactory</span><span class="p">,</span> \
    <span class="n">SingleParamNode</span><span class="p">,</span> <span class="n">ParamNode</span><span class="p">,</span> <span class="n">createMacroNode</span>
<span class="kn">from</span> <span class="nn">.sardana</span> <span class="k">import</span> <span class="n">BaseSardanaElementContainer</span><span class="p">,</span> <span class="n">BaseSardanaElement</span>
<span class="kn">from</span> <span class="nn">.pool</span> <span class="k">import</span> <span class="n">getChannelConfigs</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">zip_longest</span>

<span class="n">CHANGE_EVT_TYPES</span> <span class="o">=</span> <span class="n">TaurusEventType</span><span class="o">.</span><span class="n">Change</span><span class="p">,</span> <span class="n">TaurusEventType</span><span class="o">.</span><span class="n">Periodic</span>


<span class="k">def</span> <span class="nf">get_terminal_size</span><span class="p">(</span><span class="n">fileno</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fileno</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fileno</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">isatty</span><span class="p">(</span><span class="n">fileno</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">(</span><span class="n">fileno</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_get_nb_lines</span><span class="p">(</span><span class="n">nb_chrs</span><span class="p">,</span> <span class="n">max_chrs</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nb_chrs</span><span class="p">)</span><span class="o">/</span><span class="n">max_chrs</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">Attr</span><span class="p">(</span><span class="n">Logger</span><span class="p">,</span> <span class="n">EventGenerator</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj_class</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dev</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_obj_class</span> <span class="o">=</span> <span class="n">obj_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attr</span> <span class="o">=</span> <span class="n">attr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call__init__</span><span class="p">(</span><span class="n">Logger</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">event_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">getNormalName</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call__init__</span><span class="p">(</span><span class="n">EventGenerator</span><span class="p">,</span> <span class="n">event_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_attr</span><span class="o">.</span><span class="n">addListener</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">eventReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">evt_value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">TaurusEventType</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fireEvent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">!=</span> <span class="n">TaurusEventType</span><span class="o">.</span><span class="n">Config</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">evt_value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fireEvent</span><span class="p">(</span><span class="n">evt_value</span><span class="o">.</span><span class="n">rvalue</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fireEvent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getTaurusAttribute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attr</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attr</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LogAttr</span><span class="p">(</span><span class="n">Attr</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj_class</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">max_buff_size</span><span class="o">=</span><span class="mi">4096</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_buffer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_buff_size</span> <span class="o">=</span> <span class="n">max_buff_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call__init__</span><span class="p">(</span><span class="n">Attr</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj_class</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getLogBuffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_buffer</span>

    <span class="k">def</span> <span class="nf">clearLogBuffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_buffer</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">eventReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">evt_value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">TaurusEventType</span><span class="o">.</span><span class="n">Change</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">evt_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">evt_value</span><span class="o">.</span><span class="n">rvalue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fireEvent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_buffer</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">evt_value</span><span class="o">.</span><span class="n">rvalue</span><span class="p">)</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_buffer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_buff_size</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log_buffer</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">evt_value</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fireEvent</span><span class="p">(</span><span class="n">evt_value</span><span class="o">.</span><span class="n">rvalue</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BaseInputHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span> <span class="o">=</span> <span class="n">raw_input</span>
        <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span> <span class="o">=</span> <span class="nb">input</span>

    <span class="k">def</span> <span class="nf">input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">input_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">input_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prompt&#39;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cancel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">prompt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;cancel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">input_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;input timeout&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MacroServerDevice</span><span class="p">(</span><span class="n">TangoDevice</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class encapsulating a generic macro server device (usually a</span>
<span class="sd">    MacroServer or a Door&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_getEventWait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_evt_wait&#39;</span><span class="p">):</span>
            <span class="c1"># create an object that waits for attribute events.</span>
            <span class="c1"># each time we use it we have to connect and disconnect to an</span>
            <span class="c1"># attribute</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_evt_wait</span> <span class="o">=</span> <span class="n">AttributeEventWait</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evt_wait</span>


<span class="k">class</span> <span class="nc">ExperimentConfiguration</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">door</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_door</span> <span class="o">=</span> <span class="n">door</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">door</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_door</span>
        <span class="n">macro_server</span> <span class="o">=</span> <span class="n">door</span><span class="o">.</span><span class="n">macro_server</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">door</span><span class="o">.</span><span class="n">getEnvironment</span><span class="p">()</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ScanDir</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ScanDir&#39;</span><span class="p">),</span>
                   <span class="n">DataCompressionRank</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DataCompressionRank&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                   <span class="n">PreScanSnapshot</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PreScanSnapshot&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">scan_file</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ScanFile&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scan_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scan_file</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scan_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">scan_file</span> <span class="o">=</span> <span class="p">[</span><span class="n">scan_file</span><span class="p">]</span>
        <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;ScanFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan_file</span>
        <span class="n">mnt_grps</span> <span class="o">=</span> <span class="n">macro_server</span><span class="o">.</span><span class="n">getElementsOfType</span><span class="p">(</span><span class="s2">&quot;MeasurementGroup&quot;</span><span class="p">)</span>
        <span class="n">mnt_grps_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">mnt_grp</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">mnt_grp</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mnt_grps</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span>
        <span class="n">mnt_grps_full_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mnt_grps</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="n">active_mnt_grp</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ActiveMntGrp&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">active_mnt_grp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">mnt_grps</span><span class="p">):</span>
            <span class="n">active_mnt_grp</span> <span class="o">=</span> <span class="n">mnt_grps_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">door</span><span class="o">.</span><span class="n">putEnvironment</span><span class="p">(</span><span class="s1">&#39;ActiveMntGrp&#39;</span><span class="p">,</span> <span class="n">active_mnt_grp</span><span class="p">)</span>

        <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;ActiveMntGrp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">active_mnt_grp</span>
        <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;MntGrpConfigs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mnt_grp_configs</span> <span class="o">=</span> <span class="n">CaselessDict</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mnt_grps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="n">mnt_grp_grps</span> <span class="o">=</span> <span class="n">PyTango</span><span class="o">.</span><span class="n">Group</span><span class="p">(</span><span class="s2">&quot;grp&quot;</span><span class="p">)</span>
        <span class="c1"># use full names cause we may be using a different Tango database</span>
        <span class="n">mnt_grp_grps</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mnt_grps_full_names</span><span class="p">)</span>

        <span class="n">codec</span> <span class="o">=</span> <span class="n">CodecFactory</span><span class="p">()</span><span class="o">.</span><span class="n">getCodec</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="n">replies</span> <span class="o">=</span> <span class="n">mnt_grp_grps</span><span class="o">.</span><span class="n">read_attribute</span><span class="p">(</span><span class="s2">&quot;configuration&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mnt_grp</span><span class="p">,</span> <span class="n">reply</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mnt_grps_names</span><span class="p">,</span> <span class="n">replies</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mnt_grp_configs</span><span class="p">[</span><span class="n">mnt_grp</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">codec</span><span class="o">.</span><span class="n">decode</span><span class="p">((</span><span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="n">reply</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">taurus.core.util.log</span> <span class="k">import</span> <span class="n">warning</span>
                <span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Cannot load Measurement group &quot;</span><span class="si">%s</span><span class="s1">&quot;: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="nb">repr</span><span class="p">(</span><span class="n">mnt_grp</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">mnt_grps</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the ExperimentConfiguration dictionary.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mnt_grps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mnt_grps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;MntGrpConfigs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="n">codec</span> <span class="o">=</span> <span class="n">CodecFactory</span><span class="p">()</span><span class="o">.</span><span class="n">getCodec</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="n">msg_error</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">mnt_grp</span> <span class="ow">in</span> <span class="n">mnt_grps</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mnt_grp_cfg</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;MntGrpConfigs&#39;</span><span class="p">][</span><span class="n">mnt_grp</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">mnt_grp_cfg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># a mntGrp to be deleted</span>
                    <span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPoolOfElement</span><span class="p">(</span><span class="n">mnt_grp</span><span class="p">)</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">DeleteElement</span><span class="p">(</span><span class="n">mnt_grp</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># TODO: Fix incorrect implementation. It must check if</span>
                        <span class="c1">#  the measurement group is part of the Pools</span>
                        <span class="c1">#  controlled by the MacroServer. Otherwise,</span>
                        <span class="c1">#  it must raise an exception.</span>
                        <span class="n">mnt_grp_dev</span> <span class="o">=</span> <span class="n">Device</span><span class="p">(</span><span class="n">mnt_grp</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="c1"># if the mnt_grp did not already exist, create it now</span>
                        <span class="n">chconfigs</span> <span class="o">=</span> <span class="n">getChannelConfigs</span><span class="p">(</span><span class="n">mnt_grp_cfg</span><span class="p">)</span>
                        <span class="n">chnames</span><span class="p">,</span> <span class="n">chinfos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">chconfigs</span><span class="p">))</span>  <span class="c1"># unzipping</span>
                        <span class="c1"># We assume that all the channels belong to the same</span>
                        <span class="c1"># pool!</span>
                        <span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPoolOfElement</span><span class="p">(</span><span class="n">chnames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">pool</span><span class="o">.</span><span class="n">createMeasurementGroup</span><span class="p">([</span><span class="n">mnt_grp</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">chnames</span><span class="p">))</span>
                        <span class="n">mnt_grp_dev</span> <span class="o">=</span> <span class="n">Device</span><span class="p">(</span><span class="n">mnt_grp</span><span class="p">)</span>

                    <span class="c1"># TODO when we start using measurement group extension</span>
                    <span class="c1"># change the code below with the following:</span>
                    <span class="c1"># mnt_grp.setConfiguration(mnt_grp_cfg)</span>

                    <span class="n">data</span> <span class="o">=</span> <span class="n">codec</span><span class="o">.</span><span class="n">encode</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">mnt_grp_cfg</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">mnt_grp_dev</span><span class="o">.</span><span class="n">write_attribute</span><span class="p">(</span><span class="s1">&#39;configuration&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">PyTango</span><span class="o">.</span><span class="n">DevFailed</span> <span class="k">as</span> <span class="n">df</span><span class="p">:</span>
                <span class="c1"># Take the description of the first exception.</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">desc</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">msg_error</span> <span class="o">+=</span> <span class="s1">&#39;Measurement Group </span><span class="si">{0}</span><span class="s1">:</span><span class="se">\n</span><span class="s1">&#39;</span>\
                             <span class="s1">&#39;</span><span class="si">{1}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mnt_grp</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg_error</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg_error</span><span class="p">)</span>

        <span class="c1"># Send the environment changes</span>
        <span class="n">env</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ScanDir</span><span class="o">=</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ScanDir&#39;</span><span class="p">),</span>
                   <span class="n">ScanFile</span><span class="o">=</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ScanFile&#39;</span><span class="p">),</span>
                   <span class="n">DataCompressionRank</span><span class="o">=</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DataCompressionRank&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                   <span class="n">ActiveMntGrp</span><span class="o">=</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ActiveMntGrp&#39;</span><span class="p">),</span>
                   <span class="n">PreScanSnapshot</span><span class="o">=</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PreScanSnapshot&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_door</span><span class="o">.</span><span class="n">putEnvironments</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getPoolOfElement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elementname</span><span class="p">):</span>
        <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_door</span><span class="o">.</span><span class="n">macro_server</span>
        <span class="n">einfo</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">getElementInfo</span><span class="p">(</span><span class="n">elementname</span><span class="p">)</span>
        <span class="n">poolname</span> <span class="o">=</span> <span class="n">einfo</span><span class="o">.</span><span class="n">pool</span>
        <span class="k">return</span> <span class="n">ms</span><span class="o">.</span><span class="n">getElementInfo</span><span class="p">(</span><span class="n">poolname</span><span class="p">)</span>

<span class="c1">#    @property</span>
<span class="c1">#    def _pool(self):</span>
<span class="c1">#        pooldict = self._door.macro_server.getElementsOfType(&#39;Pool&#39;)</span>
<span class="c1">#        if len(pooldict)==0:</span>
<span class="c1">#            raise ValueError(&#39;Cannot access the Pool&#39;)</span>
<span class="c1">#        elif len(pooldict)&gt;1:</span>
<span class="c1">#            raise ValueError(&#39;Multiple pools are not supported&#39;)</span>
<span class="c1">#        poolinfo = pooldict.values()[0]</span>
<span class="c1">#        return poolinfo</span>


<div class="viewcode-block" id="BaseDoor"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor">[docs]</a><span class="k">class</span> <span class="nc">BaseDoor</span><span class="p">(</span><span class="n">MacroServerDevice</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Class encapsulating Door device functionality.&quot;&quot;&quot;</span>

    <span class="n">On</span> <span class="o">=</span> <span class="n">PyTango</span><span class="o">.</span><span class="n">DevState</span><span class="o">.</span><span class="n">ON</span>
    <span class="n">Running</span> <span class="o">=</span> <span class="n">PyTango</span><span class="o">.</span><span class="n">DevState</span><span class="o">.</span><span class="n">RUNNING</span>
    <span class="n">Paused</span> <span class="o">=</span> <span class="n">PyTango</span><span class="o">.</span><span class="n">DevState</span><span class="o">.</span><span class="n">STANDBY</span>

    <span class="n">Critical</span> <span class="o">=</span> <span class="s1">&#39;Critical&#39;</span>
    <span class="n">Error</span> <span class="o">=</span> <span class="s1">&#39;Error&#39;</span>
    <span class="ne">Warning</span> <span class="o">=</span> <span class="s1">&#39;Warning&#39;</span>
    <span class="n">Info</span> <span class="o">=</span> <span class="s1">&#39;Info&#39;</span>
    <span class="n">Output</span> <span class="o">=</span> <span class="s1">&#39;Output&#39;</span>
    <span class="n">Debug</span> <span class="o">=</span> <span class="s1">&#39;Debug&#39;</span>
    <span class="n">Result</span> <span class="o">=</span> <span class="s1">&#39;Result&#39;</span>
    <span class="n">RecordData</span> <span class="o">=</span> <span class="s1">&#39;RecordData&#39;</span>

    <span class="n">BlockStart</span> <span class="o">=</span> <span class="s1">&#39;&lt;BLOCK&gt;&#39;</span>
    <span class="n">BlockFinish</span> <span class="o">=</span> <span class="s1">&#39;&lt;/BLOCK&gt;&#39;</span>

    <span class="n">log_streams</span> <span class="o">=</span> <span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">,</span> <span class="n">Info</span><span class="p">,</span> <span class="n">Output</span><span class="p">,</span> <span class="n">Debug</span><span class="p">,</span> <span class="n">Result</span><span class="p">)</span>

    <span class="c1"># maximum execution time without user interruption</span>
    <span class="c1"># this also means a time window within door state events must arrive</span>
    <span class="c1"># 0.1 s was not enough on Windows (see sardana-ord/sardana#725)</span>
    <span class="n">InteractiveTimeout</span> <span class="o">=</span> <span class="o">.</span><span class="mi">3</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_attr</span> <span class="o">=</span> <span class="n">CaselessDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_block_lines</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in_block</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_macro_server</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running_macros</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running_macro</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_running_macro</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_xml</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ignore_logs</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ignore_logs&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_silent</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;silent&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_stream</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_writeLock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_input_handler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_len_last_data_line</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">call__init__</span><span class="p">(</span><span class="n">MacroServerDevice</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_old_door_state</span> <span class="o">=</span> <span class="n">PyTango</span><span class="o">.</span><span class="n">DevState</span><span class="o">.</span><span class="n">UNKNOWN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_old_sw_door_state</span> <span class="o">=</span> <span class="n">TaurusDevState</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stateObj</span><span class="o">.</span><span class="n">addListener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stateChanged</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">log_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_streams</span><span class="p">:</span>
            <span class="n">tg_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="n">log_name</span><span class="p">)</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">LogAttr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tg_attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">log_name</span> <span class="o">==</span> <span class="s1">&#39;Result&#39;</span><span class="p">:</span>
                <span class="n">attr</span><span class="o">.</span><span class="n">subscribeEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resultReceived</span><span class="p">,</span> <span class="n">log_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">attr</span><span class="o">.</span><span class="n">subscribeEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logReceived</span><span class="p">,</span> <span class="n">log_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_attr</span><span class="p">[</span><span class="n">log_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__input_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s2">&quot;Input&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__input_attr</span><span class="o">.</span><span class="n">addListener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputReceived</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__record_data_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;RecordData&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__record_data_attr</span><span class="o">.</span><span class="n">addListener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recordDataReceived</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__macro_status_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;MacroStatus&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__macro_status_attr</span><span class="o">.</span><span class="n">addListener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macroStatusReceived</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_experiment_configuration</span> <span class="o">=</span> <span class="n">ExperimentConfiguration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="BaseDoor.create_input_handler"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.create_input_handler">[docs]</a>    <span class="k">def</span> <span class="nf">create_input_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BaseInputHandler</span><span class="p">()</span></div>

<div class="viewcode-block" id="BaseDoor.get_input_handler"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.get_input_handler">[docs]</a>    <span class="k">def</span> <span class="nf">get_input_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_handler</span></div>

<div class="viewcode-block" id="BaseDoor.get_color_mode"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.get_color_mode">[docs]</a>    <span class="k">def</span> <span class="nf">get_color_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;NoColor&quot;</span></div>

    <span class="c1"># def macrosChanged(self, s, v, t):</span>
    <span class="c1">#    pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_log_start&quot;</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">taurus.core.util.console</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_color_mode</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;NoColor&quot;</span><span class="p">:</span>
                <span class="n">kls</span> <span class="o">=</span> <span class="n">taurus</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">NoColors</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kls</span> <span class="o">=</span> <span class="n">taurus</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">TermColors</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_start</span> <span class="o">=</span> <span class="p">{</span><span class="n">BaseDoor</span><span class="o">.</span><span class="n">Critical</span><span class="p">:</span> <span class="n">kls</span><span class="o">.</span><span class="n">LightRed</span><span class="p">,</span>
                               <span class="n">BaseDoor</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span> <span class="n">kls</span><span class="o">.</span><span class="n">Red</span><span class="p">,</span>
                               <span class="n">BaseDoor</span><span class="o">.</span><span class="n">Info</span><span class="p">:</span> <span class="n">kls</span><span class="o">.</span><span class="n">LightBlue</span><span class="p">,</span>
                               <span class="n">BaseDoor</span><span class="o">.</span><span class="n">Warning</span><span class="p">:</span> <span class="n">kls</span><span class="o">.</span><span class="n">Brown</span><span class="p">,</span>
                               <span class="n">BaseDoor</span><span class="o">.</span><span class="n">Output</span><span class="p">:</span> <span class="n">kls</span><span class="o">.</span><span class="n">Normal</span><span class="p">,</span>
                               <span class="n">BaseDoor</span><span class="o">.</span><span class="n">Debug</span><span class="p">:</span> <span class="n">kls</span><span class="o">.</span><span class="n">DarkGray</span><span class="p">,</span>
                               <span class="n">BaseDoor</span><span class="o">.</span><span class="n">Result</span><span class="p">:</span> <span class="n">kls</span><span class="o">.</span><span class="n">LightGreen</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_start</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_log_stop&quot;</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">taurus.core.util.console</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_color_mode</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;NoColor&quot;</span><span class="p">:</span>
                <span class="n">kls</span> <span class="o">=</span> <span class="n">taurus</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">NoColors</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kls</span> <span class="o">=</span> <span class="n">taurus</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">TermColors</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_stop</span> <span class="o">=</span> <span class="p">{</span><span class="n">BaseDoor</span><span class="o">.</span><span class="n">Critical</span><span class="p">:</span> <span class="n">kls</span><span class="o">.</span><span class="n">Normal</span><span class="p">,</span>
                              <span class="n">BaseDoor</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span> <span class="n">kls</span><span class="o">.</span><span class="n">Normal</span><span class="p">,</span>
                              <span class="n">BaseDoor</span><span class="o">.</span><span class="n">Info</span><span class="p">:</span> <span class="n">kls</span><span class="o">.</span><span class="n">Normal</span><span class="p">,</span>
                              <span class="n">BaseDoor</span><span class="o">.</span><span class="n">Warning</span><span class="p">:</span> <span class="n">kls</span><span class="o">.</span><span class="n">Normal</span><span class="p">,</span>
                              <span class="n">BaseDoor</span><span class="o">.</span><span class="n">Output</span><span class="p">:</span> <span class="n">kls</span><span class="o">.</span><span class="n">Normal</span><span class="p">,</span>
                              <span class="n">BaseDoor</span><span class="o">.</span><span class="n">Debug</span><span class="p">:</span> <span class="n">kls</span><span class="o">.</span><span class="n">Normal</span><span class="p">,</span>
                              <span class="n">BaseDoor</span><span class="o">.</span><span class="n">Result</span><span class="p">:</span> <span class="n">kls</span><span class="o">.</span><span class="n">Normal</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_stop</span>

<div class="viewcode-block" id="BaseDoor.getStateAttr"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.getStateAttr">[docs]</a>    <span class="k">def</span> <span class="nf">getStateAttr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_attr</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">macro_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_macro_server</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_macro_server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_macroserver_for_door</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_macro_server</span>

    <span class="k">def</span> <span class="nf">_get_macroserver_for_door</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the MacroServer device object in the same DeviceServer as</span>
<span class="sd">        this door&quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParentObj</span><span class="p">()</span>
        <span class="n">door_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev_name</span><span class="p">()</span>
        <span class="n">server_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_server_list</span><span class="p">(</span><span class="s1">&#39;MacroServer/*&#39;</span><span class="p">))</span>
        <span class="n">server_list</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_server_list</span><span class="p">(</span><span class="s1">&#39;Sardana/*&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="n">server_list</span><span class="p">:</span>
            <span class="n">server_devs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_device_class_list</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
            <span class="n">devs</span><span class="p">,</span> <span class="n">klasses</span> <span class="o">=</span> <span class="n">server_devs</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">],</span> <span class="n">server_devs</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">dev</span> <span class="ow">in</span> <span class="n">devs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dev</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">door_name</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">klass</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">klasses</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">klass</span> <span class="o">==</span> <span class="s1">&#39;MacroServer&#39;</span><span class="p">:</span>
                            <span class="n">full_name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">getFullName</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="p">()</span><span class="o">.</span><span class="n">getDevice</span><span class="p">(</span><span class="n">full_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="BaseDoor.setDebugMode"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.setDebugMode">[docs]</a>    <span class="k">def</span> <span class="nf">setDebugMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="n">state</span></div>

<div class="viewcode-block" id="BaseDoor.getDebugMode"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.getDebugMode">[docs]</a>    <span class="k">def</span> <span class="nf">getDebugMode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span></div>

<div class="viewcode-block" id="BaseDoor.setSilent"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.setSilent">[docs]</a>    <span class="k">def</span> <span class="nf">setSilent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yesno</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_silent</span> <span class="o">=</span> <span class="n">yesno</span></div>

<div class="viewcode-block" id="BaseDoor.isSilent"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.isSilent">[docs]</a>    <span class="k">def</span> <span class="nf">isSilent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_silent</span></div>

<div class="viewcode-block" id="BaseDoor.getLogObj"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.getLogObj">[docs]</a>    <span class="k">def</span> <span class="nf">getLogObj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_name</span><span class="o">=</span><span class="s1">&#39;Debug&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">log_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseDoor.getRunningXML"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.getRunningXML">[docs]</a>    <span class="k">def</span> <span class="nf">getRunningXML</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_xml</span></div>

<div class="viewcode-block" id="BaseDoor.getRunningMacro"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.getRunningMacro">[docs]</a>    <span class="k">def</span> <span class="nf">getRunningMacro</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running_macro</span></div>

<div class="viewcode-block" id="BaseDoor.getLastRunningMacro"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.getLastRunningMacro">[docs]</a>    <span class="k">def</span> <span class="nf">getLastRunningMacro</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_running_macro</span></div>

<div class="viewcode-block" id="BaseDoor.abort"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.abort">[docs]</a>    <span class="k">def</span> <span class="nf">abort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">synch</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">synch</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">command_inout</span><span class="p">(</span><span class="s2">&quot;AbortMacro&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">evt_wait</span> <span class="o">=</span> <span class="n">AttributeEventWait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">))</span>
        <span class="n">evt_wait</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">time_stamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">command_inout</span><span class="p">(</span><span class="s2">&quot;AbortMacro&quot;</span><span class="p">)</span>
            <span class="n">evt_wait</span><span class="o">.</span><span class="n">waitForEvent</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Running</span><span class="p">,</span> <span class="p">),</span> <span class="n">equal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">after</span><span class="o">=</span><span class="n">time_stamp</span><span class="p">,</span>
                                  <span class="n">reactivity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">InteractiveTimeout</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">evt_wait</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
            <span class="n">evt_wait</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span></div>

<div class="viewcode-block" id="BaseDoor.release"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.release">[docs]</a>    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">synch</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">synch</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">command_inout</span><span class="p">(</span><span class="s2">&quot;ReleaseMacro&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">PyTango</span><span class="o">.</span><span class="n">DevFailed</span> <span class="k">as</span> <span class="n">df</span><span class="p">:</span>
                <span class="c1"># Macro already finished - no need to release</span>
                <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reason</span> <span class="o">==</span> <span class="s2">&quot;API_CommandNotAllowed&quot;</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">return</span>

        <span class="n">evt_wait</span> <span class="o">=</span> <span class="n">AttributeEventWait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">))</span>
        <span class="n">evt_wait</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">time_stamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">command_inout</span><span class="p">(</span><span class="s2">&quot;ReleaseMacro&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">PyTango</span><span class="o">.</span><span class="n">DevFailed</span> <span class="k">as</span> <span class="n">df</span><span class="p">:</span>
                <span class="c1"># Macro already finished - no need to release</span>
                <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reason</span> <span class="o">==</span> <span class="s2">&quot;API_CommandNotAllowed&quot;</span><span class="p">:</span>
                    <span class="k">return</span>
            <span class="n">evt_wait</span><span class="o">.</span><span class="n">waitForEvent</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Running</span><span class="p">,</span> <span class="p">),</span> <span class="n">equal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">after</span><span class="o">=</span><span class="n">time_stamp</span><span class="p">,</span>
                                  <span class="n">reactivity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">InteractiveTimeout</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">evt_wait</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
            <span class="n">evt_wait</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span></div>

<div class="viewcode-block" id="BaseDoor.stop"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">synch</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">synch</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">command_inout</span><span class="p">(</span><span class="s2">&quot;StopMacro&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">evt_wait</span> <span class="o">=</span> <span class="n">AttributeEventWait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">))</span>
        <span class="n">evt_wait</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">time_stamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">command_inout</span><span class="p">(</span><span class="s2">&quot;StopMacro&quot;</span><span class="p">)</span>
            <span class="n">evt_wait</span><span class="o">.</span><span class="n">waitForEvent</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Running</span><span class="p">,</span> <span class="p">),</span> <span class="n">equal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">after</span><span class="o">=</span><span class="n">time_stamp</span><span class="p">,</span>
                                  <span class="n">reactivity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">InteractiveTimeout</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">evt_wait</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
            <span class="n">evt_wait</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_clearRunMacro</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Clear the log buffer</span>
        <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">LogAttr</span><span class="o">.</span><span class="n">clearLogBuffer</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_attr</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running_macros</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running_macro</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_xml</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_block_lines</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_createMacroXml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">macro_name</span><span class="p">,</span> <span class="n">macro_params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creation of the macro XML object.</span>

<span class="sd">        :param macro_name: (str) macro name</span>
<span class="sd">        :param macro_params: (sequence[str]) list of parameter values,</span>
<span class="sd">            if repeat parameters are used parameter values may be sequences</span>
<span class="sd">            itself.</span>
<span class="sd">        :return (lxml.etree._Element) macro XML element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">macro_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_server</span><span class="o">.</span><span class="n">getMacroInfoObj</span><span class="p">(</span><span class="n">macro_name</span><span class="p">)</span>
        <span class="n">params_def</span> <span class="o">=</span> <span class="n">macro_info</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">macro_node</span> <span class="o">=</span> <span class="n">createMacroNode</span><span class="p">(</span><span class="n">macro_name</span><span class="p">,</span> <span class="n">params_def</span><span class="p">,</span> <span class="n">macro_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">macro_node</span><span class="o">.</span><span class="n">toXml</span><span class="p">()</span>

<div class="viewcode-block" id="BaseDoor.preRunMacro"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.preRunMacro">[docs]</a>    <span class="k">def</span> <span class="nf">preRunMacro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clearRunMacro</span><span class="p">()</span>

        <span class="n">xml_root</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">parameters</span><span class="p">:</span>
                <span class="n">xml_root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">macros</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">macros_strs</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">macros_strs</span><span class="p">:</span>
                        <span class="n">pars</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="n">macros</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pars</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pars</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">parameters</span> <span class="o">=</span> <span class="n">recur_map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
                    <span class="n">macros</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">obj</span><span class="p">,</span> <span class="n">parameters</span><span class="p">))</span>
                <span class="n">xml_root</span> <span class="o">=</span> <span class="n">xml_seq</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;sequence&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">macros</span><span class="p">:</span>
                    <span class="n">macro_name</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">macro_params</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">xml_macro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createMacroXml</span><span class="p">(</span><span class="n">macro_name</span><span class="p">,</span> <span class="n">macro_params</span><span class="p">)</span>
                    <span class="n">xml_macro</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">()))</span>
                    <span class="n">xml_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xml_macro</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">etree</span><span class="o">.</span><span class="n">iselement</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="n">xml_root</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;obj must be a string or a etree.Element&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_running_macros</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">macro_xml</span> <span class="ow">in</span> <span class="n">xml_root</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//macro&#39;</span><span class="p">):</span>
            <span class="nb">id</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">macro_xml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="n">macro_xml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_running_macros</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">Macro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">macro_xml</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xml_root</span></div>

<div class="viewcode-block" id="BaseDoor.postRunMacro"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.postRunMacro">[docs]</a>    <span class="k">def</span> <span class="nf">postRunMacro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">synch</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="BaseDoor.runMacro"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.runMacro">[docs]</a>    <span class="k">def</span> <span class="nf">runMacro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="p">[],</span> <span class="n">synch</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preRunMacro</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runMacro</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_xml</span><span class="p">,</span> <span class="n">synch</span><span class="o">=</span><span class="n">synch</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">postRunMacro</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">synch</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_runMacro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">,</span> <span class="n">synch</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">synch</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_inout</span><span class="p">(</span><span class="s2">&quot;RunMacro&quot;</span><span class="p">,</span>
                                      <span class="p">[</span><span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span>
                                                      <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;unicode&#39;</span><span class="p">)])</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">InteractiveTimeout</span>
        <span class="n">evt_wait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getEventWait</span><span class="p">()</span>
        <span class="n">evt_wait</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">))</span>
        <span class="n">evt_wait</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">evt_wait</span><span class="o">.</span><span class="n">waitForEvent</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Running</span><span class="p">,</span> <span class="p">),</span> <span class="n">equal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">reactivity</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="c1"># Clear event set to not confuse the value coming from the</span>
            <span class="c1"># connection with the event of of end of the macro execution</span>
            <span class="c1"># in the next wait event. This was observed on Windows where</span>
            <span class="c1"># the time stamp resolution is not better than 1 ms.</span>
            <span class="n">evt_wait</span><span class="o">.</span><span class="n">clearEventSet</span><span class="p">()</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_inout</span><span class="p">(</span><span class="s2">&quot;RunMacro&quot;</span><span class="p">,</span>
                                        <span class="p">[</span><span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span>
                                                        <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;unicode&#39;</span><span class="p">)])</span>
            <span class="n">evt_wait</span><span class="o">.</span><span class="n">waitForEvent</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Running</span><span class="p">,</span> <span class="p">),</span> <span class="n">after</span><span class="o">=</span><span class="n">ts</span><span class="p">,</span>
                                  <span class="n">reactivity</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">synch</span><span class="p">:</span>
                <span class="n">evt_wait</span><span class="o">.</span><span class="n">waitForEvent</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Running</span><span class="p">,</span> <span class="p">),</span> <span class="n">equal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="n">ts</span><span class="p">,</span>
                                      <span class="n">reactivity</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clearRunMacro</span><span class="p">()</span>
            <span class="n">evt_wait</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
            <span class="n">evt_wait</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="BaseDoor.stateChanged"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.stateChanged">[docs]</a>    <span class="k">def</span> <span class="nf">stateChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="c1"># In contrary to the Taurus3 the Taurus4 raises exceptions when the</span>
        <span class="c1"># device server is getting down and we try to retrieve the state.</span>
        <span class="c1"># In this case provide the same behavior as Taurus3 - assign None to</span>
        <span class="c1"># the old state</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_old_door_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stateObj</span><span class="o">.</span><span class="n">rvalue</span>
        <span class="k">except</span> <span class="n">PyTango</span><span class="o">.</span><span class="n">DevFailed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_old_door_state</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_old_sw_door_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span></div>

<div class="viewcode-block" id="BaseDoor.resultReceived"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.resultReceived">[docs]</a>    <span class="k">def</span> <span class="nf">resultReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_name</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method invoked by the arrival of a change event on the Result</span>
<span class="sd">        attribute&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore_logs</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running_macro</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running_macro</span><span class="o">.</span><span class="n">setResult</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="BaseDoor.putEnvironment"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.putEnvironment">[docs]</a>    <span class="k">def</span> <span class="nf">putEnvironment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro_server</span><span class="o">.</span><span class="n">putEnvironment</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseDoor.putEnvironments"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.putEnvironments">[docs]</a>    <span class="k">def</span> <span class="nf">putEnvironments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro_server</span><span class="o">.</span><span class="n">putEnvironments</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></div>

    <span class="n">setEnvironment</span> <span class="o">=</span> <span class="n">putEnvironment</span>
    <span class="n">setEnvironments</span> <span class="o">=</span> <span class="n">putEnvironments</span>

<div class="viewcode-block" id="BaseDoor.getEnvironment"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.getEnvironment">[docs]</a>    <span class="k">def</span> <span class="nf">getEnvironment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_server</span><span class="o">.</span><span class="n">getEnvironment</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseDoor.inputReceived"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.inputReceived">[docs]</a>    <span class="k">def</span> <span class="nf">inputReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">CHANGE_EVT_TYPES</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running_macros</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="n">CodecFactory</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">((</span><span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processInput</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseDoor.processInput"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.processInput">[docs]</a>    <span class="k">def</span> <span class="nf">processInput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">):</span>
        <span class="n">TaurusManager</span><span class="p">()</span><span class="o">.</span><span class="n">addJob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_processInput</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_processInput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">):</span>
        <span class="n">input_type</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">input_type</span> <span class="o">==</span> <span class="s1">&#39;input&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_handler</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="s1">&#39;default_value&#39;</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">CodecFactory</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_attribute</span><span class="p">(</span><span class="s1">&#39;Input&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">input_type</span> <span class="o">==</span> <span class="s1">&#39;timeout&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_input_handler</span><span class="o">.</span><span class="n">input_timeout</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

<div class="viewcode-block" id="BaseDoor.recordDataReceived"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.recordDataReceived">[docs]</a>    <span class="k">def</span> <span class="nf">recordDataReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">CHANGE_EVT_TYPES</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processRecordData</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_processRecordData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">rvalue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rvalue</span>

        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">codec</span> <span class="o">=</span> <span class="n">CodecFactory</span><span class="p">()</span><span class="o">.</span><span class="n">getCodec</span><span class="p">(</span><span class="nb">format</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">codec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

<div class="viewcode-block" id="BaseDoor.processRecordData"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.processRecordData">[docs]</a>    <span class="k">def</span> <span class="nf">processRecordData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="BaseDoor.macroStatusReceived"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.macroStatusReceived">[docs]</a>    <span class="k">def</span> <span class="nf">macroStatusReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running_macros</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">CHANGE_EVT_TYPES</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">return</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">codec</span> <span class="o">=</span> <span class="n">CodecFactory</span><span class="p">()</span><span class="o">.</span><span class="n">getCodec</span><span class="p">(</span><span class="nb">format</span><span class="p">)</span>

        <span class="n">fmt</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">codec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">macro_status</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">macro_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
            <span class="n">macro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running_macros</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_running_macro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running_macro</span> <span class="o">=</span> <span class="n">macro</span>
            <span class="c1"># if we don&#39;t have the ID it&#39;s because the macro is running a</span>
            <span class="c1"># submacro or another client is connected to the same door (shame</span>
            <span class="c1">#  on him!) and executing a macro we discard this event</span>
            <span class="k">if</span> <span class="n">macro</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">macro</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">macro_status</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="BaseDoor.logReceived"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.logReceived">[docs]</a>    <span class="k">def</span> <span class="nf">logReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_name</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="n">term_size</span> <span class="o">=</span> <span class="n">get_terminal_size</span><span class="p">()</span>
        <span class="n">max_chrs</span> <span class="o">=</span> <span class="n">term_size</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">term_size</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">output</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_silent</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore_logs</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">log_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Debug</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_start</span><span class="p">[</span><span class="n">log_name</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">BlockStart</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_in_block</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_block_lines</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">max_chrs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">nb_lines</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">nb_lines</span> <span class="o">=</span> <span class="n">_get_nb_lines</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_len_last_data_line</span><span class="p">,</span>
                                <span class="n">max_chrs</span><span class="p">)</span>
                        <span class="c1"># per each line: erase current line,</span>
                        <span class="c1"># go up one line and erase current line</span>
                        <span class="n">o</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[2K</span><span class="se">\x1b</span><span class="s1">[1A</span><span class="se">\x1b</span><span class="s1">[2K&#39;</span> <span class="o">*</span> <span class="n">nb_lines</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_block_lines</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">line</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">BlockFinish</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_in_block</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_len_last_data_line</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in_block</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_block_lines</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_block_lines</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">o</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">line</span>
        <span class="n">o</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_stop</span><span class="p">[</span><span class="n">log_name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">o</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseDoor.write"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isSilent</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_stream</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_stream</span>
        <span class="k">if</span> <span class="n">stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_start</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stream</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_stop</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">return</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="BaseDoor.writeln"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.writeln">[docs]</a>    <span class="k">def</span> <span class="nf">writeln</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseDoor.getExperimentConfigurationObj"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.getExperimentConfigurationObj">[docs]</a>    <span class="k">def</span> <span class="nf">getExperimentConfigurationObj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_experiment_configuration</span></div>

<div class="viewcode-block" id="BaseDoor.getExperimentConfiguration"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.getExperimentConfiguration">[docs]</a>    <span class="k">def</span> <span class="nf">getExperimentConfiguration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_experiment_configuration</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="BaseDoor.setExperimentConfiguration"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseDoor.setExperimentConfiguration">[docs]</a>    <span class="k">def</span> <span class="nf">setExperimentConfiguration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">mnt_grps</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_experiment_configuration</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">mnt_grps</span><span class="o">=</span><span class="n">mnt_grps</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">UnknownMacroServerElementFormat</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">MacroPath</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ms</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro_path</span> <span class="o">=</span> <span class="n">mp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms</span><span class="p">()</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;MacroPath&quot;</span><span class="p">)[</span>
            <span class="s2">&quot;MacroPath&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_macro_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">commonprefix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_macro_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">osp</span><span class="o">.</span><span class="n">relpath</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_macro_path</span><span class="p">)]</span>


<span class="k">class</span> <span class="nc">Environment</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">macro_server</span><span class="p">):</span>
        <span class="nb">dict</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_macro_server_&quot;</span><span class="p">,</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">macro_server</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_macro_server_</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ms</span><span class="o">.</span><span class="n">putEnvironment</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_macro_server_</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ms</span><span class="o">.</span><span class="n">removeEnvironment</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)]</span>


<div class="viewcode-block" id="BaseMacroServer"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer">[docs]</a><span class="k">class</span> <span class="nc">BaseMacroServer</span><span class="p">(</span><span class="n">MacroServerDevice</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class encapsulating Macro Server device functionality.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span> <span class="o">=</span> <span class="n">BaseSardanaElementContainer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call__init__</span><span class="p">(</span><span class="n">MacroServerDevice</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__elems_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s2">&quot;Elements&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">serialization_mode</span> <span class="o">=</span> <span class="n">TaurusSerializationMode</span><span class="o">.</span><span class="n">TangoSerial</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">serialization_mode</span> <span class="o">=</span> <span class="n">TaurusSerializationMode</span><span class="o">.</span><span class="n">Serial</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__elems_attr</span><span class="o">.</span><span class="n">setSerializationMode</span><span class="p">(</span><span class="n">serialization_mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__elems_attr</span><span class="o">.</span><span class="n">addListener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_elements_changed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__elems_attr</span><span class="o">.</span><span class="n">setSerializationMode</span><span class="p">(</span>
            <span class="n">TaurusSerializationMode</span><span class="o">.</span><span class="n">Concurrent</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__env_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;Environment&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">serialization_mode</span> <span class="o">=</span> <span class="n">TaurusSerializationMode</span><span class="o">.</span><span class="n">TangoSerial</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">serialization_mode</span> <span class="o">=</span> <span class="n">TaurusSerializationMode</span><span class="o">.</span><span class="n">Serial</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__env_attr</span><span class="o">.</span><span class="n">setSerializationMode</span><span class="p">(</span><span class="n">serialization_mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__env_attr</span><span class="o">.</span><span class="n">addListener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_environment_changed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__env_attr</span><span class="o">.</span><span class="n">setSerializationMode</span><span class="p">(</span>
            <span class="n">TaurusSerializationMode</span><span class="o">.</span><span class="n">Concurrent</span><span class="p">)</span>

    <span class="n">NO_CLASS_TYPES</span> <span class="o">=</span> <span class="s1">&#39;ControllerClass&#39;</span><span class="p">,</span> <span class="s1">&#39;ControllerLibrary&#39;</span><span class="p">,</span> \
                     <span class="s1">&#39;MacroLibrary&#39;</span><span class="p">,</span> <span class="s1">&#39;Instrument&#39;</span><span class="p">,</span> <span class="s1">&#39;Meta&#39;</span><span class="p">,</span> <span class="s1">&#39;ParameterType&#39;</span>

<div class="viewcode-block" id="BaseMacroServer.on_environment_changed"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.on_environment_changed">[docs]</a>    <span class="k">def</span> <span class="nf">on_environment_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt_src</span><span class="p">,</span> <span class="n">evt_type</span><span class="p">,</span> <span class="n">evt_value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_environment_changed</span><span class="p">(</span><span class="n">evt_src</span><span class="p">,</span> <span class="n">evt_type</span><span class="p">,</span> <span class="n">evt_value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception occurred processing environment&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_on_environment_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt_src</span><span class="p">,</span> <span class="n">evt_type</span><span class="p">,</span> <span class="n">evt_value</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">added</span><span class="p">,</span> <span class="n">removed</span><span class="p">,</span> <span class="n">changed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">evt_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">CHANGE_EVT_TYPES</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="n">env</span> <span class="o">=</span> <span class="n">CodecFactory</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">evt_value</span><span class="o">.</span><span class="n">rvalue</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addEnvironment</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">added</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;del&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_removeEnvironment</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">removed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_removeEnvironment</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addEnvironment</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">changed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_addEnvironment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_removeEnvironment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

<div class="viewcode-block" id="BaseMacroServer.putEnvironment"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.putEnvironment">[docs]</a>    <span class="k">def</span> <span class="nf">putEnvironment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">putEnvironments</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span></div>

<div class="viewcode-block" id="BaseMacroServer.putEnvironments"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.putEnvironments">[docs]</a>    <span class="k">def</span> <span class="nf">putEnvironments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">new</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">codec</span> <span class="o">=</span> <span class="n">CodecFactory</span><span class="p">()</span><span class="o">.</span><span class="n">getCodec</span><span class="p">(</span><span class="s1">&#39;pickle&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_attribute</span><span class="p">(</span><span class="s1">&#39;Environment&#39;</span><span class="p">,</span> <span class="n">codec</span><span class="o">.</span><span class="n">encode</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)))</span></div>

    <span class="n">setEnvironment</span> <span class="o">=</span> <span class="n">putEnvironment</span>
    <span class="n">setEnvironments</span> <span class="o">=</span> <span class="n">putEnvironments</span>

<div class="viewcode-block" id="BaseMacroServer.getEnvironment"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.getEnvironment">[docs]</a>    <span class="k">def</span> <span class="nf">getEnvironment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>

<div class="viewcode-block" id="BaseMacroServer.removeEnvironment"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.removeEnvironment">[docs]</a>    <span class="k">def</span> <span class="nf">removeEnvironment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">key</span><span class="p">,</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">removeEnvironments</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMacroServer.removeEnvironments"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.removeEnvironments">[docs]</a>    <span class="k">def</span> <span class="nf">removeEnvironments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;del&#39;</span><span class="p">:</span> <span class="n">keys</span><span class="p">}</span>
        <span class="n">codec</span> <span class="o">=</span> <span class="n">CodecFactory</span><span class="p">()</span><span class="o">.</span><span class="n">getCodec</span><span class="p">(</span><span class="s1">&#39;pickle&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_attribute</span><span class="p">(</span><span class="s1">&#39;Environment&#39;</span><span class="p">,</span> <span class="n">codec</span><span class="o">.</span><span class="n">encode</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)))</span></div>

<div class="viewcode-block" id="BaseMacroServer.getObject"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.getObject">[docs]</a>    <span class="k">def</span> <span class="nf">getObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element_info</span><span class="p">):</span>
        <span class="n">elem_type</span> <span class="o">=</span> <span class="n">element_info</span><span class="o">.</span><span class="n">getType</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">elem_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">NO_CLASS_TYPES</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
        <span class="k">elif</span> <span class="s2">&quot;MacroCode&quot;</span> <span class="ow">in</span> <span class="n">element_info</span><span class="o">.</span><span class="n">interfaces</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createMacroClassObject</span><span class="p">(</span><span class="n">element_info</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createDeviceObject</span><span class="p">(</span><span class="n">element_info</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span></div>

    <span class="k">def</span> <span class="nf">_createMacroClassObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element_info</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">MacroInfo</span><span class="p">(</span><span class="n">from_json</span><span class="o">=</span><span class="n">element_info</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_createDeviceObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element_info</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Factory</span><span class="p">()</span><span class="o">.</span><span class="n">getDevice</span><span class="p">(</span><span class="n">element_info</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>

<div class="viewcode-block" id="BaseMacroServer.on_elements_changed"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.on_elements_changed">[docs]</a>    <span class="k">def</span> <span class="nf">on_elements_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt_src</span><span class="p">,</span> <span class="n">evt_type</span><span class="p">,</span> <span class="n">evt_value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_elements_changed</span><span class="p">(</span><span class="n">evt_src</span><span class="p">,</span> <span class="n">evt_type</span><span class="p">,</span> <span class="n">evt_value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception occurred processing elements&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_on_elements_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt_src</span><span class="p">,</span> <span class="n">evt_type</span><span class="p">,</span> <span class="n">evt_value</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">added</span><span class="p">,</span> <span class="n">removed</span><span class="p">,</span> <span class="n">changed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">evt_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">CHANGE_EVT_TYPES</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ret</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">elems</span> <span class="o">=</span> <span class="n">CodecFactory</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">evt_value</span><span class="o">.</span><span class="n">rvalue</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not decode element info format=</span><span class="si">%s</span><span class="s2"> len=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                       <span class="n">evt_value</span><span class="o">.</span><span class="n">rvalue</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">evt_value</span><span class="o">.</span><span class="n">rvalue</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">for</span> <span class="n">element_data</span> <span class="ow">in</span> <span class="n">elems</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="p">()):</span>
            <span class="n">element_data</span><span class="p">[</span><span class="s1">&#39;manager&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addElement</span><span class="p">(</span><span class="n">element_data</span><span class="p">)</span>
            <span class="n">added</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">element_data</span> <span class="ow">in</span> <span class="n">elems</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;del&#39;</span><span class="p">,</span> <span class="p">()):</span>
            <span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_removeElement</span><span class="p">(</span><span class="n">element_data</span><span class="p">)</span>
            <span class="n">removed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">element_data</span> <span class="ow">in</span> <span class="n">elems</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="p">()):</span>
            <span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_removeElement</span><span class="p">(</span><span class="n">element_data</span><span class="p">)</span>
            <span class="n">element_data</span><span class="p">[</span><span class="s1">&#39;manager&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addElement</span><span class="p">(</span><span class="n">element_data</span><span class="p">)</span>
            <span class="n">changed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_addElement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element_data</span><span class="p">):</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">BaseSardanaElement</span><span class="p">(</span><span class="o">**</span><span class="n">element_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getElementsInfo</span><span class="p">()</span><span class="o">.</span><span class="n">addElement</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">element</span>

    <span class="k">def</span> <span class="nf">_removeElement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element_data</span><span class="p">):</span>
        <span class="n">full_name</span> <span class="o">=</span> <span class="n">element_data</span><span class="p">[</span><span class="s1">&#39;full_name&#39;</span><span class="p">]</span>
        <span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getElementInfo</span><span class="p">(</span><span class="n">full_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getElementsInfo</span><span class="p">()</span><span class="o">.</span><span class="n">removeElement</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">element</span>

<div class="viewcode-block" id="BaseMacroServer.getElementsInfo"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.getElementsInfo">[docs]</a>    <span class="k">def</span> <span class="nf">getElementsInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span></div>

<div class="viewcode-block" id="BaseMacroServer.getElements"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.getElements">[docs]</a>    <span class="k">def</span> <span class="nf">getElements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getElementsInfo</span><span class="p">()</span><span class="o">.</span><span class="n">getElements</span><span class="p">()</span></div>

<div class="viewcode-block" id="BaseMacroServer.getElementInfo"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.getElementInfo">[docs]</a>    <span class="k">def</span> <span class="nf">getElementInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getElementsInfo</span><span class="p">()</span><span class="o">.</span><span class="n">getElement</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMacroServer.getElementNamesOfType"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.getElementNamesOfType">[docs]</a>    <span class="k">def</span> <span class="nf">getElementNamesOfType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_type</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getElementsInfo</span><span class="p">()</span><span class="o">.</span><span class="n">getElementNamesOfType</span><span class="p">(</span><span class="n">elem_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMacroServer.getElementNamesWithInterface"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.getElementNamesWithInterface">[docs]</a>    <span class="k">def</span> <span class="nf">getElementNamesWithInterface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interface</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getElementsInfo</span><span class="p">()</span><span class="o">.</span><span class="n">getElementNamesWithInterface</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMacroServer.getElementsWithInterface"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.getElementsWithInterface">[docs]</a>    <span class="k">def</span> <span class="nf">getElementsWithInterface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interface</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getElementsInfo</span><span class="p">()</span><span class="o">.</span><span class="n">getElementsWithInterface</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMacroServer.getElementsWithInterfaces"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.getElementsWithInterfaces">[docs]</a>    <span class="k">def</span> <span class="nf">getElementsWithInterfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getElementsInfo</span><span class="p">()</span><span class="o">.</span><span class="n">getElementsWithInterfaces</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMacroServer.getElementsOfType"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.getElementsOfType">[docs]</a>    <span class="k">def</span> <span class="nf">getElementsOfType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_type</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getElementsInfo</span><span class="p">()</span><span class="o">.</span><span class="n">getElementsOfType</span><span class="p">(</span><span class="n">elem_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMacroServer.getElementsOfTypes"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.getElementsOfTypes">[docs]</a>    <span class="k">def</span> <span class="nf">getElementsOfTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_types</span><span class="p">):</span>
        <span class="n">elems</span> <span class="o">=</span> <span class="n">CaselessDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">elem_type</span> <span class="ow">in</span> <span class="n">elem_types</span><span class="p">:</span>
            <span class="n">elems</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getElementsOfType</span><span class="p">(</span><span class="n">elem_type</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">elems</span></div>

<div class="viewcode-block" id="BaseMacroServer.getInterfaces"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.getInterfaces">[docs]</a>    <span class="k">def</span> <span class="nf">getInterfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getElementsInfo</span><span class="p">()</span><span class="o">.</span><span class="n">getInterfaces</span><span class="p">()</span></div>

<div class="viewcode-block" id="BaseMacroServer.getExpChannelElements"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.getExpChannelElements">[docs]</a>    <span class="k">def</span> <span class="nf">getExpChannelElements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">channel_types</span> <span class="o">=</span> <span class="s2">&quot;CTExpChannel&quot;</span><span class="p">,</span> <span class="s2">&quot;ZeroDExpChannel&quot;</span><span class="p">,</span> <span class="s2">&quot;OneDExpChannel&quot;</span><span class="p">,</span> \
            <span class="s2">&quot;TwoDExpChannel&quot;</span><span class="p">,</span> <span class="s2">&quot;PseudoCounter&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getElementsOfTypes</span><span class="p">(</span><span class="n">channel_types</span><span class="p">)</span></div>

    <span class="c1"># -~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-</span>
    <span class="c1"># Macro API</span>
    <span class="c1"># -~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-</span>

<div class="viewcode-block" id="BaseMacroServer.getMacros"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.getMacros">[docs]</a>    <span class="k">def</span> <span class="nf">getMacros</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">iname</span> <span class="o">=</span> <span class="s1">&#39;MacroCode&#39;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getElementsInfo</span><span class="p">()</span><span class="o">.</span><span class="n">getElementsWithInterface</span><span class="p">(</span><span class="n">iname</span><span class="p">))</span></div>

<div class="viewcode-block" id="BaseMacroServer.getMacroInfoObj"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.getMacroInfoObj">[docs]</a>    <span class="k">def</span> <span class="nf">getMacroInfoObj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">macro_name</span><span class="p">):</span>
        <span class="n">iname</span> <span class="o">=</span> <span class="s1">&#39;MacroCode&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getElementsInfo</span><span class="p">()</span><span class="o">.</span><span class="n">getElementWithInterface</span><span class="p">(</span><span class="n">macro_name</span><span class="p">,</span>
                                                              <span class="n">iname</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMacroServer.getMacroStrList"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.getMacroStrList">[docs]</a>    <span class="k">def</span> <span class="nf">getMacroStrList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getElementNamesWithInterface</span><span class="p">(</span><span class="s1">&#39;MacroCode&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMacroServer.getMacroNodeObj"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.getMacroNodeObj">[docs]</a>    <span class="k">def</span> <span class="nf">getMacroNodeObj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">macro_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method retrieves information about macro from MacroServer</span>
<span class="sd">        and creates MacroNode object, filled with all information about</span>
<span class="sd">        parameters.</span>

<span class="sd">        :param macro_name: (str) macro name</span>

<span class="sd">        :return: (MacroNode)</span>

<span class="sd">        See Also: fillMacroNodeAddidtionalInfos</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">macroInfoObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMacroInfoObj</span><span class="p">(</span><span class="n">macro_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">macroInfoObj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># fill macro parameters</span>
        <span class="n">paramsInfo</span> <span class="o">=</span> <span class="n">macroInfoObj</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">macroNode</span> <span class="o">=</span> <span class="n">MacroNode</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">macro_name</span><span class="p">,</span> <span class="n">params_def</span><span class="o">=</span><span class="n">paramsInfo</span><span class="p">)</span>
        <span class="n">hasParams</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paramsInfo</span><span class="p">))</span>
        <span class="n">macroNode</span><span class="o">.</span><span class="n">setHasParams</span><span class="p">(</span><span class="n">hasParams</span><span class="p">)</span>
        <span class="c1"># fill allowed hook places</span>
        <span class="n">allowedHookPlaces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">hints</span> <span class="o">=</span> <span class="n">macroInfoObj</span><span class="o">.</span><span class="n">hints</span>
        <span class="k">if</span> <span class="n">hints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">hints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;allowsHooks&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">allowedHookPlaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">hook</span><span class="p">))</span>
        <span class="n">macroNode</span><span class="o">.</span><span class="n">setAllowedHookPlaces</span><span class="p">(</span><span class="n">allowedHookPlaces</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">macroNode</span></div>

<div class="viewcode-block" id="BaseMacroServer.validateMacroName"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.validateMacroName">[docs]</a>    <span class="k">def</span> <span class="nf">validateMacroName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">macroName</span><span class="p">):</span>
        <span class="n">macroInfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getElementInfo</span><span class="p">(</span><span class="n">macroName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">macroInfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> macro does not exist in this sardana system.&quot;</span> <span class="o">%</span> <span class="n">macroName</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">macroInfo</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;MacroClass&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> element is not a macro.&quot;</span> <span class="o">%</span> <span class="n">macroName</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BaseMacroServer.validateMacroNode"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.validateMacroNode">[docs]</a>    <span class="k">def</span> <span class="nf">validateMacroNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">macroNode</span><span class="p">):</span>
        <span class="n">paramNodes</span> <span class="o">=</span> <span class="n">macroNode</span><span class="o">.</span><span class="n">children</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">paramNode</span> <span class="ow">in</span> <span class="n">paramNodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validateParamNode</span><span class="p">(</span><span class="n">paramNode</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BaseMacroServer.validateParamNode"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.validateParamNode">[docs]</a>    <span class="k">def</span> <span class="nf">validateParamNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paramNode</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paramNode</span><span class="p">,</span> <span class="n">ParamNode</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paramNode</span><span class="p">,</span> <span class="n">SingleParamNode</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validateSingleParam</span><span class="p">(</span><span class="n">paramNode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validateRepeatParam</span><span class="p">(</span><span class="n">paramNode</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BaseMacroServer.validateSingleParam"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.validateSingleParam">[docs]</a>    <span class="k">def</span> <span class="nf">validateSingleParam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">singleParamNode</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">singleParamNode</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="n">singleParamNode</span><span class="o">.</span><span class="n">type</span><span class="p">()</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">singleParamNode</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;Boolean&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;Env&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;File&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;Filename&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;MotorParam&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;String&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;User&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;MotorParam&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;Integer&quot;</span><span class="p">:</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="nb">min</span> <span class="o">=</span> <span class="n">singleParamNode</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="nb">max</span> <span class="o">=</span> <span class="n">singleParamNode</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> parameter value: </span><span class="si">%s</span><span class="s2"> is below minimum allowed value.&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> parameter value: </span><span class="si">%s</span><span class="s2"> is above maximum allowed value.&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;Float&quot;</span><span class="p">:</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="nb">min</span> <span class="o">=</span> <span class="n">singleParamNode</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="nb">max</span> <span class="o">=</span> <span class="n">singleParamNode</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> parameter value: </span><span class="si">%s</span><span class="s2"> is below minimum allowed value.&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> parameter value: </span><span class="si">%s</span><span class="s2"> is above maximum allowed value.&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">allowedInterfaces</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getInterfaces</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowedInterfaces</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;No element with </span><span class="si">%s</span><span class="s2"> interface exist in this sardana &quot;</span>
                    <span class="s2">&quot;system.&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">)</span>
            <span class="n">allowedValues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getElementNamesWithInterface</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowedValues</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> element with </span><span class="si">%s</span><span class="s2"> interface does not exist in this &quot;</span>
                    <span class="s2">&quot;sardana system.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BaseMacroServer.validateRepeatParam"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.validateRepeatParam">[docs]</a>    <span class="k">def</span> <span class="nf">validateRepeatParam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repeatParamNode</span><span class="p">):</span>
        <span class="n">paramName</span> <span class="o">=</span> <span class="n">repeatParamNode</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">repeatParamNode</span><span class="o">.</span><span class="n">isBelowMin</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> param repeats has not enough repeats.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">paramName</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">repeatParamNode</span><span class="o">.</span><span class="n">isAboveMax</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> param repeat has too many repeats.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">paramName</span><span class="p">))</span>
        <span class="n">repetitions</span> <span class="o">=</span> <span class="n">repeatParamNode</span><span class="o">.</span><span class="n">children</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">repeat</span> <span class="ow">in</span> <span class="n">repetitions</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">repeat</span><span class="o">.</span><span class="n">children</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">SingleParamNode</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">validateSingleParam</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">validateRepeatParam</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BaseMacroServer.fillMacroNodeAdditionalInfos"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.fillMacroNodeAdditionalInfos">[docs]</a>    <span class="k">def</span> <span class="nf">fillMacroNodeAdditionalInfos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">macroNode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method fills macroNode information which couldn&#39;t be stored</span>
<span class="sd">        in XML file.</span>

<span class="sd">        :param macroNode: (MacroNode) macro node obj populated from XML</span>
<span class="sd">          information</span>

<span class="sd">        See also: getMacroNodeObj</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">macroName</span> <span class="o">=</span> <span class="n">macroNode</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
        <span class="n">macroInfoObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMacroInfoObj</span><span class="p">(</span><span class="n">macroName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">macroInfoObj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;It was not possible to get information about </span><span class="si">{0}</span><span class="s2"> &quot;</span> \
                  <span class="s2">&quot;macro. Check if MacroServer is alive and if this macro &quot;</span> \
                  <span class="s2">&quot;exist.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">macroName</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no info about macro </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">macroName</span><span class="p">))</span>
        <span class="n">allowedHookPlaces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">hints</span> <span class="o">=</span> <span class="n">macroInfoObj</span><span class="o">.</span><span class="n">hints</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">hints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allowsHooks&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">allowedHookPlaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">hook</span><span class="p">))</span>
        <span class="n">macroNode</span><span class="o">.</span><span class="n">setAllowedHookPlaces</span><span class="p">(</span><span class="n">allowedHookPlaces</span><span class="p">)</span>
        <span class="n">hasParams</span> <span class="o">=</span> <span class="n">macroInfoObj</span><span class="o">.</span><span class="n">hasParams</span><span class="p">()</span>
        <span class="n">macroNode</span><span class="o">.</span><span class="n">setHasParams</span><span class="p">(</span><span class="n">hasParams</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hasParams</span><span class="p">:</span>
            <span class="n">paramList</span> <span class="o">=</span> <span class="n">macroInfoObj</span><span class="o">.</span><span class="n">getParamList</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">paramNode</span><span class="p">,</span> <span class="n">paramInfo</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">macroNode</span><span class="o">.</span><span class="n">params</span><span class="p">(),</span> <span class="n">paramList</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__fillParamNodeAdditionalInfos</span><span class="p">(</span><span class="n">paramNode</span><span class="p">,</span> <span class="n">paramInfo</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__fillParamNodeAdditionalInfos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paramNode</span><span class="p">,</span> <span class="n">paramInfo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a protected method foreseen to use only internally by</span>
<span class="sd">        fillMacroNodeAdditionaInfos, to be called for every param node obj.&quot;&quot;&quot;</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="n">paramInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
        <span class="n">paramNode</span><span class="o">.</span><span class="n">setDescription</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">paramInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">)))</span>
        <span class="nb">min</span> <span class="o">=</span> <span class="n">paramInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">)</span>
        <span class="n">paramNode</span><span class="o">.</span><span class="n">setMin</span><span class="p">(</span><span class="nb">min</span><span class="p">)</span>
        <span class="nb">max</span> <span class="o">=</span> <span class="n">paramInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">)</span>
        <span class="n">paramNode</span><span class="o">.</span><span class="n">setMax</span><span class="p">(</span><span class="nb">max</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">paramNode</span><span class="o">.</span><span class="n">setParamsInfo</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">repeatNode</span> <span class="ow">in</span> <span class="n">paramNode</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">internalParamNode</span><span class="p">,</span> <span class="n">internalParamInfo</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                        <span class="n">repeatNode</span><span class="o">.</span><span class="n">children</span><span class="p">(),</span> <span class="nb">type</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__fillParamNodeAdditionalInfos</span><span class="p">(</span>
                        <span class="n">internalParamNode</span><span class="p">,</span> <span class="n">internalParamInfo</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">paramNode</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">))</span>
            <span class="n">paramNode</span><span class="o">.</span><span class="n">setDefValue</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">paramInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_value&quot;</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">__fillParamNodesValues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paramInfo</span><span class="p">,</span> <span class="n">paramNode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a protected method foreseen to use only internally by</span>
<span class="sd">        __fillParamNodesValues, to be called for every param node obj.</span>

<span class="sd">        :param paramInfo, paramNode:</span>
<span class="sd">        :return:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">paramType</span> <span class="o">=</span> <span class="n">paramInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
        <span class="n">paramNode</span><span class="o">.</span><span class="n">setDescription</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">paramInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">)))</span>
        <span class="nb">min</span> <span class="o">=</span> <span class="n">paramInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">)</span>
        <span class="n">paramNode</span><span class="o">.</span><span class="n">setMin</span><span class="p">(</span><span class="nb">min</span><span class="p">)</span>
        <span class="nb">max</span> <span class="o">=</span> <span class="n">paramInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">)</span>
        <span class="n">paramNode</span><span class="o">.</span><span class="n">setMax</span><span class="p">(</span><span class="nb">max</span><span class="p">)</span>
        <span class="n">paramNode</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">paramInfo</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paramType</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">repeatNode</span> <span class="ow">in</span> <span class="n">paramNode</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
                <span class="n">children</span> <span class="o">=</span> <span class="n">repeatNode</span><span class="o">.</span><span class="n">children</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">child</span><span class="p">,</span> <span class="n">paramT</span> <span class="ow">in</span> <span class="n">zip_longest</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="n">paramType</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">child</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">node</span> <span class="o">=</span> <span class="n">ParamFactory</span><span class="p">(</span><span class="n">paramT</span><span class="p">,</span> <span class="n">repeatNode</span><span class="p">)</span>
                        <span class="n">repeatNode</span><span class="o">.</span><span class="n">insertChild</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__fillParamNodesValues</span><span class="p">(</span><span class="n">paramT</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">paramNode</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">paramType</span><span class="p">))</span>
            <span class="n">paramNode</span><span class="o">.</span><span class="n">setDefValue</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">paramInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_value&quot;</span><span class="p">)))</span>

<div class="viewcode-block" id="BaseMacroServer.printTree"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.printTree">[docs]</a>    <span class="k">def</span> <span class="nf">printTree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">tabs</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">tabs</span> <span class="o">=</span> <span class="n">tabs</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">*</span><span class="n">tabs</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">))</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">SingleParamNode</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">printTree</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">tabs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__recreateParamNodeAdditionalInfos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paramNode</span><span class="p">,</span> <span class="n">paramInfo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a protected method foreseen to use only internally by</span>
<span class="sd">        fillMacroNodeAdditionaInfos, to be called for every param node obj.&quot;&quot;&quot;</span>
        <span class="n">paramType</span> <span class="o">=</span> <span class="n">paramInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
        <span class="nb">min</span> <span class="o">=</span> <span class="n">paramInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">)</span>
        <span class="nb">max</span> <span class="o">=</span> <span class="n">paramInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">)</span>
        <span class="n">paramNode</span><span class="o">.</span><span class="n">setMin</span><span class="p">(</span><span class="nb">min</span><span class="p">)</span>
        <span class="n">paramNode</span><span class="o">.</span><span class="n">setMax</span><span class="p">(</span><span class="nb">max</span><span class="p">)</span>
        <span class="n">paramNode</span><span class="o">.</span><span class="n">setDescription</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">paramInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">)))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paramType</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">paramNode</span><span class="o">.</span><span class="n">setParamsInfo</span><span class="p">(</span><span class="n">paramType</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">repeatNode</span> <span class="ow">in</span> <span class="n">paramNode</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">internalParamNode</span><span class="p">,</span> <span class="n">internalParamInfo</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                        <span class="n">repeatNode</span><span class="o">.</span><span class="n">children</span><span class="p">(),</span> <span class="n">paramType</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__recreateParamNodeAdditionalInfos</span><span class="p">(</span>
                        <span class="n">internalParamNode</span><span class="p">,</span> <span class="n">internalParamInfo</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">paramNode</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="n">paramType</span><span class="p">)</span>
            <span class="n">paramNode</span><span class="o">.</span><span class="n">setDefValue</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">paramInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_value&quot;</span><span class="p">)))</span>

<div class="viewcode-block" id="BaseMacroServer.getMacroPathObj"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.BaseMacroServer.getMacroPathObj">[docs]</a>    <span class="k">def</span> <span class="nf">getMacroPathObj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_macro_path&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_macro_path</span> <span class="o">=</span> <span class="n">MacroPath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_macro_path</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_macro_path</span></div></div>


<div class="viewcode-block" id="registerExtensions"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.registerExtensions">[docs]</a><span class="k">def</span> <span class="nf">registerExtensions</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Registers the macroserver extensions in the</span>
<span class="sd">    :class:`taurus.core.tango.TangoFactory`&quot;&quot;&quot;</span>
    <span class="n">factory</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">(</span><span class="s1">&#39;tango&#39;</span><span class="p">)</span>
    <span class="n">factory</span><span class="o">.</span><span class="n">registerDeviceClass</span><span class="p">(</span><span class="s1">&#39;MacroServer&#39;</span><span class="p">,</span> <span class="n">BaseMacroServer</span><span class="p">)</span>
    <span class="n">factory</span><span class="o">.</span><span class="n">registerDeviceClass</span><span class="p">(</span><span class="s1">&#39;Door&#39;</span><span class="p">,</span> <span class="n">BaseDoor</span><span class="p">)</span></div>


<div class="viewcode-block" id="unregisterExtensions"><a class="viewcode-back" href="../../../../../../devel/api/sardana/taurus/core/tango/sardana/macroserver.html#sardana.taurus.core.tango.sardana.macroserver.unregisterExtensions">[docs]</a><span class="k">def</span> <span class="nf">unregisterExtensions</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Registers the macroserver extensions in the</span>
<span class="sd">    :class:`taurus.core.tango.TangoFactory`&quot;&quot;&quot;</span>
    <span class="n">factory</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">(</span><span class="s1">&#39;tango&#39;</span><span class="p">)</span>
    <span class="n">factory</span><span class="o">.</span><span class="n">unregisterDeviceClass</span><span class="p">(</span><span class="s1">&#39;MacroServer&#39;</span><span class="p">)</span>
    <span class="n">factory</span><span class="o">.</span><span class="n">unregisterDeviceClass</span><span class="p">(</span><span class="s1">&#39;Door&#39;</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright Except where otherwise noted, content on this site is
licensed under a Creative Commons Attribution 3.0 License.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>