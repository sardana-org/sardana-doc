

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>sardana.macroserver.scan.gscan &mdash; sardana 3.0.4-alpha documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home" alt="Documentation Home"> sardana
          

          
            
            <img src="../../../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference external" href="http://www.sardana-controls.org">Home Page</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/sardana-org/sardana">Project Page</a></li>
<li class="toctree-l1"><a class="reference external" href="http://pypi.python.org/pypi/sardana">Download from PyPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana-plugins">Plugins Catalogue</a></li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana/wiki">Wiki</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">sardana</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>sardana.macroserver.scan.gscan</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for sardana.macroserver.scan.gscan</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1">##############################################################################</span>
<span class="c1">##</span>
<span class="c1"># This file is part of Sardana</span>
<span class="c1">##</span>
<span class="c1"># http://www.sardana-controls.org/</span>
<span class="c1">##</span>
<span class="c1"># Copyright 2011 CELLS / ALBA Synchrotron, Bellaterra, Spain</span>
<span class="c1">##</span>
<span class="c1"># Sardana is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Lesser General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">##</span>
<span class="c1"># Sardana is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Lesser General Public License for more details.</span>
<span class="c1">##</span>
<span class="c1"># You should have received a copy of the GNU Lesser General Public License</span>
<span class="c1"># along with Sardana.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">##</span>
<span class="c1">##############################################################################</span>

<span class="sd">&quot;&quot;&quot;This module contains the class definition for the MacroServer generic</span>
<span class="sd">scan&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ScanSetupError&quot;</span><span class="p">,</span> <span class="s2">&quot;ScanException&quot;</span><span class="p">,</span> <span class="s2">&quot;ExtraData&quot;</span><span class="p">,</span> <span class="s2">&quot;TangoExtraData&quot;</span><span class="p">,</span>
           <span class="s2">&quot;GScan&quot;</span><span class="p">,</span> <span class="s2">&quot;SScan&quot;</span><span class="p">,</span> <span class="s2">&quot;CScan&quot;</span><span class="p">,</span> <span class="s2">&quot;CSScan&quot;</span><span class="p">,</span> <span class="s2">&quot;CTScan&quot;</span><span class="p">,</span> <span class="s2">&quot;HScan&quot;</span><span class="p">,</span> <span class="s2">&quot;TScan&quot;</span><span class="p">]</span>

<span class="n">__docformat__</span> <span class="o">=</span> <span class="s1">&#39;restructuredtext&#39;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">PyTango</span>
<span class="kn">import</span> <span class="nn">taurus</span>
<span class="kn">import</span> <span class="nn">collections</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="kn">from</span> <span class="nn">taurus.core.util.log</span> <span class="kn">import</span> <span class="n">Logger</span>
<span class="kn">from</span> <span class="nn">taurus.core.util.user</span> <span class="kn">import</span> <span class="n">USER_NAME</span>
<span class="kn">from</span> <span class="nn">taurus.core.tango</span> <span class="kn">import</span> <span class="n">FROM_TANGO_TO_STR_TYPE</span>
<span class="kn">from</span> <span class="nn">taurus.core.util.enumeration</span> <span class="kn">import</span> <span class="n">Enumeration</span>
<span class="kn">from</span> <span class="nn">taurus.core.util.threadpool</span> <span class="kn">import</span> <span class="n">ThreadPool</span>
<span class="kn">from</span> <span class="nn">taurus.core.util.event</span> <span class="kn">import</span> <span class="n">CallableRef</span>
<span class="kn">from</span> <span class="nn">taurus.core.tango.tangovalidator</span> <span class="kn">import</span> <span class="n">TangoDeviceNameValidator</span>

<span class="kn">from</span> <span class="nn">sardana.sardanathreadpool</span> <span class="kn">import</span> <span class="n">OmniWorker</span>
<span class="kn">from</span> <span class="nn">sardana.util.tree</span> <span class="kn">import</span> <span class="n">BranchNode</span><span class="p">,</span> <span class="n">LeafNode</span><span class="p">,</span> <span class="n">Tree</span>
<span class="kn">from</span> <span class="nn">sardana.util.motion</span> <span class="kn">import</span> <span class="n">Motor</span> <span class="k">as</span> <span class="n">VMotor</span>
<span class="kn">from</span> <span class="nn">sardana.util.motion</span> <span class="kn">import</span> <span class="n">MotionPath</span>
<span class="kn">from</span> <span class="nn">sardana.util.thread</span> <span class="kn">import</span> <span class="n">CountLatch</span>
<span class="kn">from</span> <span class="nn">sardana.pool.pooldefs</span> <span class="kn">import</span> <span class="n">SynchDomain</span><span class="p">,</span> <span class="n">SynchParam</span>
<span class="kn">from</span> <span class="nn">sardana.macroserver.msexception</span> <span class="kn">import</span> <span class="n">MacroServerException</span><span class="p">,</span> <span class="n">UnknownEnv</span><span class="p">,</span> \
    <span class="n">InterruptException</span><span class="p">,</span> <span class="n">StopException</span><span class="p">,</span> <span class="n">AbortException</span>
<span class="kn">from</span> <span class="nn">sardana.macroserver.msparameter</span> <span class="kn">import</span> <span class="n">Type</span>
<span class="kn">from</span> <span class="nn">sardana.macroserver.scan.scandata</span> <span class="kn">import</span> <span class="n">ColumnDesc</span><span class="p">,</span> <span class="n">MoveableDesc</span><span class="p">,</span> \
    <span class="n">ScanFactory</span><span class="p">,</span> <span class="n">ScanDataEnvironment</span>
<span class="kn">from</span> <span class="nn">sardana.macroserver.scan.recorder</span> <span class="kn">import</span> <span class="p">(</span><span class="n">AmbiguousRecorderError</span><span class="p">,</span>
                                               <span class="n">SharedMemoryRecorder</span><span class="p">,</span>
                                               <span class="n">FileRecorder</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sardana.taurus.core.tango.sardana.pool</span> <span class="kn">import</span> <span class="n">Ready</span><span class="p">,</span> <span class="n">TwoDExpChannel</span>


<span class="c1"># ScanEndStatus enumeration indicates the reason of the scan end.</span>
<span class="n">ScanEndStatus</span> <span class="o">=</span> <span class="n">Enumeration</span><span class="p">(</span><span class="s2">&quot;ScanEndStatus&quot;</span><span class="p">,</span>
                            <span class="p">[</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="s2">&quot;Stop&quot;</span><span class="p">,</span> <span class="s2">&quot;Abort&quot;</span><span class="p">,</span> <span class="s2">&quot;Exception&quot;</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">ScanSetupError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">ScanException</span><span class="p">(</span><span class="n">MacroServerException</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">ExtraData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Expected keywords are:</span>
<span class="sd">            - model (str, mandatory): represents data source (ex.: a/b/c/d)</span>
<span class="sd">            - label (str, mandatory): column label</span>
<span class="sd">            - name (str, optional): unique name (defaults to model)</span>
<span class="sd">            - shape (seq, optional): data shape</span>
<span class="sd">            - dtype (numpy.dtype, optional): data type</span>
<span class="sd">            - instrument (str, optional): full instrument name&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;dtype&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getType</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;shape&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getShape</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_column</span> <span class="o">=</span> <span class="n">ColumnDesc</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getLabel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label</span>

    <span class="k">def</span> <span class="nf">getName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label</span>

    <span class="k">def</span> <span class="nf">getColumnDesc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column</span>

    <span class="k">def</span> <span class="nf">getType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Must be implemented in subclass&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getShape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Must be implemented in subclass&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Must be implemented in subclass&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TangoExtraData</span><span class="p">(</span><span class="n">ExtraData</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attribute</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ExtraData</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attribute</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_attribute</span> <span class="o">=</span> <span class="n">taurus</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attribute</span>

    <span class="k">def</span> <span class="nf">getType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">getType</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Could not determine type for unknown attribute &quot;</span>
                            <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FROM_TANGO_TO_STR_TYPE</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">getShape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">getShape</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Could not determine type for unknown attribute &quot;</span>
                            <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>


<div class="viewcode-block" id="GScan"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/scan.html#sardana.macroserver.scan.GScan">[docs]</a><span class="k">class</span> <span class="nc">GScan</span><span class="p">(</span><span class="n">Logger</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generic Scan object.</span>
<span class="sd">    The idea is that the scan macros create an instance of this Generic Scan,</span>
<span class="sd">    supplying in the constructor a reference to the macro that created the</span>
<span class="sd">    scan, a generator function pointer, a list of moveable items, an extra</span>
<span class="sd">    environment and a sequence of constrains.</span>

<span class="sd">    If the referenced macro is hookable, ``pre-scan`` and ``post-scan`` hook</span>
<span class="sd">    hints will be used to execute callables before the start and after the</span>
<span class="sd">    end of the scan, respectively</span>

<span class="sd">    The generator must be a function yielding a dictionary with the following</span>
<span class="sd">    content (minimum) at each step of the scan:</span>

<span class="sd">    - &#39;positions&#39; : In a step scan, the position where the moveables</span>
<span class="sd">      should go</span>
<span class="sd">    - &#39;integ_time&#39; : In a step scan, a number representing the integration</span>
<span class="sd">      time for the step (in seconds)</span>
<span class="sd">    - &#39;integ_time&#39; : In a continuous scan, the time between acquisitions</span>
<span class="sd">    - &#39;pre-move-hooks&#39; : (optional) a sequence of callables to be called</span>
<span class="sd">      in strict order before starting to move.</span>
<span class="sd">    - &#39;post-move-hooks&#39;: (optional) a sequence of callables to be called</span>
<span class="sd">      in strict order after finishing the move.</span>
<span class="sd">    - &#39;pre-acq-hooks&#39; : (optional) a sequence of callables to be called in</span>
<span class="sd">      strict order before starting to acquire.</span>
<span class="sd">    - &#39;post-acq-hooks&#39; : (optional) a sequence of callables to be called in</span>
<span class="sd">      strict order after finishing acquisition but before recording the step.</span>
<span class="sd">    - &#39;post-step-hooks&#39; : (optional) a sequence of callables to be called in</span>
<span class="sd">      strict order after finishing recording the step.</span>
<span class="sd">    - &#39;point_id&#39; : a hashable identifing the scan point.</span>
<span class="sd">    - &#39;check_func&#39; : (optional) a list of callable objects.</span>
<span class="sd">      callable(moveables, counters)</span>
<span class="sd">    - &#39;extravalues&#39;: (optional) a dictionary containing the values for</span>
<span class="sd">      each extra info field. The extra information fields must be described</span>
<span class="sd">      in extradesc (passed in the constructor of the Gscan)</span>


<span class="sd">    The moveables must be a sequence Motion or MoveableDesc objects.</span>

<span class="sd">    The environment is a dictionary of extra environment to be added specific</span>
<span class="sd">    to the macro in question.</span>

<span class="sd">    Each constrain must be a callable which must receive a two parameters: the</span>
<span class="sd">    current point and the next point. It should return True or False</span>

<span class="sd">    The extradesc optional argument consists of a list of ColumnDesc objects</span>
<span class="sd">    which describe the data fields that will be filled using</span>
<span class="sd">    step[&#39;extravalues&#39;], where step is what the generator yields.</span>

<span class="sd">    The Generic Scan will create:</span>

<span class="sd">    - a ScanData</span>
<span class="sd">    - DataHandler with the following recorders:</span>
<span class="sd">    - OutputRecorder (depends on ``OutputCols`` environment variable)</span>
<span class="sd">    - SharedMemoryRecorder (depends on ``SharedMemory`` environment variable)</span>
<span class="sd">    - FileRecorder (depends on ``ScanDir``, ``ScanData`` and ``ScanRecorder``</span>
<span class="sd">      environment variables)</span>
<span class="sd">    - ScanDataEnvironment with the following contents:</span>

<span class="sd">        - &#39;serialno&#39; : a integer identifier for the scan operation</span>
<span class="sd">        - &#39;user&#39; : the user which started the scan</span>
<span class="sd">        - &#39;title&#39; : the scan title (build from macro.getCommand)</span>
<span class="sd">        - &#39;datadesc&#39; : a seq&lt;ColumnDesc&gt; describing each column of data</span>
<span class="sd">          (labels, data format, data shape, etc)</span>
<span class="sd">        - &#39;estimatedtime&#39; : a float representing an estimation for the duration</span>
<span class="sd">          of the scan (in seconds). Negative means the time estimation is known</span>
<span class="sd">          not to be accurate. Anyway, time estimation has &#39;at least&#39; semantics.</span>
<span class="sd">        - &#39;total_scan_intervals&#39; : total number of scan intervals. Negative</span>
<span class="sd">          means the estimation is known not to be accurate. In this case,</span>
<span class="sd">          estimation has &#39;at least&#39; semantics.</span>
<span class="sd">        - &#39;&#39; : a datetime.datetime representing the start of the scan</span>
<span class="sd">        - &#39;instrumentlist&#39; : a list of Instrument objects containing info about</span>
<span class="sd">          the physical setup of the motors, counters,</span>
<span class="sd">        - &lt;extra environment&gt; given in the constructor</span>

<span class="sd">        (at the end of the scan, extra keys &#39;endtime&#39; and &#39;deadtime&#39; will be</span>
<span class="sd">        added representing the time at the end of the scan and the dead time)</span>

<span class="sd">        This object is passed to all recorders at the beginning and at the end</span>
<span class="sd">        of the scan (when startRecordList and endRecordList is called)</span>

<span class="sd">    At each step of the scan, for each Recorder, the writeRecord method will</span>
<span class="sd">    be called with a Record object as parameter. The Record.data member will be</span>
<span class="sd">    a dictionary containing:</span>

<span class="sd">    - &#39;point_nb&#39; : the point number of the scan</span>
<span class="sd">    - for each column of the scan (motor or counter), a key with the</span>
<span class="sd">      corresponding column name will contain the value</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">MAX_SCAN_HISTORY</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="n">env</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ActiveMntGrp&#39;</span><span class="p">,</span> <span class="s1">&#39;ExtraColumns&#39;</span> <span class="s1">&#39;ScanDir&#39;</span><span class="p">,</span> <span class="s1">&#39;ScanFile&#39;</span><span class="p">,</span>
           <span class="s1">&#39;ScanRecorder&#39;</span><span class="p">,</span> <span class="s1">&#39;SharedMemory&#39;</span><span class="p">,</span> <span class="s1">&#39;OutputCols&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">macro</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">moveables</span><span class="o">=</span><span class="p">[],</span> <span class="n">env</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">constraints</span><span class="o">=</span><span class="p">[],</span> <span class="n">extrainfodesc</span><span class="o">=</span><span class="p">[]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_macro</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">macro</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">CallableRef</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generator</span> <span class="o">=</span> <span class="n">generator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extrainfodesc</span> <span class="o">=</span> <span class="n">extrainfodesc</span>

        <span class="c1"># nasty hack to make sure macro has access to gScan as soon as</span>
        <span class="c1"># possible</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">_gScan</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rec_manager</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">getMacroServer</span><span class="p">()</span><span class="o">.</span><span class="n">recorder_manager</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_moveables</span><span class="p">,</span> <span class="n">moveable_names</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">moveable</span> <span class="ow">in</span> <span class="n">moveables</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">moveable</span><span class="p">,</span> <span class="n">MoveableDesc</span><span class="p">):</span>
                <span class="n">moveable</span> <span class="o">=</span> <span class="n">MoveableDesc</span><span class="p">(</span><span class="n">moveable</span><span class="o">=</span><span class="n">moveable</span><span class="p">)</span>
            <span class="n">moveable_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">moveable</span><span class="o">.</span><span class="n">moveable</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_moveables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">moveable</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_moveables_limits</span><span class="p">()</span>

        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call__init__</span><span class="p">(</span><span class="n">Logger</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Setup motion objects</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">moveable_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_motion</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">getMotion</span><span class="p">(</span><span class="n">moveable_names</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_motion</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Find the measurement group</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mnt_grp_name</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;ActiveMntGrp&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UnknownEnv</span><span class="p">:</span>
            <span class="n">mnt_grps</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">getObjs</span><span class="p">(</span><span class="s2">&quot;.*&quot;</span><span class="p">,</span> <span class="n">type_class</span><span class="o">=</span><span class="n">Type</span><span class="o">.</span><span class="n">MeasurementGroup</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mnt_grps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScanSetupError</span><span class="p">(</span><span class="s1">&#39;No Measurement Group defined&#39;</span><span class="p">)</span>
            <span class="n">mnt_grp</span> <span class="o">=</span> <span class="n">mnt_grps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">macro</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ActiveMntGrp not defined. Using </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mnt_grp</span><span class="p">)</span>
            <span class="n">macro</span><span class="o">.</span><span class="n">setEnv</span><span class="p">(</span><span class="s1">&#39;ActiveMntGrp&#39;</span><span class="p">,</span> <span class="n">mnt_grp</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mnt_grp_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">mnt_grp_name</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ActiveMntGrp MUST be string. It is &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span>

            <span class="n">mnt_grp</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">getObj</span><span class="p">(</span><span class="n">mnt_grp_name</span><span class="p">,</span>
                                   <span class="n">type_class</span><span class="o">=</span><span class="n">Type</span><span class="o">.</span><span class="n">MeasurementGroup</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mnt_grp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScanSetupError</span><span class="p">(</span><span class="s2">&quot;ActiveMntGrp has invalid value: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
                                 <span class="o">%</span> <span class="n">mnt_grp_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_master</span> <span class="o">=</span> <span class="n">mnt_grp</span><span class="o">.</span><span class="n">getConfiguration</span><span class="p">()</span><span class="o">.</span><span class="n">getTimer</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScanSetupError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> has no timer defined&#39;</span> <span class="o">%</span> <span class="n">mnt_grp</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_measurement_group</span> <span class="o">=</span> <span class="n">mnt_grp</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Setup extra columns</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraColumns</span><span class="p">()</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Setup data management</span>
        <span class="c1"># ---------------------------------------------------------------------</span>

        <span class="c1"># Generate data handler</span>
        <span class="n">data_handler</span> <span class="o">=</span> <span class="n">ScanFactory</span><span class="p">()</span><span class="o">.</span><span class="n">getDataHandler</span><span class="p">()</span>

        <span class="c1"># The Scan data object</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">apply_interpol</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;ApplyInterpolation&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UnknownEnv</span><span class="p">:</span>
            <span class="n">apply_interpol</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">apply_extrapol</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;ApplyExtrapolation&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UnknownEnv</span><span class="p">:</span>
            <span class="n">apply_extrapol</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># The Scan data object</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ScanFactory</span><span class="p">()</span><span class="o">.</span><span class="n">getScanData</span><span class="p">(</span><span class="n">data_handler</span><span class="p">,</span>
                                         <span class="n">apply_interpolation</span><span class="o">=</span><span class="n">apply_interpol</span><span class="p">,</span>
                                         <span class="n">apply_extrapolation</span><span class="o">=</span><span class="n">apply_extrapol</span><span class="p">)</span>

        <span class="c1"># The Output recorder (if any)</span>
        <span class="n">output_recorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getOutputRecorder</span><span class="p">()</span>

        <span class="c1"># The Output recorder (if any)</span>
        <span class="n">json_recorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getJsonRecorder</span><span class="p">()</span>

        <span class="c1"># The File recorders (if any)</span>
        <span class="n">file_recorders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFileRecorders</span><span class="p">()</span>

        <span class="c1"># The Shared memory recorder (if any)</span>
        <span class="n">shm_recorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getSharedMemoryRecorder</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">shm_recorder_1d</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">shm_recorder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shm_recorder_1d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getSharedMemoryRecorder</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">data_handler</span><span class="o">.</span><span class="n">addRecorder</span><span class="p">(</span><span class="n">output_recorder</span><span class="p">)</span>
        <span class="n">data_handler</span><span class="o">.</span><span class="n">addRecorder</span><span class="p">(</span><span class="n">json_recorder</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file_recorder</span> <span class="ow">in</span> <span class="n">file_recorders</span><span class="p">:</span>
            <span class="n">data_handler</span><span class="o">.</span><span class="n">addRecorder</span><span class="p">(</span><span class="n">file_recorder</span><span class="p">)</span>
        <span class="n">data_handler</span><span class="o">.</span><span class="n">addRecorder</span><span class="p">(</span><span class="n">shm_recorder</span><span class="p">)</span>
        <span class="n">data_handler</span><span class="o">.</span><span class="n">addRecorder</span><span class="p">(</span><span class="n">shm_recorder_1d</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_handler</span> <span class="o">=</span> <span class="n">data_handler</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Setup environment</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setupEnvironment</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_moveables_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moveables</span><span class="p">:</span>
            <span class="n">pos_range</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">moveable</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s2">&quot;Position&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">range</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">high</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pos_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">magnitude</span><span class="p">)</span>    <span class="c1"># Taurus 4</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">high</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pos_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>          <span class="c1"># Taurus 3</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">high</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">low</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pos_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">magnitude</span><span class="p">)</span>     <span class="c1"># Taurus 4</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">low</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pos_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>           <span class="c1"># Taurus 3</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">low</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">((</span><span class="n">m</span><span class="o">.</span><span class="n">min_value</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">max_value</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Scan range is not defined for </span><span class="si">%s</span><span class="s2"> and could &quot;</span>
                                 <span class="s2">&quot;not be verified against motor limits.&quot;</span>
                                 <span class="o">%</span> <span class="n">m</span><span class="o">.</span><span class="n">moveable</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">min_value</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">max_value</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">high</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">high</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                            <span class="s2">&quot;requested movement of </span><span class="si">%s</span><span class="s2"> is above its upper limit&quot;</span>
                            <span class="o">%</span> <span class="n">m</span><span class="o">.</span><span class="n">moveable</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">low</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                            <span class="s2">&quot;requested movement of </span><span class="si">%s</span><span class="s2"> is below its lower limit&quot;</span>
                            <span class="o">%</span> <span class="n">m</span><span class="o">.</span><span class="n">moveable</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_getExtraColumns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;ExtraColumns&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ExtraColumns is not defined&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
                <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;instrument&#39;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
                        <span class="n">type_class</span> <span class="o">=</span> <span class="n">Type</span><span class="o">.</span><span class="n">Instrument</span>
                        <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getObj</span><span class="p">(</span><span class="n">kw</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">],</span>
                                                        <span class="n">type_class</span><span class="o">=</span><span class="n">type_class</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">instrument</span><span class="p">:</span>
                            <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instrument</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TangoExtraData</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">))</span>
                <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">colexcept</span><span class="p">:</span>
                    <span class="n">colname</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Extra column </span><span class="si">%s</span><span class="s2"> is invalid: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                       <span class="n">colname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">colexcept</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;ExtraColumns has invalid value. Must be a &#39;</span>
                               <span class="s1">&#39;sequence of maps&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_getJsonRecorder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">json_enabled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;JsonRecorder&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">json_enabled</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_manager</span><span class="o">.</span><span class="n">getRecorderClass</span><span class="p">(</span><span class="s2">&quot;JsonRecorder&quot;</span><span class="p">)(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;JsonRecorder is not defined. Use &quot;senv JsonRecorder &#39;</span>
                  <span class="s1">&#39;True&quot; to enable it&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getOutputRecorder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">output_block</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;OutputCols&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">output_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getViewOption</span><span class="p">(</span><span class="s1">&#39;OutputBlock&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_manager</span><span class="o">.</span><span class="n">getRecorderClass</span><span class="p">(</span><span class="s2">&quot;OutputRecorder&quot;</span><span class="p">)(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span> <span class="n">number_fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">output_block</span><span class="o">=</span><span class="n">output_block</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getFileRecorders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">macro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">scan_dir</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;ScanDir&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scan_dir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">macro</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;ScanDir value is empty&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ScanDir value is empty&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">macro</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;ScanDir is not defined. This operation will not be &#39;</span>
                          <span class="s1">&#39;stored persistently. Use &quot;expconf&quot; or &quot;newfile&quot; &#39;</span>
                          <span class="s1">&#39;to configure data storage (or eventually &quot;senv &#39;</span>
                          <span class="s1">&#39;ScanDir &lt;abs directory&gt;&quot;)&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scan_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">scan_dir_t</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">scan_dir</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ScanDir MUST be string. It is &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">scan_dir_t</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_names</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;ScanFile&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_names</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">macro</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;ScanFile value is empty&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ScanFile value is empty&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">macro</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;ScanFile is not defined. This operation will not &#39;</span>
                          <span class="s1">&#39;be stored persistently. Use &quot;expconf&quot; or &quot;newfile&quot; &#39;</span>
                          <span class="s1">&#39;to configure data storage (or eventually &quot;senv &#39;</span>
                          <span class="s1">&#39;ScanFile &lt;scan file(s)&gt;&quot;)&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">()</span>

        <span class="n">scan_recorders</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">scan_recorders</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;ScanRecorder&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="n">UnknownEnv</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">file_names</span> <span class="o">=</span> <span class="p">(</span><span class="n">file_names</span><span class="p">,)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_names</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
            <span class="n">scan_file_t</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">file_names</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ScanFile MUST be string or sequence of strings.&quot;</span>
                            <span class="s2">&quot; It is &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">scan_file_t</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scan_recorders</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">scan_recorders</span> <span class="o">=</span> <span class="p">(</span><span class="n">scan_recorders</span><span class="p">,)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scan_recorders</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
            <span class="n">scan_recorders_t</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">scan_recorders</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ScanRecorder MUST be string or sequence of &quot;</span>
                            <span class="s2">&quot;strings. It is &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">scan_recorders_t</span><span class="p">)</span>

        <span class="n">file_recorders</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">file_names</span><span class="p">):</span>
            <span class="n">abs_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scan_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">file_recorder</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scan_recorders</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
                    <span class="n">file_recorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_manager</span><span class="o">.</span><span class="n">getRecorderClass</span><span class="p">(</span>
                        <span class="n">scan_recorders</span><span class="p">[</span><span class="n">i</span><span class="p">])(</span><span class="n">abs_file_name</span><span class="p">,</span> <span class="n">macro</span><span class="o">=</span><span class="n">macro</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">file_recorder</span><span class="p">:</span>
                    <span class="n">file_recorder</span> <span class="o">=</span> <span class="n">FileRecorder</span><span class="p">(</span><span class="n">abs_file_name</span><span class="p">,</span> <span class="n">macro</span><span class="o">=</span><span class="n">macro</span><span class="p">)</span>
                <span class="n">file_recorders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_recorder</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="n">AmbiguousRecorderError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">macro</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Select recorder that you would like to use &#39;</span>
                            <span class="s1">&#39;(i.e. set ScanRecorder environment variable).&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">macro</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Error creating recorder for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">abs_file_name</span><span class="p">)</span>
                <span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_recorders</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">macro</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No valid recorder found. This operation will not &quot;</span>
                          <span class="s2">&quot;be stored persistently&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">file_recorders</span>

    <span class="k">def</span> <span class="nf">_getSharedMemoryRecorder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eid</span><span class="p">):</span>
        <span class="n">macro</span><span class="p">,</span> <span class="n">mg</span><span class="p">,</span> <span class="n">shm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement_group</span><span class="p">,</span> <span class="kc">False</span>
        <span class="n">shmRecorder</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shm</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;SharedMemory&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;SharedMemory is not defined. Use &quot;senv &#39;</span>
                      <span class="s1">&#39;SharedMemory sps&quot; to enable it&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">shm</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># For now we only support SPS shared memory format</span>
        <span class="k">if</span> <span class="n">shm</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;sps&#39;</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="mi">1</span>                            <span class="c1"># Point nb column</span>
            <span class="n">cols</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moveables</span><span class="p">)</span>          <span class="c1"># motor columns</span>
            <span class="n">ch_nb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mg</span><span class="o">.</span><span class="n">getChannels</span><span class="p">())</span>
            <span class="n">oned_nb</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">array_prefix</span> <span class="o">=</span> <span class="n">mg</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">oned_nb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mg</span><span class="o">.</span><span class="n">OneDExpChannels</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">oned_nb</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">twod_nb</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">twod_nb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mg</span><span class="o">.</span><span class="n">TwoDExpChannels</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">twod_nb</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">eid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># counter/timer &amp; 0D channel columns</span>
                <span class="n">cols</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ch_nb</span> <span class="o">-</span> <span class="n">oned_nb</span> <span class="o">-</span> <span class="n">twod_nb</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">eid</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="mi">1024</span>

            <span class="k">if</span> <span class="n">eid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;program&#39;</span><span class="p">:</span> <span class="n">macro</span><span class="o">.</span><span class="n">getDoorName</span><span class="p">(),</span>
                               <span class="s1">&#39;array&#39;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_0D&quot;</span> <span class="o">%</span> <span class="n">array_prefix</span><span class="p">,</span>
                               <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)})</span>
            <span class="k">elif</span> <span class="n">eid</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">oned_nb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;program&#39;</span><span class="p">:</span> <span class="n">macro</span><span class="o">.</span><span class="n">getDoorName</span><span class="p">(),</span>
                                   <span class="s1">&#39;array&#39;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_1D&quot;</span> <span class="o">%</span> <span class="n">array_prefix</span><span class="p">,</span>
                                   <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="mi">99</span><span class="p">)})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shmRecorder</span> <span class="o">=</span> <span class="n">SharedMemoryRecorder</span><span class="p">(</span><span class="n">shm</span><span class="p">,</span> <span class="n">macro</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">macro</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Error creating </span><span class="si">%s</span><span class="s2"> SharedMemory recorder.&quot;</span> <span class="o">%</span> <span class="n">shm</span><span class="p">)</span>
            <span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">shmRecorder</span>

    <span class="k">def</span> <span class="nf">_secsToTimedelta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secs</span><span class="p">):</span>
        <span class="n">days</span><span class="p">,</span> <span class="n">secs</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">secs</span><span class="p">,</span> <span class="mi">86400</span><span class="p">)</span>
        <span class="c1"># we don&#39;t have to care about microseconds because if secs is a float</span>
        <span class="c1"># timedelta will do it for us</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="n">secs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_timedeltaToSecs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">td</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">86400</span> <span class="o">*</span> <span class="n">td</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="n">td</span><span class="o">.</span><span class="n">seconds</span> <span class="o">+</span> <span class="mf">1E-6</span> <span class="o">*</span> <span class="n">td</span><span class="o">.</span><span class="n">microseconds</span>

    <span class="k">def</span> <span class="nf">_setupEnvironment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">additional_env</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">serialno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s2">&quot;ScanID&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="n">UnknownEnv</span><span class="p">:</span>
            <span class="n">serialno</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">setEnv</span><span class="p">(</span><span class="s2">&quot;ScanID&quot;</span><span class="p">,</span> <span class="n">serialno</span><span class="p">)</span>

        <span class="n">env</span> <span class="o">=</span> <span class="n">ScanDataEnvironment</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;serialno&#39;</span><span class="p">:</span> <span class="n">serialno</span><span class="p">,</span>
             <span class="c1"># TODO: this should be got from</span>
             <span class="c1"># self.measurement_group.getChannelsInfo()</span>
             <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">USER_NAME</span><span class="p">,</span>
             <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getCommand</span><span class="p">()})</span>

        <span class="c1"># Initialize the data_desc list (and add the point number column)</span>
        <span class="n">data_desc</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ColumnDesc</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;point_nb&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;#Pt No&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># add motor columns</span>
        <span class="n">ref_moveables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">moveable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">moveables</span><span class="p">:</span>
            <span class="n">data_desc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">moveable</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">moveable</span><span class="o">.</span><span class="n">is_reference</span><span class="p">:</span>
                <span class="n">ref_moveables</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">moveable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ref_moveables</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moveables</span><span class="p">):</span>
            <span class="n">ref_moveables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_desc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;ref_moveables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref_moveables</span>

        <span class="c1"># add master column</span>
        <span class="n">master</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master</span>

        <span class="c1"># add channels from measurement group</span>
        <span class="n">channels_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement_group</span><span class="o">.</span><span class="n">getChannelsEnabledInfo</span><span class="p">()</span>
        <span class="n">counters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="n">channels_info</span><span class="p">:</span>
            <span class="n">full_name</span> <span class="o">=</span> <span class="n">ci</span><span class="o">.</span><span class="n">full_name</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Use DeviceProxy instead of taurus to avoid crashes in Py3</span>
                <span class="c1"># See: tango-controls/pytango#292</span>
                <span class="c1"># channel = taurus.Device(full_name)</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="n">PyTango</span><span class="o">.</span><span class="n">DeviceProxy</span><span class="p">(</span><span class="n">full_name</span><span class="p">)</span>
                <span class="n">instrument</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">instrument</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># full_name of external channels is the name of the attribute</span>
                <span class="c1"># external channels are not assigned to instruments</span>
                <span class="n">instrument</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">instrumentFullName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">findObjs</span><span class="p">(</span>
                    <span class="n">instrument</span><span class="p">,</span> <span class="n">type_class</span><span class="o">=</span><span class="n">Type</span><span class="o">.</span><span class="n">Instrument</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getFullName</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">instrumentFullName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="c1"># substitute the axis placeholder by the corresponding moveable.</span>
            <span class="n">plotAxes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ci</span><span class="o">.</span><span class="n">plot_axes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="s1">&#39;&lt;mov&gt;&#39;</span><span class="p">:</span>
                    <span class="c1"># skip plots against moveables in scans that do not involve</span>
                    <span class="c1"># them e.g. time scans</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_moveables</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">plotAxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref_moveables</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plotAxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value_ref_enabled</span> <span class="o">=</span> <span class="n">ci</span><span class="o">.</span><span class="n">value_ref_enabled</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">value_ref_enabled</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># create the ColumnDesc object</span>
            <span class="n">column</span> <span class="o">=</span> <span class="n">ColumnDesc</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">ci</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span>
                                <span class="n">label</span><span class="o">=</span><span class="n">ci</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="n">ci</span><span class="o">.</span><span class="n">data_type</span><span class="p">,</span>
                                <span class="n">shape</span><span class="o">=</span><span class="n">ci</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                <span class="n">instrument</span><span class="o">=</span><span class="n">instrumentFullName</span><span class="p">,</span>
                                <span class="n">source</span><span class="o">=</span><span class="n">ci</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                                <span class="n">output</span><span class="o">=</span><span class="n">ci</span><span class="o">.</span><span class="n">output</span><span class="p">,</span>
                                <span class="n">conditioning</span><span class="o">=</span><span class="n">ci</span><span class="o">.</span><span class="n">conditioning</span><span class="p">,</span>
                                <span class="n">normalization</span><span class="o">=</span><span class="n">ci</span><span class="o">.</span><span class="n">normalization</span><span class="p">,</span>
                                <span class="n">plot_type</span><span class="o">=</span><span class="n">ci</span><span class="o">.</span><span class="n">plot_type</span><span class="p">,</span>
                                <span class="n">plot_axes</span><span class="o">=</span><span class="n">plotAxes</span><span class="p">,</span>
                                <span class="n">data_units</span><span class="o">=</span><span class="n">ci</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span>
                                <span class="n">value_ref_enabled</span><span class="o">=</span><span class="n">value_ref_enabled</span><span class="p">)</span>
            <span class="n">data_desc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
            <span class="n">counters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">counters</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">master</span><span class="p">[</span><span class="s1">&#39;full_name&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># timer may be disabled</span>
            <span class="k">pass</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;counters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">counters</span>

        <span class="k">for</span> <span class="n">extra_column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_columns</span><span class="p">:</span>
            <span class="n">data_desc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extra_column</span><span class="o">.</span><span class="n">getColumnDesc</span><span class="p">())</span>
        <span class="c1"># add extra columns</span>
        <span class="n">data_desc</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extrainfodesc</span>
        <span class="n">data_desc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ColumnDesc</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span>
                                    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">))</span>

        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;datadesc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_desc</span>

        <span class="c1"># set the data compression default</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;DataCompressionRank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span>
                <span class="s1">&#39;DataCompressionRank&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UnknownEnv</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;DataCompressionRank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># set the sample information</span>
        <span class="c1"># @todo: use the instrument API to get this info</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;SampleInfo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;SampleInfo&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UnknownEnv</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;SampleInfo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># set the source information</span>
        <span class="c1"># @todo: use the instrument API to get this info</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;SourceInfo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;SourceInfo&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UnknownEnv</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;SourceInfo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># take the pre-scan snapshot</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">preScanSnapShot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;PreScanSnapshot&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UnknownEnv</span><span class="p">:</span>
            <span class="n">preScanSnapShot</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;preScanSnapShot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">takeSnapshot</span><span class="p">(</span><span class="n">elements</span><span class="o">=</span><span class="n">preScanSnapShot</span><span class="p">)</span>

        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;macro_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getID</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;ScanFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;ScanFile&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;ScanFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;ScanDir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;ScanDir&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;ScanDir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;estimatedtime&#39;</span><span class="p">],</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;total_scan_intervals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate</span><span class="p">()</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;instrumentlist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">findObjs</span><span class="p">(</span>
            <span class="s1">&#39;.*&#39;</span><span class="p">,</span> <span class="n">type_class</span><span class="o">=</span><span class="n">Type</span><span class="o">.</span><span class="n">Instrument</span><span class="p">)</span>

        <span class="c1"># env.update(self._getExperimentConfiguration) #add all the info from</span>
        <span class="c1"># the experiment configuration to the environment</span>
        <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">additional_env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">env</span>

        <span class="c1"># Give the environment to the ScanData</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">setEnviron</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

<div class="viewcode-block" id="GScan.takeSnapshot"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/scan.html#sardana.macroserver.scan.GScan.takeSnapshot">[docs]</a>    <span class="k">def</span> <span class="nf">takeSnapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;reads the current values of the given elements</span>

<span class="sd">        :param elements: (list&lt;str,str&gt;) list of tuples of label,src for the</span>
<span class="sd">                         elements to read (can be pool elements or Taurus</span>
<span class="sd">                         attribute names).</span>

<span class="sd">        :return: (list&lt;ColumnDesc&gt;) a list of :class:`ColumnDesc`,</span>
<span class="sd">                 each including a &quot;pre_scan_value&quot; attribute with the read</span>
<span class="sd">                 value for that attr</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getManager</span><span class="p">()</span>
        <span class="n">all_elements_info</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">get_elements_with_interface</span><span class="p">(</span><span class="s1">&#39;Element&#39;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">all_elements_info</span><span class="p">:</span>
                    <span class="n">ei</span> <span class="o">=</span> <span class="n">all_elements_info</span><span class="p">[</span><span class="n">src</span><span class="p">]</span>
                    <span class="n">column</span> <span class="o">=</span> <span class="n">ColumnDesc</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">ei</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span>
                                        <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                        <span class="n">instrument</span><span class="o">=</span><span class="n">ei</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span>
                                        <span class="n">source</span><span class="o">=</span><span class="n">ei</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">column</span> <span class="o">=</span> <span class="n">ColumnDesc</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">src</span><span class="p">,</span>
                                        <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                        <span class="n">source</span><span class="o">=</span><span class="n">src</span><span class="p">)</span>

                <span class="c1"># @Fixme: Tango-centric. It should work for any Taurus</span>
                <span class="c1"># Attribute</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">PyTango</span><span class="o">.</span><span class="n">AttributeProxy</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
                <span class="n">column</span><span class="o">.</span><span class="n">pre_scan_value</span> <span class="o">=</span> <span class="n">v</span>
                <span class="n">column</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">column</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span><span class="o">.</span><span class="n">name</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;Error taking pre-scan snapshot of </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Details:&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="k">def</span> <span class="nf">get_virtual_motors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">moveable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">moveables</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">v_motor</span> <span class="o">=</span> <span class="n">VMotor</span><span class="o">.</span><span class="n">fromMotor</span><span class="p">(</span><span class="n">moveable</span><span class="o">.</span><span class="n">moveable</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># self.debug(&quot;Details:&quot;, exc_info=1)</span>
                <span class="n">v_motor</span> <span class="o">=</span> <span class="n">VMotor</span><span class="p">(</span><span class="n">min_vel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_vel</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;+inf&#39;</span><span class="p">),</span>
                                 <span class="n">accel_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">decel_time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_motor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="n">MAX_ITER</span> <span class="o">=</span> <span class="mi">100000</span>

    <span class="k">def</span> <span class="nf">_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Estimate time and intervals of a scan.</span>

<span class="sd">        Time estimation considers motion time (including going to the start</span>
<span class="sd">        position) and acquisition time.</span>

<span class="sd">        Interval estimation is a number of scan trajectory intervals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">with_time</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">,</span> <span class="s2">&quot;getTimeEstimation&quot;</span><span class="p">)</span>
        <span class="n">with_interval</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">,</span> <span class="s2">&quot;getIntervalEstimation&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_time</span> <span class="ow">and</span> <span class="n">with_interval</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getTimeEstimation</span><span class="p">()</span>
            <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getIntervalEstimation</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">i</span>

        <span class="n">max_iter</span> <span class="o">=</span> <span class="n">max_iter</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_ITER</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">()</span>
        <span class="n">total_time</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">point_nb</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">interval_nb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">with_time</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">start_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">motion</span><span class="o">.</span><span class="n">readPosition</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">v_motors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_virtual_motors</span><span class="p">()</span>
                    <span class="n">motion_time</span><span class="p">,</span> <span class="n">acq_time</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
                    <span class="k">while</span> <span class="n">point_nb</span> <span class="o">&lt;</span> <span class="n">max_iter</span><span class="p">:</span>
                        <span class="n">step</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
                        <span class="n">end_pos</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">]</span>
                        <span class="n">max_path_duration</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="k">for</span> <span class="n">v_motor</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">v_motors</span><span class="p">,</span>
                                                        <span class="n">start_pos</span><span class="p">,</span>
                                                        <span class="n">end_pos</span><span class="p">):</span>
                            <span class="n">path</span> <span class="o">=</span> <span class="n">MotionPath</span><span class="p">(</span><span class="n">v_motor</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
                            <span class="n">max_path_duration</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                                <span class="n">max_path_duration</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
                        <span class="n">integ_time</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;integ_time&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                        <span class="n">acq_time</span> <span class="o">+=</span> <span class="n">integ_time</span>
                        <span class="n">motion_time</span> <span class="o">+=</span> <span class="n">max_path_duration</span>
                        <span class="n">total_time</span> <span class="o">+=</span> <span class="n">integ_time</span> <span class="o">+</span> <span class="n">max_path_duration</span>
                        <span class="n">point_nb</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">start_pos</span> <span class="o">=</span> <span class="n">end_pos</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">with_interval</span><span class="p">:</span>
                        <span class="n">interval_nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getIntervalEstimation</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">while</span> <span class="n">point_nb</span> <span class="o">&lt;</span> <span class="n">max_iter</span><span class="p">:</span>
                        <span class="n">step</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
                        <span class="n">point_nb</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">total_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getTimeEstimation</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># max iteration reached.</span>
            <span class="n">total_time</span> <span class="o">=</span> <span class="o">-</span><span class="n">total_time</span>
            <span class="n">point_nb</span> <span class="o">=</span> <span class="o">-</span><span class="n">point_nb</span>
        <span class="k">if</span> <span class="n">interval_nb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">point_nb</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">interval_nb</span> <span class="o">=</span> <span class="n">point_nb</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">point_nb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">interval_nb</span> <span class="o">=</span> <span class="n">point_nb</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">interval_nb</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Estimation of intervals have not succeeded&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">total_time</span><span class="p">,</span> <span class="n">interval_nb</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Scan data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_handler</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">macro</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_macro</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">measurement_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measurement_group</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generator of steps or waypoints used in this scan.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generator</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">motion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motion</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">moveables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moveables</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_steps&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_steps</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_steps</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_backup</span><span class="p">()</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;startts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;acqtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;motiontime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;deadtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;endts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;endtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">end_ts</span><span class="p">)</span>
        <span class="n">total_time</span> <span class="o">=</span> <span class="n">end_ts</span> <span class="o">-</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;startts&#39;</span><span class="p">]</span>
        <span class="c1"># estimated = env[&#39;estimatedtime&#39;]</span>
        <span class="n">acq_time</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;acqtime&#39;</span><span class="p">]</span>
        <span class="c1"># env[&#39;deadtime&#39;] = 100.0 * (total_time - estimated) / total_time</span>

        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;deadtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_time</span> <span class="o">-</span> <span class="n">acq_time</span>
        <span class="k">if</span> <span class="s1">&#39;delaytime&#39;</span> <span class="ow">in</span> <span class="n">env</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;motiontime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_time</span> <span class="o">-</span> <span class="n">acq_time</span> <span class="o">-</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;delaytime&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;motiontime&#39;</span> <span class="ow">in</span> <span class="n">env</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;delaytime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_time</span> <span class="o">-</span> <span class="n">acq_time</span> <span class="o">-</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;motiontime&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">scan_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;ScanHistory&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UnknownEnv</span><span class="p">:</span>
            <span class="n">scan_history</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">scan_file</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;ScanFile&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scan_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">scan_file</span> <span class="o">=</span> <span class="n">scan_file</span><span class="p">,</span>

        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;datadesc&#39;</span><span class="p">]]</span>
        <span class="n">history</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">startts</span><span class="o">=</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;startts&#39;</span><span class="p">],</span> <span class="n">endts</span><span class="o">=</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;endts&#39;</span><span class="p">],</span>
                       <span class="n">estimatedtime</span><span class="o">=</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;estimatedtime&#39;</span><span class="p">],</span>
                       <span class="n">deadtime</span><span class="o">=</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;deadtime&#39;</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
                       <span class="n">serialno</span><span class="o">=</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;serialno&#39;</span><span class="p">],</span> <span class="n">user</span><span class="o">=</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],</span>
                       <span class="n">ScanFile</span><span class="o">=</span><span class="n">scan_file</span><span class="p">,</span> <span class="n">ScanDir</span><span class="o">=</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ScanDir&#39;</span><span class="p">],</span>
                       <span class="n">endstatus</span><span class="o">=</span><span class="n">ScanEndStatus</span><span class="o">.</span><span class="n">whatis</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;endstatus&#39;</span><span class="p">]),</span>
                       <span class="n">channels</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
        <span class="n">scan_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">scan_history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_SCAN_HISTORY</span><span class="p">:</span>
            <span class="n">scan_history</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">setEnv</span><span class="p">(</span><span class="s1">&#39;ScanHistory&#39;</span><span class="p">,</span> <span class="n">scan_history</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_scan</span><span class="p">():</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">step_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">macro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">macro</span><span class="p">,</span> <span class="s1">&#39;getHooks&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">macro</span><span class="o">.</span><span class="n">getHooks</span><span class="p">(</span><span class="s1">&#39;pre-scan&#39;</span><span class="p">):</span>
                <span class="n">hook</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_loop</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">pausePoint</span><span class="p">()</span>
                <span class="k">yield</span> <span class="n">i</span>
            <span class="n">endstatus</span> <span class="o">=</span> <span class="n">ScanEndStatus</span><span class="o">.</span><span class="n">Normal</span>
        <span class="k">except</span> <span class="n">StopException</span><span class="p">:</span>
            <span class="n">endstatus</span> <span class="o">=</span> <span class="n">ScanEndStatus</span><span class="o">.</span><span class="n">Stop</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="n">AbortException</span><span class="p">:</span>
            <span class="n">endstatus</span> <span class="o">=</span> <span class="n">ScanEndStatus</span><span class="o">.</span><span class="n">Abort</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">endstatus</span> <span class="o">=</span> <span class="n">ScanEndStatus</span><span class="o">.</span><span class="n">Exception</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">[</span><span class="s2">&quot;endstatus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endstatus</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_restore</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">endstatus</span> <span class="o">==</span> <span class="n">ScanEndStatus</span><span class="o">.</span><span class="n">Normal</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">macro</span><span class="p">,</span> <span class="s1">&#39;getHooks&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">macro</span><span class="o">.</span><span class="n">getHooks</span><span class="p">(</span><span class="s1">&#39;post-scan&#39;</span><span class="p">):</span>
                        <span class="n">hook</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">scan_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Scan method cannot be called by &#39;</span>
                                  <span class="s1">&#39;abstract class&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">,</span> <span class="s1">&#39;do_backup&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">do_backup</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Failed to execute &#39;do_backup&#39; method of the </span><span class="si">%s</span><span class="s2"> macro&quot;</span> <span class="o">%</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Details: &#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ScanException</span><span class="p">(</span><span class="s1">&#39;error while doing a backup&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">,</span> <span class="s1">&#39;do_restore&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">do_restore</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Failed to execute &#39;do_restore&#39; method of the </span><span class="si">%s</span><span class="s2"> macro&quot;</span> <span class="o">%</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Details: &#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ScanException</span><span class="p">(</span><span class="s1">&#39;error while restoring a backup&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SScan"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/scan.html#sardana.macroserver.scan.SScan">[docs]</a><span class="k">class</span> <span class="nc">SScan</span><span class="p">(</span><span class="n">GScan</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Step scan&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">scan_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lstep</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">macro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span>
        <span class="n">scream</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_deterministic_scan</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">macro</span><span class="p">,</span> <span class="s2">&quot;nb_points&quot;</span><span class="p">):</span>
            <span class="n">nb_points</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">macro</span><span class="o">.</span><span class="n">nb_points</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">macro</span><span class="p">,</span> <span class="s2">&quot;integ_time&quot;</span><span class="p">):</span>
                <span class="n">integ_time</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">integ_time</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">measurement_group</span><span class="o">.</span><span class="n">putIntegrationTime</span><span class="p">(</span><span class="n">integ_time</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">measurement_group</span><span class="o">.</span><span class="n">setNbStarts</span><span class="p">(</span><span class="n">nb_points</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">measurement_group</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_deterministic_scan</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">scream</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="mf">0.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sum_motion_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sum_acq_time</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">:</span>
            <span class="c1"># allow scan to be stopped between points</span>
            <span class="n">macro</span><span class="o">.</span><span class="n">checkPoint</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stepUp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">lstep</span><span class="p">)</span>
            <span class="n">lstep</span> <span class="o">=</span> <span class="n">step</span>
            <span class="k">if</span> <span class="n">scream</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">nb_points</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">scream</span><span class="p">:</span>
            <span class="k">yield</span> <span class="mf">100.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">[</span><span class="s1">&#39;motiontime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_motion_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">[</span><span class="s1">&#39;acqtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_acq_time</span>

    <span class="k">def</span> <span class="nf">stepUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">lstep</span><span class="p">):</span>
        <span class="n">motion</span><span class="p">,</span> <span class="n">mg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">motion</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement_group</span>
        <span class="n">startts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">[</span><span class="s1">&#39;startts&#39;</span><span class="p">]</span>

        <span class="c1"># pre-move hooks</span>
        <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pre-move-hooks&#39;</span><span class="p">,</span> <span class="p">()):</span>
            <span class="n">hook</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">step</span><span class="p">[</span><span class="s1">&#39;extrainfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hook</span><span class="o">.</span><span class="n">getStepExtraInfo</span><span class="p">())</span>
            <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Move</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[START] motion&quot;</span><span class="p">)</span>
        <span class="n">move_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">state</span><span class="p">,</span> <span class="n">positions</span> <span class="o">=</span> <span class="n">motion</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sum_motion_time</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">move_start_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">[</span><span class="s1">&#39;motiontime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_motion_time</span>
        <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump_information</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">motion</span><span class="o">.</span><span class="n">moveable_list</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[ END ] motion&quot;</span><span class="p">)</span>

        <span class="n">curr_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">curr_time</span> <span class="o">-</span> <span class="n">startts</span>

        <span class="c1"># post-move hooks</span>
        <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;post-move-hooks&#39;</span><span class="p">,</span> <span class="p">()):</span>
            <span class="n">hook</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">step</span><span class="p">[</span><span class="s1">&#39;extrainfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hook</span><span class="o">.</span><span class="n">getStepExtraInfo</span><span class="p">())</span>
            <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># allow scan to be stopped between motion and data acquisition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">checkPoint</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">state</span> <span class="o">!=</span> <span class="n">Ready</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump_information</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">motion</span><span class="o">.</span><span class="n">moveable_list</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="s2">&quot;Scan aborted after problematic motion: &quot;</span> \
                <span class="s2">&quot;Motion ended with </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ScanException</span><span class="p">({</span><span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="n">m</span><span class="p">})</span>

        <span class="c1"># pre-acq hooks</span>
        <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pre-acq-hooks&#39;</span><span class="p">,</span> <span class="p">()):</span>
            <span class="n">hook</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">step</span><span class="p">[</span><span class="s1">&#39;extrainfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hook</span><span class="o">.</span><span class="n">getStepExtraInfo</span><span class="p">())</span>
            <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">integ_time</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;integ_time&#39;</span><span class="p">]</span>
        <span class="c1"># Acquire data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[START] acquisition&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deterministic_scan</span><span class="p">:</span>
                <span class="n">state</span><span class="p">,</span> <span class="n">data_line</span> <span class="o">=</span> <span class="n">mg</span><span class="o">.</span><span class="n">count_raw</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">state</span><span class="p">,</span> <span class="n">data_line</span> <span class="o">=</span> <span class="n">mg</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">integ_time</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">mg</span><span class="o">.</span><span class="n">ElementList</span>
            <span class="n">elements</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getObj</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump_information</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">elements</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">for</span> <span class="n">ec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_columns</span><span class="p">:</span>
            <span class="n">data_line</span><span class="p">[</span><span class="n">ec</span><span class="o">.</span><span class="n">getName</span><span class="p">()]</span> <span class="o">=</span> <span class="n">ec</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[ END ] acquisition&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sum_acq_time</span> <span class="o">+=</span> <span class="n">integ_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">[</span><span class="s1">&#39;acqtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_acq_time</span>

        <span class="c1"># post-acq hooks</span>
        <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;post-acq-hooks&#39;</span><span class="p">,</span> <span class="p">()):</span>
            <span class="n">hook</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">step</span><span class="p">[</span><span class="s1">&#39;extrainfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hook</span><span class="o">.</span><span class="n">getStepExtraInfo</span><span class="p">())</span>
            <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Add final moveable positions</span>
        <span class="n">data_line</span><span class="p">[</span><span class="s1">&#39;point_nb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
        <span class="n">data_line</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moveables</span><span class="p">):</span>
            <span class="n">data_line</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">moveable</span><span class="o">.</span><span class="n">getName</span><span class="p">()]</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Add extra data coming in the step[&#39;extrainfo&#39;] dictionary</span>
        <span class="k">if</span> <span class="s1">&#39;extrainfo&#39;</span> <span class="ow">in</span> <span class="n">step</span><span class="p">:</span>
            <span class="n">data_line</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;extrainfo&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">addRecord</span><span class="p">(</span><span class="n">data_line</span><span class="p">)</span>

        <span class="c1"># post-step hooks</span>
        <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;post-step-hooks&#39;</span><span class="p">,</span> <span class="p">()):</span>
            <span class="n">hook</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">step</span><span class="p">[</span><span class="s1">&#39;extrainfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hook</span><span class="o">.</span><span class="n">getStepExtraInfo</span><span class="p">())</span>
            <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">dump_information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">elements</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Report: Stopped at step #&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; with:&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">information</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span></div>


<div class="viewcode-block" id="CScan"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/scan.html#sardana.macroserver.scan.CScan">[docs]</a><span class="k">class</span> <span class="nc">CScan</span><span class="p">(</span><span class="n">GScan</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Continuous scan abstract class. Implements helper methods.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">macro</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">moveables</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">env</span><span class="o">=</span><span class="p">{},</span> <span class="n">constraints</span><span class="o">=</span><span class="p">[],</span> <span class="n">extrainfodesc</span><span class="o">=</span><span class="p">[]):</span>
        <span class="n">GScan</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">macro</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span>
                       <span class="n">moveables</span><span class="o">=</span><span class="n">moveables</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
                       <span class="n">extrainfodesc</span><span class="o">=</span><span class="n">extrainfodesc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_waypoint_finished</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_waypoints_finished</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motion_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motion_end_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="n">data_structures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">populate_moveables_data_structures</span><span class="p">(</span><span class="n">moveables</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_moveables_trees</span><span class="p">,</span> \
            <span class="n">physical_moveables_names</span><span class="p">,</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_physical_moveables</span> <span class="o">=</span> <span class="n">data_structures</span>
        <span class="c1"># The physical motion object contains only physical motors - no pseudo</span>
        <span class="c1"># motors (in case the pseudomotors are involved in the scan,</span>
        <span class="c1"># it comprarises the underneath physical motors)</span>
        <span class="c1"># This is due to the fact that the CTScan coordinates the</span>
        <span class="c1"># pseudomotors&#39; underneeth physical motors on on their constant</span>
        <span class="c1"># velocity in contrary to the the CScan which do not coordinate them</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">physical_moveables_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_physical_motion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getMotion</span><span class="p">(</span>
                <span class="n">physical_moveables_names</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_physical_motion</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="CScan.populate_moveables_data_structures"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/scan.html#sardana.macroserver.scan.CScan.populate_moveables_data_structures">[docs]</a>    <span class="k">def</span> <span class="nf">populate_moveables_data_structures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moveables</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populates moveables data structures.</span>
<span class="sd">        :param moveables: (list&lt;Moveable&gt;) data structures will be generated</span>
<span class="sd">        for these moveables</span>
<span class="sd">        :return (moveable_trees, physical_moveables_names, physical_moveables)</span>

<span class="sd">        - moveable_trees (list&lt;Tree&gt;) - each tree represent one Moveable</span>
<span class="sd">          with its hierarchy of inferior moveables.</span>
<span class="sd">        - physical_moveables_names (list&lt;str&gt; - list of the names of</span>
<span class="sd">          the physical moveables. List order is important and preserved.</span>
<span class="sd">        - physical_moveables (list&lt;Moveable&gt; - list of the moveable</span>
<span class="sd">          objects. List order is important and preserved.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">generate_moveable_node</span><span class="p">(</span><span class="n">macro</span><span class="p">,</span> <span class="n">moveable</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Function to generate a moveable data structures based on</span>
<span class="sd">            moveable object. Internally can be recursively called if</span>
<span class="sd">            moveable is a PseudoMotor.</span>
<span class="sd">            :param moveable: moveable object</span>
<span class="sd">            :return (moveable_node, physical_moveables_names,</span>
<span class="sd">                    physical_moveables)</span>
<span class="sd">                - moveable_node (BaseNode) - can be a BranchNode if moveable</span>
<span class="sd">                      is a PseudoMotor or a LeafNode if moveable is a</span>
<span class="sd">                      PhysicalMotor.</span>
<span class="sd">                - physical_moveables_names (list&lt;str&gt; - list of the names of</span>
<span class="sd">                      the physical moveables. List order is important and</span>
<span class="sd">                      preserved.</span>
<span class="sd">                - physical_moveables (list&lt;Moveable&gt; - list of the moveable</span>
<span class="sd">                      objects. List order is important and preserved.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">moveable_node</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">physical_moveables_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">physical_moveables</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">moveable_type</span> <span class="o">=</span> <span class="n">moveable</span><span class="o">.</span><span class="n">getType</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">moveable_type</span> <span class="o">==</span> <span class="s2">&quot;PseudoMotor&quot;</span><span class="p">:</span>
                <span class="n">moveable_node</span> <span class="o">=</span> <span class="n">BranchNode</span><span class="p">(</span><span class="n">moveable</span><span class="p">)</span>
                <span class="n">moveables_names</span> <span class="o">=</span> <span class="n">moveable</span><span class="o">.</span><span class="n">elements</span>
                <span class="n">sub_moveables</span> <span class="o">=</span> <span class="p">[</span><span class="n">macro</span><span class="o">.</span><span class="n">getMoveable</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">moveables_names</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">sub_moveable</span> <span class="ow">in</span> <span class="n">sub_moveables</span><span class="p">:</span>
                    <span class="n">sub_moveable_node</span><span class="p">,</span> \
                        <span class="n">_physical_moveables_names</span><span class="p">,</span> \
                        <span class="n">_physical_moveables</span> <span class="o">=</span> \
                        <span class="n">generate_moveable_node</span><span class="p">(</span><span class="n">macro</span><span class="p">,</span> <span class="n">sub_moveable</span><span class="p">)</span>
                    <span class="n">physical_moveables_names</span> <span class="o">+=</span> <span class="n">_physical_moveables_names</span>
                    <span class="n">physical_moveables</span> <span class="o">+=</span> <span class="n">_physical_moveables</span>
                    <span class="n">moveable_node</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="n">sub_moveable_node</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">moveable_type</span> <span class="o">==</span> <span class="s2">&quot;Motor&quot;</span><span class="p">:</span>
                <span class="n">moveable_node</span> <span class="o">=</span> <span class="n">LeafNode</span><span class="p">(</span><span class="n">moveable</span><span class="p">)</span>
                <span class="n">moveable_name</span> <span class="o">=</span> <span class="n">moveable</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
                <span class="n">physical_moveables_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">moveable_name</span><span class="p">)</span>
                <span class="n">physical_moveables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">moveable</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">moveable_node</span><span class="p">,</span> <span class="n">physical_moveables_names</span><span class="p">,</span> <span class="n">physical_moveables</span>

        <span class="n">moveable_trees</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">physical_moveables_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">physical_moveables</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">moveable</span> <span class="ow">in</span> <span class="n">moveables</span><span class="p">:</span>
            <span class="n">moveable_root_node</span><span class="p">,</span> <span class="n">_physical_moveables_names</span><span class="p">,</span> \
                <span class="n">_physical_moveables</span> <span class="o">=</span> <span class="n">generate_moveable_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">,</span>
                                                             <span class="n">moveable</span><span class="o">.</span><span class="n">moveable</span><span class="p">)</span>
            <span class="n">moveable_tree</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">(</span><span class="n">moveable_root_node</span><span class="p">)</span>
            <span class="n">moveable_trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">moveable_tree</span><span class="p">)</span>
            <span class="n">physical_moveables_names</span> <span class="o">+=</span> <span class="n">_physical_moveables_names</span>
            <span class="n">physical_moveables</span> <span class="o">+=</span> <span class="n">_physical_moveables</span>
        <span class="k">return</span> <span class="n">moveable_trees</span><span class="p">,</span> <span class="n">physical_moveables_names</span><span class="p">,</span> <span class="n">physical_moveables</span></div>

<div class="viewcode-block" id="CScan.get_moveables_trees"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/scan.html#sardana.macroserver.scan.CScan.get_moveables_trees">[docs]</a>    <span class="k">def</span> <span class="nf">get_moveables_trees</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns reference to the list of the moveables trees&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moveables_trees</span></div>

<div class="viewcode-block" id="CScan.on_waypoints_end"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/scan.html#sardana.macroserver.scan.CScan.on_waypoints_end">[docs]</a>    <span class="k">def</span> <span class="nf">on_waypoints_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restore_positions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;To be called by the waypoint thread to handle the end of waypoints</span>
<span class="sd">        (either because no more waypoints or because a macro abort was</span>
<span class="sd">        triggered)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_all_waypoints_finished</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">restore_positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setFastMotions</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Correcting overshoot...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">motion</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">restore_positions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motion_end_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motion_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>

<div class="viewcode-block" id="CScan.go_through_waypoints"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/scan.html#sardana.macroserver.scan.CScan.go_through_waypoints">[docs]</a>    <span class="k">def</span> <span class="nf">go_through_waypoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterate_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Go through the different waypoints.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_go_through_waypoints</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_waypoints_end</span><span class="p">()</span>
            <span class="k">raise</span></div>

    <span class="k">def</span> <span class="nf">_go_through_waypoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal, unprotected method to go through the different waypoints.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;_go_through_waypoints must be implemented&quot;</span>
                                  <span class="s2">&quot; in CScan derived classes&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="CScan.waypoint_estimation"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/scan.html#sardana.macroserver.scan.CScan.waypoint_estimation">[docs]</a>    <span class="k">def</span> <span class="nf">waypoint_estimation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal, unprotected method to go through the different waypoints.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">motion</span><span class="p">,</span> <span class="n">waypoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">motion</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">()</span>
        <span class="n">total_duration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># v_motors = self.get_virtual_motors()</span>
        <span class="n">curr_positions</span><span class="p">,</span> <span class="n">last_end_positions</span> <span class="o">=</span> <span class="n">motion</span><span class="o">.</span><span class="n">readPosition</span><span class="p">(</span>
            <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">waypoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">waypoints</span><span class="p">):</span>
            <span class="n">start_positions</span> <span class="o">=</span> <span class="n">waypoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;start_positions&#39;</span><span class="p">,</span> <span class="n">last_end_positions</span><span class="p">)</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="n">waypoint</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">start_positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">last_end_positions</span> <span class="o">=</span> <span class="n">positions</span>
                <span class="k">continue</span>

            <span class="n">waypoint_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_waypoint</span><span class="p">(</span><span class="n">waypoint</span><span class="p">,</span> <span class="n">start_positions</span><span class="p">,</span>
                                                  <span class="n">iterate_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">motion_paths</span><span class="p">,</span> <span class="n">delta_start</span><span class="p">,</span> <span class="n">acq_duration</span> <span class="o">=</span> <span class="n">waypoint_info</span>

            <span class="n">start_path</span><span class="p">,</span> <span class="n">end_path</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">motion_paths</span><span class="p">:</span>
                <span class="n">start_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">initial_user_pos</span><span class="p">)</span>
                <span class="n">end_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">final_user_pos</span><span class="p">)</span>

            <span class="c1"># move from last waypoint to start position of this waypoint</span>
            <span class="n">first_duration</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># first waypoint means, moving from current position to the</span>
                <span class="c1"># start of first waypoint</span>
                <span class="n">initial</span> <span class="o">=</span> <span class="n">curr_positions</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">initial</span> <span class="o">=</span> <span class="n">start_positions</span>
            <span class="k">for</span> <span class="n">_path</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">motion_paths</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">start_path</span><span class="p">):</span>
                <span class="n">v_motor</span> <span class="o">=</span> <span class="n">_path</span><span class="o">.</span><span class="n">motor</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">MotionPath</span><span class="p">(</span><span class="n">v_motor</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
                <span class="n">first_duration</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">first_duration</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>

            <span class="c1"># move from waypoint start position to waypoint end position</span>
            <span class="n">second_duration</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_path</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">motion_paths</span><span class="p">,</span> <span class="n">start_path</span><span class="p">,</span> <span class="n">end_path</span><span class="p">):</span>
                <span class="n">v_motor</span> <span class="o">=</span> <span class="n">_path</span><span class="o">.</span><span class="n">motor</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">MotionPath</span><span class="p">(</span><span class="n">v_motor</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
                <span class="n">second_duration</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">second_duration</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>

            <span class="n">total_duration</span> <span class="o">+=</span> <span class="n">first_duration</span> <span class="o">+</span> <span class="n">second_duration</span>

            <span class="n">last_end_positions</span> <span class="o">=</span> <span class="n">end_path</span>

        <span class="c1"># add correct overshoot time</span>
        <span class="n">overshoot_duration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_path</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">motion_paths</span><span class="p">,</span> <span class="n">last_end_positions</span><span class="p">,</span>
                                     <span class="n">positions</span><span class="p">):</span>
            <span class="n">v_motor</span> <span class="o">=</span> <span class="n">_path</span><span class="o">.</span><span class="n">motor</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">MotionPath</span><span class="p">(</span><span class="n">v_motor</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="n">overshoot_duration</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">overshoot_duration</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>

        <span class="n">total_duration</span> <span class="o">+=</span> <span class="n">overshoot_duration</span>
        <span class="k">return</span> <span class="n">total_duration</span></div>

    <span class="k">def</span> <span class="nf">prepare_waypoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">waypoint</span><span class="p">,</span> <span class="n">start_positions</span><span class="p">,</span> <span class="n">iterate_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;prepare_waypoint must be implemented in &quot;</span> <span class="o">+</span>
                                  <span class="s2">&quot;CScan derived classes&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_all_waypoints_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_waypoints_finished</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">_backup_motor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Backup motors initial state (velocity, acceleration and</span>
<span class="sd">        deceleration).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span> <span class="o">=</span> <span class="n">backup</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">moveable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_physical_moveables</span><span class="p">:</span>
            <span class="c1"># first backup all motor parameters</span>
            <span class="n">motor</span> <span class="o">=</span> <span class="n">moveable</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">velocity</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getVelocity</span><span class="p">()</span>
                <span class="n">accel_time</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getAcceleration</span><span class="p">()</span>
                <span class="n">decel_time</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getDeceleration</span><span class="p">()</span>
                <span class="n">motor_backup</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">moveable</span><span class="o">=</span><span class="n">moveable</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">velocity</span><span class="p">,</span>
                                    <span class="n">acceleration</span><span class="o">=</span><span class="n">accel_time</span><span class="p">,</span>
                                    <span class="n">deceleration</span><span class="o">=</span><span class="n">decel_time</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Backup of </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">motor</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">motor_backup</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">backup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">motor_backup</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CScan</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">do_backup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backup_motor</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_restore_motors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restore changed motors to initial state (velocity, acceleration and</span>
<span class="sd">        deceleration).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">motor_backup</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">motor_backup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">motor</span> <span class="o">=</span> <span class="n">motor_backup</span><span class="p">[</span><span class="s1">&#39;moveable&#39;</span><span class="p">]</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">velocity</span><span class="o">=</span><span class="n">motor_backup</span><span class="p">[</span><span class="s2">&quot;velocity&quot;</span><span class="p">],</span>
                                     <span class="n">acceleration</span><span class="o">=</span><span class="n">motor_backup</span><span class="p">[</span><span class="s2">&quot;acceleration&quot;</span><span class="p">],</span>
                                     <span class="n">deceleration</span><span class="o">=</span><span class="n">motor_backup</span><span class="p">[</span><span class="s2">&quot;deceleration&quot;</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">configure_motor</span><span class="p">(</span><span class="n">motor</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ScanException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Error when restoring motor&#39;s backup (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">e</span>
                <span class="k">raise</span> <span class="n">ScanException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Restore motor backups (vel, acc, ...) first so the macro&#39;s</span>
        <span class="c1"># do_restore finds the system as before GSF found it.</span>
        <span class="c1"># This is especially important for dscan macros which must return</span>
        <span class="c1"># to inital position at nominal speed even after user stop.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restore_motors</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CScan</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">do_restore</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_setFastMotions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;make given motors go at their max speed and accel&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">motors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">motors</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;moveable&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span> <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">motor</span> <span class="ow">in</span> <span class="n">motors</span><span class="p">:</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">velocity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_max_top_velocity</span><span class="p">(</span><span class="n">motor</span><span class="p">),</span>
                                     <span class="n">acceleration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_min_acc_time</span><span class="p">(</span><span class="n">motor</span><span class="p">),</span>
                                     <span class="n">deceleration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_min_dec_time</span><span class="p">(</span><span class="n">motor</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">configure_motor</span><span class="p">(</span><span class="n">motor</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ScanException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Error when setting fast motion (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">e</span>
                <span class="k">raise</span> <span class="n">ScanException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<div class="viewcode-block" id="CScan.get_max_top_velocity"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/scan.html#sardana.macroserver.scan.CScan.get_max_top_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">get_max_top_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method to find the maximum top velocity for the motor.</span>
<span class="sd">        If the motor doesn&#39;t have a defined range for top velocity,</span>
<span class="sd">        then use the current top velocity&quot;&quot;&quot;</span>

        <span class="n">top_vel_obj</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getVelocityObj</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">max_top_vel</span> <span class="o">=</span> <span class="n">top_vel_obj</span><span class="o">.</span><span class="n">getRange</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">max_top_vel</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_top_vel</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># hack to avoid recursive velocity reduction</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_maxVelDict</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_maxVelDict&#39;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="n">motor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maxVelDict</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_maxVelDict</span><span class="p">[</span><span class="n">motor</span><span class="p">]</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getVelocity</span><span class="p">()</span>
                <span class="n">max_top_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maxVelDict</span><span class="p">[</span><span class="n">motor</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="c1"># Taurus4 reports -inf or inf when no limits are defined (NotSpecified)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">max_top_vel</span><span class="p">):</span>
            <span class="n">max_top_vel</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getVelocity</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">max_top_vel</span></div>

<div class="viewcode-block" id="CScan.get_min_acc_time"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/scan.html#sardana.macroserver.scan.CScan.get_min_acc_time">[docs]</a>    <span class="k">def</span> <span class="nf">get_min_acc_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method to find the minimum acceleration time for the motor.</span>
<span class="sd">        If the motor doesn&#39;t have a defined range for the acceleration time,</span>
<span class="sd">        then use the current acceleration time&quot;&quot;&quot;</span>

        <span class="n">acc_time_obj</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getAccelerationObj</span><span class="p">()</span>
        <span class="n">min_acc_time</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">acc_time_obj</span><span class="o">.</span><span class="n">getRange</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">min_acc_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">min_acc_time</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">min_acc_time</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getAcceleration</span><span class="p">()</span>
        <span class="c1"># Taurus4 reports -inf or inf when no limits are defined (NotSpecified)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">min_acc_time</span><span class="p">):</span>
            <span class="n">min_acc_time</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getAcceleration</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">min_acc_time</span></div>

<div class="viewcode-block" id="CScan.get_min_dec_time"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/scan.html#sardana.macroserver.scan.CScan.get_min_dec_time">[docs]</a>    <span class="k">def</span> <span class="nf">get_min_dec_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method to find the minimum deceleration time for the motor.</span>
<span class="sd">        If the motor doesn&#39;t have a defined range for the acceleration time,</span>
<span class="sd">        then use the current acceleration time&quot;&quot;&quot;</span>

        <span class="n">dec_time_obj</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getDecelerationObj</span><span class="p">()</span>
        <span class="n">min_dec_time</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">dec_time_obj</span><span class="o">.</span><span class="n">getRange</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">min_dec_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">min_dec_time</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">min_dec_time</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getDeceleration</span><span class="p">()</span>
        <span class="c1"># Taurus4 reports -inf or inf when no limits are defined (NotSpecified)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">min_dec_time</span><span class="p">):</span>
            <span class="n">min_dec_time</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getAcceleration</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">min_dec_time</span></div>

<div class="viewcode-block" id="CScan.set_max_top_velocity"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/scan.html#sardana.macroserver.scan.CScan.set_max_top_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">set_max_top_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method to set the maximum top velocity for the motor to</span>
<span class="sd">        its maximum allowed limit.&quot;&quot;&quot;</span>

        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_max_top_velocity</span><span class="p">(</span><span class="n">motor</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">motor</span><span class="o">.</span><span class="n">setVelocity</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="CScan.get_min_pos"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/scan.html#sardana.macroserver.scan.CScan.get_min_pos">[docs]</a>    <span class="k">def</span> <span class="nf">get_min_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Helper method to find the minimum position for a given motor.</span>
<span class="sd">        If the motor doesn&#39;t define its minimum position, then the negative</span>
<span class="sd">        infinite float representation is returned.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">pos_obj</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getPositionObj</span><span class="p">()</span>
        <span class="n">min_pos</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pos_obj</span><span class="o">.</span><span class="n">getRange</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Taurus 4 uses quantities however Sardana does not support them</span>
            <span class="c1"># yet - use magnitude for the moment.</span>
            <span class="n">min_pos</span> <span class="o">=</span> <span class="n">min_pos</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">min_pos</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">min_pos</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">min_pos</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-Inf&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">min_pos</span></div>

<div class="viewcode-block" id="CScan.get_max_pos"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/scan.html#sardana.macroserver.scan.CScan.get_max_pos">[docs]</a>    <span class="k">def</span> <span class="nf">get_max_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Helper method to find the maximum position for a given motor.</span>
<span class="sd">        If the motor doesn&#39;t define its maximum position, then the positive</span>
<span class="sd">        infinite float representation is returned.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">pos_obj</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getPositionObj</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">max_pos</span> <span class="o">=</span> <span class="n">pos_obj</span><span class="o">.</span><span class="n">getRange</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Taurus 4 uses quantities however Sardana does not support them</span>
            <span class="c1"># yet - use magnitude for the moment.</span>
            <span class="n">max_pos</span> <span class="o">=</span> <span class="n">max_pos</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">max_pos</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_pos</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">max_pos</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;Inf&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">max_pos</span></div>

<div class="viewcode-block" id="CScan.configure_motor"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/scan.html#sardana.macroserver.scan.CScan.configure_motor">[docs]</a>    <span class="k">def</span> <span class="nf">configure_motor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="n">attributes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Configure motor with a given attribute values.</span>

<span class="sd">        :param motor: (Motor or Moveable) motor to be configured</span>
<span class="sd">        :param attributes: (OrderedDict) dictionary with attribute names (keys)</span>
<span class="sd">            and attribute values (values)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">motor</span><span class="o">.</span><span class="n">_getAttrEG</span><span class="p">(</span><span class="n">param</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Error when setting </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                 <span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">motor</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;setting </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%r</span><span class="s2"> failed&quot;</span> <span class="o">%</span>\
                    <span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">motor</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">ScanException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">CSScan</span><span class="p">(</span><span class="n">CScan</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Continuous scan controlled by software&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">macro</span><span class="p">,</span> <span class="n">waypointGenerator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">periodGenerator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">moveables</span><span class="o">=</span><span class="p">[],</span> <span class="n">env</span><span class="o">=</span><span class="p">{},</span> <span class="n">constraints</span><span class="o">=</span><span class="p">[],</span> <span class="n">extrainfodesc</span><span class="o">=</span><span class="p">[]):</span>
        <span class="n">CScan</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">macro</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">waypointGenerator</span><span class="p">,</span>
                       <span class="n">moveables</span><span class="o">=</span><span class="n">moveables</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
                       <span class="n">extrainfodesc</span><span class="o">=</span><span class="n">extrainfodesc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_periodGenerator</span> <span class="o">=</span> <span class="n">periodGenerator</span>

    <span class="k">def</span> <span class="nf">_calculateTotalAcquisitionTime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">period_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_periodGenerator</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">period_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_period_steps&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_period_steps</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">period_generator</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_period_steps</span>

    <span class="k">def</span> <span class="nf">prepare_waypoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">waypoint</span><span class="p">,</span> <span class="n">start_positions</span><span class="p">,</span> <span class="n">iterate_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">slow_down</span> <span class="o">=</span> <span class="n">waypoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slow_down&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">waypoint</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">]</span>

        <span class="n">duration</span><span class="p">,</span> <span class="n">cruise_duration</span><span class="p">,</span> <span class="n">delta_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">ideal_paths</span><span class="p">,</span> <span class="n">real_paths</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">moveable</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moveables</span><span class="p">,</span>
                                                     <span class="n">positions</span><span class="p">)):</span>
            <span class="n">motor</span> <span class="o">=</span> <span class="n">moveable</span><span class="o">.</span><span class="n">moveable</span>

            <span class="n">coordinate</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">base_vel</span><span class="p">,</span> <span class="n">top_vel</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getBaseRate</span><span class="p">(),</span> <span class="n">motor</span><span class="o">.</span><span class="n">getVelocity</span><span class="p">()</span>
                <span class="n">accel_time</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getAcceleration</span><span class="p">()</span>
                <span class="n">decel_time</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getDeceleration</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">slow_down</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># find and set the maximum top velocity for the motor.</span>
                    <span class="c1"># If the motor doesn&#39;t have a defined range for top</span>
                    <span class="c1"># velocity, then use the current top velocity</span>
                    <span class="n">max_top_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_max_top_velocity</span><span class="p">(</span><span class="n">motor</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">iterate_only</span><span class="p">:</span>
                        <span class="n">motor</span><span class="o">.</span><span class="n">setVelocity</span><span class="p">(</span><span class="n">max_top_vel</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">max_top_vel</span> <span class="o">=</span> <span class="n">top_vel</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">iterate_only</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> motion will not be coordinated&quot;</span><span class="p">,</span> <span class="n">motor</span><span class="p">)</span>
                <span class="n">base_vel</span><span class="p">,</span> <span class="n">top_vel</span><span class="p">,</span> <span class="n">max_top_vel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="s1">&#39;+inf&#39;</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;+inf&#39;</span><span class="p">)</span>
                <span class="n">accel_time</span><span class="p">,</span> <span class="n">decel_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
                <span class="n">coordinate</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">last_user_pos</span> <span class="o">=</span> <span class="n">start_positions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="n">real_vmotor</span> <span class="o">=</span> <span class="n">VMotor</span><span class="p">(</span><span class="n">min_vel</span><span class="o">=</span><span class="n">base_vel</span><span class="p">,</span> <span class="n">max_vel</span><span class="o">=</span><span class="n">max_top_vel</span><span class="p">,</span>
                                 <span class="n">accel_time</span><span class="o">=</span><span class="n">accel_time</span><span class="p">,</span>
                                 <span class="n">decel_time</span><span class="o">=</span><span class="n">decel_time</span><span class="p">)</span>
            <span class="n">real_path</span> <span class="o">=</span> <span class="n">MotionPath</span><span class="p">(</span><span class="n">real_vmotor</span><span class="p">,</span> <span class="n">last_user_pos</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
            <span class="n">real_path</span><span class="o">.</span><span class="n">moveable</span> <span class="o">=</span> <span class="n">moveable</span>
            <span class="n">real_path</span><span class="o">.</span><span class="n">apply_correction</span> <span class="o">=</span> <span class="n">coordinate</span>

            <span class="c1"># Find the cruise duration of motion at top velocity. For this</span>
            <span class="c1"># create a virtual motor which has instantaneous acceleration and</span>
            <span class="c1"># deceleration</span>
            <span class="n">ideal_vmotor</span> <span class="o">=</span> <span class="n">VMotor</span><span class="p">(</span><span class="n">min_vel</span><span class="o">=</span><span class="n">base_vel</span><span class="p">,</span> <span class="n">max_vel</span><span class="o">=</span><span class="n">max_top_vel</span><span class="p">,</span>
                                  <span class="n">accel_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">decel_time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># create a path which will tell us which is the cruise</span>
            <span class="c1"># duration of this motion at top velocity</span>
            <span class="n">ideal_path</span> <span class="o">=</span> <span class="n">MotionPath</span><span class="p">(</span><span class="n">ideal_vmotor</span><span class="p">,</span> <span class="n">last_user_pos</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
            <span class="n">ideal_path</span><span class="o">.</span><span class="n">moveable</span> <span class="o">=</span> <span class="n">moveable</span>
            <span class="n">ideal_path</span><span class="o">.</span><span class="n">apply_correction</span> <span class="o">=</span> <span class="n">coordinate</span>

            <span class="c1"># if really motor is moving in this waypoint</span>
            <span class="k">if</span> <span class="n">ideal_path</span><span class="o">.</span><span class="n">displacement</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># recalculate time to reach maximum velocity</span>
                <span class="n">delta_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">delta_start</span><span class="p">,</span> <span class="n">accel_time</span><span class="p">)</span>

            <span class="c1"># recalculate cruise duration of motion at top velocity</span>
            <span class="n">cruise_duration</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cruise_duration</span><span class="p">,</span> <span class="n">ideal_path</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="n">real_path</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>

            <span class="n">ideal_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ideal_path</span><span class="p">)</span>
            <span class="n">real_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">real_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">slow_down</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">real_paths</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">duration</span>

        <span class="c1"># after finding the duration, introduce the slow down factor added</span>
        <span class="c1"># by the user</span>
        <span class="n">cruise_duration</span> <span class="o">/=</span> <span class="n">slow_down</span>

        <span class="k">if</span> <span class="n">cruise_duration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cruise_duration</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;+inf&#39;</span><span class="p">)</span>

        <span class="c1"># now that we have the appropriate top velocity for all motors, the</span>
        <span class="c1"># cruise duration of motion at top velocity, and the time it takes to</span>
        <span class="c1"># recalculate</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">ideal_paths</span><span class="p">:</span>
            <span class="n">vmotor</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">motor</span>
            <span class="c1"># in the case of pseudo motors or not moving a motor...</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">apply_correction</span> <span class="ow">or</span> <span class="n">path</span><span class="o">.</span><span class="n">displacement</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">moveable</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">moveable</span>
            <span class="n">motor</span> <span class="o">=</span> <span class="n">moveable</span><span class="o">.</span><span class="n">moveable</span>
            <span class="n">new_top_vel</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">displacement</span> <span class="o">/</span> <span class="n">cruise_duration</span>
            <span class="n">vmotor</span><span class="o">.</span><span class="n">setMaxVelocity</span><span class="p">(</span><span class="n">new_top_vel</span><span class="p">)</span>
            <span class="n">accel_t</span><span class="p">,</span> <span class="n">decel_t</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getAcceleration</span><span class="p">(),</span> <span class="n">motor</span><span class="o">.</span><span class="n">getDeceleration</span><span class="p">()</span>
            <span class="n">base_vel</span> <span class="o">=</span> <span class="n">vmotor</span><span class="o">.</span><span class="n">getMinVelocity</span><span class="p">()</span>
            <span class="n">vmotor</span><span class="o">.</span><span class="n">setAccelerationTime</span><span class="p">(</span><span class="n">accel_t</span><span class="p">)</span>
            <span class="n">vmotor</span><span class="o">.</span><span class="n">setDecelerationTime</span><span class="p">(</span><span class="n">decel_t</span><span class="p">)</span>
            <span class="n">disp_sign</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">positive_displacement</span> <span class="ow">and</span> <span class="mi">1</span> <span class="ow">or</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">new_initial_pos</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">initial_user_pos</span> <span class="o">-</span> <span class="n">accel_t</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> \
                <span class="n">disp_sign</span> <span class="o">*</span> <span class="p">(</span><span class="n">new_top_vel</span> <span class="o">+</span> <span class="n">base_vel</span><span class="p">)</span> <span class="o">-</span> <span class="n">disp_sign</span> <span class="o">*</span> \
                <span class="n">new_top_vel</span> <span class="o">*</span> <span class="p">(</span><span class="n">delta_start</span> <span class="o">-</span> <span class="n">accel_t</span><span class="p">)</span>
            <span class="n">path</span><span class="o">.</span><span class="n">setInitialUserPos</span><span class="p">(</span><span class="n">new_initial_pos</span><span class="p">)</span>
            <span class="n">new_final_pos</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">final_user_pos</span> <span class="o">+</span> \
                <span class="n">disp_sign</span> <span class="o">*</span> <span class="n">vmotor</span><span class="o">.</span><span class="n">displacement_reach_min_vel</span>
            <span class="n">path</span><span class="o">.</span><span class="n">setFinalUserPos</span><span class="p">(</span><span class="n">new_final_pos</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ideal_paths</span><span class="p">,</span> <span class="n">delta_start</span><span class="p">,</span> <span class="n">cruise_duration</span>

    <span class="k">def</span> <span class="nf">go_through_waypoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterate_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;go through the different waypoints.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_go_through_waypoints</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;An error occurred moving to waypoints&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Details: &#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_waypoints_end</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">ScanException</span><span class="p">(</span><span class="s1">&#39;error while moving to waypoints&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_go_through_waypoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal, unprotected method to go through the different waypoints.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">macro</span><span class="p">,</span> <span class="n">motion</span><span class="p">,</span> <span class="n">waypoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">motion</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;_go_through_waypoints() entering...&quot;</span><span class="p">)</span>

        <span class="n">last_positions</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">waypoint</span> <span class="ow">in</span> <span class="n">waypoints</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waypoint iteration...&quot;</span><span class="p">)</span>
            <span class="n">start_positions</span> <span class="o">=</span> <span class="n">waypoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start_positions&#39;</span><span class="p">)</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="n">waypoint</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">start_positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">start_positions</span> <span class="o">=</span> <span class="n">last_positions</span>
            <span class="k">if</span> <span class="n">start_positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">last_positions</span> <span class="o">=</span> <span class="n">positions</span>
                <span class="k">continue</span>

            <span class="n">waypoint_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_waypoint</span><span class="p">(</span><span class="n">waypoint</span><span class="p">,</span> <span class="n">start_positions</span><span class="p">)</span>
            <span class="n">motion_paths</span><span class="p">,</span> <span class="n">delta_start</span><span class="p">,</span> <span class="n">acq_duration</span> <span class="o">=</span> <span class="n">waypoint_info</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">acq_duration</span> <span class="o">=</span> <span class="n">acq_duration</span>

            <span class="c1"># execute pre-move hooks</span>
            <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">waypoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pre-move-hooks&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">hook</span><span class="p">()</span>

            <span class="n">start_pos</span><span class="p">,</span> <span class="n">final_pos</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">motion_paths</span><span class="p">:</span>
                <span class="n">start_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">initial_user_pos</span><span class="p">)</span>
                <span class="n">final_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">final_user_pos</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">macro</span><span class="o">.</span><span class="n">isStopped</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_waypoints_end</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="c1"># move to start position</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Moving to start position: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">start_pos</span><span class="p">))</span>
            <span class="n">motion</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">start_pos</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">macro</span><span class="o">.</span><span class="n">isStopped</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_waypoints_end</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="c1"># prepare motor(s) with the velocity required for synchronization</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">motion_paths</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">apply_correction</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">vmotor</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">motor</span>
                <span class="n">motor</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">moveable</span><span class="o">.</span><span class="n">moveable</span>
                <span class="n">motor</span><span class="o">.</span><span class="n">setVelocity</span><span class="p">(</span><span class="n">vmotor</span><span class="o">.</span><span class="n">getMaxVelocity</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">macro</span><span class="o">.</span><span class="n">isStopped</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_waypoints_end</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">timestamp_to_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">delta_start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">motion_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

            <span class="c1"># move to waypoint end position</span>
            <span class="n">motion</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">final_pos</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">motion_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">macro</span><span class="o">.</span><span class="n">isStopped</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_waypoints_end</span><span class="p">()</span>

            <span class="c1"># execute post-move hooks</span>
            <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">waypoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;post-move-hooks&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">hook</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">start_positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">last_positions</span> <span class="o">=</span> <span class="n">positions</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">on_waypoints_end</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">scan_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">motion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">motion</span>
        <span class="n">mg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement_group</span>
        <span class="c1"># waypoints = self.steps</span>
        <span class="n">macro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">getManager</span><span class="p">()</span>
        <span class="n">scream</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">motion_event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">motion_event</span>
        <span class="n">startts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">[</span><span class="s1">&#39;startts&#39;</span><span class="p">]</span>

        <span class="n">sum_delay</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sum_integ_time</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">macro</span><span class="p">,</span> <span class="s2">&quot;nb_points&quot;</span><span class="p">):</span>
            <span class="n">nb_points</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">macro</span><span class="o">.</span><span class="n">nb_points</span><span class="p">)</span>
            <span class="n">scream</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="mf">0.0</span>

        <span class="c1"># moveables = [m.moveable for m in self.moveables]</span>
        <span class="n">period_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">period_steps</span>
        <span class="n">point_nb</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span>
        <span class="c1"># data = self.data</span>

        <span class="c1"># start move &amp; acquisition as close as possible</span>
        <span class="c1"># from this point on synchronization becomes critical</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">go_through_waypoints</span><span class="p">)</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_waypoints_finished</span><span class="p">:</span>

            <span class="c1"># wait for motor to reach start position</span>
            <span class="n">motion_event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

            <span class="c1"># allow scan to stop</span>
            <span class="n">macro</span><span class="o">.</span><span class="n">checkPoint</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_waypoints_finished</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># wait for motor to reach max velocity</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">deltat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp_to_start</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="k">if</span> <span class="n">deltat</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">deltat</span><span class="p">)</span>
            <span class="n">curr_time</span> <span class="o">=</span> <span class="n">acq_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">integ_time</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Acquisition loop: acquire consecutively until waypoint asks to</span>
            <span class="c1"># stop or we see that we will enter deceleration time in next</span>
            <span class="c1"># acquisition</span>
            <span class="k">while</span> <span class="n">motion_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>

                <span class="c1"># allow scan to stop</span>
                <span class="n">macro</span><span class="o">.</span><span class="n">checkPoint</span><span class="p">()</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">point_nb</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">period_steps</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_all_waypoints_finished</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

                <span class="n">integ_time</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;integ_time&#39;</span><span class="p">]</span>

                <span class="c1"># If there is no more time to acquire... stop!</span>
                <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">acq_start_time</span>
                <span class="k">if</span> <span class="n">elapsed_time</span> <span class="o">+</span> <span class="n">integ_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">acq_duration</span><span class="p">:</span>
                    <span class="n">motion_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="k">break</span>

                <span class="c1"># pre-acq hooks</span>
                <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pre-acq-hooks&#39;</span><span class="p">,</span> <span class="p">()):</span>
                    <span class="n">hook</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">step</span><span class="p">[</span><span class="s1">&#39;extrainfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hook</span><span class="o">.</span><span class="n">getStepExtraInfo</span><span class="p">())</span>
                    <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_all_waypoints_finished</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">raise</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>

                <span class="c1"># allow scan to stop</span>
                <span class="n">macro</span><span class="o">.</span><span class="n">checkPoint</span><span class="p">()</span>

                <span class="n">positions</span> <span class="o">=</span> <span class="n">motion</span><span class="o">.</span><span class="n">readPosition</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">dt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">startts</span>

                <span class="c1"># Acquire data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[START] acquisition&quot;</span><span class="p">)</span>
                <span class="n">state</span><span class="p">,</span> <span class="n">data_line</span> <span class="o">=</span> <span class="n">mg</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">integ_time</span><span class="p">)</span>

                <span class="n">sum_integ_time</span> <span class="o">+=</span> <span class="n">integ_time</span>

                <span class="c1"># allow scan to stop</span>
                <span class="n">macro</span><span class="o">.</span><span class="n">checkPoint</span><span class="p">()</span>

                <span class="c1"># After acquisition, test if we are asked to stop, probably</span>
                <span class="c1"># because the motor are stopped. In this case discard the last</span>
                <span class="c1"># acquisition</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_waypoints_finished</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_columns</span><span class="p">:</span>
                        <span class="n">data_line</span><span class="p">[</span><span class="n">ec</span><span class="o">.</span><span class="n">getName</span><span class="p">()]</span> <span class="o">=</span> <span class="n">ec</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[ END ] acquisition&quot;</span><span class="p">)</span>

                    <span class="c1"># post-acq hooks</span>
                    <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;post-acq-hooks&#39;</span><span class="p">,</span> <span class="p">()):</span>
                        <span class="n">hook</span><span class="p">()</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">step</span><span class="p">[</span><span class="s1">&#39;extrainfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hook</span><span class="o">.</span><span class="n">getStepExtraInfo</span><span class="p">())</span>
                        <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_all_waypoints_finished</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">raise</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>

                    <span class="c1"># Add final moveable positions</span>
                    <span class="n">data_line</span><span class="p">[</span><span class="s1">&#39;point_nb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">point_nb</span>
                    <span class="n">data_line</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moveables</span><span class="p">):</span>
                        <span class="n">data_line</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">moveable</span><span class="o">.</span><span class="n">getName</span><span class="p">()]</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                    <span class="c1"># Add extra data coming in the step[&#39;extrainfo&#39;] dictionary</span>
                    <span class="k">if</span> <span class="s1">&#39;extrainfo&#39;</span> <span class="ow">in</span> <span class="n">step</span><span class="p">:</span>
                        <span class="n">data_line</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;extrainfo&#39;</span><span class="p">])</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">addRecord</span><span class="p">(</span><span class="n">data_line</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">scream</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="p">((</span><span class="n">point_nb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">nb_points</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">old_curr_time</span> <span class="o">=</span> <span class="n">curr_time</span>
                <span class="n">curr_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">sum_delay</span> <span class="o">+=</span> <span class="p">(</span><span class="n">curr_time</span> <span class="o">-</span> <span class="n">old_curr_time</span><span class="p">)</span> <span class="o">-</span> <span class="n">integ_time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">motion_end_event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;acqtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_integ_time</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;delaytime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_delay</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">scream</span><span class="p">:</span>
            <span class="k">yield</span> <span class="mf">100.0</span>


<span class="k">class</span> <span class="nc">CAcquisition</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># protect older versions of Taurus (without the worker_cls argument)</span>
        <span class="c1"># remove it whenever we bump Taurus dependency</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread_pool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;ValueBufferTH&quot;</span><span class="p">,</span>
                                           <span class="n">Psize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                           <span class="n">Qsize</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span>
                                           <span class="n">worker_cls</span><span class="o">=</span><span class="n">OmniWorker</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">taurus</span>
            <span class="n">taurus</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Your Sardana system is affected by bug&quot;</span>
                           <span class="s2">&quot;tango-controls/pytango#307. Please use &quot;</span>
                           <span class="s2">&quot;Taurus with taurus-org/taurus#1081.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread_pool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;ValueBufferTH&quot;</span><span class="p">,</span>
                                           <span class="n">Psize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                           <span class="n">Qsize</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_countdown_latch</span> <span class="o">=</span> <span class="n">CountLatch</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_offset</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">value_buffer_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">value_buffer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delegate processing of value buffer events to a worker thread.&quot;&quot;&quot;</span>
        <span class="c1"># value_buffer is a dictionary with at least keys: data, index</span>
        <span class="c1"># and its values are of type sequence</span>
        <span class="c1"># e.g. dict(data=seq&lt;float&gt;, index=seq&lt;int&gt;)</span>
        <span class="k">if</span> <span class="n">value_buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">full_name</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">getFullName</span><span class="p">()</span>

        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">full_name</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value_buffer</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">])</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_offset</span>
            <span class="n">value_buffer</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value_buffer</span><span class="p">)</span>
        <span class="c1"># info is a dictionary with at least keys: label, data,</span>
        <span class="c1"># index and its values are of type string for label and</span>
        <span class="c1"># sequence for data, index</span>
        <span class="c1"># e.g. dict(label=str, data=seq&lt;float&gt;, index=seq&lt;int&gt;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_countdown_latch</span><span class="o">.</span><span class="n">count_up</span><span class="p">()</span>
        <span class="c1"># only one thread is present in the pool so jobs are serialized</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread_pool</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">addData</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">_countdown_latch</span><span class="o">.</span><span class="n">count_down</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">value_ref_buffer_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">value_ref_buffer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delegate processing of value buffer events to a worker thread.&quot;&quot;&quot;</span>
        <span class="c1"># value_ref_buffer is a dictionary with at least keys:</span>
        <span class="c1"># value_ref, index</span>
        <span class="c1"># and its values are of type sequence</span>
        <span class="c1"># e.g. dict(value_ref=seq&lt;float&gt;, index=seq&lt;int&gt;)</span>
        <span class="k">if</span> <span class="n">value_ref_buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">full_name</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">getFullName</span><span class="p">()</span>

        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">full_name</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value_ref_buffer</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">])</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_offset</span>
            <span class="n">value_ref_buffer</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value_ref_buffer</span><span class="p">)</span>
        <span class="c1"># info is a dictionary with at least keys: label, data,</span>
        <span class="c1"># index and its values are of type string for label and</span>
        <span class="c1"># sequence for data, index</span>
        <span class="c1"># e.g. dict(label=str, data=seq&lt;float&gt;, index=seq&lt;int&gt;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_countdown_latch</span><span class="o">.</span><span class="n">count_up</span><span class="p">()</span>
        <span class="c1"># only one thread is present in the pool so jobs are serialized</span>
        <span class="c1"># TODO: think if the RecordList.addData is the best API for</span>
        <span class="c1"># passing value references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread_pool</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">addData</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">_countdown_latch</span><span class="o">.</span><span class="n">count_down</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">wait_value_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wait until all value buffer events are processed.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_countdown_latch</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">join_thread_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dispose the thread pool. Call it when you finish with processing</span>
<span class="sd">        value_buffer events.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread_pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_measurement_group_compatible</span><span class="p">(</span><span class="n">measurement_group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if the given measurement group is compatible with continuous</span>
<span class="sd">        acquisition. Non compatible measurement groups are those with channels</span>
<span class="sd">        of the following types:</span>
<span class="sd">          - external channels (Tango attributes)</span>
<span class="sd">          - pseudo counters that are not based on physical channels</span>

<span class="sd">        .. todo:: add validation for psuedo counters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">non_compatible_channels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="n">TangoDeviceNameValidator</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">channel_info</span> <span class="ow">in</span> <span class="n">measurement_group</span><span class="o">.</span><span class="n">getChannels</span><span class="p">():</span>
            <span class="n">full_name</span> <span class="o">=</span> <span class="n">channel_info</span><span class="p">[</span><span class="s2">&quot;full_name&quot;</span><span class="p">]</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">channel_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">validator</span><span class="o">.</span><span class="n">isValid</span><span class="p">(</span><span class="n">full_name</span><span class="p">):</span>
                <span class="n">non_compatible_channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">is_compatible</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_compatible_channels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">is_compatible</span><span class="p">,</span> <span class="n">non_compatible_channels</span>


<span class="k">def</span> <span class="nf">generate_timestamps</span><span class="p">(</span><span class="n">synch_description</span><span class="p">,</span> <span class="n">initial_timestamp</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate theoretical timestamps at which the acquisition should take</span>
<span class="sd">    place according to the synchronization description</span>

<span class="sd">    :param synch_description: synchronization description data</span>
<span class="sd">      structure</span>
<span class="sd">    :type synch_description: list&lt;dict&gt;</span>
<span class="sd">    :param initial_timestamp: initial timestamp to start from</span>
<span class="sd">    :type initial_timestamp: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">initial_timestamp</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">synch_description</span><span class="p">:</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">SynchParam</span><span class="o">.</span><span class="n">Delay</span><span class="p">][</span><span class="n">SynchDomain</span><span class="o">.</span><span class="n">Time</span><span class="p">]</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">SynchParam</span><span class="o">.</span><span class="n">Total</span><span class="p">][</span><span class="n">SynchDomain</span><span class="o">.</span><span class="n">Time</span><span class="p">]</span>
        <span class="n">repeats</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">SynchParam</span><span class="o">.</span><span class="n">Repeats</span><span class="p">]</span>
        <span class="n">timestamp</span> <span class="o">+=</span> <span class="n">delay</span>
        <span class="n">ret</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">repeats</span><span class="p">):</span>
            <span class="n">timestamp</span> <span class="o">+=</span> <span class="n">total</span>
            <span class="n">ret</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">ret</span>


<span class="k">def</span> <span class="nf">generate_positions</span><span class="p">(</span><span class="n">motors</span><span class="p">,</span> <span class="n">starts</span><span class="p">,</span> <span class="n">finals</span><span class="p">,</span> <span class="n">nb_points</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="c1"># generate theoretical positions</span>
    <span class="n">moveable_positions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">final</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">finals</span><span class="p">):</span>
        <span class="n">moveable_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">final</span><span class="p">,</span> <span class="n">nb_points</span><span class="p">))</span>
    <span class="c1"># prepare table header from moveables names</span>
    <span class="n">dtype_spec</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">motor</span> <span class="ow">in</span> <span class="n">motors</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
        <span class="n">dtype_spec</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;float64&#39;</span><span class="p">))</span>
    <span class="c1"># convert to numpy array for easier handling</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">moveable_positions</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype_spec</span><span class="p">)</span>
    <span class="n">n_rows</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_rows</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">row</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ret</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span>
    <span class="k">return</span> <span class="n">ret</span>


<span class="k">class</span> <span class="nc">CTScan</span><span class="p">(</span><span class="n">CScan</span><span class="p">,</span> <span class="n">CAcquisition</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Generic continuous scan class.</span>

<span class="sd">    The idea is that the scan macros create an instance of this class,</span>
<span class="sd">    supplying in the constructor a reference to the macro that created the</span>
<span class="sd">    scan, a waypoint generator function pointer, a list of moveable items,</span>
<span class="sd">    an extra environment and a sequence of constrains.</span>

<span class="sd">    The generator must be a function yielding a dictionary with the following</span>
<span class="sd">    content (minimum) at each step of the scan:</span>
<span class="sd">      - &#39;start_positions&#39; : The user positions where the **physical** motors</span>
<span class="sd">                            should start the active region of the waypoint scan</span>
<span class="sd">                            (usually during the constant velocity of the</span>
<span class="sd">                            **physical** motors)</span>
<span class="sd">      - &#39;positions&#39;  : The user positions where the **physical** motors should</span>
<span class="sd">                       end the active region of the waypoint scan (since</span>
<span class="sd">                       currently the post-trigger acquisition is assumed this</span>
<span class="sd">                       does not mean leaving the constant velocity of the</span>
<span class="sd">                       **physical** motors - the constant velocity will be</span>
<span class="sd">                       maintained for the last point of the waypoint scan)</span>
<span class="sd">      - &#39;active_time&#39; : Duration of the active region of the waypoint scan,</span>
<span class="sd">                        (in contrary to the *positions* configuration this one</span>
<span class="sd">                        includes the time necessary for hangling the last point</span>
<span class="sd">                        of the waypoint scan with its *latency time*</span>
<span class="sd">                        (in seconds)</span>
<span class="sd">      - &#39;pre-move-hooks&#39; : (optional) a sequence of callables to be called</span>
<span class="sd">                           in strict order before starting to move</span>
<span class="sd">      - &#39;post-move-hooks&#39;: (optional) a sequence of callables to be called</span>
<span class="sd">                           in strict order after finishing the move</span>
<span class="sd">      - &#39;waypoint_id&#39; : a hashable identifing the waypoint</span>
<span class="sd">      - &#39;check_func&#39; : (optional) a list of callable objects.</span>
<span class="sd">                       callable(moveables, counters)</span>
<span class="sd">      - &#39;extravalues&#39;: (optional) a dictionary containing the values for</span>
<span class="sd">                       each extra info field. The extra information fields</span>
<span class="sd">                       must be described in extradesc (passed in the</span>
<span class="sd">                       constructor of the Gscan)</span>

<span class="sd">    .. todo::</span>
<span class="sd">        - instead of passing the *active_time* pass the synchronization</span>
<span class="sd">          description</span>
<span class="sd">        - decide whether *positions* should include the real end of the active</span>
<span class="sd">          region</span>
<span class="sd">        - decide if the *start_positions* and *positions* should operate</span>
<span class="sd">          directly on the physical motors or it would be more interesting on</span>
<span class="sd">          the pseudo motors</span>

<span class="sd">    .. note::</span>
<span class="sd">        The CTScan class has been included in Sardana</span>
<span class="sd">        on a provisional basis. Backwards incompatible changes</span>
<span class="sd">        (up to and including removal of the module) may occur if</span>
<span class="sd">        deemed necessary by the core developers.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">macro</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">moveables</span><span class="o">=</span><span class="p">[],</span> <span class="n">env</span><span class="o">=</span><span class="p">{},</span> <span class="n">constraints</span><span class="o">=</span><span class="p">[],</span> <span class="n">extrainfodesc</span><span class="o">=</span><span class="p">[]):</span>
        <span class="n">CScan</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">macro</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span>
                       <span class="n">moveables</span><span class="o">=</span><span class="n">moveables</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
                       <span class="n">extrainfodesc</span><span class="o">=</span><span class="n">extrainfodesc</span><span class="p">)</span>
        <span class="n">CAcquisition</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mntGrpSubscribed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">prepare_waypoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">waypoint</span><span class="p">,</span> <span class="n">start_positions</span><span class="p">,</span> <span class="n">iterate_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare list of MotionPath objects per each physical motor.</span>
<span class="sd">        :param waypoint: (dict) waypoint dictionary with necessary information</span>
<span class="sd">        :param start_positions: (list&lt;</span>
<span class="sd">        float&gt;) list of starting position per each</span>
<span class="sd">                                 physical motor</span>
<span class="sd">        :return (ideal_paths, acc_time, active_time)</span>
<span class="sd">                - ideal_paths: (list&lt;MotionPath&gt; representing motion attributes</span>
<span class="sd">                               of each physical motor)</span>
<span class="sd">                - acc_time: acceleration time which will be used during the</span>
<span class="sd">                            scan it corresponds to the longest acceleration</span>
<span class="sd">                            time of all the motors</span>
<span class="sd">                - active_time: time interval while all the physical motors will</span>
<span class="sd">                               maintain constant velocity&quot;&quot;&quot;</span>

        <span class="n">positions</span> <span class="o">=</span> <span class="n">waypoint</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">]</span>
        <span class="n">active_time</span> <span class="o">=</span> <span class="n">waypoint</span><span class="p">[</span><span class="s2">&quot;active_time&quot;</span><span class="p">]</span>

        <span class="n">ideal_paths</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">max_acc_time</span><span class="p">,</span> <span class="n">max_dec_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">moveable</span><span class="p">,</span> <span class="n">start_position</span><span class="p">,</span> <span class="n">end_position</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_physical_moveables</span><span class="p">,</span> <span class="n">start_positions</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
            <span class="c1"># motors that won&#39;t be moved do not participate in the</span>
            <span class="c1"># configuration selection</span>
            <span class="c1"># TODO: think of not attaching them to the waypoint at all</span>
            <span class="k">if</span> <span class="n">start_position</span> <span class="o">==</span> <span class="n">end_position</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">motor</span> <span class="o">=</span> <span class="n">moveable</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Motor: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;AccTime: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_min_acc_time</span><span class="p">(</span><span class="n">motor</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DecTime: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_min_dec_time</span><span class="p">(</span><span class="n">motor</span><span class="p">))</span>
            <span class="n">max_acc_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_min_acc_time</span><span class="p">(</span><span class="n">motor</span><span class="p">),</span> <span class="n">max_acc_time</span><span class="p">)</span>
            <span class="n">max_dec_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_min_dec_time</span><span class="p">(</span><span class="n">motor</span><span class="p">),</span> <span class="n">max_dec_time</span><span class="p">)</span>

        <span class="n">acc_time</span> <span class="o">=</span> <span class="n">max_acc_time</span>
        <span class="n">dec_time</span> <span class="o">=</span> <span class="n">max_dec_time</span>

        <span class="k">for</span> <span class="n">moveable</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> \
                <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_physical_moveables</span><span class="p">,</span> <span class="n">start_positions</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
            <span class="n">total_displacement</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">start</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">interval_displacement</span> <span class="o">=</span> <span class="n">total_displacement</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">nr_interv</span>
            <span class="c1"># move further in order to acquire the last point at constant</span>
            <span class="c1"># velocity</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">end</span> <span class="o">+</span> <span class="n">direction</span> <span class="o">*</span> <span class="n">interval_displacement</span>

            <span class="n">base_vel</span> <span class="o">=</span> <span class="n">moveable</span><span class="o">.</span><span class="n">getBaseRate</span><span class="p">()</span>
            <span class="n">ideal_vmotor</span> <span class="o">=</span> <span class="n">VMotor</span><span class="p">(</span><span class="n">accel_time</span><span class="o">=</span><span class="n">acc_time</span><span class="p">,</span>
                                  <span class="n">decel_time</span><span class="o">=</span><span class="n">dec_time</span><span class="p">,</span>
                                  <span class="n">min_vel</span><span class="o">=</span><span class="n">base_vel</span><span class="p">)</span>
            <span class="n">ideal_path</span> <span class="o">=</span> <span class="n">MotionPath</span><span class="p">(</span><span class="n">ideal_vmotor</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">active_time</span><span class="p">)</span>

            <span class="c1"># check if calculated ideal velocity is accepted by hardware</span>
            <span class="n">backup_vel</span> <span class="o">=</span> <span class="n">moveable</span><span class="o">.</span><span class="n">getVelocity</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ideal_max_vel</span> <span class="o">=</span> <span class="n">try_vel</span> <span class="o">=</span> <span class="n">ideal_path</span><span class="o">.</span><span class="n">max_vel</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">moveable</span><span class="o">.</span><span class="n">setVelocity</span><span class="p">(</span><span class="n">try_vel</span><span class="p">)</span>
                    <span class="n">get_vel</span> <span class="o">=</span> <span class="n">moveable</span><span class="o">.</span><span class="n">getVelocity</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">get_vel</span> <span class="o">&lt;</span> <span class="n">ideal_max_vel</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Ideal scan velocity </span><span class="si">{0}</span><span class="s1"> of motor </span><span class="si">{1}</span><span class="s1"> cannot &#39;</span> \
                              <span class="s1">&#39;be reached, </span><span class="si">{2}</span><span class="s1"> will be used instead&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                  <span class="n">ideal_max_vel</span><span class="p">,</span> <span class="n">moveable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">get_vel</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">ideal_path</span><span class="o">.</span><span class="n">max_vel</span> <span class="o">=</span> <span class="n">get_vel</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="n">get_vel</span> <span class="o">&gt;</span> <span class="n">ideal_max_vel</span><span class="p">:</span>
                        <span class="n">try_vel</span> <span class="o">-=</span> <span class="p">(</span><span class="n">get_vel</span> <span class="o">-</span> <span class="n">try_vel</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Unknown error when trying if hardware &quot;</span>
                                 <span class="s2">&quot;accepts ideal scan velocity&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ideal_path</span><span class="o">.</span><span class="n">max_vel</span> <span class="o">=</span> <span class="n">ideal_max_vel</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">moveable</span><span class="o">.</span><span class="n">setVelocity</span><span class="p">(</span><span class="n">backup_vel</span><span class="p">)</span>

            <span class="n">ideal_path</span><span class="o">.</span><span class="n">moveable</span> <span class="o">=</span> <span class="n">moveable</span>
            <span class="n">ideal_path</span><span class="o">.</span><span class="n">apply_correction</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ideal_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ideal_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ideal_paths</span><span class="p">,</span> <span class="n">acc_time</span><span class="p">,</span> <span class="n">active_time</span>

    <span class="k">def</span> <span class="nf">_go_through_waypoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal, unprotected method to go through the different waypoints.</span>
<span class="sd">           It controls all the three objects: motion, trigger and measurement</span>
<span class="sd">           group.&quot;&quot;&quot;</span>
        <span class="n">macro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span>
        <span class="n">motion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_physical_motion</span>
        <span class="n">waypoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span>
        <span class="n">measurement_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement_group</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;_go_through_waypoints() entering...&quot;</span><span class="p">)</span>

        <span class="n">compatible</span><span class="p">,</span> <span class="n">channels</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">is_measurement_group_compatible</span><span class="p">(</span><span class="n">measurement_group</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">compatible</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Non compatible channels are: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">channels</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Measurement group </span><span class="si">%s</span><span class="s2"> is not compatible with </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>\
                  <span class="p">(</span><span class="n">measurement_group</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="n">macro</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
            <span class="k">raise</span> <span class="n">ScanException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># add listener of data events</span>
        <span class="n">measurement_group</span><span class="o">.</span><span class="n">subscribeValueBuffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value_buffer_changed</span><span class="p">)</span>
        <span class="c1"># add listener of value ref events</span>
        <span class="n">measurement_group</span><span class="o">.</span><span class="n">subscribeValueRefBuffer</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value_ref_buffer_changed</span><span class="p">)</span>
        <span class="c1"># initializing mntgrp subscription control variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mntGrpSubscribed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">initial_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">last_positions</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Motor positions and relative timestamp (dt) columns contains&quot;</span>
            <span class="s2">&quot; theoretical values&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">waypoint</span> <span class="ow">in</span> <span class="n">waypoints</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waypoint iteration...&quot;</span><span class="p">)</span>

            <span class="n">start_positions</span> <span class="o">=</span> <span class="n">waypoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start_positions&#39;</span><span class="p">)</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="n">waypoint</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">start_positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">start_positions</span> <span class="o">=</span> <span class="n">last_positions</span>
            <span class="k">if</span> <span class="n">start_positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">last_positions</span> <span class="o">=</span> <span class="n">positions</span>
                <span class="k">continue</span>

            <span class="n">waypoint_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_waypoint</span><span class="p">(</span><span class="n">waypoint</span><span class="p">,</span> <span class="n">start_positions</span><span class="p">)</span>
            <span class="n">motion_paths</span><span class="p">,</span> <span class="n">delta_start</span><span class="p">,</span> <span class="n">acq_duration</span> <span class="o">=</span> <span class="n">waypoint_info</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">acq_duration</span> <span class="o">=</span> <span class="n">acq_duration</span>

            <span class="c1"># execute pre-move hooks</span>
            <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">waypoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pre-move-hooks&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">hook</span><span class="p">()</span>
            <span class="c1"># parepare list of start and final positions for the motion object</span>
            <span class="n">start_pos</span><span class="p">,</span> <span class="n">final_pos</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">motion_paths</span><span class="p">:</span>
                <span class="n">start_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">initial_user_pos</span><span class="p">)</span>
                <span class="n">final_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">final_user_pos</span><span class="p">)</span>
            <span class="c1"># validate if start and final positions are within range</span>
            <span class="n">moveables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_physical_moveables</span>
            <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">final</span><span class="p">,</span> <span class="n">moveable</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">start_pos</span><span class="p">,</span> <span class="n">final_pos</span><span class="p">,</span> <span class="n">moveables</span><span class="p">):</span>
                <span class="n">min_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_min_pos</span><span class="p">(</span><span class="n">moveable</span><span class="p">)</span>
                <span class="n">max_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_max_pos</span><span class="p">(</span><span class="n">moveable</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">min_pos</span> <span class="ow">or</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">max_pos</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">moveable</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;start position of motor </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%f</span><span class="s1">) &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span> <span class="o">+</span>\
                          <span class="s1">&#39;is out of range (</span><span class="si">%f</span><span class="s1">, </span><span class="si">%f</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">min_pos</span><span class="p">,</span> <span class="n">max_pos</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">ScanException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">final</span> <span class="o">&lt;</span> <span class="n">min_pos</span> <span class="ow">or</span> <span class="n">final</span> <span class="o">&gt;</span> <span class="n">max_pos</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">moveable</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;final position of motor </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%f</span><span class="s1">) &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">final</span><span class="p">)</span> <span class="o">+</span>\
                          <span class="s1">&#39;is out of range (</span><span class="si">%f</span><span class="s1">, </span><span class="si">%f</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">min_pos</span><span class="p">,</span> <span class="n">max_pos</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">ScanException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">macro</span><span class="o">.</span><span class="n">isStopped</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_waypoints_end</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="c1"># at least one motor must have different start and final positions</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">starts</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">finals</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">starts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Scan start and end must be different for at &quot;</span> \
                          <span class="s2">&quot;least one motor&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Scan start and end must be different.&quot;</span>
                <span class="k">raise</span> <span class="n">ScanException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># Set the index offset used in CAcquisition class.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_index_offset</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">nb_points</span>

            <span class="n">startTimestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="c1"># extra pre configuration</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">macro</span><span class="p">,</span> <span class="s1">&#39;getHooks&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">macro</span><span class="o">.</span><span class="n">getHooks</span><span class="p">(</span><span class="s1">&#39;pre-configuration&#39;</span><span class="p">):</span>
                    <span class="n">hook</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">checkPoint</span><span class="p">()</span>

            <span class="c1"># TODO: let a pseudomotor specify which motor should be used as</span>
            <span class="c1"># source</span>
            <span class="n">MASTER</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">moveable</span> <span class="o">=</span> <span class="n">moveables</span><span class="p">[</span><span class="n">MASTER</span><span class="p">]</span><span class="o">.</span><span class="n">full_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measurement_group</span><span class="o">.</span><span class="n">setMoveable</span><span class="p">(</span><span class="n">moveable</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">motion_paths</span><span class="p">[</span><span class="n">MASTER</span><span class="p">]</span>
            <span class="n">repeats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">nb_points</span>
            <span class="n">active_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">integ_time</span>
            <span class="n">active_position</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">max_vel</span> <span class="o">*</span> <span class="n">active_time</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">positive_displacement</span><span class="p">:</span>
                <span class="n">active_position</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">_initial_user_pos</span>
            <span class="n">final</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">_final_user_pos</span>
            <span class="n">total_position</span> <span class="o">=</span> <span class="p">(</span><span class="n">final</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">repeats</span>
            <span class="n">initial_position</span> <span class="o">=</span> <span class="n">start</span>
            <span class="n">total_time</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">total_position</span><span class="p">)</span> <span class="o">/</span> <span class="n">path</span><span class="o">.</span><span class="n">max_vel</span>
            <span class="n">delay_time</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">max_vel_time</span>
            <span class="n">synch</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span><span class="n">SynchParam</span><span class="o">.</span><span class="n">Delay</span><span class="p">:</span> <span class="p">{</span><span class="n">SynchDomain</span><span class="o">.</span><span class="n">Time</span><span class="p">:</span> <span class="n">delay_time</span><span class="p">},</span>
                 <span class="n">SynchParam</span><span class="o">.</span><span class="n">Initial</span><span class="p">:</span> <span class="p">{</span><span class="n">SynchDomain</span><span class="o">.</span><span class="n">Position</span><span class="p">:</span> <span class="n">initial_position</span><span class="p">},</span>
                 <span class="n">SynchParam</span><span class="o">.</span><span class="n">Active</span><span class="p">:</span> <span class="p">{</span><span class="n">SynchDomain</span><span class="o">.</span><span class="n">Position</span><span class="p">:</span> <span class="n">active_position</span><span class="p">,</span>
                                     <span class="n">SynchDomain</span><span class="o">.</span><span class="n">Time</span><span class="p">:</span> <span class="n">active_time</span><span class="p">},</span>
                 <span class="n">SynchParam</span><span class="o">.</span><span class="n">Total</span><span class="p">:</span> <span class="p">{</span><span class="n">SynchDomain</span><span class="o">.</span><span class="n">Position</span><span class="p">:</span> <span class="n">total_position</span><span class="p">,</span>
                                    <span class="n">SynchDomain</span><span class="o">.</span><span class="n">Time</span><span class="p">:</span> <span class="n">total_time</span><span class="p">},</span>
                 <span class="n">SynchParam</span><span class="o">.</span><span class="n">Repeats</span><span class="p">:</span> <span class="n">repeats</span><span class="p">}]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;SynchDescription: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">synch</span><span class="p">)</span>
            <span class="n">measurement_group</span><span class="o">.</span><span class="n">setSynchDescription</span><span class="p">(</span><span class="n">synch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">checkPoint</span><span class="p">()</span>

            <span class="c1"># extra post configuration</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">macro</span><span class="p">,</span> <span class="s1">&#39;getHooks&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">macro</span><span class="o">.</span><span class="n">getHooks</span><span class="p">(</span><span class="s1">&#39;post-configuration&#39;</span><span class="p">):</span>
                    <span class="n">hook</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">checkPoint</span><span class="p">()</span>

            <span class="n">endTimestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Configuration took </span><span class="si">%s</span><span class="s2"> time.&quot;</span> <span class="o">%</span>
                       <span class="nb">repr</span><span class="p">(</span><span class="n">endTimestamp</span> <span class="o">-</span> <span class="n">startTimestamp</span><span class="p">))</span>
            <span class="c1">############</span>
            <span class="c1"># try to go as fast as possile to start position</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setFastMotions</span><span class="p">(</span><span class="n">moveables</span><span class="p">)</span>
            <span class="c1"># move to start position</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Moving to start position: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">start_pos</span><span class="p">))</span>
            <span class="n">motion</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">start_pos</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">macro</span><span class="o">.</span><span class="n">isStopped</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_waypoints_end</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="c1"># prepare motor(s) to move with their maximum velocity</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">motion_paths</span><span class="p">:</span>
                <span class="n">motor</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">moveable</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Motor: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;start_user: </span><span class="si">%f</span><span class="s1">; &#39;</span> <span class="o">%</span> <span class="n">path</span><span class="o">.</span><span class="n">_initial_user_pos</span> <span class="o">+</span>
                                 <span class="s1">&#39;end_user: </span><span class="si">%f</span><span class="s1">; &#39;</span> <span class="o">%</span> <span class="n">path</span><span class="o">.</span><span class="n">_final_user_pos</span> <span class="o">+</span>
                                 <span class="s1">&#39;start: </span><span class="si">%f</span><span class="s1">; &#39;</span> <span class="o">%</span> <span class="n">path</span><span class="o">.</span><span class="n">initial_pos</span> <span class="o">+</span>
                                 <span class="s1">&#39;end: </span><span class="si">%f</span><span class="s1">; &#39;</span> <span class="o">%</span> <span class="n">path</span><span class="o">.</span><span class="n">final_pos</span> <span class="o">+</span>
                                 <span class="s1">&#39;ds: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">final_pos</span> <span class="o">-</span>
                                             <span class="n">path</span><span class="o">.</span><span class="n">initial_pos</span><span class="p">))</span>
                <span class="n">attributes</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">velocity</span><span class="o">=</span><span class="n">path</span><span class="o">.</span><span class="n">max_vel</span><span class="p">,</span>
                                         <span class="n">acceleration</span><span class="o">=</span><span class="n">path</span><span class="o">.</span><span class="n">max_vel_time</span><span class="p">,</span>
                                         <span class="n">deceleration</span><span class="o">=</span><span class="n">path</span><span class="o">.</span><span class="n">min_vel_time</span><span class="p">)</span>
                <span class="c1"># do not configure motors which are not moved in the waypoint</span>
                <span class="c1"># TODO: think of not attaching them to the waypoint at all</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">initial_user_pos</span> <span class="o">==</span> <span class="n">path</span><span class="o">.</span><span class="n">final_user_pos</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">configure_motor</span><span class="p">(</span><span class="n">motor</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">ScanException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Error when configuring scan motion (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">e</span>
                    <span class="k">raise</span> <span class="n">ScanException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">macro</span><span class="o">.</span><span class="n">isStopped</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_waypoints_end</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="c1"># TODO: don&#39;t fill theoretical positions but implement the position</span>
            <span class="c1"># capture, both hardware and software</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dt_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">first_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dt_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">first_timestamp</span>
            <span class="n">initial_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">initial_data</span>

            <span class="n">motors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">motors</span>
            <span class="n">starts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">starts</span>
            <span class="n">finals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">finals</span>
            <span class="n">nb_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">nb_points</span>
            <span class="n">theoretical_positions</span> <span class="o">=</span> <span class="n">generate_positions</span><span class="p">(</span><span class="n">motors</span><span class="p">,</span> <span class="n">starts</span><span class="p">,</span> <span class="n">finals</span><span class="p">,</span>
                                                       <span class="n">nb_points</span><span class="p">)</span>
            <span class="n">theoretical_timestamps</span> <span class="o">=</span> <span class="n">generate_timestamps</span><span class="p">(</span><span class="n">synch</span><span class="p">,</span> <span class="n">dt_timestamp</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">theoretical_positions</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">theoretical_timestamps</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
                <span class="n">initial_data</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="c1"># TODO: this changes the initial data on-the-fly - seems like not</span>
            <span class="c1"># the best practice</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">initial_data</span> <span class="o">=</span> <span class="n">initial_data</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">macro</span><span class="p">,</span> <span class="s1">&#39;getHooks&#39;</span><span class="p">):</span>
                <span class="n">pre_acq_hooks</span> <span class="o">=</span> <span class="n">waypoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pre-acq-hooks&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">pre_acq_hooks</span><span class="p">:</span>
                    <span class="n">hook</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">checkPoint</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting measurement group&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measurement_group</span><span class="o">.</span><span class="n">setNbStarts</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measurement_group</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>
            <span class="n">mg_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement_group</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">first_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timestamp_to_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">delta_start</span>
                <span class="n">end_move</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># move to waypoint end position</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Moving to waypoint position: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">final_pos</span><span class="p">))</span>
                <span class="n">motion</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">final_pos</span><span class="p">)</span>
                <span class="n">end_move</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">measurement_group</span><span class="o">.</span><span class="n">waitFinish</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">mg_id</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Motion did not start properly.</span><span class="se">\n</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">ScanException</span><span class="p">(</span><span class="s2">&quot;move to final position failed&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># wait extra 15 s to for the acquisition to finish</span>
                <span class="c1"># if it does not finish, abort the measurement group</span>
                <span class="c1"># (this could be due to missed hardware triggers or</span>
                <span class="c1"># positioning problems)</span>
                <span class="c1"># TODO: allow parametrizing timeout</span>
                <span class="n">timeout</span> <span class="o">=</span> <span class="mi">15</span>
                <span class="n">measurement_group</span><span class="o">.</span><span class="n">waitFinish</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">mg_id</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">measurement_group</span><span class="o">.</span><span class="n">stateObj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">rvalue</span>
                <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">PyTango</span><span class="o">.</span><span class="n">DevState</span><span class="o">.</span><span class="n">MOVING</span><span class="p">:</span>
                    <span class="n">measurement_group</span><span class="o">.</span><span class="n">Stop</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">end_move</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Measurement did not finish acquisition within &quot;</span>\
                              <span class="s2">&quot;timeout. Stopping it...&quot;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">ScanException</span><span class="p">(</span><span class="s2">&quot;acquisition timeout reached&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">waypoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;post-acq-hooks&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">hook</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">macro</span><span class="o">.</span><span class="n">isStopped</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_waypoints_end</span><span class="p">()</span>
                <span class="k">return</span>
            <span class="c1"># execute post-move hooks</span>
            <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">waypoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;post-move-hooks&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">hook</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">start_positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">last_positions</span> <span class="o">=</span> <span class="n">positions</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">on_waypoints_end</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_waypoints_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restore_positions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;To be called by the waypoint thread to handle the end of waypoints</span>
<span class="sd">        (either because no more waypoints or because a macro abort was</span>
<span class="sd">        triggered)</span>

<span class="sd">        .. todo:: Unify this method for all the continuous scans. Hint: use</span>
<span class="sd">                  the motion property and return the _physical_motion member</span>
<span class="sd">                  instead of _motion or in both cases: CSScan and CTScan</span>
<span class="sd">                  coordinate the physical motors&#39; velocit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;on_waypoints_end() entering...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_all_waypoints_finished</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">restore_positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_restore_motors</span><span class="p">()</span>  <span class="c1"># first restore motors backup</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setFastMotions</span><span class="p">()</span>  <span class="c1"># then try to go even faster (limits)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Correcting overshoot...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_physical_motion</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">restore_positions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motion_end_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waiting for data events to be processed&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_value_buffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join_thread_pool</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;All data events are processed&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">scan_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">macro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span>
        <span class="c1"># manager = macro.getManager()</span>
        <span class="n">scream</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># startts = self._env[&#39;startts&#39;]</span>

        <span class="n">sum_delay</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sum_integ_time</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">macro</span><span class="p">,</span> <span class="s2">&quot;nb_points&quot;</span><span class="p">):</span>
            <span class="c1"># nb_points = float(macro.nb_points)</span>
            <span class="n">scream</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="mf">0.0</span>

        <span class="c1"># moveables = [m.moveable for m in self.moveables]</span>

        <span class="c1"># point_nb, step = -1, None</span>
        <span class="c1"># data = self.data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">go_through_waypoints</span><span class="p">()</span>

        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;acqtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_integ_time</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;delaytime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_delay</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">scream</span><span class="p">:</span>
            <span class="k">yield</span> <span class="mf">100.0</span>

    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;This method is responsible for restoring state of measurement group</span>
<span class="sd">        and trigger to its state before the scan.&#39;&#39;&#39;</span>
        <span class="n">startTimestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mntGrpSubscribed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Unsubscribing from value buffer events&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">measurement_group</span><span class="o">.</span><span class="n">unsubscribeValueBuffer</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">value_buffer_changed</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">measurement_group</span><span class="o">.</span><span class="n">unsubscribeValueRefBuffer</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">value_ref_buffer_changed</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__mntGrpSubscribed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Exception occurred trying to remove data listeners&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Details: &#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">ScanException</span><span class="p">(</span><span class="s1">&#39;removing data listeners failed&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">,</span> <span class="s1">&#39;getHooks&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getHooks</span><span class="p">(</span><span class="s1">&#39;pre-cleanup&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Executing pre-cleanup hook&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hook</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Exception while trying to execute a pre-cleanup &quot;</span> \
                          <span class="s2">&quot;hook&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Details: &#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">ScanException</span><span class="p">(</span><span class="s1">&#39;pre-cleanup hook failed&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">,</span> <span class="s1">&#39;getHooks&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getHooks</span><span class="p">(</span><span class="s1">&#39;post-cleanup&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Executing post-cleanup hook&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hook</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Exception while trying to execute a &quot;</span> <span class="o">+</span> \
                          <span class="s2">&quot;post-cleanup hook&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Details: &#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">ScanException</span><span class="p">(</span><span class="s1">&#39;post-cleanup hook failed&#39;</span><span class="p">)</span>

        <span class="n">endTimestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cleanup took </span><span class="si">%s</span><span class="s2"> time.&quot;</span> <span class="o">%</span>
                   <span class="nb">repr</span><span class="p">(</span><span class="n">endTimestamp</span> <span class="o">-</span> <span class="n">startTimestamp</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">HScan</span><span class="p">(</span><span class="n">SScan</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Hybrid scan&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">stepUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">lstep</span><span class="p">):</span>
        <span class="n">motion</span><span class="p">,</span> <span class="n">mg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">motion</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement_group</span>
        <span class="n">startts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">[</span><span class="s1">&#39;startts&#39;</span><span class="p">]</span>

        <span class="c1"># pre-move hooks</span>
        <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pre-move-hooks&#39;</span><span class="p">,</span> <span class="p">()):</span>
            <span class="n">hook</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">step</span><span class="p">[</span><span class="s1">&#39;extrainfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hook</span><span class="o">.</span><span class="n">getStepExtraInfo</span><span class="p">())</span>
            <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">positions</span><span class="p">,</span> <span class="n">integ_time</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">],</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;integ_time&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">m_ID</span> <span class="o">=</span> <span class="n">motion</span><span class="o">.</span><span class="n">startMove</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
            <span class="n">mg_ID</span> <span class="o">=</span> <span class="n">mg</span><span class="o">.</span><span class="n">startCount</span><span class="p">(</span><span class="n">integ_time</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump_information</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">motion</span><span class="o">.</span><span class="n">moveable_list</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">motion</span><span class="o">.</span><span class="n">waitMove</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">m_ID</span><span class="p">)</span>
            <span class="n">mg</span><span class="o">.</span><span class="n">waitCount</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">mg_ID</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump_information</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">motion</span><span class="o">.</span><span class="n">moveable_list</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sum_acq_time</span> <span class="o">+=</span> <span class="n">integ_time</span>

        <span class="n">curr_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">curr_time</span> <span class="o">-</span> <span class="n">startts</span>

        <span class="n">m_state</span><span class="p">,</span> <span class="n">m_positions</span> <span class="o">=</span> <span class="n">motion</span><span class="o">.</span><span class="n">readState</span><span class="p">(),</span> <span class="n">motion</span><span class="o">.</span><span class="n">readPosition</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">m_state</span> <span class="o">!=</span> <span class="n">Ready</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump_information</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">motion</span><span class="o">.</span><span class="n">moveable_list</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="s2">&quot;Scan aborted after problematic motion: &quot;</span> \
                <span class="s2">&quot;Motion ended with </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">m_state</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ScanException</span><span class="p">({</span><span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="n">m</span><span class="p">})</span>

        <span class="n">data_line</span> <span class="o">=</span> <span class="n">mg</span><span class="o">.</span><span class="n">getValues</span><span class="p">()</span>

        <span class="c1"># Add final moveable positions</span>
        <span class="n">data_line</span><span class="p">[</span><span class="s1">&#39;point_nb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
        <span class="n">data_line</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moveables</span><span class="p">):</span>
            <span class="n">data_line</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">moveable</span><span class="o">.</span><span class="n">getName</span><span class="p">()]</span> <span class="o">=</span> <span class="n">m_positions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Add extra data coming in the step[&#39;extrainfo&#39;] dictionary</span>
        <span class="k">if</span> <span class="s1">&#39;extrainfo&#39;</span> <span class="ow">in</span> <span class="n">step</span><span class="p">:</span>
            <span class="n">data_line</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;extrainfo&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">addRecord</span><span class="p">(</span><span class="n">data_line</span><span class="p">)</span>

        <span class="c1"># post-step hooks</span>
        <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;post-step-hooks&#39;</span><span class="p">,</span> <span class="p">()):</span>
            <span class="n">hook</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">step</span><span class="p">[</span><span class="s1">&#39;extrainfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hook</span><span class="o">.</span><span class="n">getStepExtraInfo</span><span class="p">())</span>
            <span class="k">except</span> <span class="n">InterruptException</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">dump_information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">elements</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Report: Stopped at step #&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; with:&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">information</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">TScan</span><span class="p">(</span><span class="n">GScan</span><span class="p">,</span> <span class="n">CAcquisition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Time scan.</span>

<span class="sd">    Macro that employs the time scan must define the synchronization</span>
<span class="sd">    description in either of the following two ways:</span>
<span class="sd">      - synch_description attribute that follows the synchronization</span>
<span class="sd">      description format of the measurement group</span>
<span class="sd">      - integ_time, nb_points and latency_time (optional) attributes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">macro</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">moveables</span><span class="o">=</span><span class="p">[],</span> <span class="n">env</span><span class="o">=</span><span class="p">{},</span> <span class="n">constraints</span><span class="o">=</span><span class="p">[],</span> <span class="n">extrainfodesc</span><span class="o">=</span><span class="p">[]):</span>
        <span class="n">GScan</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">macro</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span>
                       <span class="n">moveables</span><span class="o">=</span><span class="n">moveables</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
                       <span class="n">extrainfodesc</span><span class="o">=</span><span class="n">extrainfodesc</span><span class="p">)</span>
        <span class="n">CAcquisition</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_synch_description</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_create_synch_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active_time</span><span class="p">,</span> <span class="n">repeats</span><span class="p">,</span> <span class="n">latency_time</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">delay_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mg_latency_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement_group</span><span class="o">.</span><span class="n">getLatencyTime</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mg_latency_time</span> <span class="o">&gt;</span> <span class="n">latency_time</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Choosing measurement group latency time: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span>
                            <span class="n">mg_latency_time</span><span class="p">)</span>
            <span class="n">latency_time</span> <span class="o">=</span> <span class="n">mg_latency_time</span>
        <span class="n">total_time</span> <span class="o">=</span> <span class="n">active_time</span> <span class="o">+</span> <span class="n">latency_time</span>
        <span class="n">synch_description</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="n">SynchParam</span><span class="o">.</span><span class="n">Delay</span><span class="p">:</span> <span class="p">{</span><span class="n">SynchDomain</span><span class="o">.</span><span class="n">Time</span><span class="p">:</span> <span class="n">delay_time</span><span class="p">},</span>
             <span class="n">SynchParam</span><span class="o">.</span><span class="n">Active</span><span class="p">:</span> <span class="p">{</span><span class="n">SynchDomain</span><span class="o">.</span><span class="n">Time</span><span class="p">:</span> <span class="n">active_time</span><span class="p">},</span>
             <span class="n">SynchParam</span><span class="o">.</span><span class="n">Total</span><span class="p">:</span> <span class="p">{</span><span class="n">SynchDomain</span><span class="o">.</span><span class="n">Time</span><span class="p">:</span> <span class="n">total_time</span><span class="p">},</span>
             <span class="n">SynchParam</span><span class="o">.</span><span class="n">Repeats</span><span class="p">:</span> <span class="n">repeats</span><span class="p">}]</span>
        <span class="k">return</span> <span class="n">synch_description</span>

    <span class="k">def</span> <span class="nf">get_synch_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_synch_description</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_synch_description</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">,</span> <span class="s2">&quot;synch_description&quot;</span><span class="p">):</span>
            <span class="n">synch_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">synch_description</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">active_time</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">,</span> <span class="s2">&quot;integ_time&quot;</span><span class="p">)</span>
                <span class="n">repeats</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">,</span> <span class="s2">&quot;nb_points&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Macro object is missing synchronization description &quot;</span> \
                      <span class="s2">&quot;attributes&quot;</span>
                <span class="k">raise</span> <span class="n">ScanSetupError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">latency_time</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">,</span> <span class="s2">&quot;latency_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">synch_description</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_synch_description</span><span class="p">(</span><span class="n">active_time</span><span class="p">,</span> <span class="n">repeats</span><span class="p">,</span>
                                               <span class="n">latency_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_synch_description</span> <span class="o">=</span> <span class="n">synch_description</span>
        <span class="k">return</span> <span class="n">synch_description</span>

    <span class="n">synch_description</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_synch_description</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">scan_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">macro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span>
        <span class="n">measurement_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement_group</span>
        <span class="n">synch_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synch_description</span>

        <span class="n">compatible</span><span class="p">,</span> <span class="n">channels</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">is_measurement_group_compatible</span><span class="p">(</span><span class="n">measurement_group</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">compatible</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Non compatible channels are: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">channels</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Measurement group </span><span class="si">%s</span><span class="s2"> is not compatible with </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>\
                  <span class="p">(</span><span class="n">measurement_group</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="n">macro</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
            <span class="k">raise</span> <span class="n">ScanException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">theoretical_timestamps</span> <span class="o">=</span> \
            <span class="n">generate_timestamps</span><span class="p">(</span><span class="n">synch_description</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">initial_data</span> <span class="o">=</span> <span class="n">theoretical_timestamps</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Relative timestamp (dt) column contains theoretical values&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">macro</span><span class="p">,</span> <span class="s1">&#39;getHooks&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">macro</span><span class="o">.</span><span class="n">getHooks</span><span class="p">(</span><span class="s1">&#39;pre-acq&#39;</span><span class="p">):</span>
                <span class="n">hook</span><span class="p">()</span>

        <span class="k">yield</span> <span class="mi">0</span>
        <span class="n">measurement_group</span><span class="o">.</span><span class="n">setNbStarts</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">measurement_group</span><span class="o">.</span><span class="n">count_continuous</span><span class="p">(</span><span class="n">synch_description</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">value_buffer_changed</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">value_ref_buffer_changed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waiting for value buffer events to be processed&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_value_buffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join_thread_pool</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">checkPoint</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fill_missing_records</span><span class="p">()</span>
        <span class="k">yield</span> <span class="mi">100</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">macro</span><span class="p">,</span> <span class="s1">&#39;getHooks&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">macro</span><span class="o">.</span><span class="n">getHooks</span><span class="p">(</span><span class="s1">&#39;post-acq&#39;</span><span class="p">):</span>
                <span class="n">hook</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_fill_missing_records</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># fill record list with dummy records for the final padding</span>
        <span class="n">nb_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">nb_points</span>
        <span class="n">records</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">records</span><span class="p">)</span>
        <span class="n">missing_records</span> <span class="o">=</span> <span class="n">nb_points</span> <span class="o">-</span> <span class="n">records</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">initRecords</span><span class="p">(</span><span class="n">missing_records</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">with_time</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">,</span> <span class="s2">&quot;getTimeEstimation&quot;</span><span class="p">)</span>
        <span class="n">with_interval</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">,</span> <span class="s2">&quot;getIntervalEstimation&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_time</span> <span class="ow">and</span> <span class="n">with_interval</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getTimeEstimation</span><span class="p">()</span>
            <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">getIntervalEstimation</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">i</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">,</span> <span class="s2">&quot;synch_description&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;synch_description is mandatory &quot;</span>
                                 <span class="s2">&quot;to estimate&quot;</span><span class="p">)</span>
        <span class="n">synch_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">synch_description</span>
        <span class="n">time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">intervals</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">synch_description</span><span class="p">:</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">SynchParam</span><span class="o">.</span><span class="n">Delay</span><span class="p">][</span><span class="n">SynchDomain</span><span class="o">.</span><span class="n">Time</span><span class="p">]</span>
            <span class="n">time</span> <span class="o">+=</span> <span class="n">delay</span>
            <span class="n">total</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">SynchParam</span><span class="o">.</span><span class="n">Total</span><span class="p">][</span><span class="n">SynchDomain</span><span class="o">.</span><span class="n">Time</span><span class="p">]</span>
            <span class="n">repeats</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">SynchParam</span><span class="o">.</span><span class="n">Repeats</span><span class="p">]</span>
            <span class="n">time</span> <span class="o">+=</span> <span class="n">total</span> <span class="o">*</span> <span class="n">repeats</span>
            <span class="n">intervals</span> <span class="o">+=</span> <span class="n">repeats</span>
        <span class="k">return</span> <span class="n">time</span><span class="p">,</span> <span class="n">intervals</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright Except where otherwise noted, content on this site is
licensed under a Creative Commons Attribution 3.0 License

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>