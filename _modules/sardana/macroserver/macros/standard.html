

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>sardana.macroserver.macros.standard &mdash; sardana 3.0.2-alpha documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> sardana
          

          
            
            <img src="../../../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference external" href="http://www.sardana-controls.org">Home Page</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/sardana-org/sardana">Project Page</a></li>
<li class="toctree-l1"><a class="reference external" href="http://pypi.python.org/pypi/sardana">Download from PyPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana-plugins">Plugins Catalogue</a></li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana/wiki">Wiki</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">sardana</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>sardana.macroserver.macros.standard</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for sardana.macroserver.macros.standard</h1><div class="highlight"><pre>
<span></span><span class="c1">##############################################################################</span>
<span class="c1">##</span>
<span class="c1"># This file is part of Sardana</span>
<span class="c1">##</span>
<span class="c1"># http://www.sardana-controls.org/</span>
<span class="c1">##</span>
<span class="c1"># Copyright 2011 CELLS / ALBA Synchrotron, Bellaterra, Spain</span>
<span class="c1">##</span>
<span class="c1"># Sardana is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Lesser General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">##</span>
<span class="c1"># Sardana is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Lesser General Public License for more details.</span>
<span class="c1">##</span>
<span class="c1"># You should have received a copy of the GNU Lesser General Public License</span>
<span class="c1"># along with Sardana.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">##</span>
<span class="c1">##############################################################################</span>

<span class="sd">&quot;&quot;&quot;This is the standard macro module&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ct&quot;</span><span class="p">,</span> <span class="s2">&quot;mstate&quot;</span><span class="p">,</span> <span class="s2">&quot;mv&quot;</span><span class="p">,</span> <span class="s2">&quot;mvr&quot;</span><span class="p">,</span> <span class="s2">&quot;pwa&quot;</span><span class="p">,</span> <span class="s2">&quot;pwm&quot;</span><span class="p">,</span> <span class="s2">&quot;repeat&quot;</span><span class="p">,</span> <span class="s2">&quot;set_lim&quot;</span><span class="p">,</span>
           <span class="s2">&quot;set_lm&quot;</span><span class="p">,</span> <span class="s2">&quot;set_pos&quot;</span><span class="p">,</span> <span class="s2">&quot;settimer&quot;</span><span class="p">,</span> <span class="s2">&quot;uct&quot;</span><span class="p">,</span> <span class="s2">&quot;umv&quot;</span><span class="p">,</span> <span class="s2">&quot;umvr&quot;</span><span class="p">,</span> <span class="s2">&quot;wa&quot;</span><span class="p">,</span> <span class="s2">&quot;wm&quot;</span><span class="p">,</span>
           <span class="s2">&quot;tw&quot;</span><span class="p">,</span> <span class="s2">&quot;logmacro&quot;</span><span class="p">,</span> <span class="s2">&quot;newfile&quot;</span><span class="p">]</span>

<span class="n">__docformat__</span> <span class="o">=</span> <span class="s1">&#39;restructuredtext&#39;</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">taurus</span> <span class="kn">import</span> <span class="n">Device</span>
<span class="kn">from</span> <span class="nn">taurus.console.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">import</span> <span class="nn">PyTango</span>
<span class="kn">from</span> <span class="nn">PyTango</span> <span class="kn">import</span> <span class="n">DevState</span>

<span class="kn">from</span> <span class="nn">sardana.macroserver.macro</span> <span class="kn">import</span> <span class="n">Macro</span><span class="p">,</span> <span class="n">macro</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">ParamRepeat</span><span class="p">,</span> \
    <span class="n">ViewOption</span><span class="p">,</span> <span class="n">iMacro</span><span class="p">,</span> <span class="n">Hookable</span>
<span class="kn">from</span> <span class="nn">sardana.macroserver.msexception</span> <span class="kn">import</span> <span class="n">StopException</span><span class="p">,</span> <span class="n">UnknownEnv</span>
<span class="kn">from</span> <span class="nn">sardana.macroserver.scan.scandata</span> <span class="kn">import</span> <span class="n">Record</span>
<span class="kn">from</span> <span class="nn">sardana.macroserver.macro</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="c1">##########################################################################</span>
<span class="c1">#</span>
<span class="c1"># Motion related macros</span>
<span class="c1">#</span>
<span class="c1">##########################################################################</span>


<span class="k">class</span> <span class="nc">_wm</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show motor positions&quot;&quot;&quot;</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;motor_list&#39;</span><span class="p">,</span>
         <span class="n">ParamRepeat</span><span class="p">([</span><span class="s1">&#39;motor&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Motor to move&#39;</span><span class="p">]),</span>
         <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;List of motor to show&#39;</span><span class="p">],</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor_list</span><span class="p">):</span>
        <span class="n">show_dial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getViewOption</span><span class="p">(</span><span class="n">ViewOption</span><span class="o">.</span><span class="n">ShowDial</span><span class="p">)</span>
        <span class="n">show_ctrlaxis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getViewOption</span><span class="p">(</span><span class="n">ViewOption</span><span class="o">.</span><span class="n">ShowCtrlAxis</span><span class="p">)</span>
        <span class="n">pos_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getViewOption</span><span class="p">(</span><span class="n">ViewOption</span><span class="o">.</span><span class="n">PosFormat</span><span class="p">)</span>
        <span class="n">motor_width</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="n">motors</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dict(motor name: motor obj)</span>
        <span class="n">requests</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dict(motor name: request id)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dict(motor name: list of motor data)</span>
        <span class="c1"># sending asynchronous requests: neither Taurus nor Sardana extensions</span>
        <span class="c1"># allow asynchronous requests - use PyTango asynchronous request model</span>
        <span class="k">for</span> <span class="n">motor</span> <span class="ow">in</span> <span class="n">motor_list</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
            <span class="n">motors</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">motor</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">,)</span>
            <span class="k">if</span> <span class="n">show_dial</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;dialposition&#39;</span><span class="p">,)</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">read_attributes_asynch</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="n">requests</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_id</span>
            <span class="n">motor_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">motor_width</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># get additional motor information (ctrl name &amp; axis)</span>
        <span class="k">if</span> <span class="n">show_ctrlaxis</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">motor</span> <span class="ow">in</span> <span class="n">motors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ctrl_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getController</span><span class="p">(</span><span class="n">motor</span><span class="o">.</span><span class="n">controller</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
                <span class="n">axis_nb</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">motor</span><span class="p">,</span> <span class="s2">&quot;axis&quot;</span><span class="p">))</span>
                <span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">ctrl_name</span><span class="p">,</span> <span class="n">axis_nb</span><span class="p">))</span>
                <span class="n">motor_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">motor_width</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctrl_name</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis_nb</span><span class="p">))</span>
        <span class="c1"># collect asynchronous replies</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">requests</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">req2delete</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_id</span> <span class="ow">in</span> <span class="n">requests</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">motor</span> <span class="o">=</span> <span class="n">motors</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">attrs</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">read_attributes_reply</span><span class="p">(</span><span class="n">_id</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">value</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;NaN&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;dialposition&#39;</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getDialPosition</span><span class="p">()</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">req2delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">PyTango</span><span class="o">.</span><span class="n">AsynReplyNotArrived</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">except</span> <span class="n">PyTango</span><span class="o">.</span><span class="n">DevFailed</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;NaN&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">show_dial</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;NaN&#39;</span><span class="p">))</span>
                    <span class="n">req2delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Error when reading </span><span class="si">%s</span><span class="s1"> position(s)&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Details:&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="c1"># removing motors which alredy replied</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">req2delete</span><span class="p">:</span>
                <span class="n">requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># define format for numerical values</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%c</span><span class="s1">*.</span><span class="si">%d</span><span class="s1">f&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="n">motor_width</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pos_format</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%c</span><span class="s1">*.</span><span class="si">%d</span><span class="s1">f&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">pos_format</span><span class="p">))</span>
        <span class="c1"># prepare row headers and formats</span>
        <span class="n">row_headers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">t_format</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">show_ctrlaxis</span><span class="p">:</span>
            <span class="n">row_headers</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;Ctrl&#39;</span><span class="p">,</span> <span class="s1">&#39;Axis&#39;</span><span class="p">]</span>
            <span class="n">t_format</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%*s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%*s</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="n">row_headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">)</span>
        <span class="n">t_format</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_dial</span><span class="p">:</span>
            <span class="n">row_headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Dial&#39;</span><span class="p">)</span>
            <span class="n">t_format</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
        <span class="c1"># sort the data dict by keys</span>
        <span class="n">col_headers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mot_name</span><span class="p">,</span> <span class="n">mot_values</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">col_headers</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">mot_name</span><span class="p">])</span>  <span class="c1"># convert name to list</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mot_values</span><span class="p">)</span>
        <span class="c1"># create and print table</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">elem_fmt</span><span class="o">=</span><span class="n">t_format</span><span class="p">,</span>
                      <span class="n">col_head_str</span><span class="o">=</span><span class="n">col_headers</span><span class="p">,</span> <span class="n">col_head_width</span><span class="o">=</span><span class="n">motor_width</span><span class="p">,</span>
                      <span class="n">row_head_str</span><span class="o">=</span><span class="n">row_headers</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">genOutput</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_wum</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show user motor positions&quot;&quot;&quot;</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;motor_list&#39;</span><span class="p">,</span>
         <span class="n">ParamRepeat</span><span class="p">([</span><span class="s1">&#39;motor&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Motor to move&#39;</span><span class="p">]),</span>
         <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;List of motor to show&#39;</span><span class="p">],</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor_list</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_opts</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor_list</span><span class="p">):</span>
        <span class="n">motor_width</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="n">motor_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">motor_pos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">motor_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">motor_list</span><span class="p">)</span>
        <span class="n">pos_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getViewOption</span><span class="p">(</span><span class="n">ViewOption</span><span class="o">.</span><span class="n">PosFormat</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">motor</span> <span class="ow">in</span> <span class="n">motor_list</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
            <span class="n">motor_names</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">name</span><span class="p">])</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getPosition</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;NAN&#39;</span><span class="p">)</span>
            <span class="n">motor_pos</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pos</span><span class="p">,))</span>
            <span class="n">motor_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">motor_width</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

        <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%c</span><span class="s1">*.</span><span class="si">%d</span><span class="s1">f&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="n">motor_width</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pos_format</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%c</span><span class="s1">*.</span><span class="si">%d</span><span class="s1">f&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">pos_format</span><span class="p">))</span>

        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">motor_pos</span><span class="p">,</span> <span class="n">elem_fmt</span><span class="o">=</span><span class="p">[</span><span class="n">fmt</span><span class="p">],</span>
                      <span class="n">col_head_str</span><span class="o">=</span><span class="n">motor_names</span><span class="p">,</span> <span class="n">col_head_width</span><span class="o">=</span><span class="n">motor_width</span><span class="p">,</span>
                      <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">table_opts</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">genOutput</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">wu</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show all user motor positions&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_motors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findObjs</span><span class="p">(</span><span class="s1">&#39;.*&#39;</span><span class="p">,</span> <span class="n">type_class</span><span class="o">=</span><span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_opts</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nr_motors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_motors</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nr_motors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;No motor defined&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;Current positions (user) on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">execMacro</span><span class="p">(</span><span class="s1">&#39;_wum&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_motors</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">table_opts</span><span class="p">)</span>


<div class="viewcode-block" id="wa"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.wa">[docs]</a><span class="k">class</span> <span class="nc">wa</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show all motor positions&quot;&quot;&quot;</span>

    <span class="c1"># TODO: duplication of the default value definition is a workaround</span>
    <span class="c1"># for #427. See commit message cc3331a for more details.</span>
    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span>
         <span class="n">ParamRepeat</span><span class="p">([</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="s1">&#39;.*&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;a regular expression filter&#39;</span><span class="p">],</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
         <span class="p">[</span><span class="s1">&#39;.*&#39;</span><span class="p">],</span> <span class="s1">&#39;a regular expression filter&#39;</span><span class="p">],</span>
    <span class="p">]</span>

<div class="viewcode-block" id="wa.prepare"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.wa.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_motors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findObjs</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="n">type_class</span><span class="o">=</span><span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_opts</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="wa.run"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.wa.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
        <span class="n">nr_motors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_motors</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nr_motors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;No motor defined&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">show_dial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getViewOption</span><span class="p">(</span><span class="n">ViewOption</span><span class="o">.</span><span class="n">ShowDial</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_dial</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;Current positions (user, dial) on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                        <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;Current positions (user) on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                        <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execMacro</span><span class="p">(</span><span class="s1">&#39;_wm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_motors</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">table_opts</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="pwa"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.pwa">[docs]</a><span class="k">class</span> <span class="nc">pwa</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show all motor positions in a pretty table&quot;&quot;&quot;</span>

    <span class="c1"># TODO: duplication of the default value definition is a workaround</span>
    <span class="c1"># for #427. See commit message cc3331a for more details.</span>
    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span>
         <span class="n">ParamRepeat</span><span class="p">([</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="s1">&#39;.*&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;a regular expression filter&#39;</span><span class="p">],</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
         <span class="p">[</span><span class="s1">&#39;.*&#39;</span><span class="p">],</span> <span class="s1">&#39;a regular expression filter&#39;</span><span class="p">],</span>
    <span class="p">]</span>

<div class="viewcode-block" id="pwa.run"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.pwa.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execMacro</span><span class="p">(</span><span class="s1">&#39;wa&#39;</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="o">**</span><span class="n">Table</span><span class="o">.</span><span class="n">PrettyOpts</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="set_lim"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.set_lim">[docs]</a><span class="k">class</span> <span class="nc">set_lim</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets the software limits on the specified motor hello&quot;&quot;&quot;</span>
    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;motor&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Motor name&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">,</span>   <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;lower limit&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">,</span>   <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;upper limit&#39;</span><span class="p">]</span>
    <span class="p">]</span>

<div class="viewcode-block" id="set_lim.run"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.set_lim.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting user limits for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">motor</span><span class="o">.</span><span class="n">getPositionObj</span><span class="p">()</span><span class="o">.</span><span class="n">setLimits</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> limits set to </span><span class="si">%.4f</span><span class="s2"> </span><span class="si">%.4f</span><span class="s2"> (user units)&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="set_lm"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.set_lm">[docs]</a><span class="k">class</span> <span class="nc">set_lm</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets the dial limits on the specified motor&quot;&quot;&quot;</span>
    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;motor&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Motor</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Motor name&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">,</span>   <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;lower limit&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">,</span>   <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;upper limit&#39;</span><span class="p">]</span>
    <span class="p">]</span>

<div class="viewcode-block" id="set_lm.run"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.set_lm.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting dial limits for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">motor</span><span class="o">.</span><span class="n">getDialPositionObj</span><span class="p">()</span><span class="o">.</span><span class="n">setLimits</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> limits set to </span><span class="si">%.4f</span><span class="s2"> </span><span class="si">%.4f</span><span class="s2"> (dial units)&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="set_pos"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.set_pos">[docs]</a><span class="k">class</span> <span class="nc">set_pos</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets the position of the motor to the specified value&quot;&quot;&quot;</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;motor&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Motor</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Motor name&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span>   <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Position to move to&#39;</span><span class="p">]</span>
    <span class="p">]</span>

<div class="viewcode-block" id="set_pos.run"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.set_pos.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
        <span class="n">old_pos</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getPosition</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">motor</span><span class="o">.</span><span class="n">definePosition</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> reset from </span><span class="si">%.4f</span><span class="s2"> to </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">old_pos</span><span class="p">,</span> <span class="n">pos</span><span class="p">))</span></div></div>


<span class="k">class</span> <span class="nc">set_user_pos</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets the USER position of the motor to the specified value (by</span>
<span class="sd">    changing OFFSET and keeping DIAL)&quot;&quot;&quot;</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;motor&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Motor</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Motor name&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span>   <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Position to move to&#39;</span><span class="p">]</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
        <span class="n">old_pos</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getPosition</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">offset_attr</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;Offset&#39;</span><span class="p">)</span>
        <span class="n">old_offset</span> <span class="o">=</span> <span class="n">offset_attr</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">rvalue</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">new_offset</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="p">(</span><span class="n">old_pos</span> <span class="o">-</span> <span class="n">old_offset</span><span class="p">)</span>
        <span class="n">offset_attr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_offset</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> reset from </span><span class="si">%.4f</span><span class="s2"> (offset </span><span class="si">%.4f</span><span class="s2">) to </span><span class="si">%.4f</span><span class="s2"> (offset </span><span class="si">%.4f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">old_pos</span><span class="p">,</span> <span class="n">old_offset</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">new_offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<div class="viewcode-block" id="wm"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.wm">[docs]</a><span class="k">class</span> <span class="nc">wm</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show the position of the specified motors.&quot;&quot;&quot;</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;motor_list&#39;</span><span class="p">,</span>
         <span class="n">ParamRepeat</span><span class="p">([</span><span class="s1">&#39;motor&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="s1">&#39;Motor to see where it is&#39;</span><span class="p">]),</span>
         <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;List of motor to show&#39;</span><span class="p">],</span>
    <span class="p">]</span>

<div class="viewcode-block" id="wm.prepare"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.wm.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor_list</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_opts</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="wm.run"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.wm.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor_list</span><span class="p">):</span>
        <span class="n">motor_width</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">motor_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">motor_pos</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">show_dial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getViewOption</span><span class="p">(</span><span class="n">ViewOption</span><span class="o">.</span><span class="n">ShowDial</span><span class="p">)</span>
        <span class="n">show_ctrlaxis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getViewOption</span><span class="p">(</span><span class="n">ViewOption</span><span class="o">.</span><span class="n">ShowCtrlAxis</span><span class="p">)</span>
        <span class="n">pos_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getViewOption</span><span class="p">(</span><span class="n">ViewOption</span><span class="o">.</span><span class="n">PosFormat</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">motor</span> <span class="ow">in</span> <span class="n">motor_list</span><span class="p">:</span>

            <span class="n">max_len</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">show_ctrlaxis</span><span class="p">:</span>
                <span class="n">axis_nb</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">motor</span><span class="p">,</span> <span class="s2">&quot;axis&quot;</span><span class="p">)</span>
                <span class="n">ctrl_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getController</span><span class="p">(</span><span class="n">motor</span><span class="o">.</span><span class="n">controller</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
                <span class="n">max_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctrl_name</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">axis_nb</span><span class="p">)))</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
            <span class="n">max_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

            <span class="n">max_len</span> <span class="o">=</span> <span class="n">max_len</span> <span class="o">+</span> <span class="mi">5</span>
            <span class="k">if</span> <span class="n">max_len</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">:</span>
                <span class="n">max_len</span> <span class="o">=</span> <span class="mi">14</span>  <span class="c1"># Length of &#39;Not specified&#39;</span>

            <span class="n">str_fmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%c%d</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_len</span><span class="p">))</span>

            <span class="n">name</span> <span class="o">=</span> <span class="n">str_fmt</span> <span class="o">%</span> <span class="n">name</span>

            <span class="n">motor_names</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">name</span><span class="p">])</span>
            <span class="n">posObj</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getPositionObj</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">pos_format</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%c</span><span class="s1">.</span><span class="si">%d</span><span class="s1">f&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">pos_format</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">val1</span> <span class="o">=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="n">motor</span><span class="o">.</span><span class="n">getPosition</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">val1</span> <span class="o">=</span> <span class="n">str_fmt</span> <span class="o">%</span> <span class="n">val1</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">val1</span> <span class="o">=</span> <span class="n">str_fmt</span> <span class="o">%</span> <span class="n">motor</span><span class="o">.</span><span class="n">getPosition</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">val2</span> <span class="o">=</span> <span class="n">str_fmt</span> <span class="o">%</span> <span class="n">posObj</span><span class="o">.</span><span class="n">getMaxRange</span><span class="p">()</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="n">val3</span> <span class="o">=</span> <span class="n">str_fmt</span> <span class="o">%</span> <span class="n">posObj</span><span class="o">.</span><span class="n">getMinRange</span><span class="p">()</span><span class="o">.</span><span class="n">magnitude</span>

            <span class="k">if</span> <span class="n">show_ctrlaxis</span><span class="p">:</span>
                <span class="n">valctrl</span> <span class="o">=</span> <span class="n">str_fmt</span> <span class="o">%</span> <span class="p">(</span><span class="n">ctrl_name</span><span class="p">)</span>
                <span class="n">valaxis</span> <span class="o">=</span> <span class="n">str_fmt</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">axis_nb</span><span class="p">)</span>
                <span class="n">upos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="n">valctrl</span><span class="p">,</span> <span class="n">valaxis</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">val1</span><span class="p">,</span>
                                      <span class="n">val3</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">upos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">val1</span><span class="p">,</span> <span class="n">val3</span><span class="p">]))</span>
            <span class="n">pos_data</span> <span class="o">=</span> <span class="n">upos</span>
            <span class="k">if</span> <span class="n">show_dial</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">val1</span> <span class="o">=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="n">motor</span><span class="o">.</span><span class="n">getDialPosition</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">val1</span> <span class="o">=</span> <span class="n">str_fmt</span> <span class="o">%</span> <span class="n">val1</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">val1</span> <span class="o">=</span> <span class="n">str_fmt</span> <span class="o">%</span> <span class="n">motor</span><span class="o">.</span><span class="n">getDialPosition</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">dPosObj</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getDialPositionObj</span><span class="p">()</span>
                <span class="n">val2</span> <span class="o">=</span> <span class="n">str_fmt</span> <span class="o">%</span> <span class="n">dPosObj</span><span class="o">.</span><span class="n">getMaxRange</span><span class="p">()</span><span class="o">.</span><span class="n">magnitude</span>
                <span class="n">val3</span> <span class="o">=</span> <span class="n">str_fmt</span> <span class="o">%</span> <span class="n">dPosObj</span><span class="o">.</span><span class="n">getMinRange</span><span class="p">()</span><span class="o">.</span><span class="n">magnitude</span>

                <span class="n">dpos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="n">val2</span><span class="p">,</span> <span class="n">val1</span><span class="p">,</span> <span class="n">val3</span><span class="p">]))</span>
                <span class="n">pos_data</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dpos</span>

            <span class="n">motor_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_data</span><span class="p">)</span>

        <span class="n">elem_fmt</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;</span><span class="si">%*s</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%*s</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">row_head_str</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">show_ctrlaxis</span><span class="p">:</span>
            <span class="n">row_head_str</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;Ctrl&#39;</span><span class="p">,</span> <span class="s1">&#39;Axis&#39;</span><span class="p">]</span>
        <span class="n">row_head_str</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="s1">&#39; High&#39;</span><span class="p">,</span> <span class="s1">&#39; Current&#39;</span><span class="p">,</span> <span class="s1">&#39; Low&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">show_dial</span><span class="p">:</span>
            <span class="n">row_head_str</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;Dial&#39;</span><span class="p">,</span> <span class="s1">&#39; High&#39;</span><span class="p">,</span> <span class="s1">&#39; Current&#39;</span><span class="p">,</span> <span class="s1">&#39; Low&#39;</span><span class="p">]</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">motor_pos</span><span class="p">,</span> <span class="n">elem_fmt</span><span class="o">=</span><span class="n">elem_fmt</span><span class="p">,</span> <span class="n">row_head_str</span><span class="o">=</span><span class="n">row_head_str</span><span class="p">,</span>
                      <span class="n">col_head_str</span><span class="o">=</span><span class="n">motor_names</span><span class="p">,</span> <span class="n">col_head_width</span><span class="o">=</span><span class="n">motor_width</span><span class="p">,</span>
                      <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">table_opts</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">genOutput</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">wum</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show the user position of the specified motors.&quot;&quot;&quot;</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;motor_list&#39;</span><span class="p">,</span>
         <span class="n">ParamRepeat</span><span class="p">([</span><span class="s1">&#39;motor&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="s1">&#39;Motor to see where it is&#39;</span><span class="p">]),</span>
         <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;List of motor to show&#39;</span><span class="p">],</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor_list</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_opts</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor_list</span><span class="p">):</span>
        <span class="n">motor_width</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">motor_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">motor_pos</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">motor</span> <span class="ow">in</span> <span class="n">motor_list</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
            <span class="n">motor_names</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">name</span><span class="p">])</span>
            <span class="n">posObj</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getPositionObj</span><span class="p">()</span>
            <span class="n">upos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="n">posObj</span><span class="o">.</span><span class="n">getMaxRange</span><span class="p">()</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
                                  <span class="n">motor</span><span class="o">.</span><span class="n">getPosition</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                                  <span class="n">posObj</span><span class="o">.</span><span class="n">getMinRange</span><span class="p">()</span><span class="o">.</span><span class="n">magnitude</span><span class="p">]))</span>
            <span class="n">pos_data</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">upos</span>

            <span class="n">motor_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_data</span><span class="p">)</span>

        <span class="n">elem_fmt</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;</span><span class="si">%*s</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%*s</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">row_head_str</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="s1">&#39; High&#39;</span><span class="p">,</span> <span class="s1">&#39; Current&#39;</span><span class="p">,</span> <span class="s1">&#39; Low&#39;</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">motor_pos</span><span class="p">,</span> <span class="n">elem_fmt</span><span class="o">=</span><span class="n">elem_fmt</span><span class="p">,</span> <span class="n">row_head_str</span><span class="o">=</span><span class="n">row_head_str</span><span class="p">,</span>
                      <span class="n">col_head_str</span><span class="o">=</span><span class="n">motor_names</span><span class="p">,</span> <span class="n">col_head_width</span><span class="o">=</span><span class="n">motor_width</span><span class="p">,</span>
                      <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">table_opts</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">genOutput</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>


<div class="viewcode-block" id="pwm"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.pwm">[docs]</a><span class="k">class</span> <span class="nc">pwm</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show the position of the specified motors in a pretty table&quot;&quot;&quot;</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;motor_list&#39;</span><span class="p">,</span>
         <span class="n">ParamRepeat</span><span class="p">([</span><span class="s1">&#39;motor&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Motor to move&#39;</span><span class="p">]),</span>
         <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;List of motor to show&#39;</span><span class="p">],</span>
    <span class="p">]</span>

<div class="viewcode-block" id="pwm.run"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.pwm.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execMacro</span><span class="p">(</span><span class="s1">&#39;wm&#39;</span><span class="p">,</span> <span class="n">motor_list</span><span class="p">,</span> <span class="o">**</span><span class="n">Table</span><span class="o">.</span><span class="n">PrettyOpts</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="mv"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.mv">[docs]</a><span class="k">class</span> <span class="nc">mv</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Move motor(s) to the specified position(s)&quot;&quot;&quot;</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;motor_pos_list&#39;</span><span class="p">,</span>
         <span class="n">ParamRepeat</span><span class="p">([</span><span class="s1">&#39;motor&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Motor to move&#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span>   <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Position to move to&#39;</span><span class="p">]),</span>
         <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;List of motor/position pairs&#39;</span><span class="p">],</span>
    <span class="p">]</span>

<div class="viewcode-block" id="mv.run"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.mv.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor_pos_list</span><span class="p">):</span>
        <span class="n">motors</span><span class="p">,</span> <span class="n">positions</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">motor_pos_list</span><span class="p">:</span>
            <span class="n">motors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting </span><span class="si">%s</span><span class="s2"> movement to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">motion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMotion</span><span class="p">(</span><span class="n">motors</span><span class="p">)</span>
        <span class="n">state</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">motion</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">!=</span> <span class="n">DevState</span><span class="o">.</span><span class="n">ON</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Motion ended in </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">motor</span> <span class="ow">in</span> <span class="n">motors</span><span class="p">:</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">motor</span><span class="o">.</span><span class="n">information</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="mstate"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.mstate">[docs]</a><span class="k">class</span> <span class="nc">mstate</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prints the state of a motor&quot;&quot;&quot;</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;motor&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Motor to check state&#39;</span><span class="p">]]</span>

<div class="viewcode-block" id="mstate.run"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.mstate.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Motor </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">motor</span><span class="o">.</span><span class="n">stateObj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">rvalue</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="umv"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.umv">[docs]</a><span class="k">class</span> <span class="nc">umv</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Move motor(s) to the specified position(s) and update&quot;&quot;&quot;</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="n">mv</span><span class="o">.</span><span class="n">param_def</span>

<div class="viewcode-block" id="umv.prepare"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.umv.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor_pos_list</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_pos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_pos</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">motor</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">motor_pos_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_names</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">()])</span>
            <span class="n">pos</span><span class="p">,</span> <span class="n">posObj</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getPosition</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">motor</span><span class="o">.</span><span class="n">getPositionObj</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_pos</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pos</span><span class="p">])</span>
            <span class="n">posObj</span><span class="o">.</span><span class="n">subscribeEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positionChanged</span><span class="p">,</span> <span class="n">motor</span><span class="p">)</span></div>

<div class="viewcode-block" id="umv.run"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.umv.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor_pos_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_pos</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execMacro</span><span class="p">(</span><span class="s1">&#39;mv&#39;</span><span class="p">,</span> <span class="n">motor_pos_list</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">printAllPos</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">motor</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParameters</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">posObj</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getPositionObj</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">posObj</span><span class="o">.</span><span class="n">unsubscribeEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positionChanged</span><span class="p">,</span> <span class="n">motor</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">e</span>

    <span class="k">def</span> <span class="nf">positionChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_names</span><span class="o">.</span><span class="n">index</span><span class="p">([</span><span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">()])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_pos</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_pos</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">printAllPos</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">printAllPos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">motor_width</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_pos</span><span class="p">,</span> <span class="n">elem_fmt</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%*.4f</span><span class="s1">&#39;</span><span class="p">],</span>
                      <span class="n">col_head_str</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">all_names</span><span class="p">,</span> <span class="n">col_head_width</span><span class="o">=</span><span class="n">motor_width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputBlock</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">genOutput</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flushOutput</span><span class="p">()</span></div>


<div class="viewcode-block" id="mvr"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.mvr">[docs]</a><span class="k">class</span> <span class="nc">mvr</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Move motor(s) relative to the current position(s)&quot;&quot;&quot;</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;motor_disp_list&#39;</span><span class="p">,</span>
         <span class="n">ParamRepeat</span><span class="p">([</span><span class="s1">&#39;motor&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Motor to move&#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;disp&#39;</span><span class="p">,</span>  <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Relative displacement&#39;</span><span class="p">]),</span>
         <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;List of motor/displacement pairs&#39;</span><span class="p">],</span>
    <span class="p">]</span>

<div class="viewcode-block" id="mvr.run"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.mvr.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor_disp_list</span><span class="p">):</span>
        <span class="n">motor_pos_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">motor</span><span class="p">,</span> <span class="n">disp</span> <span class="ow">in</span> <span class="n">motor_disp_list</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getPosition</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot get </span><span class="si">%s</span><span class="s2"> position&quot;</span> <span class="o">%</span> <span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="n">disp</span>
            <span class="n">motor_pos_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">motor</span><span class="p">,</span> <span class="n">pos</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execMacro</span><span class="p">(</span><span class="s1">&#39;mv&#39;</span><span class="p">,</span> <span class="n">motor_pos_list</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="umvr"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.umvr">[docs]</a><span class="k">class</span> <span class="nc">umvr</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Move motor(s) relative to the current position(s) and update&quot;&quot;&quot;</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="n">mvr</span><span class="o">.</span><span class="n">param_def</span>

<div class="viewcode-block" id="umvr.run"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.umvr.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor_disp_list</span><span class="p">):</span>
        <span class="n">motor_pos_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">motor</span><span class="p">,</span> <span class="n">disp</span> <span class="ow">in</span> <span class="n">motor_disp_list</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">getPosition</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot get </span><span class="si">%s</span><span class="s2"> position&quot;</span> <span class="o">%</span> <span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="n">disp</span>
            <span class="n">motor_pos_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">motor</span><span class="p">,</span> <span class="n">pos</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execMacro</span><span class="p">(</span><span class="s1">&#39;umv&#39;</span><span class="p">,</span> <span class="n">motor_pos_list</span><span class="p">)</span></div></div>

<span class="c1"># TODO: implement tw macro with param repeats in order to be able to pass</span>
<span class="c1"># multiple motors and multiple deltas. Also allow to pass the integration time</span>
<span class="c1"># in order to execute the measurement group acquisition after each move and</span>
<span class="c1"># print the results. Basically follow the SPEC&#39;s API:</span>
<span class="c1"># https://certif.com/spec_help/tw.html</span>


<div class="viewcode-block" id="tw"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.tw">[docs]</a><span class="k">class</span> <span class="nc">tw</span><span class="p">(</span><span class="n">iMacro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tweak motor by variable delta&quot;&quot;&quot;</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;motor&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s1">&#39;Motor to move&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">,</span>   <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Amount to tweak&#39;</span><span class="p">]</span>
    <span class="p">]</span>

<div class="viewcode-block" id="tw.run"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.tw.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span>
            <span class="s2">&quot;Indicate direction with + (or p) or - (or n) or enter&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span>
            <span class="s2">&quot;new step size. Type something else (or ctrl-C) to quit.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        <span class="k">while</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">):</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">position</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">, which way? &quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">motor</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span> <span class="n">default_value</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">Type</span><span class="o">.</span><span class="n">String</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># check if the input is a new delta</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                <span class="c1"># obtain the sign of the new delta</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># convert to the common sign</span>
                <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="s2">&quot;p&quot;</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
                <span class="c1"># convert to the common sign</span>
                <span class="k">elif</span> <span class="n">a</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
                <span class="c1"># the sign is already correct, just continue</span>
                <span class="k">elif</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Typing &#39;</span><span class="si">%s</span><span class="s2">&#39; caused &#39;tw&#39; macro to stop.&quot;</span> <span class="o">%</span> <span class="n">a</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">StopException</span><span class="p">()</span>
                <span class="c1"># invert the delta if necessary</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> \
                   <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">delta</span> <span class="o">=</span> <span class="o">-</span><span class="n">delta</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="n">delta</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="n">motor</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span></div></div>


<span class="c1">##########################################################################</span>
<span class="c1">#</span>
<span class="c1"># Data acquisition related macros</span>
<span class="c1">#</span>
<span class="c1">##########################################################################</span>


<span class="k">def</span> <span class="nf">_value_to_repr</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;nodata&gt;&quot;</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span>


<span class="k">class</span> <span class="nc">_ct</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">dump_information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Elements ended acquisition with:&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">information</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>


<div class="viewcode-block" id="ct"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.ct">[docs]</a><span class="k">class</span> <span class="nc">ct</span><span class="p">(</span><span class="n">Macro</span><span class="p">,</span> <span class="n">Hookable</span><span class="p">,</span> <span class="n">_ct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Count for the specified time on the measurement group</span>
<span class="sd">       or experimental channel given as second argument</span>
<span class="sd">       (if not given the active measurement group is used)&quot;&quot;&quot;</span>

    <span class="n">hints</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;allowsHooks&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;pre-acq&#39;</span><span class="p">,</span> <span class="s1">&#39;post-acq&#39;</span><span class="p">)}</span>
    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;integ_time&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;Integration time&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;countable_elem&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Countable</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span>
         <span class="s1">&#39;Countable element e.g. MeasurementGroup or ExpChannel&#39;</span><span class="p">]</span>
    <span class="p">]</span>

<div class="viewcode-block" id="ct.prepare"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.ct.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">integ_time</span><span class="p">,</span> <span class="n">countable_elem</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">countable_elem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;ActiveMntGrp&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">UnknownEnv</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getObj</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem_name</span><span class="p">,</span> <span class="n">type_class</span><span class="o">=</span><span class="n">Type</span><span class="o">.</span><span class="n">MeasurementGroup</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem_name</span> <span class="o">=</span> <span class="n">countable_elem</span><span class="o">.</span><span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span> <span class="o">=</span> <span class="n">countable_elem</span></div>

<div class="viewcode-block" id="ct.run"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.ct.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">integ_time</span><span class="p">,</span> <span class="n">countable_elem</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Unknown countable </span><span class="si">{0}</span><span class="s1"> element. Use macro parameter or&#39;</span>
                   <span class="s1">&#39;ActiveMntGrp environment variable&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem_name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># integration time has to be accessible from with in the hooks</span>
        <span class="c1"># so declare it also instance attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integ_time</span> <span class="o">=</span> <span class="n">integ_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Counting for </span><span class="si">%s</span><span class="s2"> sec&quot;</span><span class="p">,</span> <span class="n">integ_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputDate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flushOutput</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">preAcqHook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getHooks</span><span class="p">(</span><span class="s1">&#39;pre-acq&#39;</span><span class="p">):</span>
            <span class="n">preAcqHook</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">state</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">integ_time</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">Type</span><span class="o">.</span><span class="n">MeasurementGroup</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span><span class="o">.</span><span class="n">ElementList</span>
                <span class="n">elements</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">getObj</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dump_information</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">!=</span> <span class="n">DevState</span><span class="o">.</span><span class="n">ON</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">Type</span><span class="o">.</span><span class="n">MeasurementGroup</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span><span class="o">.</span><span class="n">ElementList</span>
                <span class="n">elements</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">getObj</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dump_information</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Acquisition ended with </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">postAcqHook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getHooks</span><span class="p">(</span><span class="s1">&#39;post-acq&#39;</span><span class="p">):</span>
            <span class="n">postAcqHook</span><span class="p">()</span>

        <span class="n">names</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">Type</span><span class="o">.</span><span class="n">MeasurementGroup</span><span class="p">:</span>
            <span class="n">meas_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span>
            <span class="k">for</span> <span class="n">ch_info</span> <span class="ow">in</span> <span class="n">meas_grp</span><span class="o">.</span><span class="n">getChannelsEnabledInfo</span><span class="p">():</span>
                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ch_info</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="n">ch_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ch_info</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
                <span class="n">counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_value_to_repr</span><span class="p">(</span><span class="n">ch_data</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span>
            <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">channel</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_value_to_repr</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="c1"># to be compatible with measurement group count</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">channel</span><span class="o">.</span><span class="n">full_name</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">Record</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">counts</span><span class="p">],</span> <span class="n">row_head_str</span><span class="o">=</span><span class="n">names</span><span class="p">,</span> <span class="n">row_head_fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%*s</span><span class="s1">&#39;</span><span class="p">,</span>
                      <span class="n">col_sep</span><span class="o">=</span><span class="s1">&#39;  =  &#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">genOutput</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="uct"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.uct">[docs]</a><span class="k">class</span> <span class="nc">uct</span><span class="p">(</span><span class="n">Macro</span><span class="p">,</span> <span class="n">_ct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Count on the active measurement group and update&quot;&quot;&quot;</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;integ_time&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;Integration time&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;countable_elem&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Countable</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span>
         <span class="s1">&#39;Countable element e.g. MeasurementGroup or ExpChannel&#39;</span><span class="p">]</span>
    <span class="p">]</span>

<div class="viewcode-block" id="uct.prepare"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.uct.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">integ_time</span><span class="p">,</span> <span class="n">countable_elem</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">print_value</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">countable_elem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;ActiveMntGrp&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">UnknownEnv</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getObj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">countable_elem_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem_name</span> <span class="o">=</span> <span class="n">countable_elem</span><span class="o">.</span><span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span> <span class="o">=</span> <span class="n">countable_elem</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">Type</span><span class="o">.</span><span class="n">MeasurementGroup</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span><span class="o">.</span><span class="n">getChannelLabels</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">channel_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span><span class="o">.</span><span class="n">getChannels</span><span class="p">():</span>
                <span class="n">full_name</span> <span class="o">=</span> <span class="n">channel_info</span><span class="p">[</span><span class="s2">&quot;full_name&quot;</span><span class="p">]</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="n">Device</span><span class="p">(</span><span class="n">full_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">value</span><span class="p">])</span>
                <span class="n">valueObj</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">getValueObj_</span><span class="p">()</span>
                <span class="n">valueObj</span><span class="o">.</span><span class="n">subscribeEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counterChanged</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[[</span><span class="n">channel</span><span class="o">.</span><span class="n">getName</span><span class="p">()]]</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="n">Device</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">value</span><span class="p">])</span>
            <span class="n">valueObj</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">getValueObj_</span><span class="p">()</span>
            <span class="n">valueObj</span><span class="o">.</span><span class="n">subscribeEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counterChanged</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span></div>

<div class="viewcode-block" id="uct.run"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.uct.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">integ_time</span><span class="p">,</span> <span class="n">countable_elem</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Unknown countable </span><span class="si">{0}</span><span class="s1"> element. Use macro parameter or&#39;</span>
                   <span class="s1">&#39;ActiveMntGrp environment variable&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem_name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">print_value</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">state</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">integ_time</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">Type</span><span class="o">.</span><span class="n">MeasurementGroup</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span><span class="o">.</span><span class="n">ElementList</span>
                <span class="n">elements</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">getObj</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dump_information</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">!=</span> <span class="n">DevState</span><span class="o">.</span><span class="n">ON</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">Type</span><span class="o">.</span><span class="n">MeasurementGroup</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countable_elem</span><span class="o">.</span><span class="n">ElementList</span>
                <span class="n">elements</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">getObj</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dump_information</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Acquisition ended with </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">Record</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">printAllValues</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">:</span>
            <span class="n">valueObj</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">getValueObj_</span><span class="p">()</span>
            <span class="n">valueObj</span><span class="o">.</span><span class="n">unsubscribeEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counterChanged</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">counterChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">([</span><span class="n">channel</span><span class="o">.</span><span class="n">getName</span><span class="p">()])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_value</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isStopped</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">printAllValues</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">printAllValues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ch_width</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">elem_fmt</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%*.4f</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">col_head_str</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
                      <span class="n">col_head_width</span><span class="o">=</span><span class="n">ch_width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputBlock</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">genOutput</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flushOutput</span><span class="p">()</span></div>


<div class="viewcode-block" id="settimer"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.settimer">[docs]</a><span class="k">class</span> <span class="nc">settimer</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Defines the timer channel for the active measurement group&quot;&quot;&quot;</span>

    <span class="n">env</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ActiveMntGrp&#39;</span><span class="p">,)</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;timer&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">ExpChannel</span><span class="p">,</span>   <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Timer&#39;</span><span class="p">],</span>
    <span class="p">]</span>

<div class="viewcode-block" id="settimer.run"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.settimer.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timer</span><span class="p">):</span>
        <span class="n">mnt_grp_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;ActiveMntGrp&#39;</span><span class="p">)</span>
        <span class="n">mnt_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getObj</span><span class="p">(</span><span class="n">mnt_grp_name</span><span class="p">,</span> <span class="n">type_class</span><span class="o">=</span><span class="n">Type</span><span class="o">.</span><span class="n">MeasurementGroup</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mnt_grp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;ActiveMntGrp is not defined or has invalid value.</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;please define a valid active measurement group &#39;</span>
                       <span class="s1">&#39;before setting a timer&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">mnt_grp</span><span class="o">.</span><span class="n">getConfiguration</span><span class="p">()</span><span class="o">.</span><span class="n">setTimer</span><span class="p">(</span><span class="n">timer</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is not a valid channel in the active measurement group&quot;</span>
                <span class="o">%</span> <span class="n">timer</span><span class="p">)</span></div></div>


<span class="nd">@macro</span><span class="p">([[</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="n">ParamRepeat</span><span class="p">([</span><span class="s1">&#39;message_item&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                 <span class="s1">&#39;message item to be reported&#39;</span><span class="p">]),</span> <span class="kc">None</span><span class="p">,</span>
         <span class="s1">&#39;message to be reported&#39;</span><span class="p">]])</span>
<span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Logs a new record into the message report system (if active)&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>


<div class="viewcode-block" id="logmacro"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.logmacro">[docs]</a><span class="k">class</span> <span class="nc">logmacro</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turn on/off logging of the spock output.</span>

<span class="sd">    .. note::</span>
<span class="sd">        The logmacro class has been included in Sardana</span>
<span class="sd">        on a provisional basis. Backwards incompatible changes</span>
<span class="sd">        (up to and including its removal) may occur if</span>
<span class="sd">        deemed necessary by the core developers</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;offon&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Unset/Set logging&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Mode: 0 append, 1 new file&#39;</span><span class="p">],</span>
    <span class="p">]</span>

<div class="viewcode-block" id="logmacro.run"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.logmacro.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offon</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">offon</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setEnv</span><span class="p">(</span><span class="s1">&#39;LogMacroMode&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setEnv</span><span class="p">(</span><span class="s1">&#39;LogMacroMode&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setEnv</span><span class="p">(</span><span class="s1">&#39;LogMacro&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setEnv</span><span class="p">(</span><span class="s1">&#39;LogMacro&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="repeat"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.repeat">[docs]</a><span class="k">class</span> <span class="nc">repeat</span><span class="p">(</span><span class="n">Hookable</span><span class="p">,</span> <span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This macro executes as many repetitions of a set of macros as</span>
<span class="sd">    specified by nr parameter. The macros to be repeated can be</span>
<span class="sd">    given as parameters or as body hooks.</span>
<span class="sd">    If both are given first will be executed the ones given as</span>
<span class="sd">    parameters and then the ones given as body hooks.</span>
<span class="sd">    If nr has negative value, repetitions will be executed until you</span>
<span class="sd">    stop repeat macro.</span>

<span class="sd">    .. note::</span>
<span class="sd">        The repeat macro has been included in Sardana</span>
<span class="sd">        on a provisional basis. Backwards incompatible changes</span>
<span class="sd">        (up to and including removal of the macro) may occur if</span>
<span class="sd">        deemed necessary by the core developers.&quot;&quot;&quot;</span>

    <span class="n">hints</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;allowsHooks&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">,)}</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;nr&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Nr of iterations&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;macro_name_params&#39;</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">String</span><span class="p">,</span>
                 <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Macro name and parameters (if any)&#39;</span><span class="p">],</span>
                <span class="p">{</span><span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;List with macro name and parameters (if any)&quot;</span><span class="p">]</span>
    <span class="p">]</span>

<div class="viewcode-block" id="repeat.prepare"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.repeat.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">macro_name_params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bodyHooks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getHooks</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro_name_params</span> <span class="o">=</span> <span class="n">macro_name_params</span></div>

    <span class="k">def</span> <span class="nf">__loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkPoint</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro_name_params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">macro_cmd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_name_params</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">execMacro</span><span class="p">(</span><span class="n">macro_cmd</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bodyHook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bodyHooks</span><span class="p">:</span>
            <span class="n">bodyHook</span><span class="p">()</span>

<div class="viewcode-block" id="repeat.run"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.repeat.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">macro_name_params</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__loop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__loop</span><span class="p">()</span>
                <span class="n">progress</span> <span class="o">=</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">nr</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                <span class="k">yield</span> <span class="n">progress</span></div></div>


<div class="viewcode-block" id="newfile"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.newfile">[docs]</a><span class="k">class</span> <span class="nc">newfile</span><span class="p">(</span><span class="n">Hookable</span><span class="p">,</span> <span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Sets the ScanDir and ScanFile as well as ScanID in the environment.</span>

<span class="sd">    If ScanFilePath is only a file name, the ScanDir must be set externally</span>
<span class="sd">    via `senv ScanDir &lt;PathToScanFile&gt;` or using the %expconf. Otherwise,</span>
<span class="sd">    the path in ScanFilePath must be absolute and existing on the</span>
<span class="sd">    MacroServer host.</span>

<span class="sd">    The ScanID should be set to the value before the upcoming scan number.</span>
<span class="sd">    Default value is 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">hints</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;allowsHooks&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;post-newfile&#39;</span><span class="p">)}</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;ScanFilePath_list&#39;</span><span class="p">,</span>
         <span class="p">[[</span><span class="s1">&#39;ScanFilePath&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;(ScanDir/)ScanFile&#39;</span><span class="p">]],</span>
         <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;List of (ScanDir/)ScanFile&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;ScanID&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Scan ID&#39;</span><span class="p">],</span>
    <span class="p">]</span>

<div class="viewcode-block" id="newfile.run"><a class="viewcode-back" href="../../../../devel/api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.newfile.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ScanFilePath_list</span><span class="p">,</span> <span class="n">ScanID</span><span class="p">):</span>
        <span class="n">path_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fileName_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># traverse the repeat parameters for the ScanFilePath_list</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ScanFilePath</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ScanFilePath_list</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">ScanFilePath</span><span class="p">)</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ScanFilePath</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># first entry and no given ScanDir: check if ScanDir exists</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ScanDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;ScanDir&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">UnknownEnv</span><span class="p">:</span>
                    <span class="n">ScanDir</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ScanDir</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ScanDir</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Data is not stored until ScanDir is correctly &#39;</span>
                           <span class="s1">&#39;set! Provide ScanDir with newfile macro: &#39;</span>
                           <span class="s1">&#39;`newfile [&lt;ScanDir&gt;/&lt;ScanFile&gt;] &lt;ScanID&gt;` &#39;</span>
                           <span class="s1">&#39;or `senv ScanDir &lt;ScanDir&gt;` or with </span><span class="si">%e</span><span class="s1">xpconf&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">ScanDir</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># not first entry and no given path: use path of last iteration</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">path_list</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="c1"># relative path</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Only absolute path are allowed!&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># absolute path</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">path_list</span><span class="p">):</span>
                <span class="c1"># check if paths are equal</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Multiple paths to the data files are not allowed&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="c1"># check if folder exists</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Path </span><span class="si">%s</span><span class="s1"> does not exists on the host of the &#39;</span>
                           <span class="s1">&#39;MacroServer and has to be created in &#39;</span>
                           <span class="s1">&#39;advance.&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Path </span><span class="si">%s</span><span class="s1"> appended.&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">path_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">fileName</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No filename is given.&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">fileName</span> <span class="ow">in</span> <span class="n">fileName_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Duplicate filename </span><span class="si">%s</span><span class="s1"> is not allowed.&#39;</span> <span class="o">%</span> <span class="n">fileName</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Filename is </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">fileName</span><span class="p">)</span>
                <span class="n">fileName_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ScanID</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ScanID</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setEnv</span><span class="p">(</span><span class="s1">&#39;ScanFile&#39;</span><span class="p">,</span> <span class="n">fileName_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setEnv</span><span class="p">(</span><span class="s1">&#39;ScanDir&#39;</span><span class="p">,</span> <span class="n">path_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setEnv</span><span class="p">(</span><span class="s1">&#39;ScanID&#39;</span><span class="p">,</span> <span class="n">ScanID</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;ScanDir is</span><span class="se">\t</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">path_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ScanFile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fileName_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;ScanFile set to</span><span class="se">\t</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ScanFile</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ScanFile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;Next scan is</span><span class="se">\t</span><span class="s1">: #</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ScanID</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">postNewfileHook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getHooks</span><span class="p">(</span><span class="s1">&#39;post-newfile&#39;</span><span class="p">):</span>
            <span class="n">postNewfileHook</span><span class="p">()</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Except where otherwise noted, content on this site is
licensed under a Creative Commons Attribution 3.0 License

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>