

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>sardana.tango.macroserver.MacroServer &mdash; sardana 3.0.4-alpha documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> sardana
          

          
            
            <img src="../../../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference external" href="http://www.sardana-controls.org">Home Page</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/sardana-org/sardana">Project Page</a></li>
<li class="toctree-l1"><a class="reference external" href="http://pypi.python.org/pypi/sardana">Download from PyPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana-plugins">Plugins Catalogue</a></li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana/wiki">Wiki</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">sardana</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>sardana.tango.macroserver.MacroServer</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for sardana.tango.macroserver.MacroServer</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1">##############################################################################</span>
<span class="c1">##</span>
<span class="c1"># This file is part of Sardana</span>
<span class="c1">##</span>
<span class="c1"># http://www.sardana-controls.org/</span>
<span class="c1">##</span>
<span class="c1"># Copyright 2011 CELLS / ALBA Synchrotron, Bellaterra, Spain</span>
<span class="c1">##</span>
<span class="c1"># Sardana is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Lesser General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">##</span>
<span class="c1"># Sardana is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Lesser General Public License for more details.</span>
<span class="c1">##</span>
<span class="c1"># You should have received a copy of the GNU Lesser General Public License</span>
<span class="c1"># along with Sardana.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">##</span>
<span class="c1">##############################################################################</span>

<span class="sd">&quot;&quot;&quot;The MacroServer tango module&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">PyTango</span> <span class="kn">import</span> <span class="n">Util</span><span class="p">,</span> <span class="n">Except</span><span class="p">,</span> <span class="n">DevVoid</span><span class="p">,</span> <span class="n">DevLong</span><span class="p">,</span> <span class="n">DevString</span><span class="p">,</span> <span class="n">DevState</span><span class="p">,</span> \
    <span class="n">DevEncoded</span><span class="p">,</span> <span class="n">DevVarStringArray</span><span class="p">,</span> <span class="n">READ</span><span class="p">,</span> <span class="n">READ_WRITE</span><span class="p">,</span> <span class="n">SCALAR</span><span class="p">,</span> <span class="n">SPECTRUM</span><span class="p">,</span> <span class="n">DebugIt</span>

<span class="kn">import</span> <span class="nn">taurus</span>
<span class="kn">from</span> <span class="nn">taurus.core.util.codecs</span> <span class="kn">import</span> <span class="n">CodecFactory</span>

<span class="kn">from</span> <span class="nn">sardana</span> <span class="kn">import</span> <span class="n">State</span><span class="p">,</span> <span class="n">SardanaServer</span>
<span class="kn">from</span> <span class="nn">sardana.tango.core.SardanaDevice</span> <span class="kn">import</span> <span class="n">SardanaDevice</span><span class="p">,</span> <span class="n">SardanaDeviceClass</span>
<span class="kn">from</span> <span class="nn">sardana.macroserver.msexception</span> <span class="kn">import</span> <span class="n">MacroServerException</span>
<span class="kn">from</span> <span class="nn">sardana.macroserver.macroserver</span> <span class="kn">import</span> <span class="n">MacroServer</span> <span class="k">as</span> <span class="n">MS</span>


<div class="viewcode-block" id="MacroServer"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer">[docs]</a><span class="k">class</span> <span class="nc">MacroServer</span><span class="p">(</span><span class="n">SardanaDevice</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The MacroServer tango class&quot;&quot;&quot;</span>

    <span class="n">ElementsCache</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">EnvironmentCache</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cl</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_macro_server</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">SardanaDevice</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cl</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="MacroServer.init"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">SardanaDevice</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span> <span class="o">=</span> <span class="n">Util</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">get_ds_inst_name</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_macro_server</span> <span class="o">=</span> <span class="n">ms</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
        <span class="n">ms</span><span class="o">.</span><span class="n">add_listener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_macro_server_changed</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">macro_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_macro_server</span>

<div class="viewcode-block" id="MacroServer.delete_device"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer.delete_device">[docs]</a>    <span class="k">def</span> <span class="nf">delete_device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">SardanaDevice</span><span class="o">.</span><span class="n">delete_device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_macro_server</span><span class="o">.</span><span class="n">clear_log_report</span><span class="p">()</span>
        <span class="c1"># Workaround for bug #494.</span>
        <span class="n">factory</span> <span class="o">=</span> <span class="n">taurus</span><span class="o">.</span><span class="n">Factory</span><span class="p">(</span><span class="s2">&quot;tango&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">factory</span><span class="o">.</span><span class="n">tango_attrs</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">cleanUp</span><span class="p">()</span></div>

<div class="viewcode-block" id="MacroServer.init_device"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer.init_device">[docs]</a>    <span class="k">def</span> <span class="nf">init_device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">SardanaDevice</span><span class="o">.</span><span class="n">init_device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_change_event</span><span class="p">(</span><span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_change_event</span><span class="p">(</span><span class="s1">&#39;Status&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_change_event</span><span class="p">(</span><span class="s1">&#39;TypeList&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_change_event</span><span class="p">(</span><span class="s1">&#39;DoorList&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_change_event</span><span class="p">(</span><span class="s1">&#39;MacroList&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_change_event</span><span class="p">(</span><span class="s1">&#39;MacroLibList&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_change_event</span><span class="p">(</span><span class="s1">&#39;Elements&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_change_event</span><span class="p">(</span><span class="s1">&#39;Environment&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">dev_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_device_class</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_device_properties</span><span class="p">(</span><span class="n">dev_class</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">EnvironmentDb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EnvironmentDb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LogReportFilename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LogReportFilename</span><span class="p">)</span>

        <span class="n">macro_server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_server</span>
        <span class="n">macro_server</span><span class="o">.</span><span class="n">set_python_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PythonPath</span><span class="p">)</span>
        <span class="n">macro_server</span><span class="o">.</span><span class="n">set_max_parallel_macros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MaxParallelMacros</span><span class="p">)</span>

        <span class="c1"># if it is not possible to store/retrieve the environment from the</span>
        <span class="c1"># current path then setup a new unique path and store the environment</span>
        <span class="c1"># there forever</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">macro_server</span><span class="o">.</span><span class="n">set_environment_db</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EnvironmentDb</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to set environment DB to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">EnvironmentDb</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">tempfile</span>
            <span class="n">env_db</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(),</span>
                                  <span class="n">MacroServerClass</span><span class="o">.</span><span class="n">DefaultEnvRelDir</span><span class="p">)</span>
            <span class="n">env_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_name</span><span class="p">(</span><span class="n">env_db</span><span class="p">)</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">Util</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span>
            <span class="n">db</span><span class="o">.</span><span class="n">put_device_property</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">EnvironmentDb</span><span class="o">=</span><span class="n">env_db</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">EnvironmentDb</span> <span class="o">=</span> <span class="n">env_db</span>
            <span class="n">macro_server</span><span class="o">.</span><span class="n">set_environment_db</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EnvironmentDb</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">macro_server</span><span class="o">.</span><span class="n">set_log_report</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">LogReportFilename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LogReportFormat</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to setup log report to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">LogReportFilename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">macro_server</span><span class="o">.</span><span class="n">set_recorder_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RecorderPath</span><span class="p">)</span>
        <span class="n">macro_server</span><span class="o">.</span><span class="n">set_macro_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MacroPath</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">RConsolePort</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">rfoo.utils.rconsole</span>
                <span class="n">rfoo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">rconsole</span><span class="o">.</span><span class="n">spawn_server</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">RConsolePort</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to start rconsole&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">DevState</span><span class="o">.</span><span class="n">ON</span><span class="p">)</span></div>

<div class="viewcode-block" id="MacroServer.sardana_init_hook"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer.sardana_init_hook">[docs]</a>    <span class="k">def</span> <span class="nf">sardana_init_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro_server</span><span class="o">.</span><span class="n">set_pool_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PoolNames</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_calculate_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">util</span> <span class="o">=</span> <span class="n">Util</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">name</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;ds_name&#39;</span><span class="p">:</span> <span class="n">util</span><span class="o">.</span><span class="n">get_ds_name</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                       <span class="s1">&#39;ds_exec_name&#39;</span><span class="p">:</span> <span class="n">util</span><span class="o">.</span><span class="n">get_ds_exec_name</span><span class="p">(),</span>
                       <span class="s1">&#39;ds_inst_name&#39;</span><span class="p">:</span> <span class="n">util</span><span class="o">.</span><span class="n">get_ds_inst_name</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()}</span>

<div class="viewcode-block" id="MacroServer.on_macro_server_changed"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer.on_macro_server_changed">[docs]</a>    <span class="k">def</span> <span class="nf">on_macro_server_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt_src</span><span class="p">,</span> <span class="n">evt_type</span><span class="p">,</span> <span class="n">evt_value</span><span class="p">):</span>
        <span class="c1"># during server startup and shutdown avoid processing element</span>
        <span class="c1"># creation events</span>
        <span class="k">if</span> <span class="n">SardanaServer</span><span class="o">.</span><span class="n">server_state</span> <span class="o">!=</span> <span class="n">State</span><span class="o">.</span><span class="n">Running</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">evt_name</span> <span class="o">=</span> <span class="n">evt_type</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">multi_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_device_attr</span><span class="p">()</span>
        <span class="n">elems_attr</span> <span class="o">=</span> <span class="n">multi_attr</span><span class="o">.</span><span class="n">get_attr_by_name</span><span class="p">(</span><span class="s2">&quot;Elements&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">evt_name</span> <span class="o">==</span> <span class="s2">&quot;poolelementschanged&quot;</span><span class="p">:</span>
            <span class="c1"># force the element list cache to be rebuild next time someone reads</span>
            <span class="c1"># the element list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ElementsCache</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="n">elems_attr</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">evt_value</span><span class="o">.</span><span class="n">rvalue</span><span class="p">)</span>
            <span class="c1">#self.push_change_event(&#39;Elements&#39;, *evt_value.value)</span>
        <span class="k">elif</span> <span class="n">evt_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;elementcreated&quot;</span><span class="p">,</span> <span class="s2">&quot;elementdeleted&quot;</span><span class="p">):</span>
            <span class="c1"># force the element list cache to be rebuild next time someone reads</span>
            <span class="c1"># the element list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ElementsCache</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">elem</span> <span class="o">=</span> <span class="n">evt_value</span>

            <span class="n">value</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="s2">&quot;created&quot;</span> <span class="ow">in</span> <span class="n">evt_name</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;new&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;del&#39;</span>
            <span class="n">json_elem</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
            <span class="n">value</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_elem</span><span class="p">,</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">CodecFactory</span><span class="p">()</span><span class="o">.</span><span class="n">getCodec</span><span class="p">(</span><span class="s1">&#39;utf8_json&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="n">elems_attr</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
            <span class="c1">#self.push_change_event(&#39;Elements&#39;, *value)</span>
        <span class="k">elif</span> <span class="n">evt_name</span> <span class="o">==</span> <span class="s2">&quot;elementschanged&quot;</span><span class="p">:</span>
            <span class="c1"># force the element list cache to be rebuild next time someone reads</span>
            <span class="c1"># the element list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ElementsCache</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">ms_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_server</span><span class="o">.</span><span class="n">full_name</span>
            <span class="n">new_values</span><span class="p">,</span> <span class="n">changed_values</span><span class="p">,</span> <span class="n">deleted_values</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">evt_value</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">]:</span>
                <span class="n">json_elem</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">macro_server</span><span class="o">=</span><span class="n">ms_name</span><span class="p">)</span>
                <span class="n">new_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json_elem</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">evt_value</span><span class="p">[</span><span class="s1">&#39;change&#39;</span><span class="p">]:</span>
                <span class="n">json_elem</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">macro_server</span><span class="o">=</span><span class="n">ms_name</span><span class="p">)</span>
                <span class="n">changed_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json_elem</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">evt_value</span><span class="p">[</span><span class="s1">&#39;del&#39;</span><span class="p">]:</span>
                <span class="n">json_elem</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">macro_server</span><span class="o">=</span><span class="n">ms_name</span><span class="p">)</span>
                <span class="n">deleted_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json_elem</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">new_values</span><span class="p">,</span> <span class="s2">&quot;change&quot;</span><span class="p">:</span> <span class="n">changed_values</span><span class="p">,</span>
                     <span class="s2">&quot;del&quot;</span><span class="p">:</span> <span class="n">deleted_values</span><span class="p">}</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">CodecFactory</span><span class="p">()</span><span class="o">.</span><span class="n">getCodec</span><span class="p">(</span><span class="s1">&#39;utf8_json&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="n">elems_attr</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
            <span class="c1">#self.push_change_event(&#39;Elements&#39;, *value)</span>
        <span class="k">elif</span> <span class="n">evt_name</span> <span class="o">==</span> <span class="s2">&quot;environmentchanged&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">EnvironmentCache</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">env_attr</span> <span class="o">=</span> <span class="n">multi_attr</span><span class="o">.</span><span class="n">get_attr_by_name</span><span class="p">(</span><span class="s2">&quot;Environment&quot;</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">CodecFactory</span><span class="p">()</span><span class="o">.</span><span class="n">getCodec</span><span class="p">(</span><span class="s1">&#39;pickle&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">evt_value</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="n">env_attr</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="MacroServer.always_executed_hook"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer.always_executed_hook">[docs]</a>    <span class="k">def</span> <span class="nf">always_executed_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">read_attr_hardware</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="MacroServer.read_DoorList"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer.read_DoorList">[docs]</a>    <span class="k">def</span> <span class="nf">read_DoorList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="n">door_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_server</span><span class="o">.</span><span class="n">get_door_names</span><span class="p">()</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">door_names</span><span class="p">)</span></div>

<div class="viewcode-block" id="MacroServer.read_MacroList"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer.read_MacroList">[docs]</a>    <span class="nd">@DebugIt</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">read_MacroList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="n">macro_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_server</span><span class="o">.</span><span class="n">get_macro_names</span><span class="p">()</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">macro_names</span><span class="p">)</span></div>

<div class="viewcode-block" id="MacroServer.read_MacroLibList"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer.read_MacroLibList">[docs]</a>    <span class="k">def</span> <span class="nf">read_MacroLibList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="n">macro_lib_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_server</span><span class="o">.</span><span class="n">get_macro_lib_names</span><span class="p">()</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">macro_lib_names</span><span class="p">)</span></div>

<div class="viewcode-block" id="MacroServer.read_TypeList"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer.read_TypeList">[docs]</a>    <span class="k">def</span> <span class="nf">read_TypeList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="n">type_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_server</span><span class="o">.</span><span class="n">get_data_type_names_with_asterisc</span><span class="p">()</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">type_names</span><span class="p">)</span></div>

    <span class="c1">#@DebugIt()</span>
<div class="viewcode-block" id="MacroServer.getElements"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer.getElements">[docs]</a>    <span class="k">def</span> <span class="nf">getElements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ElementsCache</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_server</span><span class="o">.</span><span class="n">get_elements_info</span><span class="p">()</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">new</span><span class="o">=</span><span class="n">elements</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">CodecFactory</span><span class="p">()</span><span class="o">.</span><span class="n">getCodec</span><span class="p">(</span><span class="s1">&#39;utf8_json&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ElementsCache</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">value</span></div>

    <span class="c1">#@DebugIt()</span>
<div class="viewcode-block" id="MacroServer.read_Elements"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer.read_Elements">[docs]</a>    <span class="k">def</span> <span class="nf">read_Elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="n">fmt</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getElements</span><span class="p">()</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="MacroServer.is_Elements_allowed"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer.is_Elements_allowed">[docs]</a>    <span class="k">def</span> <span class="nf">is_Elements_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_type</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SardanaServer</span><span class="o">.</span><span class="n">server_state</span> <span class="o">==</span> <span class="n">State</span><span class="o">.</span><span class="n">Running</span></div>

    <span class="n">is_DoorList_allowed</span> <span class="o">=</span> \
        <span class="n">is_MacroList_allowed</span> <span class="o">=</span> \
        <span class="n">is_MacroLibList_allowed</span> <span class="o">=</span> \
        <span class="n">is_TypeList_allowed</span> <span class="o">=</span> <span class="n">is_Elements_allowed</span>

<div class="viewcode-block" id="MacroServer.GetMacroInfo"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer.GetMacroInfo">[docs]</a>    <span class="k">def</span> <span class="nf">GetMacroInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">macro_names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get macro information</span>

<span class="sd">       Returns a list of strings containing macro information.</span>
<span class="sd">       Each string is a JSON encoded.</span>

<span class="sd">       Args:</span>
<span class="sd">           macro_names (list(str)): macro(s) name(s)</span>

<span class="sd">       Returns:</span>
<span class="sd">           list(str): macro(s) information</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">macro_server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_server</span>
        <span class="n">codec</span> <span class="o">=</span> <span class="n">CodecFactory</span><span class="p">()</span><span class="o">.</span><span class="n">getCodec</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">macro</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">macro_server</span><span class="o">.</span><span class="n">get_macros</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">macro</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">macro_names</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">codec</span><span class="o">.</span><span class="n">encode</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">macro</span><span class="o">.</span><span class="n">serialize</span><span class="p">()))[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="MacroServer.ReloadMacro"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer.ReloadMacro">[docs]</a>    <span class="k">def</span> <span class="nf">ReloadMacro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">macro_names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ReloadMacro(list&lt;string&gt; macro_names):&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">macro_name</span> <span class="ow">in</span> <span class="n">macro_names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">macro_server</span><span class="o">.</span><span class="n">reload_macro</span><span class="p">(</span><span class="n">macro_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">MacroServerException</span> <span class="k">as</span> <span class="n">mse</span><span class="p">:</span>
            <span class="n">Except</span><span class="o">.</span><span class="n">throw_exception</span><span class="p">(</span><span class="n">mse</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">mse</span><span class="o">.</span><span class="n">msg</span><span class="p">,</span> <span class="s1">&#39;ReloadMacro&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;OK&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="MacroServer.ReloadMacroLib"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer.ReloadMacroLib">[docs]</a>    <span class="k">def</span> <span class="nf">ReloadMacroLib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lib_names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ReloadMacroLib(sequence&lt;string&gt; lib_names):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">lib_name</span> <span class="ow">in</span> <span class="n">lib_names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">macro_server</span><span class="o">.</span><span class="n">reload_macro_lib</span><span class="p">(</span><span class="n">lib_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">MacroServerException</span> <span class="k">as</span> <span class="n">mse</span><span class="p">:</span>
            <span class="n">Except</span><span class="o">.</span><span class="n">throw_exception</span><span class="p">(</span><span class="n">mse</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">mse</span><span class="o">.</span><span class="n">msg</span><span class="p">,</span> <span class="s1">&#39;ReloadMacroLib&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;OK&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="MacroServer.GetMacroCode"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer.GetMacroCode">[docs]</a>    <span class="k">def</span> <span class="nf">GetMacroCode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;GetMacroCode(&lt;module name&gt; [, &lt;macro name&gt;]) -&gt; full filename, code, line_nb</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_server</span><span class="o">.</span><span class="n">get_or_create_macro_lib</span><span class="p">(</span><span class="o">*</span><span class="n">argin</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ret</span><span class="p">))</span></div>

<div class="viewcode-block" id="MacroServer.SetMacroCode"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer.SetMacroCode">[docs]</a>    <span class="k">def</span> <span class="nf">SetMacroCode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argin</span><span class="p">):</span>
        <span class="n">lib_name</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="n">argin</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">auto_reload</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">auto_reload</span> <span class="o">=</span> <span class="n">argin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro_server</span><span class="o">.</span><span class="n">set_macro_lib</span><span class="p">(</span>
            <span class="n">lib_name</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">auto_reload</span><span class="o">=</span><span class="n">auto_reload</span><span class="p">)</span></div>

    <span class="c1">#@DebugIt()</span>
<div class="viewcode-block" id="MacroServer.getEnvironment"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer.getEnvironment">[docs]</a>    <span class="k">def</span> <span class="nf">getEnvironment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EnvironmentCache</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_server</span><span class="o">.</span><span class="n">get_env</span><span class="p">()</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">new</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">CodecFactory</span><span class="p">()</span><span class="o">.</span><span class="n">getCodec</span><span class="p">(</span><span class="s1">&#39;pickle&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EnvironmentCache</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="MacroServer.read_Environment"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer.read_Environment">[docs]</a>    <span class="k">def</span> <span class="nf">read_Environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="n">fmt</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEnvironment</span><span class="p">()</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="MacroServer.write_Environment"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer.write_Environment">[docs]</a>    <span class="k">def</span> <span class="nf">write_Environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get_write_value</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">CodecFactory</span><span class="p">()</span><span class="o">.</span><span class="n">getCodec</span><span class="p">(</span><span class="s1">&#39;pickle&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro_server</span><span class="o">.</span><span class="n">change_env</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="MacroServer.is_Environment_allowed"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServer.is_Environment_allowed">[docs]</a>    <span class="k">def</span> <span class="nf">is_Environment_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_type</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div></div>


<div class="viewcode-block" id="MacroServerClass"><a class="viewcode-back" href="../../../../devel/api/sardana/tango/macroserver/MacroServer.html#sardana.tango.macroserver.MacroServer.MacroServerClass">[docs]</a><span class="k">class</span> <span class="nc">MacroServerClass</span><span class="p">(</span><span class="n">SardanaDeviceClass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;MacroServer Tango class class&quot;&quot;&quot;</span>

    <span class="c1">#    Class Properties</span>
    <span class="n">class_property_list</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="n">DefaultEnvBaseDir</span> <span class="o">=</span> <span class="s2">&quot;/tmp/tango&quot;</span>
    <span class="n">DefaultEnvRelDir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(ds_exec_name)s</span><span class="s2">/</span><span class="si">%(ds_inst_name)s</span><span class="s2">/macroserver.properties&quot;</span>

    <span class="n">DefaultLogReportFormat</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(levelname)-8s</span><span class="s1"> </span><span class="si">%(asctime)s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">&#39;</span>

    <span class="c1">#    Device Properties</span>
    <span class="n">device_property_list</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;PoolNames&#39;</span><span class="p">:</span>
            <span class="p">[</span><span class="n">DevVarStringArray</span><span class="p">,</span>
             <span class="s2">&quot;Sardana device pool device names&quot;</span><span class="p">,</span>
             <span class="p">[]],</span>
        <span class="s1">&#39;MacroPath&#39;</span><span class="p">:</span>
            <span class="p">[</span><span class="n">DevVarStringArray</span><span class="p">,</span>
             <span class="s2">&quot;list of directories to search for macros (path separators &quot;</span>
             <span class="s2">&quot;can be &#39;</span><span class="se">\n</span><span class="s2">&#39; or character conventionally used by the OS to&quot;</span>
             <span class="s2">&quot;separate search path components, such as &#39;:&#39; for POSIX&quot;</span>
             <span class="s2">&quot;or &#39;;&#39; for Windows)&quot;</span><span class="p">,</span>
             <span class="p">[]],</span>
        <span class="s1">&#39;RecorderPath&#39;</span><span class="p">:</span>
            <span class="p">[</span><span class="n">DevVarStringArray</span><span class="p">,</span>
             <span class="s2">&quot;list of directories to search for recorders (path separators &quot;</span>
             <span class="s2">&quot;can be &#39;</span><span class="se">\n</span><span class="s2">&#39; or character conventionally used by the OS to&quot;</span>
             <span class="s2">&quot;separate search path components, such as &#39;:&#39; for POSIX&quot;</span>
             <span class="s2">&quot;or &#39;;&#39; for Windows)&quot;</span><span class="p">,</span>
             <span class="p">[]],</span>
        <span class="s1">&#39;PythonPath&#39;</span><span class="p">:</span>
            <span class="p">[</span><span class="n">DevVarStringArray</span><span class="p">,</span>
             <span class="s2">&quot;list of directories to be appended to sys.path at startup (path &quot;</span>
             <span class="s2">&quot;separators can be &#39;</span><span class="se">\n</span><span class="s2">&#39; or &#39;:&#39;)&quot;</span><span class="p">,</span>
             <span class="p">[]],</span>
        <span class="s1">&#39;MaxParallelMacros&#39;</span><span class="p">:</span>
            <span class="p">[</span><span class="n">DevLong</span><span class="p">,</span>
             <span class="s2">&quot;Maximum number of macros that can execute concurrently.&quot;</span><span class="p">,</span>
             <span class="p">[</span><span class="mi">10</span><span class="p">]],</span>
        <span class="s1">&#39;EnvironmentDb&#39;</span><span class="p">:</span>
            <span class="p">[</span><span class="n">DevString</span><span class="p">,</span>
             <span class="s2">&quot;The environment database (usually a plain file).&quot;</span><span class="p">,</span>
             <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DefaultEnvBaseDir</span><span class="p">,</span> <span class="n">DefaultEnvRelDir</span><span class="p">)],</span>
        <span class="s1">&#39;RConsolePort&#39;</span><span class="p">:</span>
            <span class="p">[</span><span class="n">DevLong</span><span class="p">,</span>
             <span class="s2">&quot;The rconsole port number&quot;</span><span class="p">,</span>
             <span class="kc">None</span><span class="p">],</span>
        <span class="s1">&#39;LogReportFilename&#39;</span><span class="p">:</span>
            <span class="p">[</span><span class="n">DevString</span><span class="p">,</span>
             <span class="s2">&quot;Filename (absolute) which contains user log reports [default: &quot;</span>
             <span class="s2">&quot;None, meaning don&#39;t store log report messages]. The system will &quot;</span>
             <span class="s2">&quot;save old log files by appending extensions to the filename. The &quot;</span>
             <span class="s2">&quot;extensions are date-and-time based, using the strftime &quot;</span>
             <span class="s2">&quot;format %Y-%m-</span><span class="si">%d</span><span class="s2">_%H-%M-%S or a leading portion thereof, &quot;</span>
             <span class="s2">&quot;depending on the rollover interval.&quot;</span><span class="p">,</span>
             <span class="kc">None</span><span class="p">],</span>
        <span class="s1">&#39;LogReportFormat&#39;</span><span class="p">:</span>
            <span class="p">[</span><span class="n">DevString</span><span class="p">,</span>
             <span class="s2">&quot;Log report format [default: &#39;</span><span class="si">%s</span><span class="s2">&#39;]&quot;</span> <span class="o">%</span> <span class="n">DefaultLogReportFormat</span><span class="p">,</span>
             <span class="n">DefaultLogReportFormat</span><span class="p">],</span>
        <span class="s1">&#39;LogstashHost&#39;</span><span class="p">:</span>
            <span class="p">[</span><span class="n">DevString</span><span class="p">,</span>
             <span class="s2">&quot;Hostname where Logstash runs. &quot;</span>
             <span class="s2">&quot;This property has been included in Sardana on a provisional &quot;</span>
             <span class="s2">&quot;basis. Backwards incompatible changes (up to and including &quot;</span>
             <span class="s2">&quot;its removal) may occur if deemed necessary by the &quot;</span>
             <span class="s2">&quot;core developers.&quot;</span><span class="p">,</span>
             <span class="kc">None</span><span class="p">],</span>
        <span class="s1">&#39;LogstashPort&#39;</span><span class="p">:</span>
            <span class="p">[</span><span class="n">DevLong</span><span class="p">,</span>
             <span class="s2">&quot;Port on which Logstash will listen on events [default: 12345]. &quot;</span>
             <span class="s2">&quot;This property has been included in Sardana on a provisional &quot;</span>
             <span class="s2">&quot;basis. Backwards incompatible changes (up to and including &quot;</span>
             <span class="s2">&quot;its removal) may occur if deemed necessary by the &quot;</span>
             <span class="s2">&quot;core developers.&quot;</span><span class="p">,</span>
             <span class="mi">12345</span><span class="p">],</span>
        <span class="s1">&#39;LogstashCacheDbPath&#39;</span><span class="p">:</span>
            <span class="p">[</span><span class="n">DevString</span><span class="p">,</span>
             <span class="s2">&quot;Path to the Logstash cache database [default: None]. &quot;</span>
             <span class="s2">&quot;It is advised not to use the database cache, as it may &quot;</span>
             <span class="s2">&quot;have negative effects on logging performance. See #895. &quot;</span>
             <span class="s2">&quot;This property has been included in Sardana on a provisional &quot;</span>
             <span class="s2">&quot;basis. Backwards incompatible changes (up to and including &quot;</span>
             <span class="s2">&quot;its removal) may occur if deemed necessary by the &quot;</span>
             <span class="s2">&quot;core developers.&quot;</span><span class="p">,</span>
             <span class="kc">None</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="c1">#    Command definitions</span>
    <span class="n">cmd_list</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;GetMacroInfo&#39;</span><span class="p">:</span>
            <span class="p">[[</span><span class="n">DevVarStringArray</span><span class="p">,</span> <span class="s2">&quot;Macro(s) name(s)&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="n">DevVarStringArray</span><span class="p">,</span> <span class="s2">&quot;Macro(s) description(s)&quot;</span><span class="p">]],</span>
        <span class="s1">&#39;ReloadMacro&#39;</span><span class="p">:</span>
            <span class="p">[[</span><span class="n">DevVarStringArray</span><span class="p">,</span> <span class="s2">&quot;Macro(s) name(s)&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="n">DevVarStringArray</span><span class="p">,</span> <span class="s2">&quot;[OK] if successfull or a traceback &quot;</span>
                <span class="s2">&quot;if there was a error (one string with complete traceback of &quot;</span>
                <span class="s2">&quot;each error)&quot;</span><span class="p">]],</span>
        <span class="s1">&#39;ReloadMacroLib&#39;</span><span class="p">:</span>
            <span class="p">[[</span><span class="n">DevVarStringArray</span><span class="p">,</span> <span class="s2">&quot;MacroLib(s) name(s)&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="n">DevVarStringArray</span><span class="p">,</span> <span class="s2">&quot;[OK] if successfull or a traceback &quot;</span>
                <span class="s2">&quot;if there was a error (one string with complete traceback of &quot;</span>
                <span class="s2">&quot;each error)&quot;</span><span class="p">]],</span>
        <span class="s1">&#39;GetMacroCode&#39;</span><span class="p">:</span>
            <span class="p">[[</span><span class="n">DevVarStringArray</span><span class="p">,</span> <span class="s2">&quot;&lt;MacroLib name&gt; [, &lt;Macro name&gt;]&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="n">DevVarStringArray</span><span class="p">,</span> <span class="s2">&quot;result is a sequence of 3 strings:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;&lt;full path and file name&gt;, &lt;code&gt;, &lt;line number&gt;&quot;</span><span class="p">]],</span>
        <span class="s1">&#39;SetMacroCode&#39;</span><span class="p">:</span>
            <span class="p">[[</span><span class="n">DevVarStringArray</span><span class="p">,</span> <span class="s2">&quot;&lt;MacroLib name&gt;, &lt;code&gt; [, &lt;Auto reload&gt;=True]</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- if macro lib is a simple module name:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;  - if it exists, it is overwritten, otherwise a new python &quot;</span>
                <span class="s2">&quot;file is created in the directory of the first element in &quot;</span>
                <span class="s2">&quot;the MacroPath property&quot;</span>
                <span class="s2">&quot;- if macro lib is the full path name:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;  - if path is not in the MacroPath, an exception is thrown&quot;</span>
                <span class="s2">&quot;  - if file exists it is overwritten otherwise a new file &quot;</span>
                <span class="s2">&quot;is created&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="n">DevVoid</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]],</span>
    <span class="p">}</span>

    <span class="c1">#    Attribute definitions</span>
    <span class="n">attr_list</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;DoorList&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="n">DevString</span><span class="p">,</span>  <span class="n">SPECTRUM</span><span class="p">,</span> <span class="n">READ</span><span class="p">,</span> <span class="mi">256</span><span class="p">]],</span>
        <span class="s1">&#39;MacroList&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="n">DevString</span><span class="p">,</span>  <span class="n">SPECTRUM</span><span class="p">,</span> <span class="n">READ</span><span class="p">,</span> <span class="mi">4096</span><span class="p">]],</span>
        <span class="s1">&#39;MacroLibList&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="n">DevString</span><span class="p">,</span>  <span class="n">SPECTRUM</span><span class="p">,</span> <span class="n">READ</span><span class="p">,</span> <span class="mi">1024</span><span class="p">]],</span>
        <span class="s1">&#39;TypeList&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="n">DevString</span><span class="p">,</span>  <span class="n">SPECTRUM</span><span class="p">,</span> <span class="n">READ</span><span class="p">,</span> <span class="mi">256</span><span class="p">]],</span>
        <span class="s1">&#39;Elements&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="n">DevEncoded</span><span class="p">,</span> <span class="n">SCALAR</span><span class="p">,</span>   <span class="n">READ</span><span class="p">],</span>
                     <span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s2">&quot;Elements&quot;</span><span class="p">,</span>
                      <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s2">&quot;the list of all elements &quot;</span>
                      <span class="s2">&quot;(a JSON encoded dict)&quot;</span><span class="p">,</span> <span class="p">}],</span>
        <span class="s1">&#39;Environment&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="n">DevEncoded</span><span class="p">,</span> <span class="n">SCALAR</span><span class="p">,</span> <span class="n">READ_WRITE</span><span class="p">],</span>
                        <span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Environment&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s2">&quot;The macro server environment &quot;</span>
                         <span class="s2">&quot;(a JSON encoded dict)&quot;</span><span class="p">,</span> <span class="p">}],</span>
    <span class="p">}</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright Except where otherwise noted, content on this site is
licensed under a Creative Commons Attribution 3.0 License.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>