

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>sardana.pool.poolacquisition &mdash; sardana 3.1.2-alpha documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> sardana
          

          
            
            <img src="../../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference external" href="http://www.sardana-controls.org">Home Page</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/sardana-org/sardana">Project Page</a></li>
<li class="toctree-l1"><a class="reference external" href="http://pypi.python.org/pypi/sardana">Download from PyPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana-plugins">Plugins Catalogue</a></li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana/wiki">Wiki</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">sardana</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>sardana.pool.poolacquisition</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for sardana.pool.poolacquisition</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1">##############################################################################</span>
<span class="c1">##</span>
<span class="c1"># This file is part of Sardana</span>
<span class="c1">##</span>
<span class="c1"># http://www.sardana-controls.org/</span>
<span class="c1">##</span>
<span class="c1"># Copyright 2011 CELLS / ALBA Synchrotron, Bellaterra, Spain</span>
<span class="c1">##</span>
<span class="c1"># Sardana is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Lesser General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">##</span>
<span class="c1"># Sardana is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Lesser General Public License for more details.</span>
<span class="c1">##</span>
<span class="c1"># You should have received a copy of the GNU Lesser General Public License</span>
<span class="c1"># along with Sardana.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">##</span>
<span class="c1">##############################################################################</span>

<span class="sd">&quot;&quot;&quot;This module is part of the Python Pool library. It defines the class for an</span>
<span class="sd">acquisition&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;get_acq_ctrls&quot;</span><span class="p">,</span> <span class="s2">&quot;AcquisitionState&quot;</span><span class="p">,</span> <span class="s2">&quot;AcquisitionMap&quot;</span><span class="p">,</span>
           <span class="s2">&quot;PoolCTAcquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Pool0DAcquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;PoolIORAcquisition&quot;</span><span class="p">,</span>
           <span class="s2">&quot;PoolAcquisitionHardware&quot;</span><span class="p">,</span> <span class="s2">&quot;PoolAcquisitionSoftware&quot;</span><span class="p">,</span>
           <span class="s2">&quot;PoolAcquisitionSoftwareStart&quot;</span><span class="p">]</span>

<span class="n">__docformat__</span> <span class="o">=</span> <span class="s1">&#39;restructuredtext&#39;</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="kn">from</span> <span class="nn">taurus.core.util.log</span> <span class="k">import</span> <span class="n">DebugIt</span>
<span class="kn">from</span> <span class="nn">taurus.core.util.enumeration</span> <span class="k">import</span> <span class="n">Enumeration</span>

<span class="kn">from</span> <span class="nn">sardana</span> <span class="k">import</span> <span class="n">AttrQuality</span><span class="p">,</span> <span class="n">SardanaValue</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">ElementType</span><span class="p">,</span> \
    <span class="n">TYPE_TIMERABLE_ELEMENTS</span>

<span class="kn">from</span> <span class="nn">sardana.sardanathreadpool</span> <span class="k">import</span> <span class="n">get_thread_pool</span>
<span class="kn">from</span> <span class="nn">sardana.pool</span> <span class="k">import</span> <span class="n">AcqSynch</span><span class="p">,</span> <span class="n">AcqMode</span>
<span class="kn">from</span> <span class="nn">sardana.pool.poolaction</span> <span class="k">import</span> <span class="n">ActionContext</span><span class="p">,</span> <span class="n">PoolAction</span><span class="p">,</span> \
    <span class="n">OperationContext</span>
<span class="kn">from</span> <span class="nn">sardana.pool.poolsynchronization</span> <span class="k">import</span> <span class="n">PoolSynchronization</span>

<span class="c1">#: enumeration representing possible motion states</span>
<span class="n">AcquisitionState</span> <span class="o">=</span> <span class="n">Enumeration</span><span class="p">(</span><span class="s2">&quot;AcquisitionState&quot;</span><span class="p">,</span> <span class="p">(</span>
    <span class="s2">&quot;Stopped&quot;</span><span class="p">,</span>
    <span class="c1">#    &quot;StoppedOnError&quot;,</span>
    <span class="c1">#    &quot;StoppedOnAbort&quot;,</span>
    <span class="s2">&quot;Acquiring&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Invalid&quot;</span><span class="p">))</span>

<span class="n">AS</span> <span class="o">=</span> <span class="n">AcquisitionState</span>
<span class="n">AcquiringStates</span> <span class="o">=</span> <span class="n">AS</span><span class="o">.</span><span class="n">Acquiring</span><span class="p">,</span>
<span class="n">StoppedStates</span> <span class="o">=</span> <span class="n">AS</span><span class="o">.</span><span class="n">Stopped</span><span class="p">,</span>  <span class="c1"># MS.StoppedOnError, MS.StoppedOnAbort</span>

<span class="n">AcquisitionMap</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># AS.Stopped           : State.On,</span>
    <span class="n">AS</span><span class="o">.</span><span class="n">Acquiring</span><span class="p">:</span> <span class="n">State</span><span class="o">.</span><span class="n">Moving</span><span class="p">,</span>
    <span class="n">AS</span><span class="o">.</span><span class="n">Invalid</span><span class="p">:</span> <span class="n">State</span><span class="o">.</span><span class="n">Invalid</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">is_value_error</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">SardanaValue</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">get_acq_ctrls</span><span class="p">(</span><span class="n">ctrls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts configuration controllers into acquisition controllers.</span>

<span class="sd">    Takes care about converting their internals as well.</span>

<span class="sd">    :param ctrls: sequence of configuration controllers objects</span>
<span class="sd">    :type ctrls: sardana.pool.poolmeasurementgroup.ControllerConfiguration</span>
<span class="sd">    :return: sequence of acquisition controllers</span>
<span class="sd">    :rtype: :class:`~sardana.pool.poolacquisition.AcqController`</span>

<span class="sd">    .. note::</span>
<span class="sd">        The get_acq_ctrls function has been included in Sardana</span>
<span class="sd">        on a provisional basis. Backwards incompatible changes</span>
<span class="sd">        (up to and including removal of the class) may occur if</span>
<span class="sd">        deemed necessary by the core developers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">action_ctrls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="n">ctrls</span><span class="p">:</span>
        <span class="n">action_ctrl</span> <span class="o">=</span> <span class="n">AcqController</span><span class="p">(</span><span class="n">ctrl</span><span class="p">)</span>
        <span class="n">action_ctrls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action_ctrl</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">action_ctrls</span>


<span class="k">def</span> <span class="nf">get_timerable_ctrls</span><span class="p">(</span><span class="n">ctrls</span><span class="p">,</span> <span class="n">acq_mode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts timerable configuration controllers into acquisition</span>
<span class="sd">    controllers.</span>

<span class="sd">    Take care about converting their internals as well.</span>
<span class="sd">    Take care about assigning master according to acq_mode.</span>

<span class="sd">    :param ctrls: sequence of configuration controllers objects</span>
<span class="sd">    :type ctrls: sardana.pool.poolmeasurementgroup.ControllerConfiguration</span>
<span class="sd">    :param acq_mode: acquisition mode (timer/monitor)</span>
<span class="sd">    :type acq_mode: :class:`sardana.pool.AcqMode`</span>
<span class="sd">    :return: sequence of acquisition controllers</span>
<span class="sd">    :rtype: :class:`~sardana.pool.poolacquisition.AcqController`</span>

<span class="sd">    .. note::</span>
<span class="sd">        The get_timerable_ctrls function has been included in Sardana</span>
<span class="sd">        on a provisional basis. Backwards incompatible changes</span>
<span class="sd">        (up to and including removal of the class) may occur if</span>
<span class="sd">        deemed necessary by the core developers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">action_ctrls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="n">ctrls</span><span class="p">:</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">acq_mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">master</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">acq_mode</span> <span class="ow">is</span> <span class="n">AcqMode</span><span class="o">.</span><span class="n">Timer</span><span class="p">:</span>
                <span class="n">master</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">timer</span>
            <span class="k">elif</span> <span class="n">acq_mode</span> <span class="ow">is</span> <span class="n">AcqMode</span><span class="o">.</span><span class="n">Monitor</span><span class="p">:</span>
                <span class="n">master</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">monitor</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;master&#39;</span><span class="p">:</span> <span class="n">master</span><span class="p">}</span>
        <span class="n">action_ctrl</span> <span class="o">=</span> <span class="n">AcqController</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="n">action_ctrls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action_ctrl</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">action_ctrls</span>


<span class="k">def</span> <span class="nf">get_timerable_items</span><span class="p">(</span><span class="n">ctrls</span><span class="p">,</span> <span class="n">master</span><span class="p">,</span> <span class="n">acq_mode</span><span class="o">=</span><span class="n">AcqMode</span><span class="o">.</span><span class="n">Timer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts timerable configuration items into acquisition items.</span>

<span class="sd">    The timerable items are controllers and master. Convert these into</span>
<span class="sd">    the corresponding acquisition items.</span>

<span class="sd">    Take care about converting their internals as well.</span>
<span class="sd">    Take care about assigning master according to acq_mode.</span>

<span class="sd">    :param ctrls: sequence of configuration controllers objects</span>
<span class="sd">    :type ctrls: :obj:list&lt;:class:`~sardana.pool.poolmeasurementgroup.ControllerConfiguration`&gt;  # noqa</span>
<span class="sd">    :param master: master configuration object</span>
<span class="sd">    :type master: :class:`~sardana.pool.poolmeasurementgroup.ChannelConfiguration`  # noqa</span>
<span class="sd">    :param acq_mode: acquisition mode (timer/monitor)</span>
<span class="sd">    :type acq_mode: :class:`sardana.pool.AcqMode`</span>
<span class="sd">    :return: sequence of acquisition controllers</span>
<span class="sd">    :rtype: :class:`~sardana.pool.poolacquisition.AcqController`</span>

<span class="sd">    .. note::</span>
<span class="sd">        The get_timerable_ctrls function has been included in Sardana</span>
<span class="sd">        on a provisional basis. Backwards incompatible changes</span>
<span class="sd">        (up to and including removal of the class) may occur if</span>
<span class="sd">        deemed necessary by the core developers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ctrls</span> <span class="o">=</span> <span class="n">get_timerable_ctrls</span><span class="p">(</span><span class="n">ctrls</span><span class="p">,</span> <span class="n">acq_mode</span><span class="p">)</span>
    <span class="c1"># Search master AcqConfigurationItem obj</span>
    <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="n">ctrls</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">get_channels</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">channel</span><span class="o">.</span><span class="n">configuration</span> <span class="o">==</span> <span class="n">master</span><span class="p">:</span>
                <span class="n">master</span> <span class="o">=</span> <span class="n">channel</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">ctrls</span><span class="p">,</span> <span class="n">master</span>


<span class="k">class</span> <span class="nc">ActionArgs</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>


<span class="k">class</span> <span class="nc">AcqConfigurationItem</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper for configuration item that will be used in an action.</span>

<span class="sd">    .. note::</span>
<span class="sd">        The AcqConfigurationItem function has been included in Sardana</span>
<span class="sd">        on a provisional basis. Backwards incompatible changes</span>
<span class="sd">        (up to and including removal of the class) may occur if</span>
<span class="sd">        deemed necessary by the core developers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configuration</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructs action item from a configuration item.</span>

<span class="sd">        Eventually it can be enriched with attrs.</span>

<span class="sd">        :param configuration: item configuration object</span>
<span class="sd">        :type configuration:</span>
<span class="sd">            :class:`sardana.pool.poolmeasurementgroup.ConfigurationItem`</span>
<span class="sd">        :param attrs: extra attributes to be inserted</span>
<span class="sd">        :type attrs: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configuration</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">attrs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the element associated with this item&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configuration</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configuration</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the element for this item&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configuration</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>

    <span class="n">configuration</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_configuration</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AcqController</span><span class="p">(</span><span class="n">AcqConfigurationItem</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper for controller configuration that will be used in an action.</span>

<span class="sd">    .. note::</span>
<span class="sd">        The AcqController function has been included in Sardana</span>
<span class="sd">        on a provisional basis. Backwards incompatible changes</span>
<span class="sd">        (up to and including removal of the class) may occur if</span>
<span class="sd">        deemed necessary by the core developers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configuration</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructs action controller from a configuration controller.</span>

<span class="sd">        Eventually it can be enriched with attrs.</span>

<span class="sd">        :param configuration: controller configuration object</span>
<span class="sd">        :type configuration:</span>
<span class="sd">            :class:`sardana.pool.poolmeasurementgroup.ControllerConfiguration`</span>
<span class="sd">        :param attrs: extra attributes to be inserted</span>
<span class="sd">        :type attrs: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">master</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">attrs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">master</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;master&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channels_enabled</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channels_disabled</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ch_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;controller&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">conf_channel</span> <span class="ow">in</span> <span class="n">configuration</span><span class="o">.</span><span class="n">get_channels</span><span class="p">():</span>
            <span class="n">action_channel</span> <span class="o">=</span> <span class="n">AcqConfigurationItem</span><span class="p">(</span><span class="n">conf_channel</span><span class="p">,</span> <span class="n">ch_attrs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action_channel</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">conf_channel</span> <span class="ow">in</span> <span class="n">configuration</span><span class="o">.</span><span class="n">get_channels</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_channels_enabled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action_channel</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">conf_channel</span> <span class="ow">in</span> <span class="n">configuration</span><span class="o">.</span><span class="n">get_channels</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_channels_disabled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action_channel</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">master</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">master</span> <span class="o">==</span> <span class="n">conf_channel</span><span class="p">:</span>
                <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;master&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">action_channel</span>
                <span class="n">master</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">AcqConfigurationItem</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configuration</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">enabled</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">enabled</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_channels_enabled</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_channels_disabled</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AcquisitionBaseContext</span><span class="p">(</span><span class="n">OperationContext</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">exit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pool_action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool_action</span>
        <span class="n">pool_action</span><span class="o">.</span><span class="n">_reset_ctrl_dicts</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">OperationContext</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PoolAcquisition</span><span class="p">(</span><span class="n">PoolAction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Acquisition action which is internally composed for sub-actions.</span>

<span class="sd">    Handle acquisition of experimental channels of the following types:</span>
<span class="sd">    * timerable (C/T, 1D and 2D) synchronized by software or hardware</span>
<span class="sd">    trigger/gate/start</span>
<span class="sd">    * 0D</span>

<span class="sd">    Synchronized by T/G elements or sofware synchronizer.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Acquisition&quot;</span><span class="p">):</span>
        <span class="n">PoolAction</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">zerodname</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.0DAcquisition&quot;</span>
        <span class="n">hwname</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.HardwareAcquisition&quot;</span>
        <span class="n">swname</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.SoftwareAcquisition&quot;</span>
        <span class="n">sw_start_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.SoftwareStartAcquisition&quot;</span>
        <span class="n">synchname</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.Synchronization&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq_args</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sw_start_acq_args</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq_args</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hw_acq_args</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_synch_args</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq</span> <span class="o">=</span> <span class="n">PoolAcquisitionSoftware</span><span class="p">(</span><span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">swname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sw_start_acq</span> <span class="o">=</span> <span class="n">PoolAcquisitionSoftwareStart</span><span class="p">(</span>
            <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">sw_start_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span> <span class="o">=</span> <span class="n">Pool0DAcquisition</span><span class="p">(</span><span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">zerodname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hw_acq</span> <span class="o">=</span> <span class="n">PoolAcquisitionHardware</span><span class="p">(</span><span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">hwname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_synch</span> <span class="o">=</span> <span class="n">PoolSynchronization</span><span class="p">(</span><span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">synchname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handled_first_active</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">event_received</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback executed on event of software synchronizer.</span>

<span class="sd">        Reacts on start, active, passive or end type of events</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">args</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">type_</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;state&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">t_fmt</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span>
        <span class="n">t_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">t_fmt</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> event with id: </span><span class="si">%d</span><span class="s1"> received at: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">t_str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;start&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sw_start_acq_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sw_start_acq</span><span class="o">.</span><span class="n">_wait</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sw_start_acq</span><span class="o">.</span><span class="n">_set_busy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Executing software start acquisition.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sw_start_acq</span><span class="o">.</span><span class="n">_started</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">get_thread_pool</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sw_start_acq</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_sw_start_acq</span><span class="o">.</span><span class="n">_set_ready</span><span class="p">,</span>
                                      <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_sw_start_acq_args</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
                                      <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_sw_start_acq_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span><span class="p">:</span>
            <span class="c1"># this code is not thread safe, but for the moment we assume that</span>
            <span class="c1"># only one EventGenerator will work at the same time</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handled_first_active</span><span class="p">:</span>
                <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">timeout</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handled_first_active</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq</span><span class="o">.</span><span class="n">_wait</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Skipping trigger: software acquisition is still&#39;</span>
                           <span class="s1">&#39; in progress.&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq</span><span class="o">.</span><span class="n">_set_busy</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Executing software acquisition.&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq_args</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">index</span><span class="p">})</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq</span><span class="o">.</span><span class="n">_started</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">get_thread_pool</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq</span><span class="o">.</span><span class="n">_set_ready</span><span class="p">,</span>
                                          <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq_args</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
                                          <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">_wait</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Skipping trigger: ZeroD acquisition is still in&#39;</span>
                           <span class="s1">&#39; progress.&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">_set_busy</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Executing ZeroD acquisition.&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq_args</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">index</span><span class="p">})</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">_started</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">_stopped</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">_aborted</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">_released</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">get_thread_pool</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">_set_ready</span><span class="p">,</span>
                                          <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq_args</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
                                          <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;passive&quot;</span><span class="p">:</span>
            <span class="c1"># TODO: _0d_acq_args comparison may not be necessary</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">_is_ready</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Stopping ZeroD acquisition.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">stop_action</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">acq_mode</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">synch_description</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">moveable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sw_synch_initial_domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">nb_starts</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare measurement process.</span>

<span class="sd">        Organize sub-action arguments and loads configuration parameters to</span>
<span class="sd">        the hardware controllers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq_args</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sw_start_acq_args</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq_args</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hw_acq_args</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_synch_args</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handled_first_active</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ctrls_hw</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ctrls_sw</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ctrls_sw_start</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">repetitions</span> <span class="o">=</span> <span class="n">synch_description</span><span class="o">.</span><span class="n">repetitions</span>
        <span class="n">latency</span> <span class="o">=</span> <span class="n">synch_description</span><span class="o">.</span><span class="n">passive_time</span>
        <span class="c1"># Prepare controllers synchronized by hardware</span>
        <span class="n">acq_sync_hw</span> <span class="o">=</span> <span class="p">[</span><span class="n">AcqSynch</span><span class="o">.</span><span class="n">HardwareTrigger</span><span class="p">,</span> <span class="n">AcqSynch</span><span class="o">.</span><span class="n">HardwareStart</span><span class="p">,</span>
                       <span class="n">AcqSynch</span><span class="o">.</span><span class="n">HardwareGate</span><span class="p">]</span>
        <span class="n">ctrls</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_timerable_ctrls</span><span class="p">(</span><span class="n">acq_synch</span><span class="o">=</span><span class="n">acq_sync_hw</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctrls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ctrls_hw</span> <span class="o">=</span> <span class="n">get_timerable_ctrls</span><span class="p">(</span><span class="n">ctrls</span><span class="p">,</span> <span class="n">acq_mode</span><span class="p">)</span>
            <span class="n">hw_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrls_hw</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">repetitions</span><span class="p">,</span> <span class="n">latency</span><span class="p">)</span>
            <span class="n">hw_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">hw_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hw_acq_args</span> <span class="o">=</span> <span class="n">ActionArgs</span><span class="p">(</span><span class="n">hw_args</span><span class="p">,</span> <span class="n">hw_kwargs</span><span class="p">)</span>

        <span class="c1"># Prepare controllers synchronized by software Trigger and Gate</span>
        <span class="n">acq_sync_sw</span> <span class="o">=</span> <span class="p">[</span><span class="n">AcqSynch</span><span class="o">.</span><span class="n">SoftwareGate</span><span class="p">,</span> <span class="n">AcqSynch</span><span class="o">.</span><span class="n">SoftwareTrigger</span><span class="p">]</span>
        <span class="n">ctrls</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_timerable_ctrls</span><span class="p">(</span><span class="n">acq_synch</span><span class="o">=</span><span class="n">acq_sync_sw</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctrls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">acq_mode</span> <span class="ow">is</span> <span class="n">AcqMode</span><span class="o">.</span><span class="n">Timer</span><span class="p">:</span>
                <span class="n">master</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_master_timer_software</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">acq_mode</span> <span class="ow">is</span> <span class="n">AcqMode</span><span class="o">.</span><span class="n">Monitor</span><span class="p">:</span>
                <span class="n">master</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_master_monitor_software</span><span class="p">()</span>

            <span class="n">ctrls_sw</span><span class="p">,</span> <span class="n">master_sw</span> <span class="o">=</span> <span class="n">get_timerable_items</span><span class="p">(</span><span class="n">ctrls</span><span class="p">,</span> <span class="n">master</span><span class="p">,</span> <span class="n">acq_mode</span><span class="p">)</span>

            <span class="n">sw_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrls_sw</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">master_sw</span><span class="p">)</span>
            <span class="n">sw_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;synch&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
            <span class="n">sw_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq_args</span> <span class="o">=</span> <span class="n">ActionArgs</span><span class="p">(</span><span class="n">sw_args</span><span class="p">,</span> <span class="n">sw_kwargs</span><span class="p">)</span>

        <span class="c1"># Prepare controllers synchronized by software Start</span>
        <span class="n">ctrls</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_timerable_ctrls</span><span class="p">(</span><span class="n">acq_synch</span><span class="o">=</span><span class="n">AcqSynch</span><span class="o">.</span><span class="n">SoftwareStart</span><span class="p">,</span>
                                           <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctrls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">acq_mode</span> <span class="ow">is</span> <span class="n">AcqMode</span><span class="o">.</span><span class="n">Timer</span><span class="p">:</span>
                <span class="n">master</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_master_timer_software_start</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">acq_mode</span> <span class="ow">is</span> <span class="n">AcqMode</span><span class="o">.</span><span class="n">Monitor</span><span class="p">:</span>
                <span class="n">master</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_master_monitor_software_start</span><span class="p">()</span>

            <span class="n">ctrls_sw_start</span><span class="p">,</span> <span class="n">master_sw_start</span> <span class="o">=</span> <span class="n">get_timerable_items</span><span class="p">(</span><span class="n">ctrls</span><span class="p">,</span>
                                                                  <span class="n">master</span><span class="p">,</span>
                                                                  <span class="n">acq_mode</span><span class="p">)</span>
            <span class="n">sw_start_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrls_sw_start</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">master_sw_start</span><span class="p">,</span>
                             <span class="n">repetitions</span><span class="p">,</span> <span class="n">latency</span><span class="p">)</span>
            <span class="n">sw_start_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;synch&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
            <span class="n">sw_start_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sw_start_acq_args</span> <span class="o">=</span> <span class="n">ActionArgs</span><span class="p">(</span><span class="n">sw_start_args</span><span class="p">,</span>
                                                 <span class="n">sw_start_kwargs</span><span class="p">)</span>

        <span class="c1"># Prepare 0D controllers</span>
        <span class="n">ctrls</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_zerod_ctrls</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctrls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ctrls_acq_0d</span> <span class="o">=</span> <span class="n">get_acq_ctrls</span><span class="p">(</span><span class="n">ctrls</span><span class="p">)</span>
            <span class="n">zerod_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrls_acq_0d</span><span class="p">,)</span>
            <span class="n">zerod_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;synch&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
            <span class="n">zerod_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq_args</span> <span class="o">=</span> <span class="n">ActionArgs</span><span class="p">(</span><span class="n">zerod_args</span><span class="p">,</span> <span class="n">zerod_kwargs</span><span class="p">)</span>

        <span class="c1"># Prepare synchronizer controllers</span>
        <span class="n">ctrls</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_synch_ctrls</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ctrls_synch</span> <span class="o">=</span> <span class="n">get_acq_ctrls</span><span class="p">(</span><span class="n">ctrls</span><span class="p">)</span>
        <span class="n">synch_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrls_synch</span><span class="p">,</span> <span class="n">synch_description</span><span class="p">)</span>
        <span class="n">synch_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;moveable&#39;</span><span class="p">:</span> <span class="n">moveable</span><span class="p">,</span>
                        <span class="s1">&#39;sw_synch_initial_domain&#39;</span><span class="p">:</span> <span class="n">sw_synch_initial_domain</span><span class="p">}</span>
        <span class="n">synch_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_synch_args</span> <span class="o">=</span> <span class="n">ActionArgs</span><span class="p">(</span><span class="n">synch_args</span><span class="p">,</span> <span class="n">synch_kwargs</span><span class="p">)</span>

        <span class="c1"># Load the configuration to the timerable controllers</span>
        <span class="c1"># TODO: apply the configuration only if necessary</span>
        <span class="c1"># Checking only the &quot;changed&quot; flag is not enough, one needs to check</span>
        <span class="c1"># if the controllers were not used with different measurement groups</span>
        <span class="c1"># configurations meanwhile (see: sardana-org/sardana#1171) in this</span>
        <span class="c1"># case the configuration must be applied even if it was not changed</span>
        <span class="c1"># if config.changed:</span>
        <span class="n">ctrls</span> <span class="o">=</span> <span class="n">ctrls_hw</span> <span class="o">+</span> <span class="n">ctrls_sw_start</span> <span class="o">+</span> <span class="n">ctrls_sw</span>

        <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="n">ctrls</span><span class="p">:</span>
            <span class="n">pool_ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">element</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">is_online</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;The controller </span><span class="si">{0}</span><span class="s1"> is &#39;</span>
                                   <span class="s1">&#39;offline&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pool_ctrl</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">set_ctrl_par</span><span class="p">(</span><span class="s1">&#39;acquisition_mode&#39;</span><span class="p">,</span> <span class="n">acq_mode</span><span class="p">)</span>
            <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">operator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_element</span>
            <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">set_ctrl_par</span><span class="p">(</span><span class="s1">&#39;timer&#39;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">axis</span><span class="p">)</span>
            <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">set_ctrl_par</span><span class="p">(</span><span class="s1">&#39;monitor&#39;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">axis</span><span class="p">)</span>
            <span class="n">synch</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_acq_synch_by_controller</span><span class="p">(</span><span class="n">pool_ctrl</span><span class="p">)</span>
            <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">set_ctrl_par</span><span class="p">(</span><span class="s1">&#39;synchronization&#39;</span><span class="p">,</span> <span class="n">synch</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">is_referable</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">get_channels</span><span class="p">():</span>
                    <span class="n">value_ref_enabled</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">value_ref_enabled</span>
                    <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">set_axis_par</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span>
                                           <span class="s2">&quot;value_ref_enabled&quot;</span><span class="p">,</span>
                                           <span class="n">value_ref_enabled</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">value_ref_enabled</span><span class="p">:</span>
                        <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">set_axis_par</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span>
                                               <span class="s2">&quot;value_ref_pattern&quot;</span><span class="p">,</span>
                                               <span class="n">channel</span><span class="o">.</span><span class="n">value_ref_pattern</span><span class="p">)</span>

        <span class="n">config</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Call synchronizer controllers prepare method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_synch_ctrls</span><span class="p">(</span><span class="n">ctrls_synch</span><span class="p">,</span> <span class="n">nb_starts</span><span class="p">)</span>

        <span class="c1"># Call hardware and software start controllers prepare method</span>
        <span class="n">ctrls</span> <span class="o">=</span> <span class="n">ctrls_hw</span> <span class="o">+</span> <span class="n">ctrls_sw_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_ctrls</span><span class="p">(</span><span class="n">ctrls</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">repetitions</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span>
                            <span class="n">nb_starts</span><span class="p">)</span>

        <span class="c1"># Call software controllers prepare method</span>
        <span class="n">nb_starts</span> <span class="o">=</span> <span class="n">nb_starts</span> <span class="o">*</span> <span class="n">repetitions</span>
        <span class="n">repetitions</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_ctrls</span><span class="p">(</span><span class="n">ctrls_sw</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">repetitions</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span>
                            <span class="n">nb_starts</span><span class="p">)</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_prepare_ctrls</span><span class="p">(</span><span class="n">ctrls</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">repetitions</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span> <span class="n">nb_starts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="n">ctrls</span><span class="p">:</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">axis</span>
            <span class="n">pool_ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">element</span>
            <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">ctrl</span><span class="o">.</span><span class="n">PrepareOne</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">repetitions</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span>
                                      <span class="n">nb_starts</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_prepare_synch_ctrls</span><span class="p">(</span><span class="n">ctrls</span><span class="p">,</span> <span class="n">nb_starts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="n">ctrls</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chn</span> <span class="ow">in</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">get_channels</span><span class="p">():</span>
                <span class="n">axis</span> <span class="o">=</span> <span class="n">chn</span><span class="o">.</span><span class="n">axis</span>
                <span class="n">pool_ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">element</span>
                <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">ctrl</span><span class="o">.</span><span class="n">PrepareOne</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">nb_starts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks if acquisition is running.</span>

<span class="sd">        Acquisition is runnin if any of its sub-actions is running.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sw_start_acq</span><span class="o">.</span><span class="n">is_running</span><span class="p">()</span>\
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">is_running</span><span class="p">()</span>\
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq</span><span class="o">.</span><span class="n">is_running</span><span class="p">()</span>\
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hw_acq</span><span class="o">.</span><span class="n">is_running</span><span class="p">()</span>\
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_synch</span><span class="o">.</span><span class="n">is_running</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs acquisition according to previous preparation.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elements</span><span class="p">():</span>
            <span class="n">elem</span><span class="o">.</span><span class="n">put_state</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="c1"># TODO: temporarily clear value buffers at the beginning of the</span>
            <span class="c1"># acquisition instead of doing it in the finish hook of each</span>
            <span class="c1"># acquisition sub-actions. See extensive explanation in the</span>
            <span class="c1"># constructor of PoolAcquisitionBase.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">elem</span><span class="o">.</span><span class="n">clear_value_buffer</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">elem</span><span class="o">.</span><span class="n">clear_value_ref_buffer</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># clean also the pseudo counters, even the ones that do not</span>
            <span class="c1"># participate directly in the acquisition</span>
            <span class="k">for</span> <span class="n">pseudo_elem</span> <span class="ow">in</span> <span class="n">elem</span><span class="o">.</span><span class="n">get_pseudo_elements</span><span class="p">():</span>
                <span class="n">pseudo_elem</span><span class="o">.</span><span class="n">clear_value_buffer</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hw_acq_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hw_acq</span><span class="o">.</span><span class="n">_wait</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hw_acq</span><span class="o">.</span><span class="n">_set_busy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hw_acq</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_hw_acq_args</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
                             <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_hw_acq_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span>
                             <span class="n">cb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hw_acq</span><span class="o">.</span><span class="n">_set_ready</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>\
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sw_start_acq_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>\
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_synch</span><span class="o">.</span><span class="n">add_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_synch_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_synch</span><span class="o">.</span><span class="n">_wait</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_synch</span><span class="o">.</span><span class="n">_set_busy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_synch</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_synch_args</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
                            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_synch_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span>
                            <span class="n">cb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_synch</span><span class="o">.</span><span class="n">_set_ready</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">release_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_synch</span><span class="o">.</span><span class="n">release_action</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hw_acq</span><span class="o">.</span><span class="n">release_action</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sw_start_acq</span><span class="o">.</span><span class="n">release_action</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq</span><span class="o">.</span><span class="n">release_action</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">release_action</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_action_for_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="n">elem_type</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">elem_type</span> <span class="ow">in</span> <span class="n">TYPE_TIMERABLE_ELEMENTS</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_element</span><span class="o">.</span><span class="n">configuration</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">acq_synch</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_acq_synch_by_channel</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="c1"># when configuration was not yet set and one sets the</span>
            <span class="c1"># measurement group&#39;s integration time (this may happen on Tango</span>
            <span class="c1"># device initialization when memorized attributes are set we</span>
            <span class="c1"># fallback to software acquisition</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">acq_synch</span> <span class="o">=</span> <span class="n">AcqSynch</span><span class="o">.</span><span class="n">SoftwareTrigger</span>
            <span class="k">if</span> <span class="n">acq_synch</span> <span class="ow">in</span> <span class="p">(</span><span class="n">AcqSynch</span><span class="o">.</span><span class="n">SoftwareTrigger</span><span class="p">,</span>
                             <span class="n">AcqSynch</span><span class="o">.</span><span class="n">SoftwareGate</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq</span>
            <span class="k">elif</span> <span class="n">acq_synch</span> <span class="o">==</span> <span class="n">AcqSynch</span><span class="o">.</span><span class="n">SoftwareStart</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sw_start_acq</span>
            <span class="k">elif</span> <span class="n">acq_synch</span> <span class="ow">in</span> <span class="p">(</span><span class="n">AcqSynch</span><span class="o">.</span><span class="n">HardwareTrigger</span><span class="p">,</span>
                               <span class="n">AcqSynch</span><span class="o">.</span><span class="n">HardwareGate</span><span class="p">,</span>
                               <span class="n">AcqSynch</span><span class="o">.</span><span class="n">HardwareStart</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hw_acq</span>
        <span class="k">elif</span> <span class="n">elem_type</span> <span class="o">==</span> <span class="n">ElementType</span><span class="o">.</span><span class="n">ZeroDExpChannel</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span>
        <span class="k">elif</span> <span class="n">elem_type</span> <span class="o">==</span> <span class="n">ElementType</span><span class="o">.</span><span class="n">TriggerGate</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_synch</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Could not determine action for element </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                               <span class="n">element</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clears all elements from this action&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">add_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a new element to this action.</span>

<span class="sd">        :param element: the new element to be added</span>
<span class="sd">        :type element: sardana.pool.poolelement.PoolElement&quot;&quot;&quot;</span>
        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_action_for_element</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="n">action</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Removes an element from this action. If the element is not part of</span>
<span class="sd">        this action, a ValueError is raised.</span>

<span class="sd">        :param element: the new element to be removed</span>
<span class="sd">        :type element: sardana.pool.poolelement.PoolElement</span>

<span class="sd">        :raises: ValueError&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_acq_for_element</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
            <span class="n">action</span><span class="o">.</span><span class="n">remove_element</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy_of</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a sequence of all elements involved in this action.</span>

<span class="sd">        :param copy_of: If False (default) the internal container of</span>
<span class="sd">                        elements is returned. If True, a copy of the</span>
<span class="sd">                        internal container is returned instead</span>
<span class="sd">        :type copy_of: bool</span>
<span class="sd">        :return: a sequence of all elements involved in this action.</span>
<span class="sd">        :rtype: seq&lt;sardana.pool.poolelement.PoolElement&gt;&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hw_acq</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sw_start_acq</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">get_elements</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_synch</span><span class="o">.</span><span class="n">get_elements</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">get_pool_controller_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of all controller elements involved in this action.</span>

<span class="sd">        :return: a list of all controller elements involved in this action.</span>
<span class="sd">        :rtype: list&lt;sardana.pool.poolelement.PoolController&gt;&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_list</span>

    <span class="k">def</span> <span class="nf">get_pool_controllers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dict of all controller elements involved in this action.</span>

<span class="sd">        :return: a dict of all controller elements involved in this action.</span>
<span class="sd">        :rtype: dict&lt;sardana.pool.poolelement.PoolController,</span>
<span class="sd">                seq&lt;sardana.pool.poolelement.PoolElement&gt;&gt;&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hw_acq</span><span class="o">.</span><span class="n">get_pool_controllers</span><span class="p">())</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sw_acq</span><span class="o">.</span><span class="n">get_pool_controllers</span><span class="p">())</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sw_start_acq</span><span class="o">.</span><span class="n">get_pool_controllers</span><span class="p">())</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">get_pool_controllers</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="n">pool_controllers</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_pool_controllers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">serial</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads value information of all elements involved in this action</span>

<span class="sd">        :param ret: output map parameter that should be filled with value</span>
<span class="sd">                    information. If None is given (default), a new map is</span>
<span class="sd">                    created an returned</span>
<span class="sd">        :type ret: dict</span>
<span class="sd">        :param serial: If False (default) perform controller HW value requests</span>
<span class="sd">                       in parallel. If True, access is serialized.</span>
<span class="sd">        :type serial: bool</span>
<span class="sd">        :return: a map containing value information per element</span>
<span class="sd">        :rtype: dict&lt;:class:~`sardana.pool.poolelement.PoolElement`,</span>
<span class="sd">                     :class:~`sardana.sardanavalue.SardanaValue`&gt;&quot;&quot;&quot;</span>
        <span class="c1"># TODO: this is broken now - fix it</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ct_acq</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">ret</span><span class="p">,</span> <span class="n">serial</span><span class="o">=</span><span class="n">serial</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_0d_acq</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">ret</span><span class="p">,</span> <span class="n">serial</span><span class="o">=</span><span class="n">serial</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ret</span>


<span class="k">class</span> <span class="nc">PoolAcquisitionBase</span><span class="p">(</span><span class="n">PoolAction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for sub-acquisition.</span>

<span class="sd">    .. note::</span>
<span class="sd">        The PoolAcquisitionBase class has been included in Sardana</span>
<span class="sd">        on a provisional basis. Backwards incompatible changes</span>
<span class="sd">        (up to and including removal of the module) may occur if</span>
<span class="sd">        deemed necessary by the core developers.</span>

<span class="sd">    .. todo: Think of moving the ready/busy mechanism to PoolAction</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">PoolAction</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ready</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ready</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_is_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ready</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ready</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ready</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_is_busy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ready</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_busy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ready</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">PoolAcquisitionTimerable</span><span class="p">(</span><span class="n">PoolAcquisitionBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for acquisitions of timerable channels.</span>

<span class="sd">     Implements a generic start_action method. action_loop method must be</span>
<span class="sd">     implemented by the sub-class.</span>

<span class="sd">    .. note::</span>
<span class="sd">        The PoolAcquisitionTimerable class has been included in Sardana</span>
<span class="sd">        on a provisional basis. Backwards incompatible changes</span>
<span class="sd">        (up to and including removal of the module) may occur if</span>
<span class="sd">        deemed necessary by the core developers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">OperationContextClass</span> <span class="o">=</span> <span class="n">AcquisitionBaseContext</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">PoolAcquisitionBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nb_states_per_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_acq_sleep_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict_loop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict_ref</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict_value</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># TODO: for the moment we can not clear value buffers at the end of</span>
        <span class="c1"># the acquisition. This is because of the pseudo counters that are</span>
        <span class="c1"># based on channels synchronized by hardware and software.</span>
        <span class="c1"># These two acquisition actions finish at different moment so the</span>
        <span class="c1"># pseudo counter will loose the value buffer of some of its physicals</span>
        <span class="c1"># if we clear the buffer at the end.</span>
        <span class="c1"># Whenever there will be solution for that, after refactoring of the</span>
        <span class="c1"># acquisition actions, uncomment this line</span>
        <span class="c1"># self.add_finish_hook(self.clear_value_buffers, True)</span>

    <span class="k">def</span> <span class="nf">get_read_value_ref_ctrls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict_ref</span>

    <span class="k">def</span> <span class="nf">read_value_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">serial</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads value ref information of all elements involved in this action</span>

<span class="sd">        :param ret: output map parameter that should be filled with value</span>
<span class="sd">                    information. If None is given (default), a new map is</span>
<span class="sd">                    created an returned</span>
<span class="sd">        :type ret: dict</span>
<span class="sd">        :param serial: If False (default) perform controller HW value requests</span>
<span class="sd">                       in parallel. If True, access is serialized.</span>
<span class="sd">        :type serial: bool</span>
<span class="sd">        :return: a map containing value information per element</span>
<span class="sd">        :rtype: dict&lt;:class:~`sardana.pool.poolelement.PoolElement`,</span>
<span class="sd">                     (value object, Exception or None)&gt;&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">ActionContext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_read_value_ref</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">ret</span><span class="p">,</span> <span class="n">serial</span><span class="o">=</span><span class="n">serial</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">raw_read_value_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">serial</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;**Unsafe**. Reads value ref information of all referable elements</span>
<span class="sd">        involved in this acquisition</span>

<span class="sd">        :param ret: output map parameter that should be filled with value</span>
<span class="sd">                    information. If None is given (default), a new map is</span>
<span class="sd">                    created an returned</span>
<span class="sd">        :type ret: dict</span>
<span class="sd">        :param serial: If False (default) perform controller HW value requests</span>
<span class="sd">                       in parallel. If True, access is serialized.</span>
<span class="sd">        :type serial: bool</span>
<span class="sd">        :return: a map containing value information per element</span>
<span class="sd">        :rtype: dict&lt;:class:~`sardana.pool.poolelement.PoolElement,</span>
<span class="sd">                :class:`sardana.sardanavalue.SardanaValue`&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_read_value_ref_concurrent</span>
        <span class="k">if</span> <span class="n">serial</span><span class="p">:</span>
            <span class="n">read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_read_value_ref_serial</span>

        <span class="n">value_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_info</span>

        <span class="k">with</span> <span class="n">value_info</span><span class="p">:</span>
            <span class="n">value_info</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_read_value_ref_ctrls</span><span class="p">()))</span>
            <span class="n">read</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
            <span class="n">value_info</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_raw_read_value_ref_serial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ret</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal method. Read value ref in a serial mode&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pool_ctrl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_read_value_ref_ctrls</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raw_read_ctrl_value_ref</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">pool_ctrl</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_raw_read_value_ref_concurrent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ret</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal method. Read value ref in a concurrent mode&quot;&quot;&quot;</span>
        <span class="n">th_pool</span> <span class="o">=</span> <span class="n">get_thread_pool</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pool_ctrl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_read_value_ref_ctrls</span><span class="p">():</span>
            <span class="n">th_pool</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_read_ctrl_value_ref</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">pool_ctrl</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_raw_read_ctrl_value_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">pool_ctrl</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal method. Read controller value ref information and store</span>
<span class="sd">        it in ret parameter&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">axis</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict_ref</span><span class="p">[</span><span class="n">pool_ctrl</span><span class="p">]]</span>
            <span class="n">value_infos</span> <span class="o">=</span> <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">raw_read_axis_value_refs</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value_infos</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_value_info</span><span class="o">.</span><span class="n">finish_one</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_process_value_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">final</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">final_str</span> <span class="o">=</span> <span class="s2">&quot;final &quot;</span> <span class="k">if</span> <span class="n">final</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_value_error</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Loop </span><span class="si">%s</span><span class="s2">read value error for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">final_str</span><span class="p">,</span>
                                                           <span class="n">acquirable</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Details: &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="o">*</span><span class="n">value</span><span class="o">.</span><span class="n">exc_info</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">acquirable</span><span class="o">.</span><span class="n">put_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">acquirable</span><span class="o">.</span><span class="n">extend_value_buffer</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_value_ref_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">value_ref</span><span class="p">,</span> <span class="n">final</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">final_str</span> <span class="o">=</span> <span class="s2">&quot;final &quot;</span> <span class="k">if</span> <span class="n">final</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_value_error</span><span class="p">(</span><span class="n">value_ref</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Loop read ref </span><span class="si">%s</span><span class="s2">value error for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                       <span class="p">(</span><span class="n">final_str</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Details: &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="o">*</span><span class="n">value_ref</span><span class="o">.</span><span class="n">exc_info</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">acquirable</span><span class="o">.</span><span class="n">put_value_ref</span><span class="p">(</span><span class="n">value_ref</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">acquirable</span><span class="o">.</span><span class="n">extend_value_ref_buffer</span><span class="p">(</span><span class="n">value_ref</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">in_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines if we are in acquisition or if the acquisition has ended</span>
<span class="sd">        based on the current unit trigger modes and states returned by the</span>
<span class="sd">        controller(s)</span>

<span class="sd">        :param states: a map containing state information as returned by</span>
<span class="sd">                       read_state_info</span>
<span class="sd">        :type states: dict&lt;PoolElement, State&gt;</span>
<span class="sd">        :return: returns True if in acquisition or False otherwise</span>
<span class="sd">        :rtype: bool&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_in_action</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@DebugIt</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">start_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctrls</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">master</span><span class="p">,</span> <span class="n">repetitions</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span>
                     <span class="n">index</span><span class="p">,</span> <span class="n">acq_sleep_time</span><span class="p">,</span> <span class="n">nb_states_per_value</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares everything for acquisition and starts it</span>
<span class="sd">        :param ctrls: List of enabled pool acquisition controllers</span>
<span class="sd">        :type ctrls: list</span>
<span class="sd">        :param value: integration time/monitor counts</span>
<span class="sd">        :type value: float/int or seq&lt;float/int&gt;</span>
<span class="sd">        :param repetitions: repetitions</span>
<span class="sd">        :type repetitions: int</span>
<span class="sd">        :param latency:</span>
<span class="sd">        :type latency: float</span>
<span class="sd">        :param master: master channel is the last one to start</span>
<span class="sd">        :type master: Channel</span>
<span class="sd">        :param index:</span>
<span class="sd">        :type index: int</span>
<span class="sd">        :param acq_sleep_time: sleep time between state queries</span>
<span class="sd">        :type acq_sleep_time: float</span>
<span class="sd">        :param nb_states_per_value: how many state queries between readouts</span>
<span class="sd">        :type nb_states_per_value: int</span>
<span class="sd">        :param args:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aborted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stopped</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_released</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="n">index</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_acq_sleep_time</span> <span class="o">=</span> <span class="n">acq_sleep_time</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acq_sleep_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_acq_sleep_time</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">acq_loop_sleep_time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_nb_states_per_value</span> <span class="o">=</span> <span class="n">nb_states_per_value</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nb_states_per_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nb_states_per_value</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">acq_loop_states_per_value</span>

        <span class="c1"># make sure the controller which has the master channel is the last to</span>
        <span class="c1"># be called</span>
        <span class="k">if</span> <span class="n">master</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ctrls</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">master</span><span class="o">.</span><span class="n">controller</span><span class="p">)</span>
            <span class="n">ctrls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">master</span><span class="o">.</span><span class="n">controller</span><span class="p">)</span>

        <span class="c1"># controllers that will be read during the action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_pool_ctrl_dict_loop</span><span class="p">(</span><span class="n">ctrls</span><span class="p">)</span>
        <span class="c1"># split controllers to read value and value reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_split_ctrl</span><span class="p">(</span><span class="n">ctrls</span><span class="p">)</span>
        <span class="c1"># channels that are acquired (only enabled)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">repetitions</span><span class="p">,</span> <span class="n">latency</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">axis</span>
            <span class="n">pool_ctrl</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">controller</span>
            <span class="n">ctrl</span> <span class="o">=</span> <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">ctrl</span>
            <span class="n">ctrl</span><span class="o">.</span><span class="n">PreLoadAll</span><span class="p">()</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">PreLoadOne</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">repetitions</span><span class="p">,</span> <span class="n">latency</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.PreLoadOne(</span><span class="si">%d</span><span class="s2">) returned False&quot;</span> <span class="o">%</span>
                       <span class="p">(</span><span class="n">pool_ctrl</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">axis</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">ctrl</span><span class="o">.</span><span class="n">LoadOne</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">repetitions</span><span class="p">,</span> <span class="n">latency</span><span class="p">)</span>
            <span class="n">ctrl</span><span class="o">.</span><span class="n">LoadAll</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">ActionContext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># PreLoadAll, PreLoadOne, LoadOne and LoadAll</span>
            <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="n">ctrls</span><span class="p">:</span>
                <span class="c1"># TODO find solution for master now sardana only use timer</span>
                <span class="n">load</span><span class="p">(</span><span class="n">ctrl</span><span class="o">.</span><span class="n">timer</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">repetitions</span><span class="p">,</span> <span class="n">latency</span><span class="p">)</span>

            <span class="c1"># TODO: remove when the action allows to use tango attributes</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ctrls</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__tango__&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># PreStartAll on all enabled controllers</span>
            <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="n">ctrls</span><span class="p">:</span>
                <span class="n">pool_ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">element</span>
                <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">ctrl</span><span class="o">.</span><span class="n">PreStartAll</span><span class="p">()</span>

            <span class="c1"># PreStartOne &amp; StartOne on all enabled elements</span>
            <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="n">ctrls</span><span class="p">:</span>
                <span class="n">channels</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">get_channels</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># make sure that the master timer/monitor is started as</span>
                <span class="c1"># the last one</span>
                <span class="n">channels</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ctrl</span><span class="o">.</span><span class="n">master</span><span class="p">)</span>
                <span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ctrl</span><span class="o">.</span><span class="n">master</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
                    <span class="n">axis</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">axis</span>
                    <span class="n">pool_ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">element</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">ctrl</span><span class="o">.</span><span class="n">PreStartOne</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.PreStartOne(</span><span class="si">%d</span><span class="s2">) returns False&quot;</span> <span class="o">%</span>
                               <span class="p">(</span><span class="n">ctrl</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">axis</span><span class="p">))</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">pool_ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">element</span>
                        <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">ctrl</span><span class="o">.</span><span class="n">StartOne</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">channel</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">State</span><span class="o">.</span><span class="n">Fault</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.StartOne(</span><span class="si">%d</span><span class="s2">) failed&quot;</span> <span class="o">%</span>
                               <span class="p">(</span><span class="n">ctrl</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">axis</span><span class="p">))</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>

            <span class="c1"># set the state of all elements to  and inform their listeners</span>
            <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">:</span>
                <span class="n">channel</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">State</span><span class="o">.</span><span class="n">Moving</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># StartAll on all enabled controllers</span>
            <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="n">ctrls</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pool_ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">element</span>
                    <span class="n">pool_ctrl</span><span class="o">.</span><span class="n">ctrl</span><span class="o">.</span><span class="n">StartAll</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">channels</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">get_channels</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
                        <span class="n">channel</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">State</span><span class="o">.</span><span class="n">Fault</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.StartAll() failed&quot;</span> <span class="o">%</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_pool_ctrl_dict_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctrls</span><span class="p">):</span>
        <span class="n">ctrl_channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="n">ctrls</span><span class="p">:</span>
            <span class="n">pool_channels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pool_ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">element</span>
            <span class="c1"># only CT will be read in the loop, 1D and 2D not</span>
            <span class="k">if</span> <span class="n">ElementType</span><span class="o">.</span><span class="n">CTExpChannel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">get_ctrl_types</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">get_channels</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">pool_channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">element</span><span class="p">)</span>
            <span class="n">ctrl_channels</span><span class="p">[</span><span class="n">pool_ctrl</span><span class="p">]</span> <span class="o">=</span> <span class="n">pool_channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict_loop</span> <span class="o">=</span> <span class="n">ctrl_channels</span>

    <span class="k">def</span> <span class="nf">_split_ctrl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctrls</span><span class="p">):</span>
        <span class="n">ctrl_channels_value</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ctrl_channels_ref</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="n">ctrls</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">is_referable</span><span class="p">():</span>
                <span class="n">pool_channels_value</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">pool_ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">element</span>
                <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">get_channels</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="n">pool_channels_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">element</span><span class="p">)</span>
                <span class="n">ctrl_channels_value</span><span class="p">[</span><span class="n">pool_ctrl</span><span class="p">]</span> <span class="o">=</span> <span class="n">pool_channels_value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pool_channels_value</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">pool_channels_ref</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">pool_ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">element</span>
                <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">get_channels</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">channel</span><span class="o">.</span><span class="n">value_ref_enabled</span><span class="p">:</span>
                        <span class="n">pool_channels_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">element</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">channel</span><span class="o">.</span><span class="n">has_pseudo_elements</span><span class="p">():</span>
                            <span class="n">pool_channels_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">element</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pool_channels_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">element</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pool_channels_value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ctrl_channels_value</span><span class="p">[</span><span class="n">pool_ctrl</span><span class="p">]</span> <span class="o">=</span> <span class="n">pool_channels_value</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pool_channels_ref</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ctrl_channels_ref</span><span class="p">[</span><span class="n">pool_ctrl</span><span class="p">]</span> <span class="o">=</span> <span class="n">pool_channels_ref</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict_value</span> <span class="o">=</span> <span class="n">ctrl_channels_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict_ref</span> <span class="o">=</span> <span class="n">ctrl_channels_ref</span>

    <span class="k">def</span> <span class="nf">_reset_ctrl_dicts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict_loop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict_ref</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">clear_value_buffers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">:</span>
            <span class="n">channel</span><span class="o">.</span><span class="n">clear_value_buffer</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">PoolAcquisitionHardware</span><span class="p">(</span><span class="n">PoolAcquisitionTimerable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Acquisition action for controllers synchronized by hardware</span>

<span class="sd">    .. note::</span>
<span class="sd">        The PoolAcquisitionHardware class has been included in Sardana</span>
<span class="sd">        on a provisional basis. Backwards incompatible changes</span>
<span class="sd">        (up to and including removal of the module) may occur if</span>
<span class="sd">        deemed necessary by the core developers.</span>

<span class="sd">    .. todo:: Try to move the action loop logic to base class it is</span>
<span class="sd">    basically the same as in PoolAcquisitionSoftwareStart.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;AcquisitionHardware&quot;</span><span class="p">):</span>
        <span class="n">PoolAcquisitionTimerable</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctrls</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">repetitions</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span>
                     <span class="n">acq_sleep_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nb_states_per_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">PoolAcquisitionTimerable</span><span class="o">.</span><span class="n">start_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctrls</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                         <span class="n">repetitions</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                         <span class="n">acq_sleep_time</span><span class="p">,</span> <span class="n">nb_states_per_value</span><span class="p">,</span>
                                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_read_value_ctrls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict_value</span>

    <span class="nd">@DebugIt</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">action_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">states</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">value_refs</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">:</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">element</span>
            <span class="n">states</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">nap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acq_sleep_time</span>
        <span class="n">nb_states_per_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nb_states_per_value</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_released</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_state_info</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_acquisition</span><span class="p">(</span><span class="n">states</span><span class="p">):</span>
                <span class="k">break</span>

            <span class="c1"># read value every n times</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">%</span> <span class="n">nb_states_per_value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_process_value_buffer</span><span class="p">(</span><span class="n">acquirable</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_value_ref</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">value_refs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">value_ref</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">value_refs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_process_value_ref_buffer</span><span class="p">(</span><span class="n">acquirable</span><span class="p">,</span> <span class="n">value_ref</span><span class="p">)</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">nap</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">with</span> <span class="n">ActionContext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_read_value</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_read_value_ref</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">value_refs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">state_info</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">acquirable</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">acquirable</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_value_buffer</span><span class="p">(</span><span class="n">acquirable</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">final</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">acquirable</span> <span class="ow">in</span> <span class="n">value_refs</span><span class="p">:</span>
                <span class="n">value_ref</span> <span class="o">=</span> <span class="n">value_refs</span><span class="p">[</span><span class="n">acquirable</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_value_ref_buffer</span><span class="p">(</span><span class="n">acquirable</span><span class="p">,</span> <span class="n">value_ref</span><span class="p">,</span>
                                               <span class="n">final</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">state_info</span> <span class="o">=</span> <span class="n">acquirable</span><span class="o">.</span><span class="n">_from_ctrl_state_info</span><span class="p">(</span><span class="n">state_info</span><span class="p">)</span>
            <span class="n">set_state_info</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">acquirable</span><span class="o">.</span><span class="n">set_state_info</span><span class="p">,</span>
                                               <span class="n">state_info</span><span class="p">,</span>
                                               <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                               <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_finish_hook</span><span class="p">(</span><span class="n">set_state_info</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PoolAcquisitionSoftware</span><span class="p">(</span><span class="n">PoolAcquisitionTimerable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Acquisition action for controllers synchronized by software</span>

<span class="sd">    .. note::</span>
<span class="sd">        The PoolAcquisitionSoftware class has been included in Sardana</span>
<span class="sd">        on a provisional basis. Backwards incompatible changes</span>
<span class="sd">        (up to and including removal of the module) may occur if</span>
<span class="sd">        deemed necessary by the core developers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;AcquisitionSoftware&quot;</span><span class="p">,</span> <span class="n">slaves</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">PoolAcquisitionTimerable</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">slaves</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">slaves</span> <span class="o">=</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_slaves</span> <span class="o">=</span> <span class="n">slaves</span>

    <span class="k">def</span> <span class="nf">get_read_value_ctrls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># technical debt in order to work both in case of meas group and</span>
        <span class="c1"># single channel</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict</span>

    <span class="k">def</span> <span class="nf">get_read_value_ref_ctrls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># technical debt in order to work both in case of meas group and</span>
        <span class="c1"># single channel</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict_ref</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict</span>

    <span class="k">def</span> <span class="nf">get_read_value_loop_ctrls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict_loop</span>

    <span class="k">def</span> <span class="nf">start_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctrls</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">master</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">acq_sleep_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">nb_states_per_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">PoolAcquisitionTimerable</span><span class="o">.</span><span class="n">start_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctrls</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">master</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                         <span class="n">index</span><span class="p">,</span> <span class="n">acq_sleep_time</span><span class="p">,</span>
                                         <span class="n">nb_states_per_value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@DebugIt</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">action_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">states</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">value_refs</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">:</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">element</span>
            <span class="n">states</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">nap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acq_sleep_time</span>
        <span class="n">nb_states_per_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nb_states_per_value</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_released</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_state_info</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_acquisition</span><span class="p">(</span><span class="n">states</span><span class="p">):</span>
                <span class="k">break</span>

            <span class="c1"># read value every n times</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">%</span> <span class="n">nb_states_per_value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_value_loop</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="n">acquirable</span><span class="o">.</span><span class="n">put_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="n">AttrQuality</span><span class="o">.</span><span class="n">Changing</span><span class="p">)</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">nap</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">slave</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slaves</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">slave</span><span class="o">.</span><span class="n">stop_action</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to stop slave acquisition </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="n">slave</span><span class="o">.</span><span class="n">getLogName</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Details&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ActionContext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_read_value</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_read_value_ref</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">value_refs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">state_info</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">acquirable</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">acquirable</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">is_value_error</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Loop final read value error for: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                               <span class="n">acquirable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Details: &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="o">*</span><span class="n">value</span><span class="o">.</span><span class="n">exc_info</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">acquirable</span><span class="o">.</span><span class="n">get_value_attribute</span><span class="p">()</span><span class="o">.</span><span class="n">set_quality</span><span class="p">(</span>
                    <span class="n">AttrQuality</span><span class="o">.</span><span class="n">Valid</span><span class="p">)</span>
                <span class="n">acquirable</span><span class="o">.</span><span class="n">append_value_buffer</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">,</span>
                                               <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">acquirable</span> <span class="ow">in</span> <span class="n">value_refs</span><span class="p">:</span>
                <span class="n">value_ref</span> <span class="o">=</span> <span class="n">value_refs</span><span class="p">[</span><span class="n">acquirable</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">is_value_error</span><span class="p">(</span><span class="n">value_ref</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Loop final read value ref error for: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                               <span class="n">acquirable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Details: &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="o">*</span><span class="n">value_ref</span><span class="o">.</span><span class="n">exc_info</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">acquirable</span><span class="o">.</span><span class="n">append_value_ref_buffer</span><span class="p">(</span><span class="n">value_ref</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">)</span>
            <span class="n">state_info</span> <span class="o">=</span> <span class="n">acquirable</span><span class="o">.</span><span class="n">_from_ctrl_state_info</span><span class="p">(</span><span class="n">state_info</span><span class="p">)</span>
            <span class="n">set_state_info</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">acquirable</span><span class="o">.</span><span class="n">set_state_info</span><span class="p">,</span>
                                               <span class="n">state_info</span><span class="p">,</span>
                                               <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                               <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_finish_hook</span><span class="p">(</span><span class="n">set_state_info</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PoolAcquisitionSoftwareStart</span><span class="p">(</span><span class="n">PoolAcquisitionTimerable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Acquisition action for controllers synchronized by software start</span>

<span class="sd">    .. note::</span>
<span class="sd">        The PoolAcquisitionSoftwareStart class has been included in Sardana</span>
<span class="sd">        on a provisional basis. Backwards incompatible changes</span>
<span class="sd">        (up to and including removal of the module) may occur if</span>
<span class="sd">        deemed necessary by the core developers.</span>

<span class="sd">    .. todo:: Try to move the action loop logic to base class it is</span>
<span class="sd">    basically the same as in PoolAcquisitionHardware.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;AcquisitionSoftwareStart&quot;</span><span class="p">):</span>
        <span class="n">PoolAcquisitionTimerable</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_read_value_ctrls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># technical debt in order to work both in case of meas group and</span>
        <span class="c1"># single channel</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict_value</span>

    <span class="k">def</span> <span class="nf">start_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctrls</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">master</span><span class="p">,</span> <span class="n">repetitions</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span>
                     <span class="n">acq_sleep_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nb_states_per_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">PoolAcquisitionTimerable</span><span class="o">.</span><span class="n">start_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctrls</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">master</span><span class="p">,</span>
                                         <span class="n">repetitions</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                         <span class="n">acq_sleep_time</span><span class="p">,</span> <span class="n">nb_states_per_value</span><span class="p">,</span>
                                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@DebugIt</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">action_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">states</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">value_refs</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">:</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">element</span>
            <span class="n">states</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">nap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acq_sleep_time</span>
        <span class="n">nb_states_per_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nb_states_per_value</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_released</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_state_info</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_acquisition</span><span class="p">(</span><span class="n">states</span><span class="p">):</span>
                <span class="k">break</span>

            <span class="c1"># read value every n times</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">%</span> <span class="n">nb_states_per_value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">is_value_error</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Loop read value error for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                   <span class="n">acquirable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Details: &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="o">*</span><span class="n">value</span><span class="o">.</span><span class="n">exc_info</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">acquirable</span><span class="o">.</span><span class="n">put_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">acquirable</span><span class="o">.</span><span class="n">extend_value_buffer</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_value_ref</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">value_refs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">value_ref</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">value_refs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">is_value_error</span><span class="p">(</span><span class="n">value_ref</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Loop read value ref error for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                   <span class="n">acquirable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Details: &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="o">*</span><span class="n">value</span><span class="o">.</span><span class="n">exc_info</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">acquirable</span><span class="o">.</span><span class="n">put_value_ref</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">acquirable</span><span class="o">.</span><span class="n">extend_value_ref_buffer</span><span class="p">(</span><span class="n">value_ref</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">nap</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">with</span> <span class="n">ActionContext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_read_value</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_read_value_ref</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">value_refs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">state_info</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">acquirable</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">acquirable</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">is_value_error</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Loop final read value error for: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                               <span class="n">acquirable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Details: &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="o">*</span><span class="n">value</span><span class="o">.</span><span class="n">exc_info</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">acquirable</span><span class="o">.</span><span class="n">put_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">acquirable</span><span class="o">.</span><span class="n">extend_value_buffer</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">acquirable</span> <span class="ow">in</span> <span class="n">value_refs</span><span class="p">:</span>
                <span class="n">value_ref</span> <span class="o">=</span> <span class="n">value_refs</span><span class="p">[</span><span class="n">acquirable</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">is_value_error</span><span class="p">(</span><span class="n">value_ref</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Loop final read value ref error for: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                               <span class="n">acquirable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Details: &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="o">*</span><span class="n">value_ref</span><span class="o">.</span><span class="n">exc_info</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">acquirable</span><span class="o">.</span><span class="n">put_value_ref</span><span class="p">(</span><span class="n">value_ref</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">acquirable</span><span class="o">.</span><span class="n">extend_value_ref_buffer</span><span class="p">(</span><span class="n">value_ref</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">state_info</span> <span class="o">=</span> <span class="n">acquirable</span><span class="o">.</span><span class="n">_from_ctrl_state_info</span><span class="p">(</span><span class="n">state_info</span><span class="p">)</span>
            <span class="n">set_state_info</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">acquirable</span><span class="o">.</span><span class="n">set_state_info</span><span class="p">,</span>
                                               <span class="n">state_info</span><span class="p">,</span>
                                               <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                               <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_finish_hook</span><span class="p">(</span><span class="n">set_state_info</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>


<div class="viewcode-block" id="PoolCTAcquisition"><a class="viewcode-back" href="../../../devel/api/sardana/pool/poolacquisition.html#sardana.pool.poolacquisition.PoolCTAcquisition">[docs]</a><span class="k">class</span> <span class="nc">PoolCTAcquisition</span><span class="p">(</span><span class="n">PoolAcquisitionTimerable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;..todo:: remove it, still used by pseudo counter&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;CTAcquisition&quot;</span><span class="p">,</span> <span class="n">slaves</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">slaves</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">slaves</span> <span class="o">=</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_slaves</span> <span class="o">=</span> <span class="n">slaves</span>

        <span class="n">PoolAcquisitionTimerable</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="PoolCTAcquisition.get_read_value_loop_ctrls"><a class="viewcode-back" href="../../../devel/api/sardana/pool/poolacquisition.html#sardana.pool.poolacquisition.PoolCTAcquisition.get_read_value_loop_ctrls">[docs]</a>    <span class="k">def</span> <span class="nf">get_read_value_loop_ctrls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool_ctrl_dict_loop</span></div>

<div class="viewcode-block" id="PoolCTAcquisition.in_acquisition"><a class="viewcode-back" href="../../../devel/api/sardana/pool/poolacquisition.html#sardana.pool.poolacquisition.PoolCTAcquisition.in_acquisition">[docs]</a>    <span class="k">def</span> <span class="nf">in_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines if we are in acquisition or if the acquisition has ended</span>
<span class="sd">        based on the current unit trigger modes and states returned by the</span>
<span class="sd">        controller(s)</span>

<span class="sd">        :param states: a map containing state information as returned by</span>
<span class="sd">                       read_state_info</span>
<span class="sd">        :type states: dict&lt;PoolElement, State&gt;</span>
<span class="sd">        :return: returns True if in acquisition or False otherwise</span>
<span class="sd">        :rtype: bool&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_in_action</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="PoolCTAcquisition.action_loop"><a class="viewcode-back" href="../../../devel/api/sardana/pool/poolacquisition.html#sardana.pool.poolacquisition.PoolCTAcquisition.action_loop">[docs]</a>    <span class="nd">@DebugIt</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">action_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">states</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">:</span>
            <span class="n">states</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># values[element] = None</span>

        <span class="n">nap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acq_sleep_time</span>
        <span class="n">nb_states_per_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nb_states_per_value</span>

        <span class="c1"># read values to send a first event when starting to acquire</span>
        <span class="k">with</span> <span class="n">ActionContext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_read_value_loop</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">acquirable</span><span class="o">.</span><span class="n">put_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_state_info</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_acquisition</span><span class="p">(</span><span class="n">states</span><span class="p">):</span>
                <span class="k">break</span>

            <span class="c1"># read value every n times</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">%</span> <span class="n">nb_states_per_value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_value_loop</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="n">acquirable</span><span class="o">.</span><span class="n">put_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">nap</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">slave</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slaves</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">slave</span><span class="o">.</span><span class="n">stop_action</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to stop slave acquisition </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="n">slave</span><span class="o">.</span><span class="n">getLogName</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Details&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ActionContext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_read_state_info</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_read_value_loop</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">state_info</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="c1"># first update the element state so that value calculation</span>
            <span class="c1"># that is done after takes the updated state into account</span>
            <span class="n">acquirable</span><span class="o">.</span><span class="n">set_state_info</span><span class="p">(</span><span class="n">state_info</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">acquirable</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">acquirable</span><span class="p">]</span>
                <span class="n">acquirable</span><span class="o">.</span><span class="n">put_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">state_info</span> <span class="o">=</span> <span class="n">acquirable</span><span class="o">.</span><span class="n">_from_ctrl_state_info</span><span class="p">(</span><span class="n">state_info</span><span class="p">)</span>
            <span class="n">set_state_info</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">acquirable</span><span class="o">.</span><span class="n">set_state_info</span><span class="p">,</span>
                                               <span class="n">state_info</span><span class="p">,</span>
                                               <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                               <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_finish_hook</span><span class="p">(</span><span class="n">set_state_info</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">Pool0DAcquisition</span><span class="p">(</span><span class="n">PoolAcquisitionBase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;0DAcquisition&quot;</span><span class="p">):</span>
        <span class="n">PoolAcquisitionBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_element</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf_ctrls</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">acq_sleep_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">nb_states_per_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepares everything for acquisition and starts it.</span>

<span class="sd">           :param: config&quot;&quot;&quot;</span>

        <span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span>
        <span class="c1"># TODO: rollback this change when a proper synchronization between</span>
        <span class="c1"># acquisition actions will be develop.</span>
        <span class="c1"># Now the meta acquisition action is resettung them to 0.</span>
        <span class="c1"># self._aborted = False</span>
        <span class="c1"># self._stopped = False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_acq_sleep_time</span> <span class="o">=</span> <span class="n">acq_sleep_time</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acq_sleep_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_acq_sleep_time</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">acq_loop_sleep_time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_nb_states_per_value</span> <span class="o">=</span> <span class="n">nb_states_per_value</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nb_states_per_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nb_states_per_value</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">acq_loop_states_per_value</span>

        <span class="c1"># channels that are acquired (only enabled)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="n">ActionContext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># set the state of all elements to  and inform their listeners</span>

            <span class="k">for</span> <span class="n">conf_ctrl</span> <span class="ow">in</span> <span class="n">conf_ctrls</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">conf_channel</span> <span class="ow">in</span> <span class="n">conf_ctrl</span><span class="o">.</span><span class="n">get_channels</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="n">conf_channel</span><span class="o">.</span><span class="n">clear_buffer</span><span class="p">()</span>
                    <span class="n">conf_channel</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">State</span><span class="o">.</span><span class="n">Moving</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conf_channel</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">in_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines if we are in acquisition or if the acquisition has ended</span>
<span class="sd">        based on the current unit trigger modes and states returned by the</span>
<span class="sd">        controller(s)</span>

<span class="sd">        :param states: a map containing state information as returned by</span>
<span class="sd">                       read_state_info</span>
<span class="sd">        :type states: dict&lt;PoolElement, State&gt;</span>
<span class="sd">        :return: returns True if in acquisition or False otherwise</span>
<span class="sd">        :rtype: bool&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="n">state</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_in_action</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">action_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">states</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">conf_channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">:</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">conf_channel</span><span class="o">.</span><span class="n">element</span>
            <span class="n">states</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">values</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">nap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acq_sleep_time</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_released</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">acquirable</span><span class="o">.</span><span class="n">put_current_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopped</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aborted</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">nap</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">accumulated_value</span><span class="o">.</span><span class="n">value_obj</span>
            <span class="n">element</span><span class="o">.</span><span class="n">append_value_buffer</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ActionContext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_read_state_info</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">state_info</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">state_info</span> <span class="o">=</span> <span class="n">acquirable</span><span class="o">.</span><span class="n">_from_ctrl_state_info</span><span class="p">(</span><span class="n">state_info</span><span class="p">)</span>
            <span class="n">set_state_info</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">acquirable</span><span class="o">.</span><span class="n">set_state_info</span><span class="p">,</span>
                                               <span class="n">state_info</span><span class="p">,</span>
                                               <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                               <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_finish_hook</span><span class="p">(</span><span class="n">set_state_info</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stop_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop procedure for this action.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stopped</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">abort_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Aborts procedure for this action&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aborted</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">class</span> <span class="nc">PoolIORAcquisition</span><span class="p">(</span><span class="n">PoolAction</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;IORAcquisition&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">PoolAction</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">in_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
        <span class="k">pass</span>

    <span class="nd">@DebugIt</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">action_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">states</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">:</span>
            <span class="n">states</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">values</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># read values to send a first event when starting to acquire</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">acquirable</span><span class="o">.</span><span class="n">put_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_state_info</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_acquisition</span><span class="p">(</span><span class="n">states</span><span class="p">):</span>
                <span class="k">break</span>

            <span class="c1"># read value every n times</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="n">acquirable</span><span class="o">.</span><span class="n">put_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_state_info</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>

        <span class="c1"># first update the element state so that value calculation</span>
        <span class="c1"># that is done after takes the updated state into account</span>
        <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">state_info</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">acquirable</span><span class="o">.</span><span class="n">set_state_info</span><span class="p">(</span><span class="n">state_info</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Do NOT send events before we exit the OperationContext, otherwise</span>
        <span class="c1"># we may be asked to start another action before we leave the context</span>
        <span class="c1"># of the current action. Instead, send the events in the finish hook</span>
        <span class="c1"># which is executed outside the OperationContext</span>

        <span class="k">def</span> <span class="nf">finish_hook</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># read values and propagate the change to all listeners</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">acquirable</span><span class="o">.</span><span class="n">put_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># finally set the state and propagate to all listeners</span>
            <span class="k">for</span> <span class="n">acquirable</span><span class="p">,</span> <span class="n">state_info</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">acquirable</span><span class="o">.</span><span class="n">set_state_info</span><span class="p">(</span><span class="n">state_info</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_finish_hook</span><span class="p">(</span><span class="n">finish_hook</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright Except where otherwise noted, content on this site is
licensed under a Creative Commons Attribution 3.0 License.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>