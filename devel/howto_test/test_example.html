

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Test-driven development example &mdash; sardana 3.1.1-alpha documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Sardana Unit Test Examples" href="tests/index.html" />
    <link rel="prev" title="Run tests from command line" href="test_run_commands.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> sardana
          

          
            
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference external" href="http://www.sardana-controls.org">Home Page</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/sardana-org/sardana">Project Page</a></li>
<li class="toctree-l1"><a class="reference external" href="http://pypi.python.org/pypi/sardana">Download from PyPI</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../docs.html">Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../users/index.html">User’s Guide</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Developer’s Guide</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../overview/index.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../howto_macros/index.html">Writing macros</a></li>
<li class="toctree-l3"><a class="reference internal" href="../howto_controllers/index.html">Writing controllers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../howto_recorders.html">Writing recorders</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Sardana Testing</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="test_general.html">General test documentation</a></li>
<li class="toctree-l4"><a class="reference internal" href="test_run_commands.html">Run Sardana tests from command line</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Test-driven development example</a></li>
<li class="toctree-l4"><a class="reference internal" href="tests/index.html">Sardana Unit Test examples</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/api_sardana.html">API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide_migration/index.html">Migration guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/examples.html">Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide_coding.html">Development guidelines</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../sep/index.html">Sardana Enhancement Proposals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../news.html">What's new?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_versions.html">Docs for other Sardana versions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana-plugins">Plugins Catalogue</a></li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana/wiki">Wiki</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">sardana</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../docs.html">Sardana 3.1 Documentation</a> &raquo;</li>
        
          <li><a href="../index.html">Developer’s Guide</a> &raquo;</li>
        
          <li><a href="index.html">Sardana Testing</a> &raquo;</li>
        
      <li>Test-driven development example</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/devel/howto_test/test_example.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="test-driven-development-example">
<span id="sardana-test-driven-devel-example"></span><h1>Test-driven development example<a class="headerlink" href="#test-driven-development-example" title="Permalink to this headline">¶</a></h1>
<p>In this section it is presented a practical example of how to code a macro
by doing test-driven development thanks to the tools provided by the Sardana
Test Framework.</p>
<p>Consider that we want to write a new macro named “sqrtmac” for calculating the
square root of an input number. The “sqrtmac” specifications are:</p>
<ol class="arabic simple">
<li><p>Its data must be given in the form {‘in’:x,’out’:s}</p></li>
<li><p>Its output (‘out’) must be the square root of the input data (‘in’).</p></li>
<li><p>Macro must raise an Exception of type ValueError if negative numbers are given as input.</p></li>
</ol>
<div class="section" id="test-development">
<h2>Test development<a class="headerlink" href="#test-development" title="Permalink to this headline">¶</a></h2>
<p>First we design the tests according to the specifications considering the
features that are required for the macro. For doing so we will need some
imports in order to be able to use the base classes and decorators.
In this case the important base class is RunMacroTestCase, and
we import testRun and testFail to be used as decorators:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Tests for sqrt macro&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">sardana.macroserver.macros.test</span> <span class="k">import</span> <span class="n">RunMacroTestCase</span><span class="p">,</span> <span class="n">testRun</span><span class="p">,</span> <span class="n">testFail</span>
</pre></div>
</div>
<p>Now we will write a basic test, that will check the execution of the sqrtmac for
a given input x = 12345.678. For doing so, we inherit from unittest and
from RunMacroTestCase. In this implementation we will calculate in the test the
sqrt of the input parameter and then, using assertEqual, we will verify that
this value is equal to the output of the macro. The helper method macro_runs is
used for executing the macro:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Tests for a macro calculating the sqrt of an input number&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">sardana.macroserver.macros.test</span> <span class="k">import</span> <span class="n">RunMacroTestCase</span><span class="p">,</span> <span class="n">testRun</span><span class="p">,</span> <span class="n">testFail</span>


<span class="k">class</span> <span class="nc">sqrtmacTest</span><span class="p">(</span><span class="n">RunMacroTestCase</span><span class="p">,</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test of sqrt macro. It verifies that macro sqrt can be executed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">macro_name</span> <span class="o">=</span> <span class="s2">&quot;sqrtmac&quot;</span>

    <span class="k">def</span> <span class="nf">test_sqrtmac</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">macro_params</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro_runs</span><span class="p">(</span><span class="n">macro_params</span><span class="p">)</span>

        <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">macro_executor</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>
        <span class="n">expected_output</span> <span class="o">=</span> <span class="mi">49</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Macro output does not equals the expected output&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;in&#39;</span><span class="p">]</span> <span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">macro_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;out&#39;</span><span class="p">]</span> <span class="p">,</span><span class="n">expected_output</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, two new tests are added thanks to the decorator and the helper functions.
In this case we will use the decorator &#64;testRun. The same test case can be
launched with different sets of parameters. One decorator is used for each set
of parameters.</p>
<p>One of the tests will run the sqrtmac macro for an input value of 9 and
verify that the macro has been executed without problems.</p>
<p>Another test added will run the sqrt for an input of 2.25 and will verify
its input and output values against the expected values which we pass to the
decorator. A wait_timeout of 5s will be given;  this means, that if the test
does not finish within 5 seconds, the current test will give an error and
the following test will be executed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Tests for a macro calculating the sqrt of an input number&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">sardana.macroserver.macros.test</span> <span class="k">import</span> <span class="n">RunMacroTestCase</span><span class="p">,</span> <span class="n">testRun</span><span class="p">,</span> <span class="n">testFail</span>


<span class="nd">@testRun</span><span class="p">(</span><span class="n">macro_params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;9&#39;</span><span class="p">])</span>
<span class="nd">@testRun</span><span class="p">(</span><span class="n">macro_params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;2.25&#39;</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;in&#39;</span><span class="p">:</span><span class="mf">2.25</span><span class="p">,</span><span class="s1">&#39;out&#39;</span><span class="p">:</span><span class="mf">1.5</span><span class="p">},</span> <span class="n">wait_timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">sqrtmacTest</span><span class="p">(</span><span class="n">RunMacroTestCase</span><span class="p">,</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test of sqrt macro. It verifies that macro sqrt can be executed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">macro_name</span> <span class="o">=</span> <span class="s2">&quot;sqrtmac&quot;</span>

    <span class="k">def</span> <span class="nf">test_sqrtmac</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">macro_params</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro_runs</span><span class="p">(</span><span class="n">macro_params</span><span class="p">)</span>

        <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">macro_executor</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>
        <span class="n">expected_output</span> <span class="o">=</span> <span class="mi">49</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Macro output does not equals the expected output&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;in&#39;</span><span class="p">]</span> <span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">macro_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;out&#39;</span><span class="p">]</span> <span class="p">,</span><span class="n">expected_output</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</pre></div>
</div>
<p>The following test implemented must check that the macro is raising an Exception
if negative numbers are passed as input. The type of exception raised must be a
ValueError. For developing this test we will use the decorator testFail which
allows to test if a macro is raising an Exception before finishing its
execution. The final implementation of our test file test_sqrt.py is as
follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Tests for a macro calculating the sqrt of an input number&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">sardana.macroserver.macros.test</span> <span class="k">import</span> <span class="n">RunMacroTestCase</span><span class="p">,</span> <span class="n">testRun</span><span class="p">,</span> <span class="n">testFail</span>

<span class="nd">@testRun</span><span class="p">(</span><span class="n">macro_params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;9&#39;</span><span class="p">])</span>
<span class="nd">@testRun</span><span class="p">(</span><span class="n">macro_params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;2.25&#39;</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;in&#39;</span><span class="p">:</span><span class="mf">2.25</span><span class="p">,</span><span class="s1">&#39;out&#39;</span><span class="p">:</span><span class="mf">1.5</span><span class="p">},</span> <span class="n">wait_timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="nd">@testFail</span><span class="p">(</span><span class="n">macro_params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-3.0&#39;</span><span class="p">],</span> <span class="n">exception</span><span class="o">=</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">wait_timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">sqrtmacTest</span><span class="p">(</span><span class="n">RunMacroTestCase</span><span class="p">,</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test of sqrt macro. It verifies that macro sqrt can be executed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">macro_name</span> <span class="o">=</span> <span class="s2">&quot;sqrtmac&quot;</span>

    <span class="k">def</span> <span class="nf">test_sqrtmac</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">macro_params</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro_runs</span><span class="p">(</span><span class="n">macro_params</span><span class="p">)</span>

        <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">macro_executor</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>
        <span class="n">expected_output</span> <span class="o">=</span> <span class="mi">49</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Macro output does not equals the expected output&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;in&#39;</span><span class="p">]</span> <span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">macro_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;out&#39;</span><span class="p">]</span> <span class="p">,</span><span class="n">expected_output</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="macro-development">
<h2>Macro development<a class="headerlink" href="#macro-development" title="Permalink to this headline">¶</a></h2>
<p>Thanks to the test that we have designed precedently we can now implement
the macro and check if it is developed according to the specifications.</p>
<p>We do a first implementation of the macro by calculating the square root
of an input number. Then we will execute the test and analyze the results. The
first implementation looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sardana.macroserver.macro</span> <span class="k">import</span> <span class="n">Macro</span><span class="p">,</span> <span class="n">Type</span>

<span class="k">class</span> <span class="nc">sqrtmac</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Macro sqrtmac&quot;&quot;&quot;</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
                    <span class="s2">&quot;input value for which we want the square root&quot;</span><span class="p">]</span> <span class="p">]</span>
    <span class="n">result_def</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="s2">&quot;square root of the input value&quot;</span><span class="p">]</span> <span class="p">]</span>

    <span class="k">def</span> <span class="nf">run</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>
</pre></div>
</div>
<p>An its ouput on the screen:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sardana</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sardana</span><span class="o">/</span><span class="n">macroserver</span><span class="o">/</span><span class="n">macros</span><span class="o">/</span><span class="n">test</span><span class="o">&gt;</span> <span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">unittest</span> <span class="o">-</span><span class="n">v</span> <span class="n">test_sqrtmac</span>
<span class="n">test_sqrtmac</span> <span class="p">(</span><span class="n">test_sqrtmac</span><span class="o">.</span><span class="n">sqrtmacTest</span><span class="p">)</span> <span class="o">...</span> <span class="n">ERROR</span>
<span class="n">test_sqrtmac_macro_fails</span> <span class="p">(</span><span class="n">test_sqrtmac</span><span class="o">.</span><span class="n">sqrtmacTest</span><span class="p">)</span>
<span class="n">Testing</span> <span class="n">sqrtmac</span> <span class="k">with</span> <span class="n">macro_fails</span><span class="p">(</span><span class="n">macro_params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-3.0&#39;</span><span class="p">],</span> <span class="n">exception</span><span class="o">=&lt;</span><span class="nb">type</span> <span class="s1">&#39;exceptions.ValueError&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">wait_timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="o">...</span> <span class="n">FAIL</span>
<span class="n">test_sqrtmac_macro_runs</span> <span class="p">(</span><span class="n">test_sqrtmac</span><span class="o">.</span><span class="n">sqrtmacTest</span><span class="p">)</span>
<span class="n">Testing</span> <span class="n">sqrtmac</span> <span class="k">with</span> <span class="n">macro_runs</span><span class="p">(</span><span class="n">macro_params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;2.25&#39;</span><span class="p">],</span> <span class="n">wait_timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;out&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="mf">2.25</span><span class="p">})</span> <span class="o">...</span> <span class="n">ERROR</span>
<span class="n">test_sqrtmac_macro_runs_2</span> <span class="p">(</span><span class="n">test_sqrtmac</span><span class="o">.</span><span class="n">sqrtmacTest</span><span class="p">)</span>
<span class="n">Testing</span> <span class="n">sqrtmac</span> <span class="k">with</span> <span class="n">macro_runs</span><span class="p">(</span><span class="n">macro_params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;9&#39;</span><span class="p">])</span> <span class="o">...</span> <span class="n">ok</span>

<span class="o">======================================================================</span>
<span class="n">ERROR</span><span class="p">:</span> <span class="n">test_sqrtmac</span> <span class="p">(</span><span class="n">test_sqrtmac</span><span class="o">.</span><span class="n">sqrtmacTest</span><span class="p">)</span>
<span class="o">----------------------------------------------------------------------</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
            <span class="o">.</span>
            <span class="o">.</span>
            <span class="o">.</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">:</span> <span class="n">Macro</span> <span class="s1">&#39;sqrtmac&#39;</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">produce</span> <span class="nb">any</span> <span class="n">data</span>


<span class="o">======================================================================</span>
<span class="n">ERROR</span><span class="p">:</span> <span class="n">test_sqrtmac_macro_runs</span> <span class="p">(</span><span class="n">test_sqrtmac</span><span class="o">.</span><span class="n">sqrtmacTest</span><span class="p">)</span>
<span class="n">Testing</span> <span class="n">sqrtmac</span> <span class="k">with</span> <span class="n">macro_runs</span><span class="p">(</span><span class="n">macro_params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;2.25&#39;</span><span class="p">],</span> <span class="n">wait_timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;out&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="mf">2.25</span><span class="p">})</span>
<span class="o">----------------------------------------------------------------------</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
            <span class="o">.</span>
            <span class="o">.</span>
            <span class="o">.</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">:</span> <span class="n">Macro</span> <span class="s1">&#39;sqrtmac&#39;</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">produce</span> <span class="nb">any</span> <span class="n">data</span>


<span class="o">======================================================================</span>
<span class="n">FAIL</span><span class="p">:</span> <span class="n">test_sqrtmac_macro_fails</span> <span class="p">(</span><span class="n">test_sqrtmac</span><span class="o">.</span><span class="n">sqrtmacTest</span><span class="p">)</span>
<span class="n">Testing</span> <span class="n">sqrtmac</span> <span class="k">with</span> <span class="n">macro_fails</span><span class="p">(</span><span class="n">macro_params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-3.0&#39;</span><span class="p">],</span> <span class="n">exception</span><span class="o">=&lt;</span><span class="nb">type</span> <span class="s1">&#39;exceptions.ValueError&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">wait_timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="o">----------------------------------------------------------------------</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;/siciliarep/tmp/mrosanes/workspace/GIT/projects/sardana/src/sardana/macroserver/macros/test/base.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">144</span><span class="p">,</span> <span class="ow">in</span> <span class="n">newTest</span>
    <span class="k">return</span> <span class="n">helper</span><span class="p">(</span><span class="o">**</span><span class="n">helper_kwargs</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;/siciliarep/tmp/mrosanes/workspace/GIT/projects/sardana/src/sardana/macroserver/macros/test/base.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">271</span><span class="p">,</span> <span class="ow">in</span> <span class="n">macro_fails</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;exception&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
<span class="ne">AssertionError</span><span class="p">:</span> <span class="n">Post</span><span class="o">-</span><span class="n">execution</span> <span class="n">state</span> <span class="n">should</span> <span class="n">be</span> <span class="s2">&quot;exception&quot;</span> <span class="p">(</span><span class="n">got</span> <span class="s2">&quot;finish&quot;</span><span class="p">)</span>

<span class="o">----------------------------------------------------------------------</span>
<span class="n">Ran</span> <span class="mi">4</span> <span class="n">tests</span> <span class="ow">in</span> <span class="mf">0.977</span><span class="n">s</span>

<span class="n">FAILED</span> <span class="p">(</span><span class="n">failures</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>At this moment two tests are giving an error because ‘sqrtmac’ does not produce
data, and one test is failing because the exception is not treat.
The test that is giving ‘Ok’ is only testing that the macro can be
executed.</p>
<p>The second step will be to set the input and output data of the macro and
execute the test again:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sardana.macroserver.macro</span> <span class="k">import</span> <span class="n">Macro</span><span class="p">,</span> <span class="n">Type</span>

<span class="k">class</span> <span class="nc">sqrtmac</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Macro sqrtmac&quot;&quot;&quot;</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
                    <span class="s2">&quot;input value for which we want the square root&quot;</span><span class="p">]</span> <span class="p">]</span>
    <span class="n">result_def</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="s2">&quot;square root of the input value&quot;</span><span class="p">]</span> <span class="p">]</span>

    <span class="k">def</span> <span class="nf">run</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setData</span><span class="p">({</span><span class="s1">&#39;in&#39;</span><span class="p">:</span><span class="n">n</span><span class="p">,</span><span class="s1">&#39;out&#39;</span><span class="p">:</span><span class="n">ret</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">ret</span>
</pre></div>
</div>
<p>An its ouput on the screen:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sardana</span><span class="o">/</span><span class="n">macroserver</span><span class="o">/</span><span class="n">macros</span><span class="o">/</span><span class="n">test</span><span class="o">&gt;</span> <span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">unittest</span> <span class="o">-</span><span class="n">v</span> <span class="n">test_sqrtmac</span>
<span class="n">test_sqrtmac</span> <span class="p">(</span><span class="n">test_sqrtmac</span><span class="o">.</span><span class="n">sqrtmacTest</span><span class="p">)</span> <span class="o">...</span> <span class="n">ok</span>
<span class="n">test_sqrtmac_macro_fails</span> <span class="p">(</span><span class="n">test_sqrtmac</span><span class="o">.</span><span class="n">sqrtmacTest</span><span class="p">)</span>
<span class="n">Testing</span> <span class="n">sqrtmac</span> <span class="k">with</span> <span class="n">macro_fails</span><span class="p">(</span><span class="n">macro_params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-3.0&#39;</span><span class="p">],</span> <span class="n">exception</span><span class="o">=&lt;</span><span class="nb">type</span> <span class="s1">&#39;exceptions.ValueError&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">wait_timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="o">...</span> <span class="n">FAIL</span>
<span class="n">test_sqrtmac_macro_runs</span> <span class="p">(</span><span class="n">test_sqrtmac</span><span class="o">.</span><span class="n">sqrtmacTest</span><span class="p">)</span>
<span class="n">Testing</span> <span class="n">sqrtmac</span> <span class="k">with</span> <span class="n">macro_runs</span><span class="p">(</span><span class="n">macro_params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;2.25&#39;</span><span class="p">],</span> <span class="n">wait_timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;out&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="mf">2.25</span><span class="p">})</span> <span class="o">...</span> <span class="n">ok</span>
<span class="n">test_sqrtmac_macro_runs_2</span> <span class="p">(</span><span class="n">test_sqrtmac</span><span class="o">.</span><span class="n">sqrtmacTest</span><span class="p">)</span>
<span class="n">Testing</span> <span class="n">sqrtmac</span> <span class="k">with</span> <span class="n">macro_runs</span><span class="p">(</span><span class="n">macro_params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;9&#39;</span><span class="p">])</span> <span class="o">...</span> <span class="n">ok</span>

<span class="o">======================================================================</span>
<span class="n">FAIL</span><span class="p">:</span> <span class="n">test_sqrtmac_macro_fails</span> <span class="p">(</span><span class="n">test_sqrtmac</span><span class="o">.</span><span class="n">sqrtmacTest</span><span class="p">)</span>
<span class="n">Testing</span> <span class="n">sqrtmac</span> <span class="k">with</span> <span class="n">macro_fails</span><span class="p">(</span><span class="n">macro_params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-3.0&#39;</span><span class="p">],</span> <span class="n">exception</span><span class="o">=&lt;</span><span class="nb">type</span> <span class="s1">&#39;exceptions.ValueError&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">wait_timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="o">----------------------------------------------------------------------</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;/siciliarep/tmp/mrosanes/workspace/GIT/projects/sardana/src/sardana/macroserver/macros/test/base.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">142</span><span class="p">,</span> <span class="ow">in</span> <span class="n">newTest</span>
    <span class="k">return</span> <span class="n">helper</span><span class="p">(</span><span class="o">**</span><span class="n">helper_kwargs</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;/siciliarep/tmp/mrosanes/workspace/GIT/projects/sardana/src/sardana/macroserver/macros/test/base.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">267</span><span class="p">,</span> <span class="ow">in</span> <span class="n">macro_fails</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;exception&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
<span class="ne">AssertionError</span><span class="p">:</span> <span class="n">Post</span><span class="o">-</span><span class="n">execution</span> <span class="n">state</span> <span class="n">should</span> <span class="n">be</span> <span class="s2">&quot;exception&quot;</span> <span class="p">(</span><span class="n">got</span> <span class="s2">&quot;finish&quot;</span><span class="p">)</span>

<span class="o">----------------------------------------------------------------------</span>
<span class="n">Ran</span> <span class="mi">4</span> <span class="n">tests</span> <span class="ow">in</span> <span class="mf">0.932</span><span class="n">s</span>

<span class="n">FAILED</span> <span class="p">(</span><span class="n">failures</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>As we can see, the test_sqrtmac_macro_fails is Failing, because the case of
negative numbers is still not suppported. The rest of tests that are testing the
execution and the expected output values are OK.</p>
<p>Finally we arrive to the complete implementation of the macro taking into
account the Exception that should be raised if we enter a negative number
as input parameter. For coding this macro test-driven development has been
used:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sardana.macroserver.macro</span> <span class="k">import</span> <span class="n">Macro</span><span class="p">,</span> <span class="n">Type</span>

<span class="k">class</span> <span class="nc">sqrtmac</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Macro sqrtmac&quot;&quot;&quot;</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
                    <span class="s2">&quot;input value for which we want the square root&quot;</span><span class="p">]</span> <span class="p">]</span>
    <span class="n">result_def</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="s2">&quot;square root of the input value&quot;</span><span class="p">]</span> <span class="p">]</span>

    <span class="k">def</span> <span class="nf">run</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Negative numbers are not accepted.&quot;</span><span class="p">)</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setData</span><span class="p">({</span><span class="s1">&#39;in&#39;</span><span class="p">:</span><span class="n">n</span><span class="p">,</span><span class="s1">&#39;out&#39;</span><span class="p">:</span><span class="n">ret</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">ret</span>
</pre></div>
</div>
<p>An the output on the console after executing the test looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sardana</span><span class="o">/</span><span class="n">macroserver</span><span class="o">/</span><span class="n">macros</span><span class="o">/</span><span class="n">test</span><span class="o">&gt;</span> <span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">unittest</span> <span class="o">-</span><span class="n">v</span> <span class="n">test_sqrtmac</span>
<span class="n">test_sqrtmac</span> <span class="p">(</span><span class="n">test_sqrtmac</span><span class="o">.</span><span class="n">sqrtmacTest</span><span class="p">)</span> <span class="o">...</span> <span class="n">ok</span>
<span class="n">test_sqrtmac_macro_fails</span> <span class="p">(</span><span class="n">test_sqrtmac</span><span class="o">.</span><span class="n">sqrtmacTest</span><span class="p">)</span>
<span class="n">Testing</span> <span class="n">sqrtmac</span> <span class="k">with</span> <span class="n">macro_fails</span><span class="p">(</span><span class="n">macro_params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-3.0&#39;</span><span class="p">],</span> <span class="n">exception</span><span class="o">=&lt;</span><span class="nb">type</span> <span class="s1">&#39;exceptions.ValueError&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">wait_timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="o">...</span> <span class="n">ok</span>
<span class="n">test_sqrtmac_macro_runs</span> <span class="p">(</span><span class="n">test_sqrtmac</span><span class="o">.</span><span class="n">sqrtmacTest</span><span class="p">)</span>
<span class="n">Testing</span> <span class="n">sqrtmac</span> <span class="k">with</span> <span class="n">macro_runs</span><span class="p">(</span><span class="n">macro_params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;2.25&#39;</span><span class="p">],</span> <span class="n">wait_timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;out&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="mf">2.25</span><span class="p">})</span> <span class="o">...</span> <span class="n">ok</span>
<span class="n">test_sqrtmac_macro_runs_2</span> <span class="p">(</span><span class="n">test_sqrtmac</span><span class="o">.</span><span class="n">sqrtmacTest</span><span class="p">)</span>
<span class="n">Testing</span> <span class="n">sqrtmac</span> <span class="k">with</span> <span class="n">macro_runs</span><span class="p">(</span><span class="n">macro_params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;9&#39;</span><span class="p">])</span> <span class="o">...</span> <span class="n">ok</span>

<span class="o">----------------------------------------------------------------------</span>
<span class="n">Ran</span> <span class="mi">4</span> <span class="n">tests</span> <span class="ow">in</span> <span class="mf">0.928</span><span class="n">s</span>

<span class="n">OK</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="tests/index.html" class="btn btn-neutral float-right" title="Sardana Unit Test Examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="test_run_commands.html" class="btn btn-neutral float-left" title="Run tests from command line" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright Except where otherwise noted, content on this site is
licensed under a Creative Commons Attribution 3.0 License.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>