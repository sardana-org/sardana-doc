

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>How to write a counter/timer controller &mdash; sardana 3.0.2-alpha documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="How to write a 0D controller" href="howto_0dcontroller.html" />
    <link rel="prev" title="How to write a motor controller" href="howto_motorcontroller.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> sardana
          

          
            
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference external" href="http://www.sardana-controls.org">Home Page</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/sardana-org/sardana">Project Page</a></li>
<li class="toctree-l1"><a class="reference external" href="http://pypi.python.org/pypi/sardana">Download from PyPI</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../docs.html">Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../users/index.html">User’s Guide</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Developer’s Guide</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../overview/index.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../howto_macros/index.html">Writing macros</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Writing controllers</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="howto_controller.html">What is a controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_motorcontroller.html">How to write a motor controller</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">How to write a counter/timer controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_0dcontroller.html">How to write a 0D controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_1dcontroller.html">How to write a 1D controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_2dcontroller.html">How to write a 2D controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_triggergatecontroller.html">How to write a trigger/gate controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_ioregistercontroller.html">How to write an I/O register controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_pseudomotorcontroller.html">How to write a pseudo motor controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_pseudocountercontroller.html">How to write a pseudo counter controller</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../howto_recorders.html">Writing recorders</a></li>
<li class="toctree-l3"><a class="reference internal" href="../howto_test/index.html">Sardana Testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/api_sardana.html">API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide_migration/index.html">Migration guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/examples.html">Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide_coding.html">Development guidelines</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../sep/index.html">Sardana Enhancement Proposals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_versions.html">Docs for other Sardana versions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana-plugins">Plugins Catalogue</a></li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana/wiki">Wiki</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">sardana</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../docs.html">Sardana 3.0 Documentation</a> &raquo;</li>
        
          <li><a href="../index.html">Developer’s Guide</a> &raquo;</li>
        
          <li><a href="index.html">Writing controllers</a> &raquo;</li>
        
      <li>How to write a counter/timer controller</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/devel/howto_controllers/howto_countertimercontroller.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="how-to-write-a-counter-timer-controller">
<span id="sardana-countertimercontroller-howto-basics"></span><h1>How to write a counter/timer controller<a class="headerlink" href="#how-to-write-a-counter-timer-controller" title="Permalink to this headline">¶</a></h1>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Counter/timer controller <a class="reference internal" href="../../glossary.html#term-API"><span class="xref std std-term">API</span></a> was extended in <a class="reference external" href="http://www.sardana-controls.org/sep/?SEP18.md">SEP18</a> but this is
still not documented in this chapter. Please check the said SEP for more
information about the additional <a class="reference internal" href="../../glossary.html#term-API"><span class="xref std std-term">API</span></a> or eventual changes.</p>
</div>
<div class="section" id="the-basics">
<h2>The basics<a class="headerlink" href="#the-basics" title="Permalink to this headline">¶</a></h2>
<p>An example of a hypothetical <em>Springfield</em> counter/timer controller will be build
incrementally from scratch to aid in the explanation.</p>
<p>By now you should have read <a class="reference internal" href="../api/api_controller.html#sardana-controller-api"><span class="std std-ref">the general controller basics</span></a> chapter. You should
be able to create a CounterTimerController with:</p>
<ul class="simple">
<li><p>a proper constructor,</p></li>
<li><p>add and delete axis methods</p></li>
<li><p>get axis state</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">springfieldlib</span>

<span class="kn">from</span> <span class="nn">sardana.pool.controller</span> <span class="kn">import</span> <span class="n">CounterTimerController</span>

<span class="kn">from</span> <span class="nn">sardana</span> <span class="kn">import</span> <span class="n">State</span>

<span class="k">class</span> <span class="nc">SpringfieldCounterTimerController</span><span class="p">(</span><span class="n">CounterTimerController</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SpringfieldCounterTimerController</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># initialize hardware communication</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span> <span class="o">=</span> <span class="n">springfieldlib</span><span class="o">.</span><span class="n">SpringfieldCounterHW</span><span class="p">()</span>

        <span class="c1"># do some initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_counters</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">AddDevice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_counters</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">DeleteDevice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_counters</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>

    <span class="n">StateMap</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span> <span class="p">:</span> <span class="n">State</span><span class="o">.</span><span class="n">On</span><span class="p">,</span>
        <span class="mi">2</span> <span class="p">:</span> <span class="n">State</span><span class="o">.</span><span class="n">Moving</span><span class="p">,</span>
        <span class="mi">3</span> <span class="p">:</span> <span class="n">State</span><span class="o">.</span><span class="n">Fault</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">StateOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="n">springfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">StateMap</span><span class="p">[</span> <span class="n">springfield</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">springfield</span><span class="o">.</span><span class="n">getStatus</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">status</span>
</pre></div>
</div>
<p>The examples use a <code class="xref py py-mod docutils literal notranslate"><span class="pre">springfieldlib</span></code> module which emulates a counter/timer
hardware access library.</p>
<p>The <code class="xref py py-mod docutils literal notranslate"><span class="pre">springfieldlib</span></code> can be downloaded from
<a class="reference download internal" download="" href="../../_downloads/48cc05f28f359e8a865124c6a58f2f5c/springfieldlib.py"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>.</p>
<p>The Springfield counter/timer controller can be downloaded from
<a class="reference download internal" download="" href="../../_downloads/1ee318e3b22e27969f3c8794d728a338/sf_ct_ctrl.py"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>.</p>
<p>The following code describes a minimal <em>Springfield</em> base counter/timer controller
which is able to return both the state and value of an individual counter as
well as to start an acquisition:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpringfieldBaseCounterTimerController</span><span class="p">(</span><span class="n">CounterTimerController</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The most basic controller intended from demonstration purposes only.</span>
<span class="sd">    This is the absolute minimum you have to implement to set a proper counter</span>
<span class="sd">    controller able to get a counter value, get a counter state and do an</span>
<span class="sd">    acquisition.</span>

<span class="sd">    This example is so basic that it is not even directly described in the</span>
<span class="sd">    documentation&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SpringfieldBaseCounterTimerController</span><span class="p">,</span>
              <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span> <span class="o">=</span> <span class="n">springfieldlib</span><span class="o">.</span><span class="n">SpringfieldCounterHW</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">ReadOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the specified counter value&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">StateOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the specified counter state&quot;&quot;&quot;</span>
        <span class="n">springfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">springfield</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">State</span><span class="o">.</span><span class="n">On</span><span class="p">,</span> <span class="s2">&quot;Counter is stopped&quot;</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">State</span><span class="o">.</span><span class="n">Moving</span><span class="p">,</span> <span class="s2">&quot;Counter is acquiring&quot;</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">State</span><span class="o">.</span><span class="n">Fault</span><span class="p">,</span> <span class="s2">&quot;Counter has an error&quot;</span>

    <span class="k">def</span> <span class="nf">StartOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;acquire the specified counter&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">StartChannel</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">repetitions</span><span class="p">,</span> <span class="n">latency</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">LoadChannel</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">StopOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop the specified counter&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="get-counter-state">
<span id="sardana-countertimercontroller-howto-state"></span><h3>Get counter state<a class="headerlink" href="#get-counter-state" title="Permalink to this headline">¶</a></h3>
<p>To get the state of a counter, sardana calls the
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.StateOne" title="sardana.pool.controller.Controller.StateOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">StateOne()</span></code></a> method. This method
receives an axis as parameter and should return either:</p>
<blockquote>
<div><ul class="simple">
<li><p>state (<a class="reference internal" href="../api/sardana/sardanadefs.html#sardana.sardanadefs.State" title="sardana.sardanadefs.State"><code class="xref py py-obj docutils literal notranslate"><span class="pre">State</span></code></a>) or</p></li>
<li><dl class="simple">
<dt>a sequence of two elements:</dt><dd><ul>
<li><p>state (<a class="reference internal" href="../api/sardana/sardanadefs.html#sardana.sardanadefs.State" title="sardana.sardanadefs.State"><code class="xref py py-obj docutils literal notranslate"><span class="pre">State</span></code></a>)</p></li>
<li><p>status (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.8)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a>)</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<p>The state should be a member of <a class="reference internal" href="../api/sardana/sardanadefs.html#sardana.sardanadefs.State" title="sardana.sardanadefs.State"><code class="xref py py-obj docutils literal notranslate"><span class="pre">State</span></code></a> (For backward
compatibility reasons, it is also supported to return one of
<code class="xref py py-class docutils literal notranslate"><span class="pre">PyTango.DevState</span></code>). The status could be any string.</p>
</div>
<div class="section" id="load-a-counter">
<span id="sardana-countertimercontroller-howto-load"></span><h3>Load a counter<a class="headerlink" href="#load-a-counter" title="Permalink to this headline">¶</a></h3>
<p>To load a counter with either the integration time or the monitor counts,
sardana calls the <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Loadable.LoadOne" title="sardana.pool.controller.Loadable.LoadOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">LoadOne()</span></code></a> method.
This method receives axis, value and repetitions parameters. For the moment
let’s focus on the first two of them.</p>
<p>Here is an example of the possible implementation of
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Loadable.LoadOne" title="sardana.pool.controller.Loadable.LoadOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">LoadOne()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpringfieldCounterTimerController</span><span class="p">(</span><span class="n">CounterTimerController</span><span class="p">):</span>

<span class="hll">    <span class="k">def</span> <span class="nf">LoadOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">repetitions</span><span class="p">,</span> <span class="n">latency</span><span class="p">):</span>
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">LoadChannel</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="get-counter-value">
<span id="sardana-countertimercontroller-howto-value"></span><h3>Get counter value<a class="headerlink" href="#get-counter-value" title="Permalink to this headline">¶</a></h3>
<p>To get the counter value, sardana calls the
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Readable.ReadOne" title="sardana.pool.controller.Readable.ReadOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ReadOne()</span></code></a> method. This method
receives an axis as parameter and should return a valid counter value. Sardana
notifies the pseudo counters about the new counter value so they can be updated
(see <a class="reference internal" href="../overview/overview_pseudocounter.html#sardana-pseudocounter-overview"><span class="std std-ref">Pseudo counter overview</span></a> for more details).</p>
<p>Here is an example of the possible implementation of
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Readable.ReadOne" title="sardana.pool.controller.Readable.ReadOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ReadOne()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpringfieldCounterTimerController</span><span class="p">(</span><span class="n">CounterTimerController</span><span class="p">):</span>

<span class="hll">    <span class="k">def</span> <span class="nf">ReadOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
</span>        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>
</pre></div>
</div>
</div>
<div class="section" id="start-a-counter">
<span id="sardana-countertimercontroller-howto-start"></span><h3>Start a counter<a class="headerlink" href="#start-a-counter" title="Permalink to this headline">¶</a></h3>
<p>When an order comes for sardana to start a counter, sardana will call the
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Startable.StartOne" title="sardana.pool.controller.Startable.StartOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">StartOne()</span></code></a> method. This method receives
an axis as parameter. The controller code should trigger the hardware acquisition.</p>
<p>Here is an example of the possible implementation of
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Startable.StartOne" title="sardana.pool.controller.Startable.StartOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">StartOne()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpringfieldCounterTimerController</span><span class="p">(</span><span class="n">CounterTimerController</span><span class="p">):</span>

<span class="hll">    <span class="k">def</span> <span class="nf">StartOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">StartChannel</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
</pre></div>
</div>
<p>As soon as <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Startable.StartOne" title="sardana.pool.controller.Startable.StartOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">StartOne()</span></code></a> is invoked,
sardana expects the counter to be acquiring. It enters a high frequency acquisition
loop which asks for the counter state through calls to
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.StateOne" title="sardana.pool.controller.Controller.StateOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">StateOne()</span></code></a>. It will keep the loop
running as long as the controller responds with <code class="docutils literal notranslate"><span class="pre">State.Moving</span></code>.
If <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.StateOne" title="sardana.pool.controller.Controller.StateOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">StateOne()</span></code></a> raises an exception
or returns something other than <code class="docutils literal notranslate"><span class="pre">State.Moving</span></code>, sardana will assume the counter
is stopped and exit the acquisition loop.</p>
<p>For an acquisition to work properly, it is therefore, <strong>very important</strong> that
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.StateOne" title="sardana.pool.controller.Controller.StateOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">StateOne()</span></code></a> responds correctly.</p>
</div>
<div class="section" id="stop-a-counter">
<span id="sardana-countertimercontroller-howto-stop"></span><h3>Stop a counter<a class="headerlink" href="#stop-a-counter" title="Permalink to this headline">¶</a></h3>
<p>It is possible to stop a counter when it is acquiring. When sardana is ordered to
stop a counter acquisition, it invokes the <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Stopable.StopOne" title="sardana.pool.controller.Stopable.StopOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">StopOne()</span></code></a>
method. This method receives an axis parameter. The controller should make
sure the desired counter is <em>gracefully</em> stopped.</p>
<p>Here is an example of the possible implementation of
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Stopable.StopOne" title="sardana.pool.controller.Stopable.StopOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">StopOne()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpringfieldCounterTImerController</span><span class="p">(</span><span class="n">CounterTimerController</span><span class="p">):</span>

<span class="hll">    <span class="k">def</span> <span class="nf">StopOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">StopChannel</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="abort-a-counter">
<span id="sardana-countertimercontroller-howto-abort"></span><h3>Abort a counter<a class="headerlink" href="#abort-a-counter" title="Permalink to this headline">¶</a></h3>
<p>In an emergency situation, it is desirable to abort an acquisition
<em>as fast as possible</em>. When sardana is ordered to abort a counter acquisition,
it invokes the <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Stopable.AbortOne" title="sardana.pool.controller.Stopable.AbortOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AbortOne()</span></code></a>
method. This method receives an axis parameter. The controller should make
sure the desired counter is stopped as fast as it can be done.</p>
<p>Here is an example of the possible implementation of
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Stopable.AbortOne" title="sardana.pool.controller.Stopable.AbortOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AbortOne()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpringfieldCounterTimerController</span><span class="p">(</span><span class="n">CounterTimerController</span><span class="p">):</span>

<span class="hll">    <span class="k">def</span> <span class="nf">AbortOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">AbortChannel</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="timer-and-monitor-roles">
<span id="sardana-countertimercontroller-howto-timermonitor"></span><h2>Timer and monitor roles<a class="headerlink" href="#timer-and-monitor-roles" title="Permalink to this headline">¶</a></h2>
<p>Usually counters can work in either of two modes: timer or monitor. In both of
them, one counter in a group is assigned a special role to control when
the rest of them should stop counting. The stopping condition is based on the
integration time in case of the timer or on the monitor counts in case of the
monitor. The assignment of this special role is based on the measurement group
<a class="reference internal" href="../overview/overview_measurementgroup.html#sardana-measurementgroup-overview-configuration"><span class="std std-ref">Configuration</span></a>. The controller receives
this configuration (axis number) via the controller parameter <code class="docutils literal notranslate"><span class="pre">timer</span></code>
and <code class="docutils literal notranslate"><span class="pre">monitor</span></code>. The currently used acquisition mode is set via the controller
parameter <code class="docutils literal notranslate"><span class="pre">acquisition_mode</span></code>.</p>
<p>Controller may announce its default timer axis with the
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Loadable.default_timer" title="sardana.pool.controller.Loadable.default_timer"><code class="xref py py-obj docutils literal notranslate"><span class="pre">default_timer</span></code></a> class attribute.</p>
</div>
<div class="section" id="advanced-topics">
<span id="sardana-countertimercontroller-howto-advanced"></span><h2>Advanced topics<a class="headerlink" href="#advanced-topics" title="Permalink to this headline">¶</a></h2>
<div class="section" id="timestamp-a-counter-value">
<span id="sardana-countertimercontroller-howto-timestamp-value"></span><h3>Timestamp a counter value<a class="headerlink" href="#timestamp-a-counter-value" title="Permalink to this headline">¶</a></h3>
<p>When you read the value of a counter from the hardware sometimes it is
necessary to associate a timestamp with that value so you can track the
value of a counter in time.</p>
<p>If sardana is executed as a Tango device server, reading the value
attribute from the counter device triggers the execution of your controller’s
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Readable.ReadOne" title="sardana.pool.controller.Readable.ReadOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ReadOne()</span></code></a> method. Tango responds with
the value your controller returns from the call to
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Readable.ReadOne" title="sardana.pool.controller.Readable.ReadOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ReadOne()</span></code></a> and automatically assigns
a timestamp. However this timestamp has a certain delay since the time the
value was actually read from hardware and the time Tango generates the timestamp.</p>
<p>To avoid this, sardana supports returning in
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Readable.ReadOne" title="sardana.pool.controller.Readable.ReadOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ReadOne()</span></code></a> an object that contains both
the value and the timestamp instead of the usual <a class="reference external" href="https://docs.python.org/3/library/numbers.html#numbers.Number" title="(in Python v3.8)"><code class="xref py py-class docutils literal notranslate"><span class="pre">numbers.Number</span></code></a>.
The object must be an instance of <a class="reference internal" href="../api/sardana/sardanavalue.html#sardana.sardanavalue.SardanaValue" title="sardana.sardanavalue.SardanaValue"><code class="xref py py-class docutils literal notranslate"><span class="pre">SardanaValue</span></code></a>.</p>
<p>Here is an example of associating a timestamp in
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Readable.ReadOne" title="sardana.pool.controller.Readable.ReadOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ReadOne()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">sardana.pool.controller</span> <span class="kn">import</span> <span class="n">SardanaValue</span>

<span class="k">class</span> <span class="nc">SpringfieldCounterTimerController</span><span class="p">(</span><span class="n">CounterTimerController</span><span class="p">):</span>

   <span class="k">def</span> <span class="nf">ReadOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
       <span class="k">return</span> <span class="n">SardanaValue</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">axis</span><span class="p">),</span>
                           <span class="n">timestamp</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
</pre></div>
</div>
<p>If your controller communicates with a Tango device, Sardana also supports
returning a <code class="xref py py-class docutils literal notranslate"><span class="pre">DeviceAttribute</span></code> object. Sardana will use this
object’s value and timestamp. Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TangoCounterTimerController</span><span class="p">(</span><span class="n">CounterTimerController</span><span class="p">):</span>

   <span class="k">def</span> <span class="nf">ReadOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
       <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">read_attribute</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="multiple-acquisition-synchronization">
<span id="sardana-countertimercontroller-howto-mutliple-acquisition"></span><h3>Multiple acquisition synchronization<a class="headerlink" href="#multiple-acquisition-synchronization" title="Permalink to this headline">¶</a></h3>
<p>This chapter describes an extended <a class="reference internal" href="../../glossary.html#term-API"><span class="xref std std-term">API</span></a> that allows you to better
synchronize acquisitions involving more than one counter, as well as optimize
hardware communication (in case the hardware interface also supports this).</p>
<p>Often it is the case that the experiment/procedure the user runs requires to
acquire more than one counter at the same time
(see <a class="reference internal" href="../overview/overview_measurementgroup.html#sardana-measurementgroup-overview"><span class="std std-ref">Measurement group overview</span></a>).
Imagine that the user requires counter at axis 1 and counter at axis 2 to be
acquired.
Your controller will receive two consecutive calls to
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Startable.StartOne" title="sardana.pool.controller.Startable.StartOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">StartOne()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">StartOne</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">StartOne</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>and each StartOne will probably connect to the hardware (through serial line,
socket, <a class="reference external" href="http://www.tango-controls.org/">Tango</a> or <a class="reference external" href="http://www.aps.anl.gov/epics/">EPICS</a>) and ask the counter to be started.
This will do the job but, there will be a slight desynchronization between the
two counters because hardware call of counter 1 will be done before hardware call
to counter 2.</p>
<p>Sardana provides an extended <em>start acquisition</em> which gives you the possibility
to improve the synchronization (and probably reduce communications) but your
hardware controller must somehow support this feature as well.</p>
<p>The complete start acquisition <a class="reference internal" href="../../glossary.html#term-API"><span class="xref std std-term">API</span></a> consists of four methods:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Startable.PreStartAll" title="sardana.pool.controller.Startable.PreStartAll"><code class="xref py py-meth docutils literal notranslate"><span class="pre">PreStartAll()</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Startable.PreStartOne" title="sardana.pool.controller.Startable.PreStartOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">PreStartOne()</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Startable.StartOne" title="sardana.pool.controller.Startable.StartOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">StartOne()</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Startable.StartAll" title="sardana.pool.controller.Startable.StartAll"><code class="xref py py-meth docutils literal notranslate"><span class="pre">StartAll()</span></code></a></p></li>
</ul>
</div></blockquote>
<p>Except for <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Startable.StartOne" title="sardana.pool.controller.Startable.StartOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">StartOne()</span></code></a>, the
implementation of all other start methods is optional and their default
implementation does nothing (<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Startable.PreStartOne" title="sardana.pool.controller.Startable.PreStartOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">PreStartOne()</span></code></a>
actually returns <code class="docutils literal notranslate"><span class="pre">True</span></code>).</p>
<p>So, actually, the algorithm for counter acquisition start in sardana is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">acquisition</span>
    <span class="o">-</span> <span class="n">Call</span> <span class="n">PreStartAll</span><span class="p">()</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">acquisition</span>
    <span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">counter</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">acquisition</span>
        <span class="o">-</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">PreStartOne</span><span class="p">(</span><span class="n">counter</span> <span class="n">to</span> <span class="n">acquire</span><span class="p">,</span> <span class="n">new</span> <span class="n">position</span><span class="p">)</span>
        <span class="o">-</span> <span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">true</span>
            <span class="o">/</span><span class="n">RAISE</span><span class="o">/</span> <span class="n">Cannot</span> <span class="n">start</span><span class="o">.</span> <span class="n">Counter</span> <span class="n">PreStartOne</span> <span class="n">returns</span> <span class="kc">False</span>
        <span class="o">-</span> <span class="o">/</span><span class="n">END</span> <span class="n">IF</span><span class="o">/</span>
        <span class="o">-</span> <span class="n">Call</span> <span class="n">StartOne</span><span class="p">(</span><span class="n">counter</span> <span class="n">to</span> <span class="n">acquire</span><span class="p">,</span> <span class="n">new</span> <span class="n">position</span><span class="p">)</span>
    <span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">acquisition</span>
    <span class="o">-</span> <span class="n">Call</span> <span class="n">StartAll</span><span class="p">()</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>
</pre></div>
</div>
<p>The controllers over which we iterate in the above pseudo code are organized
so the master timer/monitor controller is the last one to be called. Similar order of
iteration applies to the counters of a given controller, so the timer/monitor
is the last one to be called.</p>
<p>You can assign the master controller role with the order of the controllers
in the measurement group. There is one master per each of the following
synchronization modes: <a class="reference internal" href="../api/sardana/pool/pooldefs.html#sardana.pool.pooldefs.AcqSynch.SoftwareTrigger" title="sardana.pool.pooldefs.AcqSynch.SoftwareTrigger"><code class="xref py py-attr docutils literal notranslate"><span class="pre">SoftwareTrigger</span></code></a>
and <a class="reference internal" href="../api/sardana/pool/pooldefs.html#sardana.pool.pooldefs.AcqSynch.SoftwareStart" title="sardana.pool.pooldefs.AcqSynch.SoftwareStart"><code class="xref py py-attr docutils literal notranslate"><span class="pre">SoftwareStart</span></code></a>. This order must be
set within the measurement group <a class="reference internal" href="../overview/overview_measurementgroup.html#sardana-measurementgroup-overview-configuration"><span class="std std-ref">Configuration</span></a>.</p>
<p>So, for the example above where we acquire two counters, the complete sequence of
calls to the controller is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">PreStartAll</span><span class="p">()</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">PreStartOne</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot start. Counter(1) PreStartOne returns False&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">PreStartOne</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot start. Counter(2) PreStartOne returns False&quot;</span><span class="p">)</span>

<span class="n">StartOne</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">StartOne</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">StartAll</span><span class="p">()</span>
</pre></div>
</div>
<p>Sardana assures that the above sequence is never interrupted by other calls,
like a call from a different user to get counter state.</p>
<p>Suppose the springfield library tells us in the documentation that:</p>
<blockquote>
<div><p>… to acquire multiple counters at the same time use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">startCounters</span><span class="p">(</span><span class="n">seq</span><span class="o">&lt;</span><span class="n">axis</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">startCounters</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div></blockquote>
<p>We can modify our counter controller to take profit of this hardware feature:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpringfieldCounterTimerController</span><span class="p">(</span><span class="n">MotorController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">PreStartAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># clear the local acquisition information dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_counters_info</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">StartOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="c1"># store information about this axis motion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_counters_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">StartAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">startCounters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_counters_info</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="hardware-synchronization">
<h3>Hardware synchronization<a class="headerlink" href="#hardware-synchronization" title="Permalink to this headline">¶</a></h3>
<p>The synchronization achieved in <a class="reference internal" href="#sardana-countertimercontroller-howto-mutliple-acquisition"><span class="std std-ref">Multiple acquisition synchronization</span></a>
may not be enough when it comes to acquiring with multiple controllers at the
same time or to executing multiple acquisitions in a row.
Some of the controllers can be synchronized on an external hardware
event and in this case several important aspects needs to be taken into account.</p>
<div class="section" id="synchronization-type">
<h4>Synchronization type<a class="headerlink" href="#synchronization-type" title="Permalink to this headline">¶</a></h4>
<p>First of all the controller needs to know which type of synchronization will
be used. This is assigned on the measurement group
<a class="reference internal" href="../overview/overview_measurementgroup.html#sardana-measurementgroup-overview-configuration"><span class="std std-ref">Configuration</span></a> level. The controller
receives one of the <a class="reference internal" href="../api/sardana/pool/pooldefs.html#sardana.pool.pooldefs.AcqSynch" title="sardana.pool.pooldefs.AcqSynch"><code class="xref py py-class docutils literal notranslate"><span class="pre">AcqSynch</span></code></a> values via the
controller parameter <code class="docutils literal notranslate"><span class="pre">synchronization</span></code>.</p>
<p>The selected mode will change the behavior of the counter after the
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Startable.StartOne" title="sardana.pool.controller.Startable.StartOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">StartOne()</span></code></a> is invoked. In case one of
the software modes was selected, the counter will immediately start acquiring.
In case one of the hardware modes was selected, the counter will immediately
get armed for the hardware events, and will wait with the acquisition until they
occur.</p>
<p>Here is an example of the possible implementation of
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.SetCtrlPar" title="sardana.pool.controller.Controller.SetCtrlPar"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SetCtrlPar()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sardana.pool</span> <span class="kn">import</span> <span class="n">AcqSynch</span>

<span class="hll"><span class="k">class</span> <span class="nc">SpringfieldCounterTimerController</span><span class="p">(</span><span class="n">CounterTimerController</span><span class="p">):</span>
</span>
    <span class="n">SynchMap</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">AcqSynch</span><span class="o">.</span><span class="n">SoftwareTrigger</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">AcqSynch</span><span class="o">.</span><span class="n">SoftwareGate</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">AcqSynch</span><span class="o">.</span><span class="n">HardwareTrigger</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">AcqSynch</span><span class="o">.</span><span class="n">HardwareGate</span><span class="p">:</span> <span class="mi">4</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">SetCtrlPar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SpringfieldMotorController</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">SetCtrlPar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">synchronization</span> <span class="o">=</span> <span class="n">SynchMap</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;synchronization&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">SetSynchronization</span><span class="p">(</span><span class="n">synchronization</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="multiple-acquisitions">
<h4>Multiple acquisitions<a class="headerlink" href="#multiple-acquisitions" title="Permalink to this headline">¶</a></h4>
<p>It is a very common scenario to execute multiple hardware synchronized
acquisitions in a row. One example of this type of measurements are the
<a class="reference internal" href="../../users/scan.html#sardana-users-scan-continuous"><span class="std std-ref">Continuous scans</span></a>. The controller receives the number of
acquisitions via the third argument of the
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Loadable.LoadOne" title="sardana.pool.controller.Loadable.LoadOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">LoadOne()</span></code></a> method.</p>
<p>Here is an example of the possible implementation of
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Loadable.LoadOne" title="sardana.pool.controller.Loadable.LoadOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">LoadOne()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpringfieldCounterTimerController</span><span class="p">(</span><span class="n">CounterTimerController</span><span class="p">):</span>

<span class="hll">    <span class="k">def</span> <span class="nf">LoadOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">repetitions</span><span class="p">,</span> <span class="n">latency</span><span class="p">):</span>
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">LoadChannel</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">SetRepetitions</span><span class="p">(</span><span class="n">repetitions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>
</pre></div>
</div>
</div>
<div class="section" id="get-counter-values">
<h4>Get counter values<a class="headerlink" href="#get-counter-values" title="Permalink to this headline">¶</a></h4>
<p>During the hardware synchronized acquisitions the counter values are usually
stored in the hardware buffers. Sardana enters a high frequency acquisition loop
after the <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Startable.StartOne" title="sardana.pool.controller.Startable.StartOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">StartOne()</span></code></a> is invoked
which, apart of asking for the counter state through calls to the
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.StateOne" title="sardana.pool.controller.Controller.StateOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">StateOne()</span></code></a> method, will try to retrieve
the counter values using the <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Readable.ReadOne" title="sardana.pool.controller.Readable.ReadOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ReadOne()</span></code></a> method.
It will keep the loop running as long as the controller responds with <code class="docutils literal notranslate"><span class="pre">State.Moving</span></code>.
Sardana executes one extra readout after the state has changed in order to retrieve
the final counter values.</p>
<p>The <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Readable.ReadOne" title="sardana.pool.controller.Readable.ReadOne"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ReadOne()</span></code></a> method is used indifferently
of the selected synchronization but its return values should depend on it and
can be:</p>
<blockquote>
<div><ul class="simple">
<li><p>a single counter value: either <a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.8)"><code class="xref py py-class docutils literal notranslate"><span class="pre">float</span></code></a> or <a class="reference internal" href="../api/sardana/sardanavalue.html#sardana.sardanavalue.SardanaValue" title="sardana.sardanavalue.SardanaValue"><code class="xref py py-obj docutils literal notranslate"><span class="pre">SardanaValue</span></code></a>
in case of the <a class="reference internal" href="../api/sardana/pool/pooldefs.html#sardana.pool.pooldefs.AcqSynch.SoftwareTrigger" title="sardana.pool.pooldefs.AcqSynch.SoftwareTrigger"><code class="xref py py-attr docutils literal notranslate"><span class="pre">SoftwareTrigger</span></code></a> or
<a class="reference internal" href="../api/sardana/pool/pooldefs.html#sardana.pool.pooldefs.AcqSynch.SoftwareGate" title="sardana.pool.pooldefs.AcqSynch.SoftwareGate"><code class="xref py py-attr docutils literal notranslate"><span class="pre">SoftwareGate</span></code></a> synchronization</p></li>
<li><p>a sequence of counter values: either <a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.8)"><code class="xref py py-class docutils literal notranslate"><span class="pre">float</span></code></a> or <a class="reference internal" href="../api/sardana/sardanavalue.html#sardana.sardanavalue.SardanaValue" title="sardana.sardanavalue.SardanaValue"><code class="xref py py-obj docutils literal notranslate"><span class="pre">SardanaValue</span></code></a>
in case of the <a class="reference internal" href="../api/sardana/pool/pooldefs.html#sardana.pool.pooldefs.AcqSynch.HardwareTrigger" title="sardana.pool.pooldefs.AcqSynch.HardwareTrigger"><code class="xref py py-attr docutils literal notranslate"><span class="pre">HardwareTrigger</span></code></a> or
<a class="reference internal" href="../api/sardana/pool/pooldefs.html#sardana.pool.pooldefs.AcqSynch.HardwareGate" title="sardana.pool.pooldefs.AcqSynch.HardwareGate"><code class="xref py py-attr docutils literal notranslate"><span class="pre">HardwareGate</span></code></a> synchronization</p></li>
</ul>
</div></blockquote>
<p>Sardana assumes that the counter values are returned in the order of acquisition
and that there are no gaps in between them.</p>
<div class="admonition-todo admonition" id="id1">
<p class="admonition-title">Todo</p>
<p>document how to skip the readouts while acquiring</p>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="howto_0dcontroller.html" class="btn btn-neutral float-right" title="How to write a 0D controller" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="howto_motorcontroller.html" class="btn btn-neutral float-left" title="How to write a motor controller" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright Except where otherwise noted, content on this site is
licensed under a Creative Commons Attribution 3.0 License

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>