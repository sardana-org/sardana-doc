

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>How to write a pseudo counter controller &mdash; sardana 3.1.2-alpha documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Writing recorders" href="../howto_recorders.html" />
    <link rel="prev" title="How to write a pseudo motor controller" href="howto_pseudomotorcontroller.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> sardana
          

          
            
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference external" href="http://www.sardana-controls.org">Home Page</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/sardana-org/sardana">Project Page</a></li>
<li class="toctree-l1"><a class="reference external" href="http://pypi.python.org/pypi/sardana">Download from PyPI</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../docs.html">Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../users/index.html">User’s Guide</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Developer’s Guide</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../overview/index.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../howto_macros/index.html">Writing macros</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Writing controllers</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="howto_controller.html">What is a controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_motorcontroller.html">How to write a motor controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_countertimercontroller.html">How to write a counter/timer controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_0dcontroller.html">How to write a 0D controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_1dcontroller.html">How to write a 1D controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_2dcontroller.html">How to write a 2D controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_triggergatecontroller.html">How to write a trigger/gate controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_ioregistercontroller.html">How to write an I/O register controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_pseudomotorcontroller.html">How to write a pseudo motor controller</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">How to write a pseudo counter controller</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../howto_recorders.html">Writing recorders</a></li>
<li class="toctree-l3"><a class="reference internal" href="../howto_test/index.html">Sardana Testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/api_sardana.html">API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide_migration/index.html">Migration guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/examples.html">Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide_coding.html">Development guidelines</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../sep/index.html">Sardana Enhancement Proposals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../news.html">What's new?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_versions.html">Docs for other Sardana versions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana-plugins">Plugins Catalogue</a></li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana/wiki">Wiki</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">sardana</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../docs.html">Sardana 3.1 Documentation</a> &raquo;</li>
        
          <li><a href="../index.html">Developer’s Guide</a> &raquo;</li>
        
          <li><a href="index.html">Writing controllers</a> &raquo;</li>
        
      <li>How to write a pseudo counter controller</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/devel/howto_controllers/howto_pseudocountercontroller.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="how-to-write-a-pseudo-counter-controller">
<span id="sardana-pseudocountercontroller-howto-basics"></span><h1>How to write a pseudo counter controller<a class="headerlink" href="#how-to-write-a-pseudo-counter-controller" title="Permalink to this headline">¶</a></h1>
<div class="section" id="the-basics">
<h2>The basics<a class="headerlink" href="#the-basics" title="Permalink to this headline">¶</a></h2>
<p>An example of a X-ray beam position monitor (XBPM) pseudo counter controller
will be build incrementally from scratch to aid in the explanation. Its purpose
is to provide an easy feedback about the beam position in the vertical and
horizontal axes as well as the total intensity of the beam.</p>
<p>By now you should have read <a class="reference internal" href="../api/api_controller.html#sardana-controller-api"><span class="std std-ref">the general controller basics</span></a> chapter. Let’s start
from writing a <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.PseudoCounterController" title="sardana.pool.controller.PseudoCounterController"><code class="xref py py-class docutils literal notranslate"><span class="pre">PseudoCounterController</span></code></a>
subclass with a proper constructor and the roles defined.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sardana.pool.controller</span> <span class="kn">import</span> <span class="n">PseudoCounterController</span>

<span class="k">class</span> <span class="nc">XBPMPseudoCounterController</span><span class="p">(</span><span class="n">PseudoCounterController</span><span class="p">):</span>

    <span class="n">counter_roles</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">pseudo_counter_roles</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">XBPMPseudoCounterController</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.PseudoCounterController.counter_roles" title="sardana.pool.controller.PseudoCounterController.counter_roles"><code class="xref py py-obj docutils literal notranslate"><span class="pre">counter_roles</span></code></a> and
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.PseudoCounterController.pseudo_counter_roles" title="sardana.pool.controller.PseudoCounterController.pseudo_counter_roles"><code class="xref py py-obj docutils literal notranslate"><span class="pre">pseudo_counter_roles</span></code></a>
tuples contains names of the counter and pseudo counter roles respectively.
These names are used when creating the controller instance and their order is
important when writing the controller itself. Each controller will define its
own roles.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is possible to omit the
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.PseudoCounterController.pseudo_counter_roles" title="sardana.pool.controller.PseudoCounterController.pseudo_counter_roles"><code class="xref py py-obj docutils literal notranslate"><span class="pre">pseudo_counter_roles</span></code></a>
definition if the controller provides only one axis. The controller class
name will be assumed as the pseudo counter role.</p>
</div>
<p>The constructor does nothing apart of calling the parent class constructor but
could be used to implement any necessary initialization.</p>
<p>The pseudo counter calculations are implemented in the
<code class="xref py py-meth docutils literal notranslate"><span class="pre">calc()</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">counter_values</span><span class="p">):</span>
    <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="n">counter_values</span>

    <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># vertical</span>
        <span class="n">vertical</span> <span class="o">=</span> <span class="p">(</span><span class="n">top</span> <span class="o">-</span> <span class="n">bottom</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">top</span> <span class="o">+</span> <span class="n">bottom</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vertical</span>
    <span class="k">elif</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># horizontal</span>
        <span class="n">horizontal</span> <span class="o">=</span> <span class="p">(</span><span class="n">right</span> <span class="o">-</span> <span class="n">left</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">right</span> <span class="o">+</span> <span class="n">left</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">horizontal</span>
    <span class="k">elif</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># total</span>
        <span class="n">total</span> <span class="o">=</span> <span class="p">(</span><span class="n">top</span> <span class="o">+</span> <span class="n">bottom</span> <span class="o">+</span> <span class="n">right</span> <span class="o">+</span> <span class="n">left</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span>
        <span class="k">return</span> <span class="n">total</span>
</pre></div>
</div>
<p>From the implementation we can conclude that the vertical pseudo counter will
give values from -1 to 1 depending on the beam position in the vertical
dimension. If the beam passes closer to the top sensor, the value will be more
positive. If the beam passes closer to the bottom sensor the value will be more
negative. The value close to the zero indicates the beam centered in the middle.
Similarly behaves the horizontal pseudo counter. The total pseudo counter is
the mean value of all the four sensors and indicates the beam intensity.</p>
</div>
<div class="section" id="changing-default-interface">
<span id="sardana-pseudocountercontroller-howto-changing-interface"></span><h2>Changing default interface<a class="headerlink" href="#changing-default-interface" title="Permalink to this headline">¶</a></h2>
<p>Pseudo counters instantiated from your controller will have a default
interface, which among others, comprises the <em>value</em> attribute. This attribute
is feed with the result of the
<code class="xref py py-meth docutils literal notranslate"><span class="pre">calc()</span></code> method and by
default it expects values of <code class="docutils literal notranslate"><span class="pre">float</span></code> type and scalar format. You can easily
<a class="reference internal" href="howto_controller.html#sardana-controller-howto-change-default-interface"><span class="std std-ref">change the default interface</span></a>.
This way you could program a pseudo counter to obtain an image <a class="reference internal" href="../../glossary.html#term-RoI"><span class="xref std std-term">RoI</span></a>
of a <a class="reference internal" href="../overview/overview_2D.html#sardana-2d-overview"><span class="std std-ref">2D experimental channel</span></a>.</p>
<p>Here is an example of how to change <em>value</em> attribute’s format to an image
and specify its maximum dimension of 1024 x 1024 pixels:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">GetAxisAttributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
    <span class="n">axis_attrs</span> <span class="o">=</span> <span class="n">PseudoCounterController</span><span class="o">.</span><span class="n">GetAxisAttributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
    <span class="n">axis_attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">axis_attrs</span><span class="p">)</span>
    <span class="n">axis_attrs</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">][</span><span class="n">Type</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="nb">float</span><span class="p">,</span> <span class="p">),</span> <span class="p">)</span>
    <span class="n">axis_attrs</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">][</span><span class="n">MaxDimSize</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">axis_attrs</span>
</pre></div>
</div>
</div>
<div class="section" id="get-pseudo-counter-shape">
<h2>Get pseudo counter shape<a class="headerlink" href="#get-pseudo-counter-shape" title="Permalink to this headline">¶</a></h2>
<p>If you change the pseudo counter format to spectrum or image then you
controller should provide the shape of the calculation result in either
of the formats:</p>
<ul class="simple">
<li><p>one-element sequence with the length of the spectrum</p></li>
<li><p>two-element sequence with the horizontal and vertical dimensions of the image</p></li>
</ul>
<p>using the <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.GetAxisPar" title="sardana.pool.controller.Controller.GetAxisPar"><code class="xref py py-meth docutils literal notranslate"><span class="pre">GetAxisPar()</span></code></a> method.</p>
<p>Here is an example of the possible implementation of
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.GetAxisPar" title="sardana.pool.controller.Controller.GetAxisPar"><code class="xref py py-meth docutils literal notranslate"><span class="pre">GetAxisPar()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">GetAxisPar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">par</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">par</span> <span class="o">==</span> <span class="s2">&quot;shape&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">]</span>
</pre></div>
</div>
<p>For backwards compatibility, in case of not implementing the <code class="docutils literal notranslate"><span class="pre">shape</span></code> axis
parameter, shape will be determined from the <code class="docutils literal notranslate"><span class="pre">MaxDimSize</span></code> of the <code class="docutils literal notranslate"><span class="pre">Value</span></code>
attribute as defined in <a class="reference internal" href="#sardana-pseudocountercontroller-howto-changing-interface"><span class="std std-ref">Changing default interface</span></a>.</p>
</div>
<div class="section" id="including-external-variables-in-the-calculation">
<h2>Including external variables in the calculation<a class="headerlink" href="#including-external-variables-in-the-calculation" title="Permalink to this headline">¶</a></h2>
<p>The pseudo counter calculation may require an arbitrary variable which is not
a counter value. One can use <a class="reference external" href="http://packages.python.org/taurus/">Taurus</a> or <a class="reference external" href="http://packages.python.org/PyTango/">PyTango</a> libraries in order to
read their attributes and use them in the calculation. It is even possible
to write pseudo counters not based at all on the counters. In this case it is
enough to define an empty
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.PseudoCounterController.counter_roles" title="sardana.pool.controller.PseudoCounterController.counter_roles"><code class="xref py py-obj docutils literal notranslate"><span class="pre">counter_roles</span></code></a> tuple.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../howto_recorders.html" class="btn btn-neutral float-right" title="Writing recorders" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="howto_pseudomotorcontroller.html" class="btn btn-neutral float-left" title="How to write a pseudo motor controller" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright Except where otherwise noted, content on this site is
licensed under a Creative Commons Attribution 3.0 License.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>