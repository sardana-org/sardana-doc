

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Device Pool Tango API &mdash; sardana 3.0.2-alpha documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> sardana
          

          
            
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference external" href="http://www.sardana-controls.org">Home Page</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/sardana-org/sardana">Project Page</a></li>
<li class="toctree-l1"><a class="reference external" href="http://pypi.python.org/pypi/sardana">Download from PyPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana-plugins">Plugins Catalogue</a></li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana/wiki">Wiki</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">sardana</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>Device Pool Tango <span class="xref std std-term">API</span></li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/devel/api/tango_device_pool.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="device-pool-tango-api">
<h1>Device Pool <a class="reference external" href="http://www.tango-controls.org/">Tango</a> <a class="reference internal" href="../../glossary.html#term-API"><span class="xref std std-term">API</span></a><a class="headerlink" href="#device-pool-tango-api" title="Permalink to this headline">¶</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Device Pool chapter is out of date. Some parts of it are not valid and may create confusions e.g. “Specifying the motor controller features”.</p>
</div>
<div class="admonition-todo admonition" id="id1">
<p class="admonition-title">Todo</p>
<p>Update this chapter and distribute its contents logically around the documentation.</p>
</div>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This paper describes what could be the implementation of the Sardana
device pool. This work is based on Jorg’s paper called “Reordered
<a class="reference external" href="http://www.certif.com/">SPEC</a>”. It is <strong>not at all</strong> a final version of this device pool. It is rather
a first approach to define this pool more precisely and to help defining its
features and the way it could be implemented.</p>
</div>
<div class="section" id="overall-pool-design">
<h2>Overall pool design<a class="headerlink" href="#overall-pool-design" title="Permalink to this headline">¶</a></h2>
<p>The pool could be seen as a kind of intelligent <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device container
to control the experiment hardware. In a first approach, it requires
that the hardware to be controlled is connected to the control
computer or to external crate(s) connected to the control computer
using bus coupler. It has two basic features which are:</p>
<ol class="arabic simple">
<li><p>Hardware access using dynamically created/deleted <a class="reference external" href="http://www.tango-controls.org/">Tango</a> devices
according to the experiment needs</p></li>
<li><p>Management of some very common and well defined action regularly done
on a beam line (scanning, motor position archiving….)</p></li>
</ol>
<p>To achieve these two goals and to provide the user with a way to
control its behavior, it is implemented as a <a class="reference external" href="http://www.tango-controls.org/">Tango</a> class with commands
and attributes like any other <a class="reference external" href="http://www.tango-controls.org/">Tango</a> class.</p>
<div class="section" id="hardware-access">
<h3>Hardware access<a class="headerlink" href="#hardware-access" title="Permalink to this headline">¶</a></h3>
<div class="section" id="core-hardware-access">
<h4>Core hardware access<a class="headerlink" href="#core-hardware-access" title="Permalink to this headline">¶</a></h4>
<p>Most of the times, it is possible to define a list of very common
devices found in most of the experiments, a list of communication link
used between the experiment hardware and the control computer(s) and
some of the most commonly used protocol used on these communication
links. Devices commonly used to drive an experiment are:</p>
<ul class="simple">
<li><p>Motor</p></li>
<li><p>Group of motor</p></li>
<li><p>Pseudo motor</p></li>
<li><p>Counter/Timer</p></li>
<li><p>Multi Channel Analyzer</p></li>
<li><p>CCD cameras</p></li>
<li><p>And some other that I don’t know</p></li>
</ul>
<p>Communication link used to drive experiment devices are:</p>
<ul class="simple">
<li><p>Serial line</p></li>
<li><p>GPIB</p></li>
<li><p>Socket</p></li>
<li><p>And some other that I don’t know (USB????)</p></li>
</ul>
<p>Protocol used on the communication links are:</p>
<ul class="simple">
<li><p>Modbus</p></li>
<li><p>Ans some other that I don’t know</p></li>
</ul>
<p>Each of the controlled hardware (one motor, one pseudo-motor, one
serial line device,…) will be driven by independent <a class="reference external" href="http://www.tango-controls.org/">Tango</a> classes.
The pool device server will embed all these <a class="reference external" href="http://www.tango-controls.org/">Tango</a> classes together
(statically linked). The pool <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device is the “container
interface” and allows the user to create/delete classical <a class="reference external" href="http://www.tango-controls.org/">Tango</a>
devices which are instances of these embedded classes. This is
summarized in the following drawing.</p>
<img alt="../../_images/hard.png" src="../../_images/hard.png" />
<p>Therefore, the three main actions to control a new equipment using the
pool will be (assuming the equipment is connected to the control
computer via a serial line):</p>
<ol class="arabic simple">
<li><p>Create the serial line <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device with one of the Pool device
command assigning it a name like “MyNewEquipment”.</p></li>
<li><p>Connect to this newly created <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device using its assigned name</p></li>
<li><p>Send order or write/read data to/from the new equipment using for
instance the WriteRead command of the serial line <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device</p></li>
</ol>
<p>When the experiment does not need this new equipment any more, the
user can delete the serial line <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device with another pool device
command. Note that most of the time, creating <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device means
defining some device configuration parameters (Property in <a class="reference external" href="http://www.tango-controls.org/">Tango</a>
language). The <a class="reference external" href="http://www.tango-controls.org/">Tango</a> wizard will be used to retrieve which properties
have to be defined and will allow the user to set them on the fly.
This means that all the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> classes embedded within the Pool must
have their wizard initialized.</p>
</div>
<div class="section" id="extending-pool-features">
<h4>Extending pool features<a class="headerlink" href="#extending-pool-features" title="Permalink to this headline">¶</a></h4>
<p>From time to time, it could be useful to extend the list of <a class="reference external" href="http://www.tango-controls.org/">Tango</a>
classes known by the device pool in case a new kind of equipment (not
using the core hardware access) is added to the experiment. Starting
with <a class="reference external" href="http://www.tango-controls.org/">Tango</a> 5.5 (and the associated Pogo), each <a class="reference external" href="http://www.tango-controls.org/">Tango</a> class has a
method which allow the class to be dynamically loaded into a running
process. This feature will be used to extend the pool feature. It has
to be checked that it is possible for <a class="reference external" href="http://www.tango-controls.org/">Tango</a> Python class.</p>
<img alt="../../_images/dyn.png" src="../../_images/dyn.png" />
<p>To achieve this feature, the pool <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device will have commands to</p>
<ul>
<li><p>Load a <a class="reference external" href="http://www.tango-controls.org/">Tango</a> class. This command will dynamically add two other
commands and one attribute to the pool device <a class="reference external" href="http://www.tango-controls.org/">Tango</a> interface. These
commands and the attribute are:</p>
<blockquote>
<div><ul class="simple">
<li><p>Command: Create a device of the newly loaded class</p></li>
<li><p>Command: Delete a device of the newly loaded class</p></li>
<li><p>Attribute: Get the list of <a class="reference external" href="http://www.tango-controls.org/">Tango</a> devices instances of the newly
created class</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Unload a <a class="reference external" href="http://www.tango-controls.org/">Tango</a> class</p></li>
<li><p>Reload a <a class="reference external" href="http://www.tango-controls.org/">Tango</a> class</p></li>
</ul>
</div>
</div>
<div class="section" id="global-actions">
<h3>Global actions<a class="headerlink" href="#global-actions" title="Permalink to this headline">¶</a></h3>
<p>The following common actions regularly done on a beam line experiment
will be done by the pool device server:</p>
<ul class="simple">
<li><p>Evaluating user constraint(s) before moving motor(s)</p></li>
<li><p>Scanning</p></li>
<li><p>Saving experiment data</p></li>
<li><p>Experiment management</p></li>
<li><p>Archiving motor positions</p></li>
</ul>
</div>
</div>
<div class="section" id="sardana-core-hardware-access">
<h2>Sardana core hardware access<a class="headerlink" href="#sardana-core-hardware-access" title="Permalink to this headline">¶</a></h2>
<div class="section" id="the-sardana-motor-management">
<h3>The Sardana Motor management<a class="headerlink" href="#the-sardana-motor-management" title="Permalink to this headline">¶</a></h3>
<div class="section" id="the-user-motor-interface">
<h4>The user motor interface<a class="headerlink" href="#the-user-motor-interface" title="Permalink to this headline">¶</a></h4>
<p>The motor interface is a first approach of what could be a complete
motor interface. It is statically linked with the Pool device server
and supports several attributes and commands. It is implemented in C++
and used a set of the so-called “controller” methods. The motor
interface is always the same whatever the hardware is. This is the
rule of the “controller” to access the hardware using the
communication link supported by the motor controller hardware (network
link, serial line…).</p>
<img alt="../../_images/motor.png" src="../../_images/motor.png" />
<p>The controller code has a well-defined interface and can be written
using Python or C++. In both cases, it will be dynamically loaded into
the pool device server process.</p>
<div class="section" id="the-states">
<h5>The states<a class="headerlink" href="#the-states" title="Permalink to this headline">¶</a></h5>
<p>The motor interface knows five states which are ON, MOVING, ALARM,
FAULT and UNKNOWN. A motor device is in MOVING state when it is
moving! It is in ALARM state when it has reached one of the limit
switches and is in FAULT if its controller software is not available
(impossible to load it) or if a fault is reported from the hardware
controller. The motor is in the UNKNOWN state if an exception occurs
during the communication between the pool and the hardware controller.
When the motor is in ALARM state, its status will indicate which limit
switches is active.</p>
</div>
<div class="section" id="the-commands">
<h5>The commands<a class="headerlink" href="#the-commands" title="Permalink to this headline">¶</a></h5>
<p>The motor interface supports 3 commands on top of the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> classical
Init, State and Status commands. These commands are summarized in the
following table:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 27%" />
<col style="width: 36%" />
<col style="width: 36%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Command name</p></th>
<th class="head"><p>Input data type</p></th>
<th class="head"><p>Output data type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Abort</p></td>
<td><p>void</p></td>
<td><p>void</p></td>
</tr>
<tr class="row-odd"><td><p>SetPosition</p></td>
<td><p>Tango::DevDouble</p></td>
<td><p>void</p></td>
</tr>
<tr class="row-even"><td><p>SaveConfig</p></td>
<td><p>void</p></td>
<td><p>void</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p><strong>Abort</strong> : It aborts a running motion. This command does not have input or
output argument.</p></li>
<li><p><strong>SetPosition</strong> : Loads a position into controller. It has one input argument which is
the new position value (a double). It is allowed only in the ON or
ALARM states. The unit used for the command input value is the
physical unit: millimeters or milli-radians. It is always an absolute
position.</p></li>
<li><p><strong>SaveConfig</strong> : Write some of the motor parameters in database. Today, it writes the
motor acceleration, deceleration, base_rate and velocity into database
as motor device properties. It is allowed only in the ON or ALARM
states</p></li>
</ul>
<p>The classical <a class="reference external" href="http://www.tango-controls.org/">Tango</a> Init command destroys the motor and re-create it.</p>
</div>
<div class="section" id="the-attributes">
<h5>The attributes<a class="headerlink" href="#the-attributes" title="Permalink to this headline">¶</a></h5>
<p>The motor interface supports several attributes which are summarized
in the following table:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 25%" />
<col style="width: 16%" />
<col style="width: 12%" />
<col style="width: 13%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Data type</p></th>
<th class="head"><p>Data format</p></th>
<th class="head"><p>Writable</p></th>
<th class="head"><p>Memorized</p></th>
<th class="head"><p>Ope/Expert</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Position</p></td>
<td><p>Tango::DevDouble</p></td>
<td><p>Scalar</p></td>
<td><p>R/W</p></td>
<td><p>No *</p></td>
<td><p>Ope</p></td>
</tr>
<tr class="row-odd"><td><p>DialPosition</p></td>
<td><p>Tango::DevDouble</p></td>
<td><p>Scalar</p></td>
<td><p>R</p></td>
<td><p>No</p></td>
<td><p>Exp</p></td>
</tr>
<tr class="row-even"><td><p>Offset</p></td>
<td><p>Tango::DevDouble</p></td>
<td><p>Scalar</p></td>
<td><p>R/W</p></td>
<td><p>Yes</p></td>
<td><p>Exp</p></td>
</tr>
<tr class="row-odd"><td><p>Acceleration</p></td>
<td><p>Tango::DevDouble</p></td>
<td><p>Scalar</p></td>
<td><p>R/W</p></td>
<td><p>No</p></td>
<td><p>Exp</p></td>
</tr>
<tr class="row-even"><td><p>Base_rate</p></td>
<td><p>Tango::DevDouble</p></td>
<td><p>Scalar</p></td>
<td><p>R/W</p></td>
<td><p>No</p></td>
<td><p>Exp</p></td>
</tr>
<tr class="row-odd"><td><p>Deceleration</p></td>
<td><p>Tango::DevDouble</p></td>
<td><p>Scalar</p></td>
<td><p>R/W</p></td>
<td><p>No</p></td>
<td><p>Exp</p></td>
</tr>
<tr class="row-even"><td><p>Velocity</p></td>
<td><p>Tango::DevDouble</p></td>
<td><p>Scalar</p></td>
<td><p>R/W</p></td>
<td><p>No</p></td>
<td><p>Exp</p></td>
</tr>
<tr class="row-odd"><td><p>Limit_Switches</p></td>
<td><p>Tango::DevBoolean</p></td>
<td><p>Spectrum</p></td>
<td><p>R</p></td>
<td><p>No</p></td>
<td><p>Exp</p></td>
</tr>
<tr class="row-even"><td><p>SimulationMode</p></td>
<td><p>Tango::DevBoolean</p></td>
<td><p>Scalar</p></td>
<td><p>R</p></td>
<td><p>No</p></td>
<td><p>Exp</p></td>
</tr>
<tr class="row-odd"><td><p>Step_per_unit</p></td>
<td><p>Tango::DevDouble</p></td>
<td><p>Scalar</p></td>
<td><p>R/W</p></td>
<td><p>Yes</p></td>
<td><p>Exp</p></td>
</tr>
<tr class="row-even"><td><p>Backlash</p></td>
<td><p>Tango::DevLong</p></td>
<td><p>Scalar</p></td>
<td><p>R/W</p></td>
<td><p>Yes</p></td>
<td><p>Exp</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Position</strong> : This is read-write scalar double attribute. With the classical Tango
min and max_value attribute properties, it is easy to define
authorized limit for this attribute. See the definition of the
DialPosition and Offset attributes to get a precise definition of the
meaning of this attribute. It is not allowed to read or write this
attribute when the motor is in FAULT or UNKNOWN state. It is also not
possible to write this attribute when the motor is already MOVING. <strong>The unit used for this attribute is the physical unit: millimeters or
milli-radian. It is always an</strong> <strong>absolute</strong> <strong>position.</strong> The value of this attribute is memorized in the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> database but not
by the default <a class="reference external" href="http://www.tango-controls.org/">Tango</a> system memorization. See chapter
XXX: Unknown inset LatexCommand ref{sub:Archiving-motor-position}:
for details about motor position archiving.</p></li>
<li><p><strong>DialPosition</strong> : This attribute is the motor dial position. The following formula
links together the Position, DialPosition, Sign and Offset attributes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Position</span> <span class="o">=</span> <span class="n">Sign</span> <span class="o">*</span> <span class="n">DialPosition</span> <span class="o">+</span> <span class="n">Offset</span>
</pre></div>
</div>
<p>This allows to have the motor position centered around any position
defined by the Offset attribute (classically the X ray beam position).
It is a read only attribute. To set the motor position, the user has
to use the Position attribute. It is not allowed to read this
attribute when the motor is in FAULT or UNKNOWN mode. The unit used
for this attribute is the physical unit: millimeters or milli-radian.
It is also always an <strong>absolute</strong> position.</p>
</li>
<li><p><strong>Offset</strong> : The offset to be applied in the motor position computation. By
default set to 0. It is a memorized attribute. It is not allowed to
read or write this attribute when the motor is in FAULT, MOVING or
UNKNOWN mode.</p></li>
<li><p><strong>Acceleration</strong> : This is an expert read-write scalar double attribute. This parameter
value is written in database when the SaveConfig command is executed.
It is not allowed to read or write this attribute when the motor is in
FAULT or UNKNOWN state.</p></li>
<li><p><strong>Deceleration</strong> : This is an expert read-write scalar double attribute. This parameter
value is written in database when the SaveConfig command is executed.
It is not allowed to read or write this attribute when the motor is in
FAULT or UNKNOWN state.</p></li>
<li><p><strong>Base_rate</strong> : This is an expert read-write scalar double attribute. This parameter
value is written in database when the SaveConfig command is executed.
It is not allowed to read or write this attribute when the motor is in
FAULT or UNKNOWN state.</p></li>
<li><p><strong>Velocity</strong> : This is an expert read-write scalar double attribute. This parameter
value is written in database when the SaveConfig command is executed.
It is not allowed to read or write this attribute when the motor is in
FAULT or UNKNOWN state.</p></li>
<li><p><strong>Limit_Switches</strong> : Three limit switches are managed by this attribute. Each of the
switch are represented by a boolean value: False means inactive while
True means active. It is a read only attribute. It is not possible to
read this attribute when the motor is in UNKNOWN mode. It is a
spectrum attribute with 3 values which are:</p>
<blockquote>
<div><ul class="simple">
<li><p>Data[0] : The Home switch value</p></li>
<li><p>Data[1] : The Upper switch value</p></li>
<li><p>Data[2] : The Lower switch value</p></li>
</ul>
</div></blockquote>
</li>
<li><p><strong>SimulationMode</strong> : This is a read only scalar boolean attribute. When set, all motion
requests are not forwarded to the software controller and then to the
hardware. When set, the motor position is simulated and is immediately
set to the value written by the user. To set this attribute, the user
has to used the pool device <a class="reference external" href="http://www.tango-controls.org/">Tango</a> interface. The value of the
position, acceleration, deceleration, base_rate, velocity and offset
attributes are memorized at the moment this attribute is set. When
this mode is turned off, if the value of any of the previously
memorized attributes has changed, it is reapplied to the memorized
value. It is not allowed to read this attribute when the motor is in
FAULT or UNKNOWN states.</p></li>
<li><p><strong>Step_per_unit</strong> : This is the number of motor step per millimeter or per degree. It is
a memorized attribute. It is not allowed to read or write this
attribute when the motor is in FAULT or UNKNOWN mode. It is also not
allowed to write this attribute when the motor is MOVING. The default
value is 1.</p></li>
<li><p><strong>Backlash</strong> : If this attribute is defined to something different than 0, the
motor will always stop the motion coming from the same mechanical
direction. This means that it could be possible to ask the motor to go
a little bit after the desired position and then to return to the
desired position. The attribute value is the number of steps the motor
will pass the desired position if it arrives from the “wrong”
direction. This is a signed value. If the sign is positive, this means
that the authorized direction to stop the motion is the increasing
motor position direction. If the sign is negative, this means that the
authorized direction to stop the motion is the decreasing motor
position direction. It is a memorized attribute. It is not allowed to
read or write this attribute when the motor is in FAULT or UNKNOWN
mode. It is also not allowed to write this attribute when the motor is
MOVING. Some hardware motor controllers are able to manage this
backlash feature. If it is not the case, the motor interface will
implement this behavior.</p></li>
</ul>
<p>All the motor devices will have the already described attributes but
some hardware motor controller supports other features which are not
covered by this list of pre-defined attributes. Using <a class="reference external" href="http://www.tango-controls.org/">Tango</a> dynamic
attribute creation, a motor device may have extra attributes used to
get/set the motor hardware controller specific features. The main
characteristics of these extra attributes are :</p>
<ul class="simple">
<li><p>Name defined by the motor controller software (See next chapter)</p></li>
<li><p>Data type is BOOLEAN, LONG, DOUBLE or STRING defined by the motor
controller software (See next chapter)</p></li>
<li><p>The data format is always Scalar</p></li>
<li><p>The write type is READ or READ_WRITE defined by the motor controller
software (See next chapter). If the write type is READ_WRITE, the
attribute is memorized by the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> layer</p></li>
</ul>
</div>
<div class="section" id="the-motor-properties">
<h5>The motor properties<a class="headerlink" href="#the-motor-properties" title="Permalink to this headline">¶</a></h5>
<p>Each motor device has a set of properties. Five of these properties
are automatically managed by the pool software and must not be changed
by the user. These properties are named Motor_id, _Acceleration,
_Velocity, _Base_rate and _Deceleration. The user properties are:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 63%" />
<col style="width: 37%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Property name</p></th>
<th class="head"><p>Default value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Sleep_bef_last_read</p></td>
<td><p>0</p></td>
</tr>
</tbody>
</table>
<p>This property defines the time in milli-second that the software
managing a motor movement will wait between it detects the end of the
motion and the last motor position reading.</p>
</div>
<div class="section" id="getting-motor-state-and-limit-switches-using-event">
<h5>Getting motor state and limit switches using event<a class="headerlink" href="#getting-motor-state-and-limit-switches-using-event" title="Permalink to this headline">¶</a></h5>
<p>The simplest way to know if a motor is moving is to survey its state.
If the motor is moving, its state will be MOVING. When the motion is
over, its state will be back to ON (or ALARM if a limit switch has
been reached). The pool motor interface allows client interested by
motor state or motor limit switches value to use the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> event
system subscribing to motor state change event. As soon as a motor
starts a motion, its state is changed to MOVING and an event is sent.
As soon as the motion is over, the motor state is updated ans another
event is sent. In the same way, as soon as a change in the limit
switches value is detected, a change event is sent to client(s) which
have subscribed to change event on the Limit_Switches attribute.</p>
</div>
<div class="section" id="reading-the-motor-position-attribute">
<h5>Reading the motor position attribute<a class="headerlink" href="#reading-the-motor-position-attribute" title="Permalink to this headline">¶</a></h5>
<p>For each motor, the key attribute is its position. Special care has
been taken on this attribute management. When the motor is not moving,
reading the Position attribute will generate calls to the controller
and therefore hardware access. When the motor is moving, its position
is automatically read every 100 milli-seconds and stored in the Tango
polling buffer. This means that a client reading motor Position
attribute while the motor is moving will get the position from the
<a class="reference external" href="http://www.tango-controls.org/">Tango</a> polling buffer and will not generate extra controller calls. It
is also possible to get a motor position using the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> event system.
When the motor is moving, an event is sent to the registered clients
when the change event criterion is true. By default, this change event
criterion is set to be a difference in position of 5. It is tunable on
a motor basis using the classical motor Position attribute abs_change
property or at the pool device basis using its DefaultMotPos_AbsChange
property. Anyway, not more than 10 events could be sent by second.
Once the motion is over, the motor position is made unavailable from
the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> polling buffer and is read a last time after a tunable
waiting time (Sleep_bef_last_read property). A forced change event
with this value is sent to clients using events.</p>
</div>
</div>
<div class="section" id="the-motor-controller">
<h4>The Motor Controller<a class="headerlink" href="#the-motor-controller" title="Permalink to this headline">¶</a></h4>
<p>XXX: Unknown inset LatexCommand label{sub:The-Motor-Controller}:</p>
<p>Each controller code is built as a shared library or as a Python
module which is dynamically loaded by the pool device the first time
one controller using the shared library (or the module) is created.
Each controller is uniquely defined by its name following the syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">controller_file_name</span><span class="o">&gt;.&lt;</span><span class="n">controller_class_name</span><span class="o">&gt;/&lt;</span><span class="n">instance_name</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>At controller creation time, the pool checks the controller unicity on
its control system (defined by the TANGO_HOST). It is possible to
write controller using either C++ or Python language. Even if a Tango
device server is a multi-threaded process, every access to the same
controller will be serialized by a monitor managed by the Motor
interface. This monitor is attached to the controller class and not to
the controller instance to handle cases where several instances of the
same controller class is used. For Python controller, this monitor
will also take care of taking/releasing the Python Global Interpreter
Lock (GIL) before any call to the Python controller is executed.</p>
<div class="section" id="the-basic">
<h5>The basic<a class="headerlink" href="#the-basic" title="Permalink to this headline">¶</a></h5>
<p>For motor controller, a pre-defined set of methods has to be
implemented in the class implementing the controller interface. These
methods can be splitted in 6 different types which are:</p>
<ol class="arabic simple">
<li><p>Methods to create/remove motor</p></li>
<li><p>Methods to move motor(s)</p></li>
<li><p>Methods to read motor(s) position</p></li>
<li><p>Methods to get motor(s) state</p></li>
<li><p>Methods to configure a motor</p></li>
<li><p>Remaining methods.</p></li>
</ol>
<p>These methods, their rules and their execution sequencing is detailed
in the following sub-chapters. The motor controller software layer is
also used to inform the upper level of the features supported by the
underlying hardware. This is called the controller <strong>features</strong> . It is detailed in a following sub-chapter. Some controller may need
some configuration data. This will be supported using Tango
properties. This is detailed in a dedicated sub-chapter.</p>
</div>
<div class="section" id="specifying-the-motor-controller-features">
<h5>Specifying the motor controller features<a class="headerlink" href="#specifying-the-motor-controller-features" title="Permalink to this headline">¶</a></h5>
<p>A controller feature is something that motor hardware controller is
able to do or require on top of what has been qualified as the basic
rules. Even if these features are common, not all the controllers
implement them. Each of these common features are referenced by a pre-
defined string. The controller code writer defined (from a pre-defined
list) which of these features his hardware controller
implements/requires. This list (a Python list or an array of C
strings) has a well-defined name used by the upper layer software to
retrieve it. The possible strings in this list are (case independent):</p>
<ul class="simple">
<li><p><strong>CanDoBacklash</strong> : The hardware controller manages the motor backlash if the user
defines one</p></li>
<li><p><strong>WantRounding</strong> : The hardware controller wants an integer number of step</p></li>
<li><p><strong>encoder</strong> : The hardware knows how to deal with encoder</p></li>
<li><p><strong>home</strong> : The hardware is able to manage home switch</p></li>
<li><p><strong>home_acceleration</strong> : It is possible to set the acceleration for motor homing</p></li>
<li><p><strong>home_method</strong> _ <strong>xxx</strong> : The hardware knows the home method called xxx</p></li>
<li><p><strong>home_method_yyy</strong> : The hardware knows the home method called yyy</p></li>
</ul>
<p>The name of this list is simply: <strong>ctrl_features</strong> . If this list is not defined, this means that the hardware does not
support/require any of the additional features. The <a class="reference external" href="http://www.tango-controls.org/">Tango</a> motor class
will retrieve this list from the controller before the first motor
belonging to this controller is created. As an example, we suppose
that we have a pool with two classes of motor controller called Ctrl_A
and Ctrl_B. The controllers features list are (in Python)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Controller</span> <span class="n">A</span> <span class="p">:</span> <span class="n">ctrl_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CanDoBacklash&#39;</span><span class="p">,</span><span class="s1">&#39;encoder&#39;</span><span class="p">]</span>
<span class="n">ControllerB</span> <span class="p">:</span> <span class="n">ctrl_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;WantRounding&#39;</span><span class="p">,</span><span class="s1">&#39;home&#39;</span><span class="p">,</span><span class="s1">&#39;home_method_xxx&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>All motors devices belonging to the controller A will have the Encoder
and Backlash features. For these motors, the backlash will be done by
the motor controller hardware. All the motors belonging to the
controller B will have the rounding, home and home_method features.
For these motors, the backlash will be done by the motor interface
code.</p>
</div>
<div class="section" id="specifying-the-motor-controller-extra-attributes">
<h5>Specifying the motor controller extra attributes<a class="headerlink" href="#specifying-the-motor-controller-extra-attributes" title="Permalink to this headline">¶</a></h5>
<p>XXX: Unknown inset LatexCommand label{par:Specifying-the-motor}:</p>
<p>Some of the hardware motor controller will have features not defined
in the features list or not accessible with a pre-defined feature. To
provide an interface to these specific hardware features, the
controller code can define extra attributes. Another list called : <strong>ctrl_extra_attributes</strong> is used to define them. This list (Python dictionary or an array of
classical C strings) is used to define the name, data and read-write
type of the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> attribute which will be created to deal with these
extra features. The attribute created for these controller extra
features are all:</p>
<ul class="simple">
<li><p>Boolean, Long, Double or String</p></li>
<li><p>Scalar</p></li>
<li><p>Read or Read/Write (and memorized if Read/Write).</p></li>
</ul>
<p>For Python classes (Python controller class), it is possible to define
these extra attributes informations using a Python dictionary called <strong>ctrl_extra</strong> _ <strong>attributes</strong> . The extra attribute name is the dictionary element key. The
dictionary element value is another dictionary with two members which
are the extra attribute data type and the extra attribute read/write
type. For instance, for our IcePap controller, this dictionary to
defined one extra attribute called “SuperExtra” of data type Double
which is also R/W will be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ctrl_extra_attributes</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;SuperExtra&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;Type&quot;</span> <span class="p">:</span> <span class="s2">&quot;DevDouble&quot;</span><span class="p">,</span> <span class="s2">&quot;R/W Type&quot;</span><span class="p">,</span> <span class="s2">&quot;READ_WRITE&quot;</span> <span class="p">}</span> <span class="p">}</span>
</pre></div>
</div>
<p>For C++ controller class, the extra attributes are defined within an
array of <strong>Controller::ExtraAttrInfo</strong> structures. The name of this array has to be
&lt;Ctrl_class_name&gt;_ctrl_extra_attributes. Each
Controller::ExtraAttrInfo structure has three elements which are all
pointers to classical C string (const char *). These elements are:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>The extra attribute name</p></li>
<li><p>The extra attribute data type</p></li>
<li><p>The extra attribute R/W type</p></li>
</ol>
</div></blockquote>
<p>A NULL pointer defined the last extra attribute. The following is an
example of extra attribute definition for a controller class called
“DummyController”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Controller</span><span class="p">::</span><span class="n">ExtraAttrInfo</span> <span class="n">DummyController_ctrl_extra_attributes</span><span class="p">[]</span> <span class="o">=</span>
    <span class="p">{</span> <span class="p">{</span> <span class="s2">&quot;SuperExtra&quot;</span><span class="p">,</span> <span class="s2">&quot;DevDouble&quot;</span><span class="p">,</span> <span class="s2">&quot;Read_Write&quot;</span> <span class="p">},</span> <span class="n">NULL</span> <span class="p">};</span>
</pre></div>
</div>
<p>The string describing the extra attribute data type may have the
following value (case independent):</p>
<ul class="simple">
<li><p>DevBoolean, DevLong, DevDouble or DevString (in Python, a preceding
“PyTango.” is allowed)</p></li>
</ul>
<p>The string describing the extra attribute R/W type may have the
following value (case independent)</p>
<ul class="simple">
<li><p>Read or Read_Write (in Python, a preceding “PyTango.” is allowed)</p></li>
</ul>
</div>
<div class="section" id="methods-to-create-remove-motor-from-controller">
<h5>Methods to create/remove motor from controller<a class="headerlink" href="#methods-to-create-remove-motor-from-controller" title="Permalink to this headline">¶</a></h5>
<p>Two methods are called when creating or removing motor from a
controller. These methods are called <strong>AddDevice</strong> and <strong>DeleteDevice</strong> . The AddDevice method is called when a new motor belonging to the
controller is created within the pool. The DeleteDevice method is
called when a motor belonging to the controller is removed from the
pool.</p>
</div>
<div class="section" id="methods-to-move-motor-s">
<h5>Methods to move motor(s)<a class="headerlink" href="#methods-to-move-motor-s" title="Permalink to this headline">¶</a></h5>
<p>Four methods are used when a request to move motor(s) is executed.
These methods are called <strong>PreStartAll</strong> , <strong>PreStartOne</strong> , <strong>StartOne</strong> and <strong>StartAll</strong> .
The algorithm used to move one or several motors is the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">motion</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">PreStartAll</span><span class="p">()</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">motor</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">motion</span>
     <span class="o">-</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">PreStartOne</span><span class="p">(</span><span class="n">motor</span> <span class="n">to</span> <span class="n">move</span><span class="p">,</span> <span class="n">new</span> <span class="n">position</span><span class="p">)</span>
     <span class="o">-</span> <span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">ret</span> <span class="ow">is</span> <span class="n">true</span>
          <span class="o">-</span> <span class="n">Call</span> <span class="n">StartOne</span><span class="p">(</span><span class="n">motor</span> <span class="n">to</span> <span class="n">move</span><span class="p">,</span> <span class="n">new</span> <span class="n">position</span><span class="p">)</span>
     <span class="o">-</span> <span class="o">/</span><span class="n">END</span> <span class="n">IF</span><span class="o">/</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">motion</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">StartAll</span><span class="p">()</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>
</pre></div>
</div>
<p>The following array summarizes the rule of each of these methods:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 13%" />
<col style="width: 20%" />
<col style="width: 21%" />
<col style="width: 25%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Default action</p></td>
<td><p>Does nothing</p></td>
<td><p>Return true</p></td>
<td><p>Does nothing</p></td>
<td><p>Does nothing</p></td>
</tr>
<tr class="row-odd"><td><p>Externally called by</p></td>
<td><p>Writing the Position attribute</p></td>
<td><p>Writing the Position attribute</p></td>
<td><p>Writing the Position attribute</p></td>
<td><p>Writing the Position attribute</p></td>
</tr>
<tr class="row-even"><td><p>Internally called</p></td>
<td><p>Once for each implied controller</p></td>
<td><p>For each implied motor</p></td>
<td><p>For each implied motor</p></td>
<td><p>Once for each implied controller</p></td>
</tr>
<tr class="row-odd"><td><p>Typical rule</p></td>
<td><p>Init internal data for motion</p></td>
<td><p>Check if motor motion is possible</p></td>
<td><p>Set new motor position in internal data</p></td>
<td><p>Send order to physical controller</p></td>
</tr>
</tbody>
</table>
<p>This algorithm covers the sophisticated case where a physical
controller is able to move several motors at the same time. For some
simpler controller, it is possible to implement only the StartOne()
method. The default implementation of the three remaining methods is
defined in a way that the algorithm works even in such a case.</p>
</div>
<div class="section" id="methods-to-read-motor-s-position">
<h5>Methods to read motor(s) position<a class="headerlink" href="#methods-to-read-motor-s-position" title="Permalink to this headline">¶</a></h5>
<p>Four methods are used when a request to read motor(s) position is
received. These methods are called PreReadAll, PreReadOne, ReadAll and
ReadOne. The algorithm used to read position of one or several motors
is the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">reading</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">PreReadAll</span><span class="p">()</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">motor</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">reading</span>
     <span class="o">-</span> <span class="n">PreReadOne</span><span class="p">(</span><span class="n">motor</span> <span class="n">to</span> <span class="n">read</span><span class="p">)</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">reading</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">ReadAll</span><span class="p">()</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">motor</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">reading</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">ReadOne</span><span class="p">(</span><span class="n">motor</span> <span class="n">to</span> <span class="n">read</span><span class="p">)</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>
</pre></div>
</div>
<p>The following array summarizes the rule of each of these methods:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 17%" />
<col style="width: 19%" />
<col style="width: 18%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Default action</p></td>
<td><p>Does nothing</p></td>
<td><p>Does nothing</p></td>
<td><p>Does nothing</p></td>
<td><p>Print message on the screen and returns NaN. Mandatory for Python</p></td>
</tr>
<tr class="row-odd"><td><p>Externally called by</p></td>
<td><p>Reading the Position attribute</p></td>
<td><p>Reading the Position attribute</p></td>
<td><p>Reading the Position attribute</p></td>
<td><p>Reading the Position attribute</p></td>
</tr>
<tr class="row-even"><td><p>Internally called</p></td>
<td><p>Once for each implied controller</p></td>
<td><p>For each implied motor</p></td>
<td><p>For each implied controller</p></td>
<td><p>Once for each implied motor</p></td>
</tr>
<tr class="row-odd"><td><p>Typical rule</p></td>
<td><p>Init internal data for reading</p></td>
<td><p>Memorize which motor has to be read</p></td>
<td><p>Send order to physical controller</p></td>
<td><p>Return motor position from internal data</p></td>
</tr>
</tbody>
</table>
<p>This algorithm covers the sophisticated case where a physical
controller is able to read several motors positions at the same time.
For some simpler controller, it is possible to implement only the
ReadOne() method. The default implementation of the three remaining
methods is defined in a way that the algorithm works even in such a
case.</p>
</div>
<div class="section" id="methods-to-get-motor-s-state">
<h5>Methods to get motor(s) state<a class="headerlink" href="#methods-to-get-motor-s-state" title="Permalink to this headline">¶</a></h5>
<p>XXX: Unknown inset LatexCommand label{par:Methods-to-get-state}:</p>
<p>Four methods are used when a request to get motor(s) state is
received. These methods are called PreStateAll, PreStateOne, StateAll
and StateOne. The algorithm used to get state of one or several motors
is the following :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">state</span> <span class="n">getting</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">PreStateAll</span><span class="p">()</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">motor</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">state</span> <span class="n">getting</span>
     <span class="o">-</span> <span class="n">PreStateOne</span><span class="p">(</span><span class="n">motor</span> <span class="n">to</span> <span class="n">get</span> <span class="n">state</span><span class="p">)</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">state</span> <span class="n">getting</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">StateAll</span><span class="p">()</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">motor</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">getting</span> <span class="n">state</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">StateOne</span><span class="p">(</span><span class="n">motor</span> <span class="n">to</span> <span class="n">get</span> <span class="n">state</span><span class="p">)</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>
</pre></div>
</div>
<p>The following array summarizes the rule of each of these methods:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 13%" />
<col style="width: 20%" />
<col style="width: 22%" />
<col style="width: 21%" />
<col style="width: 24%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Default action</p></td>
<td><p>Does nothing</p></td>
<td><p>Does nothing</p></td>
<td><p>Does nothing</p></td>
<td><p>Mandatory for Python</p></td>
</tr>
<tr class="row-odd"><td><p>Externally called by</p></td>
<td><p>Reading the motor state</p></td>
<td><p>Reading the motor state</p></td>
<td><p>Reading the motor state</p></td>
<td><p>Reading the motor state</p></td>
</tr>
<tr class="row-even"><td><p>Internally called</p></td>
<td><p>Once for each implied controller</p></td>
<td><p>For each implied motor</p></td>
<td><p>For each implied controller</p></td>
<td><p>Once for each implied motor</p></td>
</tr>
<tr class="row-odd"><td><p>Typical rule</p></td>
<td><p>Init internal data for reading</p></td>
<td><p>Memorize which motor has to be read</p></td>
<td><p>Send order to physical controller</p></td>
<td><p>Return motor state from internal data</p></td>
</tr>
</tbody>
</table>
<p>This algorithm covers the sophisticated case where a physical
controller is able to read several motors state at the same time. For
some simpler controller, it is possible to implement only the
StateOne() method. The default implementation of the three remaining
methods is defined in a way that the algorithm works even in such a
case.</p>
</div>
<div class="section" id="methods-to-configure-a-motor">
<h5>Methods to configure a motor<a class="headerlink" href="#methods-to-configure-a-motor" title="Permalink to this headline">¶</a></h5>
<p>The rule of these methods is to</p>
<ul class="simple">
<li><p>Get or Set motor parameter(s) with methods called GetPar() or SetPar()</p></li>
<li><p>Get or Set motor extra feature(s) parameter with methods called
GetExtraAttributePar() or SetExtraAttributePar()</p></li>
</ul>
<p>The following table summarizes the usage of these methods:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 3%" />
<col style="width: 30%" />
<col style="width: 35%" />
<col style="width: 16%" />
<col style="width: 17%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Called by</p></td>
<td><p>Reading the Velocity, Acceleration, Base_rate, Deceleration and eventually Backlash attributes</p></td>
<td><p>Writing the Velocity, Acceleration, Base_rate, Deceleration, Step_per_unit and eventually Backlash attribute</p></td>
<td><p>Reading any of the extra attributes</p></td>
<td><p>Writing any of the extra attributes</p></td>
</tr>
<tr class="row-odd"><td><p>Rule</p></td>
<td><p>Get parameter from physical controller</p></td>
<td><p>Set parameter in physical controller</p></td>
<td><p>Get extra attribute value from the physical layer</p></td>
<td><p>Set additional attribute value in physical controller</p></td>
</tr>
</tbody>
</table>
<p>Please, note that the default implementation of the GetPar() prints a
message on the screen and returns a NaN double value. The
GetExtraAttributePar() default implementation also prints a message on
the screen and returns a string set to “Pool_met_not_implemented”.</p>
</div>
<div class="section" id="the-remaining-methods">
<h5>The remaining methods<a class="headerlink" href="#the-remaining-methods" title="Permalink to this headline">¶</a></h5>
<p>The rule of the remaining methods are to</p>
<ul class="simple">
<li><p>Load a new motor position in a controller with a method called
DefinePosition()</p></li>
<li><p>Abort a running motion with a method called AbortOne()</p></li>
<li><p>Send a raw string to the controller with a method called SendToCtrl()</p></li>
</ul>
<p>The following table summarizes the usage of these methods:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 6%" />
<col style="width: 27%" />
<col style="width: 16%" />
<col style="width: 51%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Called by</p></td>
<td><p>The motor SetPosition command</p></td>
<td><p>The motor Abort command</p></td>
<td><p>The Pool SendToController command</p></td>
</tr>
<tr class="row-odd"><td><p>Rule</p></td>
<td><p>Load a new motor position in controller</p></td>
<td><p>Abort a running motion</p></td>
<td><p>Send the input string to the controller and returns the controller answer</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="controller-properties">
<h5>Controller properties<a class="headerlink" href="#controller-properties" title="Permalink to this headline">¶</a></h5>
<p>XXX: Unknown inset LatexCommand label{par:Controller-properties}:</p>
<p>Each controller may have a set of <strong>properties</strong> to configure itself. Properties are defined at the controller class
level but can be re-defined at the instance level. It is also possible
to define a property default value. These default values are stored
within the controller class code. If a default value is not adapted to
specific object instance, it is possible to define a new property
value which will be stored in the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> database. <a class="reference external" href="http://www.tango-controls.org/">Tango</a> database
allows storing data which are not <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device property. This storage
could be seen simply as a couple name/value. Naming convention for
this kind of storage could be defined as:</p>
<blockquote>
<div><p>controller_class-&gt;prop: value or
controller_class/instance-&gt;prop: value</p>
</div></blockquote>
<p>The calls necessary to retrieve/insert/update these values from/to the
database already exist in the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> core. The algorithm used to
retrieve a property value is the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">Property</span> <span class="n">value</span> <span class="o">=</span> <span class="n">Not</span> <span class="n">defined</span>

<span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">Property</span> <span class="n">has</span> <span class="n">a</span> <span class="n">default</span> <span class="n">value</span>
    <span class="o">-</span> <span class="n">Property</span> <span class="n">value</span> <span class="o">=</span> <span class="n">default</span> <span class="n">value</span>
<span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>

<span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">Property</span> <span class="n">has</span> <span class="n">a</span> <span class="n">value</span> <span class="n">defined</span> <span class="ow">in</span> <span class="n">db</span> <span class="n">at</span> <span class="k">class</span> <span class="nc">level</span>
    <span class="o">-</span> <span class="n">Property</span> <span class="n">value</span> <span class="o">=</span> <span class="k">class</span> <span class="nc">db</span> <span class="n">value</span>
<span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>

<span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">Property</span> <span class="n">has</span> <span class="n">a</span> <span class="n">value</span> <span class="n">defined</span> <span class="ow">in</span> <span class="n">db</span> <span class="n">at</span> <span class="n">instance</span> <span class="n">level</span>
    <span class="o">-</span> <span class="n">Property</span> <span class="n">value</span> <span class="o">=</span> <span class="n">instance</span> <span class="n">db</span> <span class="n">value</span>
<span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>

<span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">Property</span> <span class="n">still</span> <span class="ow">not</span> <span class="n">defined</span>
    <span class="o">-</span> <span class="n">Error</span>
<span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>
</pre></div>
</div>
<p>As an example, the following array summarizes the result of this
algorithm. The example is for an IcePap controller and the property is
the port number (called port_number):</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 32%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>default value</p></td>
<td><p>5000</p></td>
<td><p>5000</p></td>
<td><p>5000</p></td>
<td><p>5000</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>class in DB</p></td>
<td></td>
<td></td>
<td><p>5150</p></td>
<td><p>5150</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>inst. in DB</p></td>
<td></td>
<td><p>5200</p></td>
<td></td>
<td><p>5250</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>Property value</p></td>
<td><p>5000</p></td>
<td><p>5200</p></td>
<td><p>5150</p></td>
<td><p>5250</p></td>
<td><p>Error</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>Case 1: The IcePap controller class defines one property called
port_number and assigns it a default value of 5000</p></li>
<li><p>Case 2 : An IcePap controller is created with an instance name
“My_IcePap”. The property IcePap/My_IcePap-&gt;port_number has been set
to 5200 in db</p></li>
<li><p>Case 3: The hard coded value of 5000 for port number does not fulfill
the need. A property called IcePap-&gt;port_number set to 5150 is defined
in db.</p></li>
<li><p>Case 4: We have one instance of IcePap called “My_IcePap” for which we
have defined a property “IcePap/My_IcePap” set to 5250.</p></li>
<li><p>Case 5: The IcePap controller has not defined a default value for the
property.</p></li>
</ul>
<p>In order to provide the user with a friendly interface, all the
properties defined for a controller class have to have informations
hard-coded into the controller class code. We need at least three
informations and sometimes four for each property. They are:</p>
<ol class="arabic simple">
<li><p>The property name (Mandatory)</p></li>
<li><p>The property description (Mandatory)</p></li>
<li><p>The property data type (Mandatory)</p></li>
<li><p>The property default value (Optional)</p></li>
</ol>
<p>With these informations, a graphical user interface is able to build
at controller creation time a panel with the list of all the needed
properties, their descriptions and eventually their default value. The
user then have the possibility to re-define property value if the
default one is not valid for his usage. This is the rule of the
graphical panel to store the new value into the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> database. The
supported data type for controller property are:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Property data type</p></th>
<th class="head"><p>String to use in property definition</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Boolean</p></td>
<td><p>DevBoolean</p></td>
</tr>
<tr class="row-odd"><td><p>Long</p></td>
<td><p>DevLong</p></td>
</tr>
<tr class="row-even"><td><p>Double</p></td>
<td><p>DevDouble</p></td>
</tr>
<tr class="row-odd"><td><p>String</p></td>
<td><p>DevString</p></td>
</tr>
<tr class="row-even"><td><p>Boolean array</p></td>
<td><p>DevVarBooleanArray</p></td>
</tr>
<tr class="row-odd"><td><p>Long array</p></td>
<td><p>DevVarLongArray</p></td>
</tr>
<tr class="row-even"><td><p>Double array</p></td>
<td><p>DevVarDoubleArray</p></td>
</tr>
<tr class="row-odd"><td><p>String array</p></td>
<td><p>DevVarStringArray</p></td>
</tr>
</tbody>
</table>
<p>For Python classes (Python controller class), it is possible to define
these properties informations using a Python dictionary called <strong>class_prop</strong> . The property name is the dictionary element key. The dictionary
element value is another dictionary with two or three members which
are the property data type, the property description and an optional
default value. If the data type is an array, the default value has to
be defined in a Python list or tuple. For instance, for our IcePap
port number property, this dictionary will be</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">class_prop</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;port_number&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;Type&quot;</span> <span class="p">:</span> <span class="s2">&quot;DevLong&quot;</span><span class="p">,</span> <span class="s2">&quot;Description&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Port on which the IcePap software server is listening&quot;</span><span class="p">,</span> <span class="s2">&quot;DefaultValue&quot;</span> <span class="p">:</span> <span class="mi">5000</span> <span class="p">}</span> <span class="p">}</span>
</pre></div>
</div>
<p>For C++ controller class, the properties are defined within an array
of <strong>Controller::PropInfo</strong> structures. The name of this array has to be
&lt;Ctrl_class_name&gt;_class_prop. Each Controller::PropInfo structure has
four elements which are all pointers to classical C string (const char
*). These elements are:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>The property name</p></li>
<li><p>The property description</p></li>
<li><p>The property data type</p></li>
<li><p>The property default value (NULL if not used)</p></li>
</ol>
</div></blockquote>
<p>A NULL pointer defined the last property. The following is an example
of property definition for a controller class called “DummyController”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Controller</span><span class="p">::</span><span class="n">PropInfo</span> <span class="n">DummyController_class_prop</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{{</span><span class="s2">&quot;The prop&quot;</span><span class="p">,</span><span class="s2">&quot;The first CPP property&quot;</span><span class="p">,</span><span class="s2">&quot;DevLong&quot;</span><span class="p">,</span><span class="s2">&quot;12&quot;</span><span class="p">},</span>
 <span class="p">{</span><span class="s2">&quot;Another_Prop&quot;</span><span class="p">,</span><span class="s2">&quot;The second CPP property&quot;</span><span class="p">,</span><span class="s2">&quot;DevString&quot;</span><span class="p">,</span><span class="n">NULL</span><span class="p">},</span>
 <span class="p">{</span><span class="s2">&quot;Third_Prop&quot;</span><span class="p">,</span><span class="s2">&quot;The third CPP property&quot;</span><span class="p">,</span><span class="s2">&quot;DevVarLongArray&quot;</span><span class="p">,</span><span class="s2">&quot;11,22,33&quot;</span><span class="p">},</span>
 <span class="n">NULL</span><span class="p">};</span>
</pre></div>
</div>
<p>The value of these properties is passed to the controller at
controller instance creation time using a constructor parameter. In
Python, this parameter is a dictionnary and the base class of the
controller class will create one object attribute for each property.
In our Python example, the controller will have an attribute called
“port_number” with its value set to 5000. In C++, the controller
contructor receives a vector of <strong>Controller::Properties</strong> structure. Each Controller::Properties structure has two elements
which are:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>The property name as a C++ string</p></li>
<li><dl class="simple">
<dt>The property value in a <strong>PropData</strong> structure. This PropData structure has four elements which are</dt><dd><ol class="arabic simple">
<li><p>A C++ vector of C++ bool type</p></li>
<li><p>A C++ vector of C++ long type</p></li>
<li><p>A C++ vector of C++ double type</p></li>
<li><p>A C++ vector of C++ string.</p></li>
</ol>
</dd>
</dl>
</li>
</ol>
</div></blockquote>
<p>Only the vector corresponding to the property data type has a size
different than 0. If the property is an array, the vector has as many
elements as the property has.</p>
</div>
<div class="section" id="the-maxdevice-property">
<h5>The MaxDevice property<a class="headerlink" href="#the-maxdevice-property" title="Permalink to this headline">¶</a></h5>
<p>Each controller has to have a property defining the maximum number of
device it supports. This is a mandatory requirement. Therefore, in
Python this property is simply defined by setting the value of a
controller data member called <strong>MaxDevice</strong> which will be taken as the default value for the controller. In C++,
you have to define a global variable called
&lt;Ctrl_class_name&gt;_MaxDevice. The management of the number of devices created using a controller
(limited by this property) will be completely done by the pool
software. The information related to this property is automatically
added as first element in the information passed to the controller at
creation time. The following is an example of the definition of this
MaxDevice property in C++ for a controller class called
“DummyController”</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">long</span> <span class="n">DummyController_MaxDevice</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="c-controller">
<h5>C++ controller<a class="headerlink" href="#c-controller" title="Permalink to this headline">¶</a></h5>
<p>For C++, the controller code is implemented as a set of classes: A
base class called <strong>Controller</strong> and a class called <strong>MotorController</strong> which inherits from Controller. Finally, the user has to write its
controller class which inherits from MotorController.</p>
<p>XXX: Unknown layout Subparagraph: The Controller class
XXX: XXX: Unknown inset LatexCommand label{sub:The-Cpp-Controller-class}:
This class defined two pure virtual methods, seven virtual methods and
some data types. The methods defined in this class are:</p>
<ol class="arabic">
<li><p>void <strong>Controller::AddDevice</strong> (long axe_number)
Pure virtual</p></li>
<li><p>void <strong>Controller::DeleteDevice</strong> (long axe_number)
Pure virtual</p></li>
<li><p>void <strong>Controller::PreStateAll</strong> ()
The default implementation does nothing</p></li>
<li><p>void <strong>Controller::PreStateOne</strong> (long idx_number)
The default implementation does nothing. The parameter is the device
index in the controller</p></li>
<li><p>void <strong>Controller::StateAll</strong> ()
The default implementation does nothing</p></li>
<li><p>void <strong>Controller::StateOne</strong> (long idx_number,CtrlState *ptr)
Read a device state. The CtrlState data type is a structure with two
elements which are:</p>
<blockquote>
<div><ul class="simple">
<li><p>A long dedicated to return device state (format ??)</p></li>
<li><p>A string used in case the motor is in FAULT and the controller is able
to return a string describing the fault.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>string <strong>Controller::SendToCtrl</strong> (string in_string)
Send the input string to the controller without interpreting it and
returns the controller answer</p></li>
<li><p>Controller::CtrlData <strong>Controller::GetExtraAttributePar</strong> (long idx_number,string &amp;extra_attribute_name)
Get device extra attribute value. The name of the extra attribute is
passed as the second argument of the method. The default definition of
this method prints a message on the screen and returns a string set to
“Pool_meth_not_implemented”. The CtrlData data type is a structure
with the following elements</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>A data type enumeration called data_type describing which of the
following element is valid (BOOLEAN, LONG, DOUBLE or STRING)</p></li>
<li><p>A boolean data called bo_data for boolean transfer</p></li>
<li><p>A long data called lo_data for long transfer</p></li>
<li><p>A double data called db_data for double transfer</p></li>
<li><p>A C++ string data called str_data for string transfer</p></li>
</ol>
</div></blockquote>
</li>
<li><p>void <strong>Controller::SetExtraAttributePar</strong> (long idx_number, string &amp;extra_attribute_name, Controller::CtrlData
&amp;extra_attribute_value)
Set device extra attribute value.</p></li>
</ol>
<p>It also has one data member which is the controller instance name with
one method to return it</p>
<ol class="arabic simple">
<li><p>string &amp; <strong>Controller::get_name</strong> (): Returns the controller instance name</p></li>
</ol>
<p>XXX: Unknown layout Subparagraph: The MotorController class
This class defined twelve virtual methods with default implementation.
The virtual methods declared in this class are:</p>
<ol class="arabic">
<li><p>void <strong>MotorController::PreStartAll</strong> ()
The default implementation does nothing.</p></li>
<li><p>bool <strong>MotorController::PreStartOne</strong> (long axe_number, double wanted_position)
The default implementation returns True.</p></li>
<li><p>void <strong>MotorController::StartOne</strong> (long axe_number, double wanted_position)
The default implementation does nothing.</p></li>
<li><p>void <strong>MotorController::StartAll</strong> ()
Start the motion. The default implementation does nothing.</p></li>
<li><p>void <strong>MotorController::PreReadAll</strong> ()
The default implementation does nothing.</p></li>
<li><p>void <strong>MotorController::PreReadOne</strong> (long axe_number)
The default implementation does nothing.</p></li>
<li><p>void <strong>MotorController::ReadAll</strong> ()
The default implementation does nothing.</p></li>
<li><p>double <strong>MotorController::ReadOne</strong> (long axe_number)
Read a position. The default implementation does nothing.</p></li>
<li><p>void <strong>MotorController::AbortOne</strong> (long axe_number)
Abort a motion. The default implementation does nothing.</p></li>
<li><p>void <strong>MotorController::DefinePosition</strong> (long axe_number, double new_position)
Load a new position. The default implementation does nothing.</p></li>
<li><p>Controller::CtrlData <strong>MotorController::GetPar</strong> (long axe_number, string &amp;par_name)
Get motor parameter value. The CtrlData data type is a structure with
the following elements</p>
<ol class="arabic simple">
<li><p>A data type enumeration called data_type describing which of the
following element is valid (BOOLEAN, LONG, DOUBLE or STRING)</p></li>
<li><p>A boolean data called bo_data for boolean transfer</p></li>
<li><p>A long data called lo_data for long transfer</p></li>
<li><p>A double data called db_data for double transfer</p></li>
<li><p>A C++ string data called str_data for string transfer</p></li>
</ol>
<p>A motor controller has to handle four or five different possible
values for the “par_name” parameter which are:</p>
<ul class="simple">
<li><p>Acceleration</p></li>
<li><p>Deceleration</p></li>
<li><p>Velocity</p></li>
<li><p>Base_rate</p></li>
<li><p>Backlash which has to be handled only for controller which has the
backlash feature</p></li>
</ul>
<p>The default definition of this method prints a message on the screen
and returns a NaN double value.</p>
</li>
<li><p>void <strong>MotorController::SetPar</strong> (long axe_number, string &amp;par_name, Controller::CtrlData &amp;par_value)
Set motor parameter value. The default implementation does nothing. A
motor controller has to handle five or six different value for the
“par_name” parameter which are:</p>
<ul class="simple">
<li><p>Acceleration</p></li>
<li><p>Deceleration</p></li>
<li><p>Velocity</p></li>
<li><p>Base_rate</p></li>
<li><p>Step_per_unit</p></li>
<li><p>Backlash which has to be handled only for controller which has the
backlash feature</p></li>
</ul>
<p>The description of the CtrlData type is given in the documentation of
the GetPar() method. The default definition of this method does
nothing</p>
</li>
</ol>
<p>This class has only one constructor which is</p>
<ol class="arabic simple">
<li><p><strong>MotorController::MotorController</strong> (const char *)
Constructor of the MotorController class with the controller name as
instance name</p></li>
</ol>
<p>Please, note that this class defines a structure called MotorState
which inherits from the Controller::CtrlState and which has a data
member:</p>
<ol class="arabic simple">
<li><p>A long describing the motor limit switches state (bit 0 for the Home
switch, bit 1 for Upper Limit switch and bit 2 for the Lower Limit
switch)</p></li>
</ol>
<p>This structure is used in the StateOne() method.</p>
<p>XXX: Unknown layout Subparagraph: The user controller class
XXX: XXX: Unknown inset LatexCommand label{par:The-user-controller}:
The user has to implement the remaining pure virtual methods
(AddDevice and DeleteDevice) and has to re-define virtual methods if
the default implementation does not cover his needs. The controller
code has to define two global variables which are:</p>
<ol class="arabic simple">
<li><p><strong>Motor_Ctrl_class_name</strong> (for Motor controller). This is an array of classical C strings
terminated by a NULL pointer. Each array element is the name of a
Motor controller class defined in this file.</p></li>
<li><p><strong>&lt;CtrlClassName&gt;_MaxDevice</strong> . This variable is a long defining the maximum number of device that
the controller hardware can support.</p></li>
</ol>
<p>On top of that, a controller code has to define a C function (defined
as “extern C”) which is called by the pool to create instance(s) of
the controller class. This function has the following definition:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Controller</span> <span class="o">*</span> <span class="o">**</span><span class="n">_create_</span><span class="o">&lt;</span><span class="n">Controller</span> <span class="k">class</span> <span class="nc">name</span><span class="o">&gt;**</span> <span class="p">(</span><span class="n">const</span> <span class="n">char</span> \<span class="o">*</span><span class="n">ctrl_instance_name</span><span class="p">,</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Controller</span><span class="p">::</span><span class="n">Properties</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">props</span><span class="p">)</span>
</pre></div>
</div>
<p>For instance, for a controller class called DummyController, the name
of this function has to be: _create_DummyController(). The parameters
passed to this function are:</p>
<ol class="arabic simple">
<li><p>The forth parameter given to the pool during the CreateController
command (the instance name).</p></li>
<li><p>A reference to a C++ vector with controller properties as defined in
XXX: Unknown inset LatexCommand ref{par:Controller-properties}:</p></li>
</ol>
<p>The rule of this C function is to create one instance of the user
controller class passing it the arguments it has received. The
following is an example of these definitions</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span>
<span class="o">//</span> <span class="n">Methods</span> <span class="n">of</span> <span class="n">the</span> <span class="n">DummyController</span> <span class="n">controller</span>
<span class="o">//</span>
<span class="o">....</span>

<span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">Motor_Ctrl_class_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;DummyController&quot;</span><span class="p">,</span><span class="n">NULL</span><span class="p">};</span>

<span class="n">long</span> <span class="n">DummyController_MaxDevice</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

<span class="n">extern</span> <span class="s2">&quot;C&quot;</span> <span class="p">{</span>
<span class="n">Controller</span> <span class="o">*</span><span class="n">_create_DummyController</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">inst</span><span class="p">,</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Controller</span><span class="p">::</span><span class="n">Properties</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">prop</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">new</span> <span class="n">DummyController</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span><span class="n">prop</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>On top of these mandatory definitions, you can define a controller
documentation string, controller properties, controller features and
controller extra features. The documentation string is the first
element of the array returned by the Pool device GetControllerInfo
command as detailed in
XXX: Unknown inset LatexCommand ref{ite:GetControllerInfo:}:
. It has to be defined as a classical C string (const char *) with a
name like &lt;Ctrl_class_name&gt;_doc. The following is an example of a
controller C++ code defining all these elements.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span>
<span class="o">//</span> <span class="n">Methods</span> <span class="n">of</span> <span class="n">the</span> <span class="n">DummyController</span> <span class="n">controller</span>
<span class="o">//</span>
<span class="o">....</span>

<span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">Motor_Ctrl_class_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;DummyController&quot;</span><span class="p">,</span><span class="n">NULL</span><span class="p">};</span>
<span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">DummyController_doc</span> <span class="o">=</span> <span class="s2">&quot;This is the C++ controller for the DummyController class&quot;</span><span class="p">;</span>

<span class="n">long</span> <span class="n">DummyController_MaxDevice</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

<span class="n">char</span> <span class="o">*</span><span class="n">DummyController_ctrl_extra_features_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{{</span><span class="s2">&quot;Extra_1&quot;</span><span class="p">,</span><span class="s2">&quot;DevLong&quot;</span><span class="p">,</span><span class="s2">&quot;Read_Write&quot;</span><span class="p">},</span>
                                                    <span class="p">{</span><span class="s2">&quot;Super_2&quot;</span><span class="p">,</span><span class="s2">&quot;DevString&quot;</span><span class="p">,</span><span class="s2">&quot;Read&quot;</span><span class="p">},</span>
                                                    <span class="n">NULL</span><span class="p">};</span>
<span class="n">char</span> <span class="o">*</span><span class="n">DummyController_ctrl_features</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;WantRounding&quot;</span><span class="p">,</span><span class="s2">&quot;CanDoBacklash&quot;</span><span class="p">,</span><span class="n">NULL</span><span class="p">};</span>

<span class="n">Controller</span><span class="p">::</span><span class="n">PropInfo</span> <span class="n">DummyController_class_prop</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{{</span><span class="s2">&quot;The prop&quot;</span><span class="p">,</span><span class="s2">&quot;The first CPP property&quot;</span><span class="p">,</span><span class="s2">&quot;DevLong&quot;</span><span class="p">,</span><span class="s2">&quot;12&quot;</span><span class="p">},</span>
 <span class="p">{</span><span class="s2">&quot;Another_Prop&quot;</span><span class="p">,</span><span class="s2">&quot;The second CPP property&quot;</span><span class="p">,</span><span class="s2">&quot;DevString&quot;</span><span class="p">,</span><span class="n">NULL</span><span class="p">},</span>
 <span class="p">{</span><span class="s2">&quot;Third_Prop&quot;</span><span class="p">,</span><span class="s2">&quot;The third CPP property&quot;</span><span class="p">,</span><span class="s2">&quot;DevVarLongArray&quot;</span><span class="p">,</span><span class="s2">&quot;11,22,33&quot;</span><span class="p">},</span>
 <span class="n">NULL</span><span class="p">};</span>

<span class="n">extern</span> <span class="s2">&quot;C&quot;</span> <span class="p">{</span>
<span class="n">Controller</span> <span class="o">*</span><span class="n">_create_DummyController</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">inst</span><span class="p">,</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Controller</span><span class="p">::</span><span class="n">Properties</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">prop</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">new</span> <span class="n">DummyController</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span><span class="n">prop</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="python-controller">
<h5>Python controller<a class="headerlink" href="#python-controller" title="Permalink to this headline">¶</a></h5>
<p>The principle is exactly the same than the one used for C++ controller
but we don’t have pure virtual methods with a compiler checking if
they are defined at compile time. Therefore, it is the pool software
which checks that the following methods are defined within the
controller class when the controller module is loaded (imported):</p>
<ul class="simple">
<li><p>AddDevice</p></li>
<li><p>DeleteDevice</p></li>
<li><p>StartOne or StartAll method</p></li>
<li><p>ReadOne method</p></li>
<li><p>StateOne method</p></li>
</ul>
<p>With Python controller, there is no need for function to create
controller class instance. With the help of the Python C API, the pool
device is able to create the needed instances. Note that the
StateOne() method does not have the same signature for Python
controller.</p>
<ol class="arabic">
<li><p>tuple <strong>Stat</strong> e <strong>One</strong> (self,axe_number)
Get a motor state. The method has to return a tuple with two or three
elements which are:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>The motor state (as defined by Tango)</p></li>
<li><p>The limit switch state (integer with bit 0 for Home switch, bit 1 for
Upper switch and bit 2 for Lower switch)</p></li>
<li><p>A string describing the motor fault if the controller has this
feature.</p></li>
</ol>
</div></blockquote>
</li>
</ol>
<p>A Python controller class has to inherit from a class called <strong>MotorController</strong> . This does not add any feature but allow the pool software to realize
that this class is a motor controller.</p>
</div>
<div class="section" id="python-controller-examples">
<h5>Python controller examples<a class="headerlink" href="#python-controller-examples" title="Permalink to this headline">¶</a></h5>
<p>XXX: Unknown layout Subparagraph: A minimum controller code
The following is an example of the minimum code structure needed to
write a Python controller :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="kn">import</span> <span class="nn">socket</span>
<span class="mi">2</span> <span class="kn">import</span> <span class="nn">PyTango</span>
<span class="mi">3</span> <span class="kn">import</span> <span class="nn">MotorController</span>
<span class="mi">4</span>
<span class="mi">5</span> <span class="k">class</span> <span class="nc">MinController</span><span class="p">(</span><span class="n">MotorController</span><span class="o">.</span><span class="n">MotorController</span><span class="p">):</span>
<span class="mi">6</span>
<span class="mi">7</span> <span class="c1">#</span>
<span class="mi">8</span> <span class="c1"># Some controller definitions</span>
<span class="mi">9</span> <span class="c1">#</span>
<span class="mi">10</span>
<span class="mi">11</span>    <span class="n">MaxDevice</span> <span class="o">=</span> <span class="mi">1</span>
<span class="mi">12</span>
<span class="mi">13</span> <span class="c1">#</span>
<span class="mi">14</span> <span class="c1"># Controller methods</span>
<span class="mi">15</span> <span class="c1">#</span>
<span class="mi">16</span>
<span class="mi">17</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inst</span><span class="p">,</span><span class="n">props</span><span class="p">):</span>
<span class="mi">18</span>       <span class="n">MotorController</span><span class="o">.</span><span class="n">MotorController</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inst</span><span class="p">,</span><span class="n">props</span><span class="p">)</span>
<span class="mi">19</span>       <span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span> <span class="o">=</span> <span class="n">inst</span>
<span class="mi">20</span>       <span class="bp">self</span><span class="o">.</span><span class="n">socket_connected</span> <span class="o">=</span> <span class="kc">False</span>
<span class="mi">21</span>       <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;the_host&quot;</span>
<span class="mi">22</span>       <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="mi">1111</span>
<span class="mi">23</span>
<span class="mi">24</span> <span class="c1">#</span>
<span class="mi">25</span> <span class="c1"># Connect to the icepap</span>
<span class="mi">26</span> <span class="c1">#</span>
<span class="mi">27</span>
<span class="mi">28</span>       <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="mi">29</span>       <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
<span class="mi">30</span>       <span class="bp">self</span><span class="o">.</span><span class="n">socket_connected</span> <span class="o">=</span> <span class="kc">True</span>
<span class="mi">31</span>
<span class="mi">32</span>       <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; Connected to&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="s2">&quot; on port&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span>
<span class="mi">33</span>
<span class="mi">34</span>
<span class="mi">35</span>    <span class="k">def</span> <span class="nf">AddDevice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axis</span><span class="p">):</span>
<span class="mi">36</span>       <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; MinController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: In AddDevice method for axis&quot;</span><span class="p">,</span><span class="n">axis</span>
<span class="mi">37</span>
<span class="mi">38</span>    <span class="k">def</span> <span class="nf">DeleteDevice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axis</span><span class="p">):</span>
<span class="mi">39</span>       <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; MinController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: In DeleteDevice method for axis&quot;</span><span class="p">,</span><span class="n">axis</span>
<span class="mi">40</span>
<span class="mi">41</span>    <span class="k">def</span> <span class="nf">StateOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axis</span><span class="p">):</span>
<span class="mi">42</span>       <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; MinController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: In StateOne method for axis&quot;</span><span class="p">,</span><span class="n">axis</span>
<span class="mi">43</span>       <span class="n">tup</span> <span class="o">=</span> <span class="p">(</span><span class="n">PyTango</span><span class="o">.</span><span class="n">DevState</span><span class="o">.</span><span class="n">ON</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="mi">44</span>       <span class="k">return</span> <span class="n">tup</span>
<span class="mi">45</span>
<span class="mi">46</span>    <span class="k">def</span> <span class="nf">ReadOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axis</span><span class="p">):</span>
<span class="mi">47</span>       <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; MinController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: In ReadOne method for axis&quot;</span><span class="p">,</span><span class="n">axis</span>
<span class="mi">48</span>       <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;Read motor position&quot;</span><span class="p">)</span>
<span class="mi">49</span>       <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="mi">50</span>       <span class="k">return</span> <span class="n">pos</span>
<span class="mi">51</span>
<span class="mi">52</span>    <span class="k">def</span> <span class="nf">StartOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axis</span><span class="p">,</span><span class="n">pos</span><span class="p">):</span>
<span class="mi">53</span>       <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; MinController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: In StartOne method for axis&quot;</span><span class="p">,</span><span class="n">axis</span><span class="p">,</span><span class="s2">&quot; with pos&quot;</span><span class="p">,</span><span class="n">pos</span>
<span class="mi">54</span>       <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;Send motor to position pos&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Line 11: Definition of the mandatory MaxDevice property set to 1 in
this minimum code
Line 17-32: The IcePapController constructor code
Line 35-36: The AddDevice method
Line 38-39: The DeleteDevice method
Line 41-44: The StateOne method
Line 46-50: The ReadOne method reading motor position from the
hardware controller
Line 52-54: The StartOne method writing motor position at position pos</p>
<p>XXX: Unknown layout Subparagraph: A full features controller code
The following is an example of the code structure needed to write a
full features Python controller :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="kn">import</span> <span class="nn">socket</span>
<span class="mi">2</span> <span class="kn">import</span> <span class="nn">PyTango</span>
<span class="mi">3</span> <span class="kn">import</span> <span class="nn">MotorController</span>
<span class="mi">4</span>
<span class="mi">5</span> <span class="k">class</span> <span class="nc">IcePapController</span><span class="p">(</span><span class="n">MotorController</span><span class="o">.</span><span class="n">MotorController</span><span class="p">)</span>
<span class="mi">6</span>     <span class="s2">&quot;This is an example of a Python motor controller class&quot;</span>
<span class="mi">7</span> <span class="c1">#</span>
<span class="mi">8</span> <span class="c1"># Some controller definitions</span>
<span class="mi">9</span> <span class="c1">#</span>
<span class="mi">10</span>
<span class="mi">11</span>    <span class="n">MaxDevice</span> <span class="o">=</span> <span class="mi">128</span>
<span class="mi">12</span>    <span class="n">ctrl_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CanDoBacklash&#39;</span><span class="p">]</span>
<span class="mi">13</span>    <span class="n">ctrl_extra_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IceAttribute&#39;</span><span class="p">:{</span><span class="s1">&#39;Type&#39;</span><span class="p">:</span><span class="s1">&#39;DevLong&#39;</span><span class="p">,</span><span class="s1">&#39;R/W Type&#39;</span><span class="p">:</span><span class="s1">&#39;READ_WRITE&#39;</span><span class="p">}}</span>
<span class="mi">14</span>    <span class="n">class_prop</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:{</span><span class="s1">&#39;Type&#39;</span><span class="p">:</span><span class="s1">&#39;DevString&#39;</span><span class="p">,</span><span class="s1">&#39;Description&#39;</span><span class="p">:</span><span class="s2">&quot;The IcePap controller</span>
<span class="mi">15</span>                          <span class="n">host</span> <span class="n">name</span><span class="s2">&quot;,&#39;DefaultValue&#39;:&quot;</span><span class="n">IcePapHost</span><span class="s2">&quot;},</span>
<span class="mi">16</span>                 <span class="s1">&#39;port&#39;</span><span class="p">:{</span><span class="s1">&#39;Type&#39;</span><span class="p">:</span><span class="s1">&#39;DevLong&#39;</span><span class="p">,</span><span class="s1">&#39;Description&#39;</span><span class="p">:</span><span class="s2">&quot;The port on which the</span>
<span class="mi">17</span>                          <span class="n">IcePap</span> <span class="n">software</span> <span class="ow">is</span> <span class="n">listenning</span><span class="s2">&quot;,&#39;DefaultValue&#39;:5000}}</span>
<span class="mi">18</span>
<span class="mi">19</span> <span class="c1">#</span>
<span class="mi">20</span> <span class="c1"># Controller methods</span>
<span class="mi">21</span> <span class="c1">#</span>
<span class="mi">22</span>
<span class="mi">23</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inst</span><span class="p">,</span><span class="n">props</span><span class="p">):</span>
<span class="mi">24</span>       <span class="n">MotorController</span><span class="o">.</span><span class="n">MotorController</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inst</span><span class="p">,</span><span class="n">props</span><span class="p">)</span>
<span class="mi">25</span>       <span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span> <span class="o">=</span> <span class="n">inst</span>
<span class="mi">26</span>       <span class="bp">self</span><span class="o">.</span><span class="n">socket_connected</span> <span class="o">=</span> <span class="kc">False</span>
<span class="mi">27</span>
<span class="mi">28</span> <span class="c1">#</span>
<span class="mi">29</span> <span class="c1"># Connect to the icepap</span>
<span class="mi">30</span> <span class="c1">#</span>
<span class="mi">31</span>
<span class="mi">32</span>       <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="mi">33</span>       <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
<span class="mi">34</span>       <span class="bp">self</span><span class="o">.</span><span class="n">socket_connected</span> <span class="o">=</span> <span class="kc">True</span>
<span class="mi">35</span>
<span class="mi">36</span>       <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; Connected to&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="s2">&quot; on port&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span>
<span class="mi">37</span>
<span class="mi">38</span>
<span class="mi">39</span>    <span class="k">def</span> <span class="nf">AddDevice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axis</span><span class="p">):</span>
<span class="mi">40</span>       <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; IcePapController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: In AddDevice method for axis&quot;</span><span class="p">,</span><span class="n">axis</span>
<span class="mi">41</span>
<span class="mi">42</span>    <span class="k">def</span> <span class="nf">DeleteDevice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axis</span><span class="p">):</span>
<span class="mi">43</span>       <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; IcePapController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: In DeleteDevice method for axis&quot;</span><span class="p">,</span><span class="n">axis</span>
<span class="mi">44</span>
<span class="mi">45</span>    <span class="k">def</span> <span class="nf">PreReadAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="mi">46</span>       <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; IcePapController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: In PreReadAll method&quot;</span>
<span class="mi">47</span>       <span class="bp">self</span><span class="o">.</span><span class="n">read_pos</span> <span class="o">=</span> <span class="p">[]</span>
<span class="mi">48</span>       <span class="bp">self</span><span class="o">.</span><span class="n">motor_to_read</span> <span class="o">=</span> <span class="p">[]</span>
<span class="mi">49</span>
<span class="mi">50</span>    <span class="k">def</span> <span class="nf">PreReadOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axis</span><span class="p">):</span>
<span class="mi">51</span>       <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; IcePapController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: In PreReadOne method for axis&quot;</span><span class="p">,</span><span class="n">axis</span>
<span class="mi">52</span>       <span class="bp">self</span><span class="o">.</span><span class="n">motor_to_read</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
<span class="mi">53</span>
<span class="mi">54</span>    <span class="k">def</span> <span class="nf">ReadAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="mi">55</span>       <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; IcePapController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: In ReadAll method&quot;</span>
<span class="mi">56</span>       <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;Read motors in the motor_to_read list&quot;</span><span class="p">)</span>
<span class="mi">57</span>       <span class="bp">self</span><span class="o">.</span><span class="n">read_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="mi">58</span>
<span class="mi">59</span>    <span class="k">def</span> <span class="nf">ReadOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axis</span><span class="p">):</span>
<span class="mi">60</span>       <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; IcePapController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: In ReadOne method for axis&quot;</span><span class="p">,</span><span class="n">axis</span>
<span class="mi">61</span>       <span class="k">return</span> <span class="n">read_pos</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
<span class="mi">62</span>
<span class="mi">63</span>    <span class="k">def</span> <span class="nf">PreStartAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="mi">64</span>       <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; IcePapController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: In PreStartAll method&quot;</span>
<span class="mi">65</span>       <span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span> <span class="o">=</span> <span class="p">[]</span>
<span class="mi">66</span>       <span class="bp">self</span><span class="o">.</span><span class="n">motor_to_write</span> <span class="o">=</span> <span class="p">[]</span>
<span class="mi">67</span>
<span class="mi">68</span>    <span class="k">def</span> <span class="nf">PreStartOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axis</span><span class="p">,</span><span class="n">pos</span><span class="p">):</span>
<span class="mi">69</span>       <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; IcePapController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: In PreStartOne method for axis&quot;</span><span class="p">,</span><span class="n">axis</span><span class="p">,</span><span class="s2">&quot; with pos&quot;</span><span class="p">,</span><span class="n">pos</span>
<span class="mi">70</span>       <span class="k">return</span> <span class="kc">True</span>
<span class="mi">71</span>
<span class="mi">72</span>    <span class="k">def</span> <span class="nf">StartOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axis</span><span class="p">,</span><span class="n">pos</span><span class="p">):</span>
<span class="mi">73</span>       <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; IcePapController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: In StartOne method for axis&quot;</span><span class="p">,</span><span class="n">axis</span><span class="p">,</span><span class="s2">&quot; with pos&quot;</span><span class="p">,</span><span class="n">pos</span>
<span class="mi">74</span>       <span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
<span class="mi">75</span>       <span class="bp">self</span><span class="o">.</span><span class="n">motor_to_write</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
<span class="mi">76</span>
<span class="mi">77</span>    <span class="k">def</span> <span class="nf">StartAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="mi">78</span>       <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; IcePapController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: In StartAll method&quot;</span>
<span class="mi">79</span>       <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;Write motors in the motor_to_write list at position in the write_pos list&quot;</span>
<span class="mi">80</span>
<span class="mi">81</span>    <span class="k">def</span> <span class="nf">PreStateAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="mi">82</span>       <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; IcePapController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: In PreStateAll method&quot;</span>
<span class="mi">83</span>       <span class="bp">self</span><span class="o">.</span><span class="n">read_state</span> <span class="o">=</span> <span class="p">[]</span>
<span class="mi">84</span>       <span class="bp">self</span><span class="o">.</span><span class="n">motor_to_get_state</span> <span class="o">=</span> <span class="p">[]</span>
<span class="mi">85</span>
<span class="mi">86</span>    <span class="k">def</span> <span class="nf">PreStateOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axis</span><span class="p">):</span>
<span class="mi">87</span>       <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; IcePapController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: In PreStateOne method for axis&quot;</span><span class="p">,</span><span class="n">axis</span>
<span class="mi">88</span>       <span class="bp">self</span><span class="o">.</span><span class="n">motor_to_get_state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
<span class="mi">89</span>
<span class="mi">90</span>    <span class="k">def</span> <span class="nf">StateAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="mi">91</span>       <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; IcePapController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: In StateAll method&quot;</span>
<span class="mi">92</span>       <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;Read motors state for motor(s) in the motor_to_get_state list&quot;</span><span class="p">)</span>
<span class="mi">93</span>       <span class="bp">self</span><span class="o">.</span><span class="n">read_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="mi">94</span>
<span class="mi">95</span>    <span class="k">def</span> <span class="nf">StateOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axis</span><span class="p">):</span>
<span class="mi">96</span>       <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; IcePapController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: In StateOne method for axis&quot;</span><span class="p">,</span><span class="n">axis</span>
<span class="mi">97</span>       <span class="n">one_state</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_state</span><span class="p">[</span><span class="n">axis</span><span class="p">]]</span>
<span class="mi">98</span>       <span class="k">return</span> <span class="n">one_state</span>
<span class="mi">99</span>
<span class="mi">100</span>   <span class="k">def</span> <span class="nf">SetPar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axis</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
<span class="mi">101</span>      <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Acceleration&#39;</span>
<span class="mi">102</span>         <span class="nb">print</span> <span class="s2">&quot;Setting acceleration to&quot;</span><span class="p">,</span><span class="n">value</span>
<span class="mi">103</span>      <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Deceleration&#39;</span>
<span class="mi">104</span>         <span class="nb">print</span> <span class="s2">&quot;Setting deceleartion to&quot;</span><span class="p">,</span><span class="n">value</span>
<span class="mi">105</span>      <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Velocity&#39;</span>
<span class="mi">106</span>         <span class="nb">print</span> <span class="s2">&quot;Setting velocity to&quot;</span><span class="p">,</span><span class="n">value</span>
<span class="mi">107</span>      <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Base_rate&#39;</span>
<span class="mi">108</span>         <span class="nb">print</span> <span class="s2">&quot;Setting base_rate to&quot;</span><span class="p">,</span><span class="n">value</span>
<span class="mi">109</span>      <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Step_per_unit&#39;</span>
<span class="mi">110</span>         <span class="nb">print</span> <span class="s2">&quot;Setting step_per_unit to&quot;</span><span class="p">,</span><span class="n">value</span>
<span class="mi">111</span>      <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Backlash&#39;</span>
<span class="mi">112</span>         <span class="nb">print</span> <span class="s2">&quot;Setting backlash to&quot;</span><span class="p">,</span><span class="n">value</span>
<span class="mi">113</span>
<span class="mi">114</span>    <span class="k">def</span> <span class="nf">GetPar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axis</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
<span class="mi">115</span>      <span class="n">ret_val</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="mi">116</span>      <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Acceleration&#39;</span>
<span class="mi">117</span>         <span class="nb">print</span> <span class="s2">&quot;Getting acceleration&quot;</span>
<span class="mi">118</span>         <span class="n">ret_val</span> <span class="o">=</span> <span class="mf">12.34</span>
<span class="mi">119</span>       <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Deceleration&#39;</span>
<span class="mi">120</span>         <span class="nb">print</span> <span class="s2">&quot;Getting deceleration&quot;</span>
<span class="mi">121</span>         <span class="n">ret_val</span> <span class="o">=</span> <span class="mf">13.34</span>
<span class="mi">122</span>       <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Velocity&#39;</span>
<span class="mi">123</span>         <span class="nb">print</span> <span class="s2">&quot;Getting velocity&quot;</span>
<span class="mi">124</span>         <span class="n">ret_val</span> <span class="o">=</span> <span class="mf">14.34</span>
<span class="mi">125</span>       <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Base_rate&#39;</span>
<span class="mi">126</span>         <span class="nb">print</span> <span class="s2">&quot;Getting base_rate&quot;</span>
<span class="mi">127</span>         <span class="n">ret_val</span> <span class="o">=</span> <span class="mf">15.34</span>
<span class="mi">128</span>       <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Backlash&#39;</span>
<span class="mi">129</span>         <span class="nb">print</span> <span class="s2">&quot;Getting backlash&quot;</span>
<span class="mi">130</span>         <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">123</span>
<span class="mi">131</span>      <span class="k">return</span> <span class="n">ret_val</span>
<span class="mi">132</span>
<span class="mi">133</span>   <span class="k">def</span> <span class="nf">SetExtraAttributePar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axis</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
<span class="mi">134</span>      <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;IceAttribute&#39;</span>
<span class="mi">135</span>         <span class="nb">print</span> <span class="s2">&quot;Setting IceAttribute to&quot;</span><span class="p">,</span><span class="n">value</span>
<span class="mi">136</span>
<span class="mi">137</span>   <span class="k">def</span> <span class="nf">GetExtraAttributePar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axis</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
<span class="mi">138</span>      <span class="n">ret_val</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="mi">139</span>      <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;IceAttribute&#39;</span>
<span class="mi">140</span>         <span class="nb">print</span> <span class="s2">&quot;Getting IceAttribute&quot;</span>
<span class="mi">141</span>         <span class="n">ret_val</span> <span class="o">=</span> <span class="mf">12.34</span>
<span class="mi">142</span>      <span class="k">return</span> <span class="n">ret_val</span>
<span class="mi">143</span>
<span class="mi">144</span>   <span class="k">def</span> <span class="nf">AbortOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axis</span><span class="p">):</span>
<span class="mi">145</span>      <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; IcePapController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: Aborting motion for axis:&quot;</span><span class="p">,</span><span class="n">axis</span>
<span class="mi">146</span>
<span class="mi">147</span>   <span class="k">def</span> <span class="nf">DefinePosition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axis</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
<span class="mi">148</span>      <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; IcePapController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: Defining position for axis:&quot;</span><span class="p">,</span><span class="n">axis</span>
<span class="mi">149</span>
<span class="mi">150</span>   <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="mi">151</span>      <span class="nb">print</span> <span class="s2">&quot;PYTHON -&gt; IcePapController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: Aarrrrrg, I am dying&quot;</span>
<span class="mi">152</span>
<span class="mi">153</span>   <span class="k">def</span> <span class="nf">SendToCtrl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">in_str</span><span class="p">)</span>
<span class="mi">154</span>      <span class="nb">print</span> <span class="s2">&quot;Python -&gt; MinController/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inst_name</span><span class="p">,</span><span class="s2">&quot;: In SendToCtrl method&quot;</span>
<span class="mi">155</span>      <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;The input string&quot;</span><span class="p">)</span>
<span class="mi">156</span>      <span class="n">out_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="mi">157</span>      <span class="k">return</span> <span class="n">out_str</span>
</pre></div>
</div>
<p>Line 6 : Definition of the Python DocString which will also be used
for the first returned value of the Pool device GetControllerInfo
command. See chapter
XXX: Unknown inset LatexCommand ref{ite:GetControllerInfo:}:
to get all details about this command.
Line 11: Definition of the mandatory MaxDevice property set to 128
Line 12: Definition of the pre-defined feature supported by this
controller. In this example, only the backlash
Line 13: Definition of one controller extra feature called IceFeature
Line 14-17: Definition of 2 properties called host and port
Line 23-36: The IcePapController constructor code. Note that the
object attribute host and port automatically created by the property
management are used on line 32
Line 39-40: The AddDevice method
Line 42-43: The DeleteDevice method
Line 45-48: The PreReadAll method which clears the 2 list read_pos and
motor_to_read
Line 50-52: The PreReadOne method. It stores which method has to be
read in the motor_to_read list
Line 54-57: The ReadAll method. It send the request to read motor
positions to the controller and stores the result in the internal
read_pos list
Line 59-61: The ReadOne method returning motor position from the
internal read_pos list
Line 63-66: The PreStartAll method which clears 2 internal list called
write_pos and motor_to_write
Line 68-70: The PreStartOne method
Line 72-75: The StartOne method which appends in the write_pos and
motor_to_write list the new motor position and the motor number which
has to be moved
Line 77-79: The StartAll method sending the request to the controller
Line 81-84: The PreStateAll method which clears 2 internal list called
read_state and motor_to_get_state
Line 86-88: The PreStateOne method
Line 90-93: The StateAll method sending the request to the controller
Line 95-98: The StateOne method returning motor state from the
internal read_state list
Line 100-112: The SetPar method managing the acceleration,
deceleration, velocity, base_rate and backlash attributes (because
defined in line 11)
Line 114-131: The GetPar method managing the same 5 parameters plus
the step_per_unit
Line 133-135: The SetExtraAttributePar method for the controller extra
feature defined at line 12
Line 137-142: The GetExtraAttributePar method for controller extra
feature
Line 144-145: The AbortOne method
Line 147-148: The DefinePosition method
Line 153-157: The SendToCtrl method</p>
</div>
<div class="section" id="defining-available-controller-features">
<h5>Defining available controller features<a class="headerlink" href="#defining-available-controller-features" title="Permalink to this headline">¶</a></h5>
<p>Four data types and two read_write modes are available for the
attribute associated with controller features. The possible data type
are:</p>
<ul class="simple">
<li><p>BOOLEAN</p></li>
<li><p>LONG</p></li>
<li><p>DOUBLE</p></li>
<li><p>STRING</p></li>
</ul>
<p>The read_write modes are:</p>
<ul class="simple">
<li><p>READ</p></li>
<li><p>READ_WRITE</p></li>
</ul>
<p>All the attributes created to deal with controller features and
defined as READ_WRITE will be memorized attributes. This means that
the attribute will be written with the memorized value just after the
device creation by the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> layer. The definition of a controller
features means defining three elements which are the feature name, the
feature data type and the feature read_write mode. It uses a C++
structure called MotorFeature with three elements which are a C string
(const char *) for the feature name and two enumeration for the
feature data type and feature read_write mode. All the available
features are defined as an array of these structures in a file called <strong>MotorFeatures.h</strong></p>
</div>
<div class="section" id="controller-access-when-creating-a-motor">
<h5>Controller access when creating a motor<a class="headerlink" href="#controller-access-when-creating-a-motor" title="Permalink to this headline">¶</a></h5>
<p>When you create a motor (a new one or at Pool startup time), the calls
executed on the controller depend if a command “SaveConfig” has
already been executed for this motor. If the motor is new and the
command SaveConfig has never been executed for this motor, the
following controller methods are called:</p>
<ol class="arabic simple">
<li><p>The AddDevice() method</p></li>
<li><p>The SetPar() method for the Step_per_unit parameter</p></li>
<li><p>The GetPar() method for the Velocity parameter</p></li>
<li><p>The GetPar() method for the Acceleration parameter</p></li>
<li><p>The GetPar() method for the Deceleration parameter</p></li>
<li><p>The GetPar() method for the Base_rate parameter</p></li>
</ol>
<p>If the motor is not new and if a SaveConfig command has been executed
on this motor, during Pool startup sequence, the motor will be created
and the following controller methods will be called:</p>
<ol class="arabic simple">
<li><p>The AddDevice() method</p></li>
<li><p>The SetPar() method for the Step_per_unit parameter</p></li>
<li><p>The SetPar() method for the Velocity parameter</p></li>
<li><p>The SetPar() method for the Acceleration parameter</p></li>
<li><p>The SetPar() method for the Deceleration parameter</p></li>
<li><p>The SetPar() method for the Base_rate parameter</p></li>
<li><p>The SetExtraAttributePar() method for each of the memorized motor
extra attributes</p></li>
</ol>
</div>
</div>
</div>
<div class="section" id="the-pool-motor-group-interface">
<h3>The pool motor group interface<a class="headerlink" href="#the-pool-motor-group-interface" title="Permalink to this headline">¶</a></h3>
<p>The motor group interface allows the user to move several motor(s) at
the same time. It supports several attributes and commands. It is
implemented in C++ and is mainly a set of controller methods call or
individual motor call. The motor group interface is statically linked
with the Pool device server. When creating a group, the user can
define as group member three kinds of elements which are :</p>
<ol class="arabic simple">
<li><p>A simple motor</p></li>
<li><p>Another already created group</p></li>
<li><p>A pseudo-motor</p></li>
</ol>
<p>Nevertheless, it is not possible to have several times the same
physical motor within a group. Therefore, each group has a logical
structure (the one defined by the user when the group is created) and
a physical structure (the list of physical motors really used in the
group).</p>
<div class="section" id="id2">
<h4>The states<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>The motor group interface knows four states which are ON, MOVING,
ALARM and FAULT. A motor group device is in MOVING state when one of
the group element is in MOVING state. It is in ALARM state when one of
the motor is in ALARM state (The underlying motor has reached one of
the limit switches). A motor group device is in FAULT state as long as
any one of the underlying motor is in FAULT state.</p>
</div>
<div class="section" id="id3">
<h4>The commands<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>The motor interface supports 1 command on top of the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> Init, State
and Status command. This command is summarized in the following table:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 28%" />
<col style="width: 35%" />
<col style="width: 37%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Command name</p></th>
<th class="head"><p>Input data type</p></th>
<th class="head"><p>Output data type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Abort</p></td>
<td><p>void</p></td>
<td><p>void</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p><strong>Abort</strong> : It aborts a running motion. This command does not have input or
output argument. It aborts the motion of the motor(s) member of the
group which are still moving while the command is received.</p></li>
</ul>
</div>
<div class="section" id="id4">
<h4>The attributes<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>The motor group supports the following attributes:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 53%" />
<col style="width: 19%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Data type</p></th>
<th class="head"><p>Data format</p></th>
<th class="head"><p>Writable</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Position</p></td>
<td><p>Tango::DevVarDoubleStringArray</p></td>
<td><p>Spectrum</p></td>
<td><p>R/W</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>P <strong>osition</strong> : This is a read/write spectrum of double attribute. Each spectrum
element is the position of one motor. The order of this array is the
order used when the motor group has been created. The size of this
spectrum has to be the size corresponding to the motor number when the
group is created. For instance, for a group created with 2 motors,
another group of 3 motors and one pseudo-motor, the size of this
spectrum when written has to be 6 ( 2 + 3 + 1)</p></li>
</ul>
</div>
<div class="section" id="the-properties">
<h4>The properties<a class="headerlink" href="#the-properties" title="Permalink to this headline">¶</a></h4>
<p>Each motor group has 6 properties. Five of them are automatically
managed by the pool software and must not be changed by the user.
These properties are called Motor_group_id, Pool_device, Motor_list,
User_group_elt and Pos_spectrum_dim_x. The last property called
Sleep_bef_last_read is a user property.This user property is:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 63%" />
<col style="width: 37%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Property name</p></th>
<th class="head"><p>Default value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Sleep_bef_last_read</p></td>
<td><p>0</p></td>
</tr>
</tbody>
</table>
<p>It defines the time in milli-second that the software managing a motor
group motion will wait between it detects the end of the motion of the
last group element and the last group motors position reading.</p>
</div>
<div class="section" id="getting-motor-group-state-using-event">
<h4>Getting motor group state using event<a class="headerlink" href="#getting-motor-group-state-using-event" title="Permalink to this headline">¶</a></h4>
<p>The simplest way to know if a motor group is moving is to survey its
state. If the group is moving, its state will be MOVING. When the
motion is over, its state will be back to ON. The pool motor interface
allows client interested by group state to use the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> event system
subscribing to motor group state change event. As soon as a group
starts a motion, its state is changed to MOVING and an event is sent.
As soon as the motion is over, the group state is updated ans another
event is sent. Events will also be sent to each motor element of the
group when they start moving and when they stop. These events could be
sent before before the group state change event is sent in case of
group motion with different motor motion for each group member.</p>
</div>
<div class="section" id="reading-the-group-position-attribute">
<h4>Reading the group position attribute<a class="headerlink" href="#reading-the-group-position-attribute" title="Permalink to this headline">¶</a></h4>
<p>For each motor group, the key attribute is its position. Special care
has been taken on this attribute management. When the motor group is
not moving (None of the motor are moving), reading the Position
attribute will generate calls to the controller(s) and therefore
hardware access. When the motor group is moving (At least one of its
motor is moving), its position is automatically read every 100 milli-
seconds and stored in the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> polling buffer. This means that a
client reading motor group Position attribute while the group is
moving will get the position from the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> polling buffer and will
not generate extra controller calls. It is also possible to get a
group position using the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> event system. When the group is moving,
an event is sent to the registered clients when the change event
criterion is true. By default, this change event criterion is set to
be a difference in position of 5. It is tunable on a group basis using
the classical group Position attribute “abs_change” property or at the
pool device basis using its DefaultMotGrpPos_AbsChange property.
Anyway, not more than 10 events could be sent by second. Once the
motion is over (None of the motors within the group are moving), the
group position is made unavailable from the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> polling buffer and
is read a last time after a tunable waiting time (Sleep_bef_last_read
property). A forced change event with this value is sent to clients
using events.</p>
</div>
<div class="section" id="the-ghost-motor-group">
<h4>The ghost motor group<a class="headerlink" href="#the-ghost-motor-group" title="Permalink to this headline">¶</a></h4>
<p>In order to allow pool client software to be entirely event based,
some kind of polling has to be done on each motor to inform them on
state change which are not related to motor motion. To achieve this
goal, one internally managed motor group is created. Each pool motor
is a member of this group. The <a class="reference external" href="http://www.tango-controls.org/">Tango</a> polling thread polls the state
command of this group (Polling period tunable with the pool
Ghostgroup_PollingPeriod property). The code of this group state
command detects change in every motor state and send a state change
event on the corresponding motor. This motor group is not available to
client and is even not defined in the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> database. This is why it
is called the ghost group.</p>
</div>
</div>
<div class="section" id="the-pool-pseudo-motor-interface">
<h3>The pool pseudo motor interface<a class="headerlink" href="#the-pool-pseudo-motor-interface" title="Permalink to this headline">¶</a></h3>
<p>The pseudo motor interface acts like an abstraction layer for a motor
or a set of motors allowing the user to control the experiment by
means of an interface which is more meaningful to him(her).</p>
<p>Each pseudo motor is represented by a C++ written tango device whose
interface allows for the control of a single position (scalar value).</p>
<p>In order to translate the motor positions into pseudo positions and
vice versa, calculations have to be performed. The device pool
provides a python API class that can be overwritten to provide new
calculations.</p>
<div class="section" id="id5">
<h4>The states<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>The pseudo motor interface knows four states which are ON, MOVING,
ALARM and FAULT. A pseudo motor device is in MOVING state when at
least one motor is in MOVING state. It is in ALARM state when one of
the motor is in ALARM state (The underlying motor has reached one of
the limit switches. A pseudo motor device is in FAULT state as long as
any one of the underlying motor is in FAULT state).</p>
</div>
<div class="section" id="id6">
<h4>The commands<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<p>The pseudo motor interface supports 1 command on top of the Tango
Init, State and Status commands. This command is summarized in the
following table:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 28%" />
<col style="width: 35%" />
<col style="width: 37%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Command name</p></th>
<th class="head"><p>Input data type</p></th>
<th class="head"><p>Output data type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Abort</p></td>
<td><p>void</p></td>
<td><p>void</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p><strong>Abort</strong> : It aborts a running movement. This command does not have input or
output argument. It aborts the movement of the motor(s) member of the
pseudo motor which are still moving while the command is received.</p></li>
</ul>
</div>
<div class="section" id="id7">
<h4>The attributes<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p>The pseudo motor supports the following attributes:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 19%" />
<col style="width: 37%" />
<col style="width: 26%" />
<col style="width: 19%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Data type</p></th>
<th class="head"><p>Data format</p></th>
<th class="head"><p>Writable</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Position</p></td>
<td><p>Tango::DevDouble</p></td>
<td><p>Scalar</p></td>
<td><p>R/W</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p><strong>Position</strong> : This is read-write scalar double attribute. With the classical Tango
min and max_value, it is easy to define authorized limit for this
attribute. It is not allowed to read or write this attribute when the
pseudo motor is in FAULT or UNKNOWN state. It is also not possible to
write this attribute when the motor is already MOVING.</p></li>
</ul>
</div>
<div class="section" id="the-pseudomotor-system-class">
<h4>The PseudoMotor system class<a class="headerlink" href="#the-pseudomotor-system-class" title="Permalink to this headline">¶</a></h4>
<p>This chapter describes how to write a valid python pseudo motor system
class.</p>
<div class="section" id="prerequisites">
<h5>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h5>
<p>Before writing the first python pseudo motor class for your device
pool two checks must be performed:</p>
<ol class="arabic simple">
<li><p>The device pool <strong>PoolPath</strong> property must exist and must point to the directory which will contain
your python pseudo motor module. The syntax of this PseudoPath
property is the same used in the PATH or PYTHONPATH environment
variables. Please see
XXX: Unknown inset LatexCommand ref{sub:PoolPath}:
for more information on setting this property</p></li>
<li><p>A PseudoMotor.py file is part of the device pool distribution and is
located in &lt;device pool home dir&gt;/py_pseudo. This directory must be in
the PYTHONPATH environment variable or it must be part of the <strong>PoolPath</strong> device pool property metioned above</p></li>
</ol>
</div>
<div class="section" id="rules">
<h5>Rules<a class="headerlink" href="#rules" title="Permalink to this headline">¶</a></h5>
<p>A correct pseudo motor system class must obey the following rules:</p>
<ol class="arabic">
<li><p>the python class PseudoMotor of the PseudoMotor module must be
imported into the current namespace by using one of the python import
statements:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">PseudoMotor</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">PseudoMotor</span> <span class="ow">or</span>
<span class="kn">from</span> <span class="nn">PseudoMotor</span> <span class="kn">import</span> <span class="n">PseudoMotor</span> <span class="ow">or</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>the pseudo motor system class being written must be a subclass of the
PseudoMotor class (see example below)</p></li>
<li><p>the class variable <strong>motor_roles</strong> must be set to be a tuple of text descriptions containing each motor
role description. It is crucial that all necessary motors contain a
textual description even if it is an empty one. This is because the
number of elements in this tuple will determine the number of required
motors for this pseudo motor class. The order in which the roles are
defined is also important as it will determine the index of the motors
in the pseudo motor system.</p></li>
<li><p>the class variable <strong>pseudo_motor_roles</strong> must be set if the pseudo motor class being written represents more
than one pseudo motor. The order in which the roles are defined will
determine the index of the pseudo motors in the pseudo motor system.
If the pseudo motor class represents only one pseudo motor then this
operation is optional. If omitted the value will of pseudo_motor_roles
will be set to:</p></li>
<li><p>if the pseudo motor class needs some special parameters then the class
variable parameters must be set to be a dictionary of &lt;parameter name&gt;
: { &lt;property&gt; : &lt;value&gt; } values where:</p>
<blockquote>
<div><p>&lt;parameter name&gt; - is a string representing the name of the parameter</p>
<p>&lt;property&gt; - is one of the following mandatory properties:
‘Description’, ‘Type’. The ‘Default Value’ property is optional.</p>
<p>&lt;value&gt; - is the corresponding value of the property. The
‘Description’ can contain any text value. The ‘Type’ must be one of
available <a class="reference external" href="http://www.tango-controls.org/">Tango</a> property data types and ‘Default Value’ must be a
string containning a valid value for the corresponding ‘Type’ value.</p>
</div></blockquote>
</li>
<li><p>the pseudo motor class must implement a <strong>calc_pseudo</strong> method with the following signature:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">number</span> <span class="o">=</span> <span class="n">calc_pseudo</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">physical_pos</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>The method will receive as argument the index of the pseudo motor for
which the pseudo position calculation is requested. This number refers
to the index in the pseudo_motor_roles class variable.</p>
<p>The physical_pos is a tuple containing the motor positions.</p>
<p>The params argument is optional and will contain a dictionary of
&lt;parameter name&gt; : &lt;value&gt;.</p>
<p>The method body should contain a code to translate the given motor
positions into pseudo motor positions.</p>
<p>The method will return a number representing the calculated pseudo
motor position.</p>
</div></blockquote>
</li>
<li><p>the pseudo motor class must implement a <strong>calc_physical</strong> method with the following signature:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">number</span> <span class="o">=</span> <span class="n">calc_physical</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">pseudo_pos</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>The method will receive as argument the index of the motor for which
the physical position calculation is requested. This number refers to
the index in the motor_roles class variable.</p>
<p>The pseudo_pos is a tuple containing the pseudo motor positions.</p>
<p>The params argument is optional and will contain a dictionary of
&lt;parameter name&gt; : &lt;value&gt;.</p>
<p>The method body should contain a code to translate the given pseudo
motor positions into motor positions.</p>
<p>The method will return a number representing the calculated motor
position.</p>
</div></blockquote>
</li>
<li><p>Optional implementation of <strong>calc_all_pseudo</strong> method with the following signature:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">()</span><span class="o">/</span><span class="p">[]</span><span class="o">/</span><span class="n">number</span> <span class="o">=</span> <span class="n">calc_all_pseudo</span><span class="p">(</span><span class="n">physical_pos</span><span class="p">,</span><span class="n">params</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>The method will receive as argument a physical_pos which is a tuple of
motor positions.</p>
<p>The params argument is optional and will contain a dictionary of
&lt;parameter name&gt; : &lt;value&gt;.</p>
<p>The method will return a tuple or a list of calculated pseudo motor
positions. If the pseudo motor class represents a single pseudo motor
then the return value could be a single number.</p>
</div></blockquote>
</li>
<li><p>Optional implementation of <strong>calc_all_physical</strong> method with the following signature:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">()</span><span class="o">/</span><span class="p">[]</span><span class="o">/</span><span class="n">number</span> <span class="o">=</span> <span class="n">calc_all_physical</span><span class="p">(</span><span class="n">pseudo_pos</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>The method will receive as argument a pseudo_pos which is a tuple of
pseudo motor positions.</p>
<p>The params argument is optional and will contain a dictionary of
&lt;parameter name&gt; : &lt;value&gt;.</p>
<p>The method will return a tuple or a list of calculated motor
positions. If the pseudo motor class requires a single motor then the
return value could be a single number.</p>
</div></blockquote>
</li>
</ol>
<p><strong>Note:</strong> The default implementation <strong>calc_all_physical</strong> and <strong>calc_all_pseudo</strong> methods will call calc_physical and calc_pseudo for each motor and
physical motor respectively. Overwriting the default implementation
should only be done if a gain in performance can be obtained.</p>
</div>
</div>
<div class="section" id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h4>
<p>One of the most basic examples is the control of a slit. The slit has
two blades with one motor each. Usually the user doesn’t want to
control the experiment by directly handling these two motor positions
since their have little meaning from the experiments perspective.</p>
<img alt="../../_images/gap_offset.png" src="../../_images/gap_offset.png" />
<p>Instead, it would be more useful for the user to control the
experiment by means of changing the gap and offset values. Pseudo
motors gap and offset will provide the necessary interface for
controlling the experiments gap and offset values respectively.</p>
<p>The calculations that need to be performed are:</p>
<p>[ left{ begin{array}{l} gap=sl2t+sl2b\ offset=frac{sl2t-sl2b}{2}end{array}right.]</p>
<p>[ left{ begin{array}{l} sl2t=-offset+frac{gap}{2}\ sl2b=offset+frac{gap}{2}end{array}right.]</p>
<p>The corresponding python code would be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">01</span>  <span class="k">class</span> <span class="nc">Slit</span><span class="p">(</span><span class="n">PseudoMotor</span><span class="p">):</span>
<span class="mi">02</span>      <span class="s2">&quot;&quot;&quot;A Slit system for controlling gap and offset pseudo motors.&quot;&quot;&quot;</span>
<span class="mi">04</span>
<span class="mi">05</span>      <span class="n">pseudo_motor_roles</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Gap&quot;</span><span class="p">,</span> <span class="s2">&quot;Offset&quot;</span><span class="p">)</span>
<span class="mi">06</span>      <span class="n">motor_roles</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Motor on blade 1&quot;</span><span class="p">,</span> <span class="s2">&quot;Motor on blade 2&quot;</span><span class="p">)</span>
<span class="mi">07</span>
<span class="mi">08</span>  <span class="k">def</span> <span class="nf">calc_physical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="n">pseudo_pos</span><span class="p">,</span><span class="n">params</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="mi">09</span>      <span class="n">half_gap</span> <span class="o">=</span> <span class="n">pseudo_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span>
<span class="mi">10</span>      <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="mi">11</span>          <span class="k">return</span> <span class="o">-</span><span class="n">pseudo_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">half_gap</span>
<span class="mi">12</span>      <span class="k">else</span>
<span class="mi">13</span>          <span class="k">return</span> <span class="n">pseudo_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">half_gap</span>
<span class="mi">14</span>
<span class="mi">15</span>  <span class="k">def</span> <span class="nf">calc_pseudo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="n">physical_pos</span><span class="p">,</span><span class="n">params</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="mi">16</span>      <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="mi">17</span>          <span class="k">return</span> <span class="n">physical_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">physical_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="mi">18</span>      <span class="k">else</span><span class="p">:</span>
<span class="mi">19</span>          <span class="k">return</span> <span class="p">(</span><span class="n">physical_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">physical_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span>
</pre></div>
</div>
<div class="section" id="read-gap-position-diagram">
<h5>read gap position diagram<a class="headerlink" href="#read-gap-position-diagram" title="Permalink to this headline">¶</a></h5>
<p>The following diagram shows the sequence of operations performed when
the position is requested from the gap pseudo motor:</p>
<img alt="../../_images/gap_read.png" src="../../_images/gap_read.png" />
</div>
<div class="section" id="write-gap-position-diagram">
<h5>write gap position diagram<a class="headerlink" href="#write-gap-position-diagram" title="Permalink to this headline">¶</a></h5>
<p>The following diagram shows the sequence of operations performed when
a new position is written to the gap pseudo motor:</p>
<img alt="../../_images/gap_write.png" src="../../_images/gap_write.png" />
</div>
</div>
</div>
<div class="section" id="the-counter-timer-interface">
<h3>The Counter/Timer interface<a class="headerlink" href="#the-counter-timer-interface" title="Permalink to this headline">¶</a></h3>
<div class="section" id="the-counter-timer-user-interface">
<h4>The Counter/Timer user interface<a class="headerlink" href="#the-counter-timer-user-interface" title="Permalink to this headline">¶</a></h4>
<p>The Counter/Timer interface is statically linked with the Pool device
server and supports several attributes and commands. It is implemented
in C++ and used a set of the so-called “controller” methods. The
Counter/Timer interface is always the same whatever the hardware is.
This is the rule of the “controller” to access the hardware using the
communication link supported by the hardware (network link, Serial
line…).</p>
<p>The controller code has a well-defined interface and can be written
using Python or C++. In both cases, it will be dynamically loaded into
the pool device server process.</p>
<div class="section" id="id8">
<h5>The states<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h5>
<p>The Counter/Timer interface knows four states which are <code class="xref py py-obj docutils literal notranslate"><span class="pre">ON</span></code>, <em>MOVING</em>,
<strong>FAULT</strong> and UNKNOWN. A Counter/Timer device is in MOVING state when it
is counting! It is in FAULT if its controller software is not
available (impossible to load it), if a fault is reported from the
hardware controller or if the controller software returns an
unforeseen state. The device is in the UNKNOWN state if an exception
occurs during the communication between the pool and the hardware
controller.</p>
</div>
<div class="section" id="id9">
<h5>The commands<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h5>
<p>The Counter/Timer interface supports 2 commands on top of the Tango
classical Init, State and Status commands. These commands are
summarized in the following table:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 28%" />
<col style="width: 35%" />
<col style="width: 37%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Command name</p></th>
<th class="head"><p>Input data type</p></th>
<th class="head"><p>Output data type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Start</p></td>
<td><p>void</p></td>
<td><p>void</p></td>
</tr>
<tr class="row-odd"><td><p>Stop</p></td>
<td><p>void</p></td>
<td><p>void</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p><strong>Start</strong> : When the device is used as a counter, this commands allows the
counter to start counting. When it is used as a timer, this command
starts the timer. This command changes the device state from ON to
MOVING. It is not allowed to execute this command if the device is
already in the MOVING state.</p></li>
<li><p><strong>Stop</strong> : When the device is used as a counter, this commands stops the
counter. When it is used as a timer, this command stops the timer.
This commands changes the device state from MOVING to ON. It is a no
action command if this command is received and the device is not in
the MOVING state.</p></li>
</ul>
</div>
<div class="section" id="id10">
<h5>The attributes<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h5>
<p>The Counter/Timer interface supports several attributes which are
summarized in the following table:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 25%" />
<col style="width: 16%" />
<col style="width: 12%" />
<col style="width: 13%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Data type</p></th>
<th class="head"><p>Data format</p></th>
<th class="head"><p>Writable</p></th>
<th class="head"><p>Memorized</p></th>
<th class="head"><p>Ope/Expert</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Value</p></td>
<td><p>Tango::DevDouble</p></td>
<td><p>Scalar</p></td>
<td><p>R/W</p></td>
<td><p>No</p></td>
<td><p>Ope</p></td>
</tr>
<tr class="row-odd"><td><p>SimulationMode</p></td>
<td><p>Tango::DevBoolean</p></td>
<td><p>Scalar</p></td>
<td><p>R</p></td>
<td><p>No</p></td>
<td><p>Ope</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p><strong>Value</strong> : This is read-write scalar double attribute. Writing the value is
used to clear (or to preset) a counter or to set a timer time. For
counter, reading the value allows the user to get the count number.
For timer, the read value is the elapsed time since the timer has been
started. After the acquisition, the value stays unchanged until a new
count/time is started. For timer, the unit of this attribute is the
second.</p></li>
<li><p><strong>SimulationMode</strong> : This is a read only scalar boolean attribute. When set, all the
counting/timing requests are not forwarded to the software controller
and then to the hardware. When set, the device Value is always 0. To
set this attribute, the user has to used the pool device Tango
interface. It is not allowed to read this attribute when the device is
in FAULT or UNKNOWN states.</p></li>
</ul>
</div>
<div class="section" id="id11">
<h5>The properties<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h5>
<p>Each Counter/Timer device has one property which is automatically
managed by the pool software and must not be changed by the user. This
property is named Channel_id.</p>
</div>
</div>
<div class="section" id="the-counter-timer-controller">
<h4>The Counter/Timer controller<a class="headerlink" href="#the-counter-timer-controller" title="Permalink to this headline">¶</a></h4>
<p>The CounterTimer controller follows the same principles already
explained for the Motor controller in chapter
XXX: Unknown inset LatexCommand ref{sub:The-Motor-Controller}:</p>
<div class="section" id="id12">
<h5>The basic<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h5>
<p>For Counter/Timer, the pre-defined set of methods which has to be
implemented can be splitted in 7 different types which are:</p>
<ol class="arabic simple">
<li><p>Methods to create/remove counter/timer experiment channel</p></li>
<li><p>Methods to get channel(s) state</p></li>
<li><p>Methods to read channel(s)</p></li>
<li><p>Methods to load channel(s)</p></li>
<li><p>Methods to start channel(s)</p></li>
<li><p>Methods to configure a channel</p></li>
<li><p>Remaining method</p></li>
</ol>
</div>
<div class="section" id="the-countertimer-controller-features">
<h5>The CounterTimer controller features<a class="headerlink" href="#the-countertimer-controller-features" title="Permalink to this headline">¶</a></h5>
<p>Not defined yet</p>
</div>
<div class="section" id="the-countertimer-controller-extra-attributes">
<h5>The CounterTimer controller extra attributes<a class="headerlink" href="#the-countertimer-controller-extra-attributes" title="Permalink to this headline">¶</a></h5>
<p>The definition is the same than the one defined for Motor controller
and explained in chapter
XXX: Unknown inset LatexCommand ref{par:Specifying-the-motor}:</p>
</div>
<div class="section" id="methods-to-create-remove-counter-timer-channel">
<h5>Methods to create/remove Counter Timer Channel<a class="headerlink" href="#methods-to-create-remove-counter-timer-channel" title="Permalink to this headline">¶</a></h5>
<p>Two methods are called when creating or removing counter/timer channel
from a controller. These methods are called <strong>AddDevice</strong> and <strong>DeleteDevice</strong> . The AddDevice method is called when a new channel belonging to the
controller is created within the pool. The DeleteDevice method is
called when a channel belonging to the controller is removed from the
pool.</p>
</div>
<div class="section" id="method-s-to-get-counter-timer-channel-state">
<h5>Method(s) to get Counter Timer Channel state.<a class="headerlink" href="#method-s-to-get-counter-timer-channel-state" title="Permalink to this headline">¶</a></h5>
<p>These methods follow the same definition than the one defined for
Motor controller which are detailed in chapter
XXX: Unknown inset LatexCommand ref{par:Methods-to-get-state}:
.</p>
</div>
<div class="section" id="method-s-to-read-counter-timer-experiment-channel">
<h5>Method(s) to read Counter Timer Experiment Channel<a class="headerlink" href="#method-s-to-read-counter-timer-experiment-channel" title="Permalink to this headline">¶</a></h5>
<p>Four methods are used when a request to read channel(s) value is
received. These methods are called PreReadAll, PreReadOne, ReadAll and
ReadOne. The algorithm used to read value of one or several channels
is the following :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">reading</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">PreReadAll</span><span class="p">()</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">channel</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">reading</span>
     <span class="o">-</span> <span class="n">PreReadOne</span><span class="p">(</span><span class="n">channel</span> <span class="n">to</span> <span class="n">read</span><span class="p">)</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">reading</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">ReadAll</span><span class="p">()</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">channel</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">reading</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">ReadOne</span><span class="p">(</span><span class="n">channel</span> <span class="n">to</span> <span class="n">read</span><span class="p">)</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>
</pre></div>
</div>
<p>The following array summarizes the rule of each of these methods:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 17%" />
<col style="width: 20%" />
<col style="width: 18%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Default action</p></td>
<td><p>Does nothing</p></td>
<td><p>Does nothing</p></td>
<td><p>Does nothing</p></td>
<td><p>Print message on the screen and returns NaN. Mandatory for Python</p></td>
</tr>
<tr class="row-odd"><td><p>Externally called by</p></td>
<td><p>Reading the Value attribute</p></td>
<td><p>Reading the Value attribute</p></td>
<td><p>Reading the Value attribute</p></td>
<td><p>Reading the Value attribute</p></td>
</tr>
<tr class="row-even"><td><p>Internally called</p></td>
<td><p>Once for each implied controller</p></td>
<td><p>For each implied channel</p></td>
<td><p>For each implied controller</p></td>
<td><p>Once for each implied channel</p></td>
</tr>
<tr class="row-odd"><td><p>Typical rule</p></td>
<td><p>Init internal data for reading</p></td>
<td><p>Memorize which channel has to be read</p></td>
<td><p>Send order to physical controller</p></td>
<td><p>Return channel value from internal data</p></td>
</tr>
</tbody>
</table>
<p>This algorithm covers the sophisticated case where a physical
controller is able to read several channels positions at the same
time. For some simpler controller, it is possible to implement only
the ReadOne() method. The default implementation of the three
remaining methods is defined in a way that the algorithm works even in
such a case.</p>
</div>
<div class="section" id="method-s-to-load-counter-timer-experiment-channel">
<h5>Method(s) to load Counter Timer Experiment Channel<a class="headerlink" href="#method-s-to-load-counter-timer-experiment-channel" title="Permalink to this headline">¶</a></h5>
<p>Four methods are used when a request to load channel(s) value is
received. These methods are called PreLoadAll, PreLoadOne, LoadAll and
LoadOne. The algorithm used to load value in one or several channels
is the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">loading</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">PreLoadAll</span><span class="p">()</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">channel</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">loading</span>
     <span class="o">-</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">PreLoadOne</span><span class="p">(</span><span class="n">channel</span> <span class="n">to</span> <span class="n">load</span><span class="p">,</span><span class="n">new</span> <span class="n">channel</span> <span class="n">value</span><span class="p">)</span>
     <span class="o">-</span> <span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">ret</span> <span class="ow">is</span> <span class="n">true</span>
          <span class="o">-</span> <span class="n">Call</span> <span class="n">LoadOne</span><span class="p">(</span><span class="n">channel</span> <span class="n">to</span> <span class="n">load</span><span class="p">,</span> <span class="n">new</span> <span class="n">channel</span> <span class="n">value</span><span class="p">)</span>
     <span class="o">-</span> <span class="o">/</span><span class="n">END</span> <span class="n">IF</span><span class="o">/</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">loading</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">LoadAll</span><span class="p">()</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>
</pre></div>
</div>
<p>The following array summarizes the rule of each of these methods:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 13%" />
<col style="width: 21%" />
<col style="width: 19%" />
<col style="width: 25%" />
<col style="width: 22%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Default action</p></td>
<td><p>Does nothing</p></td>
<td><p>Returns true</p></td>
<td><p>Does nothing</p></td>
<td><p>Does nothing</p></td>
</tr>
<tr class="row-odd"><td><p>Externally called by</p></td>
<td><p>Writing the Value attribute</p></td>
<td><p>Writing the Value attribute</p></td>
<td><p>Writing the Value attribute</p></td>
<td><p>Writing the Value attribute</p></td>
</tr>
<tr class="row-even"><td><p>Internally called</p></td>
<td><p>Once for each implied controller</p></td>
<td><p>For each implied channel</p></td>
<td><p>For each implied channel</p></td>
<td><p>Once for each implied controller</p></td>
</tr>
<tr class="row-odd"><td><p>Typical rule</p></td>
<td><p>Init internal data for loading</p></td>
<td><p>Check if counting is possible</p></td>
<td><p>Set new channel value in internal data</p></td>
<td><p>Send order to physical controller</p></td>
</tr>
</tbody>
</table>
<p>This algorithm covers the sophisticated case where a physical
controller is able to write several channels positions at the same
time. For some simpler controller, it is possible to implement only
the LoadOne() method. The default implementation of the three
remaining methods is defined in a way that the algorithm works even in
such a case.</p>
</div>
<div class="section" id="method-s-to-start-counter-timer-experiment-channel">
<h5>Method(s) to start Counter Timer Experiment Channel<a class="headerlink" href="#method-s-to-start-counter-timer-experiment-channel" title="Permalink to this headline">¶</a></h5>
<p>Four methods are used when a request to start channel(s) is received.
These methods are called PreStartAllCT, PreStartOneCT, StartAllCT and
StartOneCT. The algorithm used to start one or several channels is the
following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">starting</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">PreStartAllCT</span><span class="p">()</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">channel</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">starting</span>
     <span class="o">-</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">PreStartOneCT</span><span class="p">(</span><span class="n">channel</span> <span class="n">to</span> <span class="n">start</span><span class="p">)</span>
     <span class="o">-</span> <span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">ret</span> <span class="ow">is</span> <span class="n">true</span>
          <span class="o">-</span> <span class="n">Call</span> <span class="n">StartOneCT</span><span class="p">(</span><span class="n">channel</span> <span class="n">to</span> <span class="n">start</span><span class="p">)</span>
     <span class="o">-</span> <span class="o">/</span><span class="n">END</span> <span class="n">IF</span><span class="o">/</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">starting</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">StartAllCT</span><span class="p">()</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>
</pre></div>
</div>
<p>The following array summarizes the rule of each of these methods:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 13%" />
<col style="width: 21%" />
<col style="width: 19%" />
<col style="width: 25%" />
<col style="width: 22%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Default action</p></td>
<td><p>Does nothing</p></td>
<td><p>Returns true</p></td>
<td><p>Does nothing</p></td>
<td><p>Does nothing</p></td>
</tr>
<tr class="row-odd"><td><p>Externally called by</p></td>
<td><p>The Start command</p></td>
<td><p>The Start command</p></td>
<td><p>The Start command</p></td>
<td><p>The Start command</p></td>
</tr>
<tr class="row-even"><td><p>Internally called</p></td>
<td><p>Once for each implied controller</p></td>
<td><p>For each implied channel</p></td>
<td><p>For each implied channel</p></td>
<td><p>Once for each implied controller</p></td>
</tr>
<tr class="row-odd"><td><p>Typical rule</p></td>
<td><p>Init internal data for starting</p></td>
<td><p>Check if starting is possible</p></td>
<td><p>Set new channel value in internal data</p></td>
<td><p>Send order to physical controller</p></td>
</tr>
</tbody>
</table>
<p>This algorithm covers the sophisticated case where a physical
controller is able to write several channels positions at the same
time. For some simpler controller, it is possible to implement only
the StartOneCT() method. The default implementation of the three
remaining methods is defined in a way that the algorithm works even in
such a case.</p>
</div>
<div class="section" id="methods-to-configure-counter-timer-experiment-channel">
<h5>Methods to configure Counter Timer Experiment Channel<a class="headerlink" href="#methods-to-configure-counter-timer-experiment-channel" title="Permalink to this headline">¶</a></h5>
<p>The rule of these methods is to</p>
<ul class="simple">
<li><p>Get or Set channel extra attribute(s) parameter with methods called
GetExtraAttributePar() or SetExtraAttributePar()</p></li>
</ul>
<p>The following table summarizes the usage of these methods:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 8%" />
<col style="width: 44%" />
<col style="width: 48%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Called by</p></td>
<td><p>Reading any of the extra attributes</p></td>
<td><p>Writing any of the extra attributes</p></td>
</tr>
<tr class="row-odd"><td><p>Rule</p></td>
<td><p>Get extra attribute value from the physical layer</p></td>
<td><p>Set additional attribute value in physical controller</p></td>
</tr>
</tbody>
</table>
<p>The GetExtraAttributePar() default implementation returns a string set
to “Pool_meth_not_implemented”.</p>
</div>
<div class="section" id="remaining-methods">
<h5>Remaining methods<a class="headerlink" href="#remaining-methods" title="Permalink to this headline">¶</a></h5>
<p>The rule of the remaining methods is to</p>
<ul class="simple">
<li><p>Send a raw string to the controller with a method called SendToCtrl()</p></li>
<li><p>Abort a counting counter/timer with a method called AbortOne()</p></li>
</ul>
<p>The following table summarizes the usage of this method:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 8%" />
<col style="width: 66%" />
<col style="width: 26%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Called by</p></td>
<td><p>The Pool SendToController command</p></td>
<td><p>The Stop CounterTimer command</p></td>
</tr>
<tr class="row-odd"><td><p>Rule</p></td>
<td><p>Send the input string to the controller and returns the controller answer</p></td>
<td><p>Abort a running count</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="the-counter-timer-controller-properties-including-the-maxdevice">
<h5>The Counter Timer controller properties (including the MaxDevice<a class="headerlink" href="#the-counter-timer-controller-properties-including-the-maxdevice" title="Permalink to this headline">¶</a></h5>
<p>property)</p>
<p>The definition is the same than the one defined for Motor controller
and explained in chapter
XXX: Unknown inset LatexCommand ref{par:Controller-properties}:</p>
</div>
<div class="section" id="id13">
<h5>C++ controller<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h5>
<p>For C++, the controller code is implemented as a set of classes: A
base class called <strong>Controller</strong> and a class called <strong>CoTiController</strong> which inherits from Controller. Finally, the user has to write its
controller class which inherits from CoTiController. The Controller
class has already been detailed in
XXX: Unknown inset LatexCommand ref{sub:The-Cpp-Controller-class}:
.</p>
<p>XXX: Unknown layout Subparagraph: The CoTiController class
The CoTiController class defines thirteen virtual methods which are:</p>
<ol class="arabic simple">
<li><p>void <strong>CoTiController::PreReadAll</strong> ()
The default implementation does nothing</p></li>
<li><p>void <strong>CoTiController::PreReadOne</strong> (long idx_to_read)
The default implementation does nothing</p></li>
<li><p>void <strong>CoTiController::ReadAll</strong> ()
The default implementation does nothing</p></li>
<li><p>double <strong>CoTiController::ReadOne</strong> (long idx_to_read)
The default implementation prints a message on the screen and return a
NaN value</p></li>
<li><p>void <strong>CoTiController::PreLoadAll</strong> ()
The default implementation does nothing</p></li>
<li><p>bool <strong>CoTiController::PreLoadOne</strong> (long idx_to_load,double new_value)
The default implementation returns true</p></li>
<li><p>void <strong>CoTiController::LoadOne</strong> (long idx_to_load,double new_value)
The default implementation does nothing</p></li>
<li><p>void <strong>CoTiController::LoadAll</strong> ()
The default implementation does nothing</p></li>
<li><p>void <strong>CoTiController::PreStartAllCT</strong> ()
The default implementation does nothing</p></li>
<li><p>bool <strong>CoTiController::PreStartOneCT</strong> (long idx_to_start)
The default implementation returns true</p></li>
<li><p>void <strong>CoTiController::StartOneCT</strong> (long idx_to_start)
The default implementation does nothing</p></li>
<li><p>void <strong>CoTiController::StartAllCT</strong> ()
The default implementation does nothing</p></li>
<li><p>void <strong>CoTiController::AbortOne</strong> (long idx_to_abort)
The default implementation does nothing</p></li>
</ol>
<p>This class has one constructor which is</p>
<ol class="arabic simple">
<li><p><strong>CoTiController::CoTiController</strong> (const char *)
Constructor of the CoTiController class with the controller instance
name as parameter</p></li>
</ol>
<p>XXX: Unknown layout Subparagraph: The user controller class
The user has to implement the remaining pure virtual methods
(AddDevice and DeleteDevice) and has to re-define virtual methods if
the default implementation does not cover his needs. The controller
code has to define two global variables which are:</p>
<ol class="arabic simple">
<li><p><strong>CounterTimer_Ctrl_class_name</strong> : This is an array of classical C strings terminated by a NULL
pointer. Each array element is the name of a Counter Timer Channel
controller defined in the file.</p></li>
<li><p><strong>&lt;CtrlClassName&gt;_MaxDevice</strong> : Idem motor controller definition</p></li>
</ol>
<p>On top of that, a controller code has to define a C function to create
the controller object. This is similar to the Motor controller
definition which is documented in
XXX: Unknown inset LatexCommand ref{par:The-user-controller}:</p>
</div>
<div class="section" id="id14">
<h5>Python controller<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h5>
<p>The principle is exactly the same than the one used for C++ controller
but we don’t have pure virtual methods with a compiler checking if
they are defined at compile time. Therefore, it is the pool software
which checks that the following methods are defined within the
controller class when the controller module is loaded (imported):</p>
<ul class="simple">
<li><p>AddDevice</p></li>
<li><p>DeleteDevice</p></li>
<li><p>ReadOne method</p></li>
<li><p>StateOne method</p></li>
<li><p>StartOneCT or StartAllCT method</p></li>
<li><p>LoadOne or LoadAll method</p></li>
</ul>
<p>With Python controller, there is no need for function to create
controller class instance. With the help of the Python C API, the pool
device is able to create the needed instances. Note that the
StateOne() method does not have the same signature for Python
controller.</p>
<ol class="arabic">
<li><p>tuple <strong>Stat</strong> e <strong>One</strong> (self,idx_number)
Get a channel state. The method has to return a tuple with one or two
elements which are:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>The channel state (as defined by Tango)</p></li>
<li><p>A string describing the motor fault if the controller has this
feature.</p></li>
</ol>
</div></blockquote>
</li>
</ol>
<p>A Python controller class has to inherit from a class called
<strong>CounterTimerController</strong> . This does not add any feature but allows the pool
software to realize that this class is a Counter Timer Channel controller.</p>
</div>
</div>
</div>
<div class="section" id="the-unix-timer">
<h3>The Unix Timer<a class="headerlink" href="#the-unix-timer" title="Permalink to this headline">¶</a></h3>
<p>A timer using the Unix getitimer() and setitimer() system calls is
provided. It is a Counter/Timer C++ controller following the
definition of the previous chapter. Therefore, the device created
using this controller will have the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> interface as the one
previously described.</p>
<p>The Unix Timer controller shared library is called <strong>UxTimer.so</strong> and the
Controlller class is called <strong>UnixTimer</strong> . This controller is foresee to
have only one device (MaxDevice = 1)</p>
</div>
<div class="section" id="the-zerodexpchannel-interface">
<h3>The ZeroDExpChannel interface<a class="headerlink" href="#the-zerodexpchannel-interface" title="Permalink to this headline">¶</a></h3>
<p>The ZeroDExpChannel is used to access any kind of device which returns
a scalar value and which are not counter or timer. Very often (but not
always), this is a commercial measurement equipment connected to a
GPIB bus. In order to have a precise as possible measurement, an
acquisition loop is implemented for these ZeroDExpChannel device. This
acquisition loop will simply read the data from the hardware as fast
as it can (only “sleeping” 20 mS between each reading) and a
computation is done on the resulting data set to return only one
value. Three types of computation are foreseen. The user selects which
one he needs with an attribute. The time during which this acquisition
loop will get data is also defined by an attribute</p>
<div class="section" id="the-zerodexpchannel-user-interface">
<h4>The ZeroDExpChannel user interface<a class="headerlink" href="#the-zerodexpchannel-user-interface" title="Permalink to this headline">¶</a></h4>
<p>The ZeroDExpChannel interface is statically linked with the Pool
device server and supports several attributes and commands. It is
implemented in C++ and used a set of the so-called “controller”
methods. The ZeroDExpChannel interface is always the same whatever the
hardware is. This is the rule of the “controller” to access the
hardware using the communication link supported by the hardware
(network link, GPIB…).</p>
<p>The controller code has a well-defined interface and can be written
using Python or C++. In both cases, it will be dynamically loaded into
the pool device server process.</p>
<div class="section" id="id15">
<h5>The states<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h5>
<p>The ZeroDExpChannel interface knows five states which are ON, MOVING,
ALARM, FAULT and UNKNOWN. A ZeroDExpChannel device is in MOVING state
when it is acquiring data! It is in ALARM state when at least one
error has occured during the last acquisition. It is in FAULT if its
controller software is not available (impossible to load it), if a
fault is reported from the hardware controller or if the controller
software returns an unforeseen state. The device is in the UNKNOWN
state if an exception occurs during the communication between the pool
and the hardware controller.</p>
</div>
<div class="section" id="id16">
<h5>The commands<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h5>
<p>The ZeroDExpChannel interface supports 2 commands on top of the Tango
classical Init, State and Status commands. These commands are
summarized in the following table:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 28%" />
<col style="width: 35%" />
<col style="width: 37%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Command name</p></th>
<th class="head"><p>Input data type</p></th>
<th class="head"><p>Output data type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Start</p></td>
<td><p>void</p></td>
<td><p>void</p></td>
</tr>
<tr class="row-odd"><td><p>Stop</p></td>
<td><p>void</p></td>
<td><p>void</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p><strong>Start</strong> : Start the acquisition for the time defined by the attribute
CumulatedTime. If the CumulatedTime attribute value is 0, the
acquisition will not automatically stop until a Stop command is
received. This command changes the device state from ON to MOVING. It
is not allowed to execute this command if the device is already in the
MOVING state.</p></li>
<li><p><strong>Stop</strong> : Stop the acquisition. This commands changes the device state from
MOVING to ON. It is a no action command if this command is received
and the device is not in the MOVING state.</p></li>
</ul>
</div>
<div class="section" id="id17">
<h5>The attributes<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h5>
<p>The ZeroDExpChannel interface supports several attributes which are
summarized in the following table:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 28%" />
<col style="width: 22%" />
<col style="width: 14%" />
<col style="width: 11%" />
<col style="width: 12%" />
<col style="width: 13%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Data type</p></th>
<th class="head"><p>Data format</p></th>
<th class="head"><p>Writable</p></th>
<th class="head"><p>Memorized</p></th>
<th class="head"><p>Ope/Expert</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Value</p></td>
<td><p>Tango::DevDouble</p></td>
<td><p>Scalar</p></td>
<td><p>R</p></td>
<td><p>No</p></td>
<td><p>Ope</p></td>
</tr>
<tr class="row-odd"><td><p>CumulatedValue</p></td>
<td><p>Tango::DevDouble</p></td>
<td><p>Scalar</p></td>
<td><p>R</p></td>
<td><p>No</p></td>
<td><p>Ope</p></td>
</tr>
<tr class="row-even"><td><p>CumulationTime</p></td>
<td><p>Tango::DevDouble</p></td>
<td><p>Scalar</p></td>
<td><p>R/W</p></td>
<td><p>Yes</p></td>
<td><p>Ope</p></td>
</tr>
<tr class="row-odd"><td><p>CumulationType</p></td>
<td><p>Tango::DevLong</p></td>
<td><p>Scalar</p></td>
<td><p>R/W</p></td>
<td><p>Yes</p></td>
<td><p>Ope</p></td>
</tr>
<tr class="row-even"><td><p>CumulatedPointsNumber</p></td>
<td><p>Tango::DevLong</p></td>
<td><p>Scalar</p></td>
<td><p>R</p></td>
<td><p>No</p></td>
<td><p>Ope</p></td>
</tr>
<tr class="row-odd"><td><p>CumulatedPointsError</p></td>
<td><p>Tango::DevLong</p></td>
<td><p>Scalar</p></td>
<td><p>R</p></td>
<td><p>No</p></td>
<td><p>Ope</p></td>
</tr>
<tr class="row-even"><td><p>SimulationMode</p></td>
<td><p>Tango::DevBoolean</p></td>
<td><p>Scalar</p></td>
<td><p>R</p></td>
<td><p>No</p></td>
<td><p>Ope</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>Value</strong> : This is read scalar double attribute. This is the live value reads
from the hardware through the controller</p></li>
<li><p><strong>CumulatedValue</strong> : This is a read scalar double attribute. This is the result of the
data acquisition after the computation defined by the CumulationType
attribute has been applied. This value is 0 until an acquisition has
been started. After an acquisition, the attribute value stays
unchanged until the next acquisition is started. If during the
acquisition some error(s) has been received while reading the data,
the attribute quality factor will be set to ALARM</p></li>
<li><p><strong>CumulationTime</strong> : This is a read-write scalar double and memorized attribute. This is
the acquisition time in seconds. The acquisition will automatically
stops after this CumulationTime. Very often, reading the hardware
device to get one data is time-consuming and it is not possible to
read the hardware a integer number of times within this
CumulationTime. A device property called StopIfNoTime (see
XXX: Unknown inset LatexCommand ref{ite:StopIfNoTime:-A-boolean}:
) allows the user to tune the acquisition loop.</p></li>
<li><p><strong>CumulationType</strong> : This a read-write scalar long and memorized attribute. Defines the
computation type done of the values gathered during the acquisition.
Three type of computation are supported:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Sum: The CumulatedValue attribute is the sum of all the data read
during the acquisition. This is the default type.</p></li>
<li><p>Average: The CumulatedValue attribute is the average of all the data
read during the acquisition</p></li>
<li><p>Integral: The CumulatedValue attribute is a type of the integral of
all the data read during the acquisition</p></li>
</ol>
</div></blockquote>
</li>
<li><p><strong>CumulatedPointsNumber</strong> : This is a read scalar long attribute. This is the number of data
correctly read during the acquisition. The attribute value is 0 until
an acquisition has been started and stay unchanged between the end of
the acquisition and the start of the next one.</p></li>
<li><p><strong>CumulatedPointsError</strong> : This is a read scalar long attribute. This is the number of times it
was not possible to read the data from the hardware due to error(s).
The property ContinueOnError allows the user to define what to do in
case of error. The attribute value is 0 until an acquisition has been
started and stay unchanged between the end of the acquisition and the
start of the next one.</p></li>
<li><p><strong>SimulationMode</strong> : This is a read only scalar boolean attribute. When set, all the
acquisition requests are not forwarded to the software controller and
then to the hardware. When set, the device Value, CumulatedValue,
CumulatedPointsNumber and CumulatedPointsError are always 0. To set
this attribute, the user has to used the pool device <a class="reference external" href="http://www.tango-controls.org/">Tango</a> interface.
The value of the CumulationTime and CumulationType attributes are
memorized at the moment this attribute is set. When this mode is
turned off, if the value of any of the previously memorized attributes
has changed, it is reapplied to the memorized value. It is not allowed
to read this attribute when the device is in FAULT or UNKNOWN states.</p></li>
</ul>
</div>
<div class="section" id="id18">
<h5>The properties<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h5>
<p>Each ZeroDExpChannel device has a set of properties. One of these
properties is automatically managed by the pool software and must not
be changed by the user. This property is named Channel_id. The user
properties are:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 54%" />
<col style="width: 46%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Property name</p></th>
<th class="head"><p>Default value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>StopIfNoTime</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-odd"><td><p>ContinueOnError</p></td>
<td><p>true</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>XXX: Unknown inset LatexCommand label{ite:StopIfNoTime:-A-boolean}:
<strong>StopIfNoTime</strong> : A boolean property. If this property is set to true, the acquisition
loop will check before acquiring a new data that it has enough time to
do this. To achieve this, the acquisition loop measures the time
needed by the previous data read and checks that the actual time plus
the acquisition time is still less than the CumulationTime. If not,
the acquisition stops. When this property is set to false, the
acquisition stops when the acquisition time is greater or equal than
the CumulationTime</p></li>
<li><p><strong>ContinueOnError</strong> : A boolean property. If this property is set to true (the default),
the acquisition loop continues reading the data even after an error
has been received when trying to read data. If it is false, the
acquisition stops as soon as an error is detected when trying to read
data from the hardware.</p></li>
</ul>
</div>
<div class="section" id="getting-zerodexpchannel-state-using-event">
<h5>Getting ZeroDExpChannel state using event<a class="headerlink" href="#getting-zerodexpchannel-state-using-event" title="Permalink to this headline">¶</a></h5>
<p>The simplest way to know if a Zero D Experiment Channel is acquiring
data is to survey its state. If the device is acquiring data, its
state will be MOVING. When the acquisition is over, its state will be
back to ON. The pool ZeroDExpChannel interface allows client
interested by Experiment Channel state value to use the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> event
system subscribing to channel state change event. As soon as a channel
starts an acquisition, its state is changed to MOVING and an event is
sent. As soon as the acquisition is over (for one reason or another),
the channel state is updated and another event is sent.</p>
</div>
<div class="section" id="xxx-unknown-inset-latexcommand-label-par-reading-the-zerodexpchannel">
<h5>XXX: Unknown inset LatexCommand label{par:Reading-the-ZeroDExpChannel}:<a class="headerlink" href="#xxx-unknown-inset-latexcommand-label-par-reading-the-zerodexpchannel" title="Permalink to this headline">¶</a></h5>
<p>Reading the ZeroDExpChannel CumulatedValue attribute</p>
<p>During an acquisition, events with CumulatedValue attribute are sent
from the device server to the interested clients. The acquisition loop
will periodically read this event and fire an event. The first and the
last events fired during the acquisition loop do not check the change
event criteria. The other during the acquisition loop check the change
event criteria</p>
</div>
</div>
<div class="section" id="the-zerodexpchannel-controller">
<h4>The ZeroDExpChannel Controller<a class="headerlink" href="#the-zerodexpchannel-controller" title="Permalink to this headline">¶</a></h4>
<p>The ZeroDExpChannel controller follows the same principles already
explained for the Motor controller in chapter
XXX: Unknown inset LatexCommand ref{sub:The-Motor-Controller}:</p>
<div class="section" id="id19">
<h5>The basic<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h5>
<p>For Zero Dimension Experiment Channel, the pre-defined set of methods
which has to be implemented can be splitted in 5 different types which
are:</p>
<ol class="arabic simple">
<li><p>Methods to create/remove zero dimension experiment channel</p></li>
<li><p>Methods to get channel(s) state</p></li>
<li><p>Methods to read channel(s)</p></li>
<li><p>Methods to configure a channel</p></li>
<li><p>Remaining method</p></li>
</ol>
</div>
<div class="section" id="the-zerodexpchannel-controller-features">
<h5>The ZeroDExpChannel controller features<a class="headerlink" href="#the-zerodexpchannel-controller-features" title="Permalink to this headline">¶</a></h5>
<p>Not defined yet</p>
</div>
<div class="section" id="the-zerodexpchannel-controller-extra-attributes">
<h5>The ZeroDExpChannel controller extra attributes<a class="headerlink" href="#the-zerodexpchannel-controller-extra-attributes" title="Permalink to this headline">¶</a></h5>
<p>The definition is the same than the one defined for Motor controller
and explained in chapter
XXX: Unknown inset LatexCommand ref{par:Specifying-the-motor}:</p>
</div>
<div class="section" id="methods-to-create-remove-zero-d-experiment-channel">
<h5>Methods to create/remove Zero D Experiment Channel<a class="headerlink" href="#methods-to-create-remove-zero-d-experiment-channel" title="Permalink to this headline">¶</a></h5>
<p>Two methods are called when creating or removing experiment channel
from a controller. These methods are called <strong>AddDevice</strong> and <strong>DeleteDevice</strong> . The AddDevice method is called when a new channel belonging to the
controller is created within the pool. The DeleteDevice method is
called when a channel belonging to the controller is removed from the
pool.</p>
</div>
<div class="section" id="method-s-to-get-zero-d-experiment-channel-state">
<h5>Method(s) to get Zero D Experiment Channel state.<a class="headerlink" href="#method-s-to-get-zero-d-experiment-channel-state" title="Permalink to this headline">¶</a></h5>
<p>These methods follow the same definition than the one defined for
Motor controller which are detailed in chapter
XXX: Unknown inset LatexCommand ref{par:Methods-to-get-state}:
.</p>
</div>
<div class="section" id="method-s-to-read-zero-d-experiment-channel">
<h5>Method(s) to read Zero D Experiment Channel<a class="headerlink" href="#method-s-to-read-zero-d-experiment-channel" title="Permalink to this headline">¶</a></h5>
<p>Four methods are used when a request to read channel(s) value is
received. These methods are called PreReadAll, PreReadOne, ReadAll and
ReadOne. The algorithm used to read value of one or several channels
is the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">reading</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">PreReadAll</span><span class="p">()</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">channel</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">reading</span>
     <span class="o">-</span> <span class="n">PreReadOne</span><span class="p">(</span><span class="n">channel</span> <span class="n">to</span> <span class="n">read</span><span class="p">)</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">reading</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">ReadAll</span><span class="p">()</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">channel</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">reading</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">ReadOne</span><span class="p">(</span><span class="n">channel</span> <span class="n">to</span> <span class="n">read</span><span class="p">)</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>
</pre></div>
</div>
<p>The following array summarizes the rule of each of these methods:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 17%" />
<col style="width: 20%" />
<col style="width: 18%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Default action</p></td>
<td><p>Does nothing</p></td>
<td><p>Does nothing</p></td>
<td><p>Does nothing</p></td>
<td><p>Print message on the screen and returns NaN. Mandatory for Python</p></td>
</tr>
<tr class="row-odd"><td><p>Externally called by</p></td>
<td><p>Reading the Value attribute</p></td>
<td><p>Reading the Value attribute</p></td>
<td><p>Reading the Value attribute</p></td>
<td><p>Reading the Value attribute</p></td>
</tr>
<tr class="row-even"><td><p>Internally called</p></td>
<td><p>Once for each implied controller</p></td>
<td><p>For each implied channel</p></td>
<td><p>For each implied controller</p></td>
<td><p>Once for each implied channel</p></td>
</tr>
<tr class="row-odd"><td><p>Typical rule</p></td>
<td><p>Init internal data for reading</p></td>
<td><p>Memorize which channel has to be read</p></td>
<td><p>Send order to physical controller</p></td>
<td><p>Return channel value from internal data</p></td>
</tr>
</tbody>
</table>
<p>This algorithm covers the sophisticated case where a physical
controller is able to read several channels positions at the same
time. For some simpler controller, it is possible to implement only
the ReadOne() method. The default implementation of the three
remaining methods is defined in a way that the algorithm works even in
such a case.</p>
</div>
<div class="section" id="methods-to-configure-zero-d-experiment-channel">
<h5>Methods to configure Zero D Experiment Channel<a class="headerlink" href="#methods-to-configure-zero-d-experiment-channel" title="Permalink to this headline">¶</a></h5>
<p>The rule of these methods is to</p>
<ul class="simple">
<li><p>Get or Set channel extra attribute(s) parameter with methods called
GetExtraAttributePar() or SetExtraAttributePar()</p></li>
</ul>
<p>The following table summarizes the usage of these methods:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 8%" />
<col style="width: 44%" />
<col style="width: 48%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Called by</p></td>
<td><p>Reading any of the extra attributes</p></td>
<td><p>Writing any of the extra attributes</p></td>
</tr>
<tr class="row-odd"><td><p>Rule</p></td>
<td><p>Get extra attribute value from the physical layer</p></td>
<td><p>Set additional attribute value in physical controller</p></td>
</tr>
</tbody>
</table>
<p>The GetExtraAttributePar() default implementation returns a string set
to “Pool_meth_not_implemented”.</p>
</div>
<div class="section" id="remaining-method">
<h5>Remaining method<a class="headerlink" href="#remaining-method" title="Permalink to this headline">¶</a></h5>
<p>The rule of the remaining method is to</p>
<ul class="simple">
<li><p>Send a raw string to the controller with a method called SendToCtrl()</p></li>
</ul>
<p>The following table summarizes the usage of this method:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 89%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Called by</p></td>
<td><p>The Pool SendToController command</p></td>
</tr>
<tr class="row-odd"><td><p>Rule</p></td>
<td><p>Send the input string to the controller and returns the controller answer</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="the-zerodexpchannel-controller-properties-including-the-maxdevice-property">
<h5>The ZeroDExpChannel controller properties (including the MaxDevice property)<a class="headerlink" href="#the-zerodexpchannel-controller-properties-including-the-maxdevice-property" title="Permalink to this headline">¶</a></h5>
<p>The definition is the same than the one defined for Motor controller
and explained in chapter
XXX: Unknown inset LatexCommand ref{par:Controller-properties}:</p>
</div>
<div class="section" id="id20">
<h5>C++ controller<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h5>
<p>For C++, the controller code is implemented as a set of classes: A
base class called <strong>Controller</strong> and a class called <strong>ZeroDController</strong> which inherits from Controller. Finally, the user has to write its
controller class which inherits from ZeroDController. The Controller
class has already been detailed in
XXX: Unknown inset LatexCommand ref{sub:The-Cpp-Controller-class}:
.</p>
<p>XXX: Unknown layout Subparagraph: The ZeroDController class
The ZeroDController class defines four virtual methods which are:</p>
<ol class="arabic simple">
<li><p>void <strong>ZeroDController::PreReadAll</strong> ()
The default implementation does nothing</p></li>
<li><p>void <strong>ZeroDController::PreReadOne</strong> (long idx_to_read)
The default implementation does nothing</p></li>
<li><p>void <strong>ZeroDController::ReadAll</strong> ()
The default implementation does nothing</p></li>
<li><p>double <strong>ZeroDController::ReadOne</strong> (long idx_to_read)
The default implementation prints a message on the screen and return a
NaN value</p></li>
</ol>
<p>This class has one constructor which is</p>
<ol class="arabic simple">
<li><p><strong>ZeroDController::ZeroDController</strong> (const char *)
Constructor of the ZeroDController class with the controller instance
name as parameter</p></li>
</ol>
<p>XXX: Unknown layout Subparagraph: The user controller class
The user has to implement the remaining pure virtual methods
(AddDevice and DeleteDevice) and has to re-define virtual methods if
the default implementation does not cover his needs. The controller
code has to define two global variables which are:</p>
<ol class="arabic simple">
<li><p><strong>ZeroDExpChannel_Ctrl_class_name</strong> : This is an array of classical C strings terminated by a NULL
pointer. Each array element is the name of a ZeroDExpChannel
controller defined in the file.</p></li>
<li><p><strong>&lt;CtrlClassName&gt;_MaxDevice</strong> : Idem motor controller definition</p></li>
</ol>
<p>On top of that, a controller code has to define a C function to create
the controller object. This is similar to the Motor controller
definition which is documented in
XXX: Unknown inset LatexCommand ref{par:The-user-controller}:</p>
</div>
<div class="section" id="id21">
<h5>Python controller<a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h5>
<p>The principle is exactly the same than the one used for C++ controller
but we don’t have pure virtual methods with a compiler checking if
they are defined at compile time. Therefore, it is the pool software
which checks that the following methods are defined within the
controller class when the controller module is loaded (imported):</p>
<ul class="simple">
<li><p>AddDevice</p></li>
<li><p>DeleteDevice</p></li>
<li><p>ReadOne method</p></li>
<li><p>StateOne method</p></li>
</ul>
<p>With Python controller, there is no need for function to create
controller class instance. With the help of the Python C API, the pool
device is able to create the needed instances. Note that the
StateOne() method does not have the same signature for Python
controller.</p>
<ol class="arabic">
<li><p>tuple <strong>Stat</strong> e <strong>One</strong> (self,idx_number)
Get a channel state. The method has to return a tuple with one or two
elements which are:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>The channel state (as defined by Tango)</p></li>
<li><p>A string describing the motor fault if the controller has this
feature.</p></li>
</ol>
</div></blockquote>
</li>
</ol>
<p>A Python controller class has to inherit from a class called <strong>ZeroDController</strong> . This does not add any feature but allows the pool software to
realize that this class is a Zero D Experiment Channel controller.</p>
</div>
</div>
</div>
<div class="section" id="the-onedexpchannel-interface">
<h3>The OneDExpChannel interface<a class="headerlink" href="#the-onedexpchannel-interface" title="Permalink to this headline">¶</a></h3>
<p>To be filled in</p>
</div>
<div class="section" id="the-twodexpchannel-interface">
<h3>The TwoDExpChannel interface<a class="headerlink" href="#the-twodexpchannel-interface" title="Permalink to this headline">¶</a></h3>
<p>To be filled in</p>
</div>
<div class="section" id="the-measurement-group-interface">
<h3>The Measurement Group interface<a class="headerlink" href="#the-measurement-group-interface" title="Permalink to this headline">¶</a></h3>
<p>The measurement group interface allows the user to access several data
acquisition channels at the same time. It is implemented as a C++
<a class="reference external" href="http://www.tango-controls.org/">Tango</a> device that is statically linked with the Pool device server. It
supports several attributes and commands.</p>
<p>The measurement group is the key interface to be used when getting
data. The Pool can have several measurement groups but only one will
be ‘in use’ at a time. When creating a measurement group, the user can
define four kinds of channels which are:</p>
<ol class="arabic simple">
<li><p>Counter/Timer</p></li>
<li><p>ZeroDExpChannel</p></li>
<li><p>OneDExpChannel</p></li>
<li><p>TwoDExpChannel</p></li>
</ol>
<p>In order to properly use the measurement group, one of the channels
has to be defined as the timer or the monitor. It is not possible to
have several times the same channel in a measurement group. It is also
not possible to create two measurement groups with exactly the same
channels.</p>
<div class="section" id="id22">
<h4>The States<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h4>
<p>The measurement group interface knows five states which are ON,
MOVING, ALARM, FAULT. A group is in MOVING state when it is acquiring
data (which means that the timer/monitor channel is in MOVING state).
A STANDBY state means that the group is not the current active group
of the Pool it belongs to. An ON state means that the group is ready
to be used. ALARM means that no timer or monitor are defined for the
group. If at least one of the channels reported a FAULT by the
controller(s) of that(those) channel(s), the group will be in FAULT
state.</p>
</div>
<div class="section" id="id23">
<h4>The commands<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h4>
<p>The measurement group interface supports three commands on top of the
<a class="reference external" href="http://www.tango-controls.org/">Tango</a> Init, State and Status commands. These commands are summarized
in the following table:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 34%" />
<col style="width: 32%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Command name</p></th>
<th class="head"><p>Input data type</p></th>
<th class="head"><p>Output data type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Start</p></td>
<td><p>void</p></td>
<td><p>void</p></td>
</tr>
<tr class="row-odd"><td><p>Abort</p></td>
<td><p>void</p></td>
<td><p>void</p></td>
</tr>
<tr class="row-even"><td><p>AddExpChannel</p></td>
<td><p>String</p></td>
<td><p>void</p></td>
</tr>
<tr class="row-odd"><td><p>RemoveExpChannel</p></td>
<td><p>String</p></td>
<td><p>void</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p><strong>Start</strong> : When the device is in timer mode (Integration_time attribute &gt; 0),
it will start counting on all channels at the same time until the
timer channel reaches a value of the Integration_time attribute. When
the device in in monitor mode (Integration_count attribute &gt; 0), it
will start counting on all channels at the same time until de monitor
channel reaches the value of the Integration_count attribute. For more
details on setting the acquisition mode see
XXX: Unknown inset LatexCommand ref{Measurement Group: The attributes}:
. This command will change the device state to MOVING. It will not be
allowed to execute this command if the device is already in MOVING
state. This command does not have any input or output arguments. The
state will change from MOVING to ON only when the last channel reports
that its acquisition has finished.</p></li>
<li><p><strong>Abort</strong> : It aborts the running data acquisition. It will stop each channel
member of the measurement group. This command does not have any input
or output arguments.</p></li>
<li><p><strong>AddExpChannel</strong> : adds a new experiment channel to the measurement group. The given
string argument must be a valid experiment channel in the pool and
must not be one of the channels of the measurement group. An event
will be sent on the corresponding attribute representing the list of
channels in the measurement group. For example, if the given channel
is a Counter/Timer channel, then an event will be sent for the
attribute “Counters “(See below for a list of attributes in the measurement group).</p></li>
<li><p><strong>RemoveExpChannel</strong> : removes the given channel from the measurement group. The given
string argument must be a valid experiment channel in the measurement
group. If the channel to be deleted is the current Timer/Monitor then
the value for the corresponding attribute will be set to “Not Initialized “and an event will be sent. An event will be sent on the corresponding
attribute representing the list of channels in the measurement group.</p></li>
</ul>
</div>
<div class="section" id="xxx-unknown-inset-latexcommand-label-measurement-group-the-attributes">
<h4>XXX: Unknown inset LatexCommand label{Measurement Group: The attributes}:<a class="headerlink" href="#xxx-unknown-inset-latexcommand-label-measurement-group-the-attributes" title="Permalink to this headline">¶</a></h4>
<p>The attributes</p>
<p>A measurement group will support 8+n (n being the number of channels)
attributes summarized in the following table:
=========================================  ================  =====================  ========  =========  ==========
Name                                       Data type         Data format            Writable  Memorized  Ope/Expert
=========================================  ================  =====================  ========  =========  ==========
Integration_time                           Tango::DevDouble  Scalar                 R/W       Yes        Ope
Integration_count                          Tango::DevLong    Scalar                 R/W       Yes        Ope
Timer                                      Tango::DevString  Scalar                 R/W       Yes        Ope
Monitor                                    Tango::DevString  Scalar                 R/W       Yes        Ope
Counters                                   Tango::DevString  Spectrum               R         No         Ope
ZeroDExpChannels                           Tango::DevString  Spectrum               R         No         Ope
OneDExpChannels                            Tango::DevString  Spectrum               R         No         Ope
TwoDExpChannels                            Tango::DevString  Spectrum               R         No         Ope
&lt;channel_name _{text{i}} &gt;_Value  Tango::DevDouble Scalar/Spectrum/Image  R         No         Ope
=========================================  ================  =====================  ========  =========  ==========</p>
<ul class="simple">
<li><p><strong>Integration_time</strong> : The group timer integration time. Setting this value to &gt;0 will set
the measurement group acquisition mode to timer. It will force
Integration_count attribute to 0 (zero). It will also exclude the
current Timer channel from the list of Counters. Units are in seconds.</p></li>
<li><p><strong>Integration_count</strong> : The group monitor count value. Setting this value to &gt;0 will set the
measurement group acquisition mode change to monitor. It will force
Integration_time attribute to 0 (zero).</p></li>
<li><p><strong>Timer</strong> : The name of the channel used as a Timer. A “Not Initialized “value means no timer is defined</p></li>
<li><p><strong>Monitor</strong> : The name of the channel used as a Monitor. A “Not Initialized “value means no timer is defined</p></li>
<li><p><strong>Counter</strong> : The list of counter names in the group</p></li>
<li><p><strong>ZeroDExpChannels</strong> : The list of 0D Experiment channel names in the group</p></li>
<li><p><strong>OneDExpChannels</strong> : The list of 1D Experiment channel names in the group</p></li>
<li><p><strong>TwoDExpChannels</strong> : The list of 2D Experiment channel names in the group</p></li>
<li><p><strong>&lt;channel_name</strong> _{text{i}} <strong>&gt;_Value</strong> : (with 0leq i&lt;n ) attributes dynamically created (one for each channel) which will
contain the corresponding channel Value(for Counter/Timer, 1D or
2DExpChannels), CumulatedValue(for 0DExpChannels). For Counter/Timers
and 0DExpChannels the data format will be Scalar. For 1DExpChannels it
will be Spectrum and for 2DExpChannels it will be Image.</p></li>
</ul>
</div>
<div class="section" id="id24">
<h4>The properties<a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="device-properties">
<h4>Device properties<a class="headerlink" href="#device-properties" title="Permalink to this headline">¶</a></h4>
<p>Each measurement group has five properties. All of them are managed
automatically by the pool software and must not be changed by the
user. These properties are called Measurement_group_id, Pool_device,
CT_List, ZeroDExpChannel_List, OneDExpChannel_List,
TwoDExpChannel_List.</p>
</div>
<div class="section" id="xxx-unknown-inset-latexcommand-label-measurement-group-checking-operation-modes">
<h4>XXX: Unknown inset LatexCommand label{measurement group:Checking-operation-modes}:<a class="headerlink" href="#xxx-unknown-inset-latexcommand-label-measurement-group-checking-operation-modes" title="Permalink to this headline">¶</a></h4>
<p>Checking operation mode</p>
<p>Currently, the measurement group supports two operation modes. The
table below shows how to determine the current mode for a measurement
group.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 18%" />
<col style="width: 40%" />
<col style="width: 43%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>mode</p></th>
<th class="head"><p>Integration_time</p></th>
<th class="head"><p>Integration_count</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Timer</p></td>
<td><p>&gt;0.0</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>Monitor</p></td>
<td><p>0.0</p></td>
<td><p>&gt;0</p></td>
</tr>
<tr class="row-even"><td><p>Undef</p></td>
<td><p>0.0</p></td>
<td><p>0</p></td>
</tr>
</tbody>
</table>
<p>‘Undef’ means no valid values are defined in Integration_time and in
Integration_count. You will not be able to execute the Start command
in this mode.</p>
</div>
<div class="section" id="getting-measurement-group-state-using-event">
<h4>Getting measurement group state using event<a class="headerlink" href="#getting-measurement-group-state-using-event" title="Permalink to this headline">¶</a></h4>
<p>The simplest way to know if a measurement group is acquiring data is
to survey its state. If a measurement group is acquiring data its
state will be MOVING. When the data acquisition is over, its state
will change back to ON. The data acquisition is over when the
measurement group detects that all channels finished acquisition
(their state changed from MOVING to ON).The pool group interface
allows clients interested in group state to use the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> event system
subscribing to measurement group state change event. As soon as a
group starts acquiring data, its state is changed to MOVING and an
event is sent. A new event will be sent when the data acquisition
ends. Events will also be sent to each channel of the group when they
start acquiring data and when they stop.</p>
</div>
<div class="section" id="reading-the-measurement-group-channel-values">
<h4>Reading the measurement group channel values<a class="headerlink" href="#reading-the-measurement-group-channel-values" title="Permalink to this headline">¶</a></h4>
<p>For each measurement group there is a set of key dynamic attributes
representing the value of each channel in the group. They are named
&lt;channel_name _{text{i}} &gt;_Value. Special care has been taken on the management of these
attributes with distinct behavior depending on the type of channel the
attribute represents (Counter/Timer, 0D, 1D or 2D channel).</p>
</div>
<div class="section" id="counter-timer-channel-values">
<h4>Counter/Timer channel values<a class="headerlink" href="#counter-timer-channel-values" title="Permalink to this headline">¶</a></h4>
<p>A Counter/Timer Value is represented by a scalar read-only double
attribute. When the measurement group is not taking data, reading the
counter/timer value will generate calls to the controller and
therefore hardware access. When the group is taking data (master
channel is moving), the value of a counter/timer is read every 100
miliseconds and stored in the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> polling buffer. This means that a
client reading the value of the channel while the group is moving will
get the value from the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> polling buffer and will not generate exra
controller calls. It is also possible to get the value using the Tango
event system. When the group is moving, an event is sent to the
registered clients when the change event criteria is true. This is
applicable for each Counter/Timer channel in the group. By default,
this change event criterion is set to be an absolute difference in the
value of 5.0. It is tunable by attribute using the classical “abs_change “property or the pool device basis using its defaultCtGrpVal_AbsChange
property. Anyway, not more than 10 events could be sent by second.
Once the data acquisition is over, the value is made unavailable from
the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> polling buffer and is read a last time. A forced change
event is sent to clients using events.</p>
</div>
<div class="section" id="zero-d-channel-values">
<h4>Zero D channel values<a class="headerlink" href="#zero-d-channel-values" title="Permalink to this headline">¶</a></h4>
<p>A ZeroDExpChannel CumulatedValue is represented by a scalar read-only
double attribute. Usually a ZeroDChannel represents the value of a
single device (ex.: multimeter). Therefore, has hardware access cannot
be optimized for a group of devices, reading the value on the
measurement group device attribute has exactly the same behavior as
reading it directly on the CumulatedValue attribute of the
ZeroDChannel device (see
XXX: Unknown inset LatexCommand ref{par:Reading-the-ZeroDExpChannel}:
).</p>
</div>
<div class="section" id="one-d-channel-values">
<h4>One D channel values<a class="headerlink" href="#one-d-channel-values" title="Permalink to this headline">¶</a></h4>
<p>To be filled in</p>
</div>
<div class="section" id="two-d-channel-values">
<h4>Two D channel values<a class="headerlink" href="#two-d-channel-values" title="Permalink to this headline">¶</a></h4>
<p>To be filled in</p>
</div>
<div class="section" id="performance">
<h4>Performance<a class="headerlink" href="#performance" title="Permalink to this headline">¶</a></h4>
<p>Measurement group devices can often contain many channels. Client
applications often request channel values for the set (or subset) of
channels in a group. Read requests for these channel values through
the &lt;channel_name _{text{i}} &gt;_Value attributes of a measurement group should be done by clients in
groups as often as possible. This can be achieved by using the client
<a class="reference external" href="http://www.tango-controls.org/">Tango</a> API call read_attributes on a DeviceProxy object. This will
ensure maximum performance by minimizing hardware access since the
measurement group can order channel value requests per controller thus
avoiding unecessary calls to the hardware.</p>
</div>
<div class="section" id="measurement-group-configuration">
<h4>Measurement group configuration<a class="headerlink" href="#measurement-group-configuration" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="timer-monitor">
<h4>Timer/Monitor<a class="headerlink" href="#timer-monitor" title="Permalink to this headline">¶</a></h4>
<p>Measurement group operation mode can be checked/set through the
Integration_time and Integration_count (see
XXX: Unknown inset LatexCommand ref{measurement group:Checking-operation-modes}:
). Setting the Integration_time to &gt;0.0 will make the data acquisition
(initiated by the invoking the Start command) finish when the channel
defined in the Timer attribute reaches the value of Integration_time.
Setting the Integration_count to &gt;0 will make the data acquisition
(initiated by the invoking the Start command) finish when the channel
defined in the Monitor attribute reaches the value of
Integration_count.</p>
<p>In either case, the measurement group will NOT assume that the master
channel(timer/monitor) is able to stop all the other channels in the
group, so it will force a Stop on these channels as soon as it detects
that the master has finished. This is the case of the UnixTimer
channel which itself has no knowledge of the channels involved and
therefore is not able to stop them directly.</p>
<p>Integration_time, Integration_count, timer and monitor are memorized
attributes. This means that the configuration values of these
attributes are stored in the database. The next time the Pool starts
the values are restored. This is done in order to reduce Pool
configuration at startup to the minimum.</p>
</div>
<div class="section" id="the-ghost-measurement-group">
<h4>The ghost measurement group<a class="headerlink" href="#the-ghost-measurement-group" title="Permalink to this headline">¶</a></h4>
<p>In order to allow pool client software to be entirely event based,
some kind of polling has to be done on each channel to inform them on
state change which are not related to data acquisition. To achieve
this goal, one internally managed measurement group is created. Each
pool channel (counter/timer, 0D, 1D or 2D experiment channel) is a
member of this group. The <a class="reference external" href="http://www.tango-controls.org/">Tango</a> polling thread polls the state command
of this group (Polling period tunable with the pool
Ghostgroup_PollingPeriod property). The code of this group state
command detects change in every channel state and send a state change
event on the corresponding channel. This measurment group is not
available to client and is even not defined in the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> database.
This is why it is called the ghost measurement group.</p>
</div>
</div>
<div class="section" id="the-pool-serial-line-gpib-socket-interfaces">
<h3>The pool serial line, GPIB, socket interfaces<a class="headerlink" href="#the-pool-serial-line-gpib-socket-interfaces" title="Permalink to this headline">¶</a></h3>
<p>To be filled in</p>
</div>
<div class="section" id="the-pool-modbus-interface">
<h3>The pool Modbus interface<a class="headerlink" href="#the-pool-modbus-interface" title="Permalink to this headline">¶</a></h3>
<p>To be filled in</p>
</div>
</div>
<div class="section" id="id25">
<h2>Extending pool features<a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h2>
<p>To be filled in</p>
</div>
<div class="section" id="common-task-handled-by-the-pool">
<h2>Common task handled by the pool<a class="headerlink" href="#common-task-handled-by-the-pool" title="Permalink to this headline">¶</a></h2>
<div class="section" id="constraint">
<h3>Constraint<a class="headerlink" href="#constraint" title="Permalink to this headline">¶</a></h3>
<p>Two types of constraint are identified.</p>
<ol class="arabic">
<li><p>Simple constraint: This type of constraint is valid only for motor
motion. It limits motor motion. This in not the limit switches which
are a hardware protection. It’s a software limit. This type of
constraint is managed by the min_value and max_value property of the
motor Position <a class="reference external" href="http://www.tango-controls.org/">Tango</a> attribute. <a class="reference external" href="http://www.tango-controls.org/">Tango</a> core will refused to write the
attribute (Position) if outside the limits set by these min_value and
max_value attribute properties. These values are set on motor Position
attribute in physical unit.
<strong>Warning</strong> : The backlash has to be taken into account in the management of this
limit. In order to finish the motion always coming from the same
direction, sometimes the motor has to go a little bit after the wanted
position and then returns to the desired position. The limit value has
to take the backlash value into account. If the motor backlash
attribute is modified, it will also change the Position limit value.</p>
<img alt="../../_images/limit.png" src="../../_images/limit.png" />
</li>
<li><p>User constraint: This kind of constraint is given to the user to allow
him to write constraint macros which will be executed to allow or
disallow an action to be done on one object. In the pool case, the
object is a writable attribute and the action is writing the
attribute. Therefore, the following algorithm is used when writing an
attribute with constraint:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">Simple</span> <span class="n">constraint</span> <span class="nb">set</span>
   <span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">New</span> <span class="n">value</span> <span class="n">outside</span> <span class="n">limits</span>
       <span class="o">-</span> <span class="n">Throw</span> <span class="n">an</span> <span class="n">exception</span>
   <span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>
<span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>

<span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">Some</span> <span class="n">user</span> <span class="n">constraint</span> <span class="n">associated</span> <span class="n">to</span> <span class="n">this</span> <span class="n">attribute</span>
   <span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">All</span> <span class="n">the</span> <span class="n">user</span> <span class="n">constraint</span>
      <span class="o">-</span> <span class="n">Evaluate</span> <span class="n">the</span> <span class="n">constraint</span>
      <span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">The</span> <span class="n">constraint</span> <span class="n">evaluates</span> <span class="n">to</span> <span class="kc">False</span>
          <span class="o">-</span> <span class="n">Throw</span> <span class="n">an</span> <span class="n">exception</span>
      <span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>
   <span class="o">/</span><span class="n">ENDFOR</span><span class="o">/</span>
<span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>

<span class="o">-</span> <span class="n">Write</span> <span class="n">the</span> <span class="n">attribute</span>
</pre></div>
</div>
<p>The first part of this algorithm is part of the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> core. The second
part will be coded in the Pool <a class="reference external" href="http://www.tango-controls.org/">Tango</a> classes and in a first phase will
be available only for the Position attribute of the Motor class.</p>
<div class="section" id="user-constraint-implementation">
<h4>User constraint implementation<a class="headerlink" href="#user-constraint-implementation" title="Permalink to this headline">¶</a></h4>
<p>When the user creates a constraint, he has to provide to the pool the
following information:</p>
<ol class="arabic simple">
<li><p>The name of the object to which the constraint belongs. It is the name
of the writable <a class="reference external" href="http://www.tango-controls.org/">Tango</a> attribute (actually only a motor position
attribute.</p></li>
</ol>
<p>A user constraint will be written using the Python language. It has to
be a Python class with a constructor and a “Evaluate” method. This
class has to inherit from a class called PoolConstraint. This will
allow the pool software to dynamically discover that this class is a
pool constraint. The class may define the depending
attributes/devices. A depending attribute/device is an object used to
evaluate if the constraint is true or false. The depending attributes
have to be defined in a list called <strong>depending_attr_list</strong> . Each element in this list is a dictionnary with up to 2 elements
which are the description of the depending attribute and eventually a
default value. The depending devices have to be defined in a list
called <strong>depending_dev_list</strong> which follow the same syntax than the depending_attr_list. A
constraint may also have properties as defined in
XXX: Unknown inset LatexCommand ref{par:Controller-properties}:
. The constructor will receive three input arguments which are:</p>
<ol class="arabic simple">
<li><p>A list with the depending attribute name</p></li>
<li><p>A list with the depending device name</p></li>
<li><p>A dictionnary (name:value) with the properties definition</p></li>
</ol>
<p>One rule of the constructor is to build the connection with these
<a class="reference external" href="http://www.tango-controls.org/">Tango</a> objects and to keep them in the instance. The Evaluate method
will evaluate the constraint and will return true or false. It
receives as input argument a list with the result of a read_attribute
call executed on all the depending attributes.</p>
<p>Five pool device commands and two attribute allow the management of
these constraints. The commands are <strong>CreateConstraint</strong> , <strong>DeleteConstraint</strong> , <strong>EvaluateContraint, GetConstraintClassInfo</strong> and <strong>GetConstraint</strong> . The attributes are called <strong>ConstraintList</strong> and <strong>ConstraintClassList</strong> . They are all detailed in chapters
XXX: Unknown inset LatexCommand ref{sub:Device-pool-commands}:
and
XXX: Unknown inset LatexCommand ref{sub:Device-pool-attributes}:
. The following is an example of a user constraint</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="kn">import</span> <span class="nn">PyTango</span>
<span class="mi">2</span>
<span class="mi">3</span> <span class="k">class</span> <span class="nc">MyConstraint</span><span class="p">(</span><span class="n">PoolConstraint</span><span class="p">):</span>
<span class="mi">4</span>
<span class="mi">5</span>    <span class="n">depending_attr_list</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;DefaultValue&#39;</span><span class="p">:</span><span class="s2">&quot;first_mot/position&quot;</span><span class="p">,</span>
<span class="mi">6</span>                            <span class="s1">&#39;Description&#39;</span><span class="p">:</span><span class="s2">&quot;X position&quot;</span><span class="p">},</span>
<span class="mi">7</span>                           <span class="p">{</span><span class="s1">&#39;DefaultValue&#39;</span><span class="p">:</span><span class="s2">&quot;second_mot/position&quot;</span><span class="p">,</span>
<span class="mi">8</span>                            <span class="s1">&#39;Description&#39;</span><span class="p">:</span><span class="s2">&quot;Z position&quot;</span><span class="p">},</span>
<span class="mi">9</span>                           <span class="p">{</span><span class="s1">&#39;DefaultValue&#39;</span><span class="p">:</span><span class="s2">&quot;first_mot/velocity&quot;</span><span class="p">,</span>
<span class="mi">10</span>                           <span class="s1">&#39;Description&#39;</span><span class="p">:</span><span class="s2">&quot;X position speed&quot;</span><span class="p">}]</span>
<span class="mi">11</span>
<span class="mi">11</span>   <span class="n">depending_dev_list</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;DefaultValue&#39;</span><span class="p">:</span><span class="s2">&quot;first_dev&quot;</span><span class="p">,</span>
<span class="mi">12</span>                          <span class="s1">&#39;Description&#39;</span><span class="p">:</span><span class="s2">&quot;Air pressure device&quot;</span><span class="p">}]</span>
<span class="mi">13</span>
<span class="mi">14</span>   <span class="n">inst_prop</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;MyProp&#39;</span><span class="p">:{</span><span class="s1">&#39;Type&#39;</span><span class="p">:</span><span class="n">PyTango</span><span class="o">.</span><span class="n">DevLong</span><span class="p">,</span><span class="s1">&#39;Description&#39;</span><span class="p">:</span><span class="s1">&#39;The psi constant&#39;</span><span class="p">,</span>
<span class="mi">15</span>                          <span class="s1">&#39;DefaultValue&#39;</span><span class="p">,</span><span class="mi">1234</span><span class="p">}}</span>
<span class="mi">16</span>
<span class="mi">17</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attr_list</span><span class="p">,</span><span class="n">dev_list</span><span class="p">,</span><span class="n">prop_dict</span><span class="p">)</span>
<span class="mi">18</span>       <span class="bp">self</span><span class="o">.</span><span class="n">air_device</span> <span class="o">=</span> <span class="n">PyTango</span><span class="o">.</span><span class="n">DeviceProxy</span><span class="p">(</span><span class="n">dev_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="mi">19</span>       <span class="bp">self</span><span class="o">.</span><span class="n">const</span> <span class="o">=</span> <span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;MyProp&quot;</span><span class="p">]</span>
<span class="mi">20</span>
<span class="mi">21</span>   <span class="k">def</span> <span class="nf">Evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">att_value</span><span class="p">):</span>
<span class="mi">22</span>      <span class="k">if</span> <span class="n">att_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">xxx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">)</span>
<span class="mi">23</span>         <span class="k">return</span> <span class="kc">False</span>
<span class="mi">24</span>      <span class="k">elif</span> <span class="n">att_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">yyy</span>
<span class="mi">25</span>         <span class="k">return</span> <span class="kc">False</span>
<span class="mi">26</span>      <span class="k">elif</span> <span class="n">att_value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">zzz</span>
<span class="mi">27</span>         <span class="k">return</span> <span class="kc">False</span>
<span class="mi">28</span>      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">air_device</span><span class="o">.</span><span class="n">state</span><span class="p">()</span> <span class="o">==</span> <span class="n">PyTango</span><span class="o">.</span><span class="n">FAULT</span>
<span class="mi">29</span>         <span class="k">return</span> <span class="kc">False</span>
<span class="mi">30</span>      <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
<p>Line 3 : The class inherits from the PoolConstraint class
Line 5-10: Definition of the depending attributes
Line 11-12: Definition of the depending devices
Line 14-15: Definition of a constraint property
Line 17-19: The constructor
Line 21-30: The Evaluate method</p>
</div>
</div>
<div class="section" id="archiving-motor-position">
<h3>Archiving motor position<a class="headerlink" href="#archiving-motor-position" title="Permalink to this headline">¶</a></h3>
<p>XXX: Unknown inset LatexCommand label{sub:Archiving-motor-position}:</p>
<p>It is not possible to archive motor position using the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> memorized
attribute feature because <a class="reference external" href="http://www.tango-controls.org/">Tango</a> writes the attribute value into the
database just after it has been set by the user. In case of motors
which need some time to go to the desired value and which from time to
time do not go exactly to the desired value (for always possible to
have position which is a integer number of motor steps), it is more
suited to store the motor position at the end of the motion. To
achieve this, the pool has a command (called <strong>ArchieveMotorPosition</strong> ) which will store new motor positions into the database. This command
will be polled by the classical <a class="reference external" href="http://www.tango-controls.org/">Tango</a> polling thread in order to
execute it regularly. The algorithm used by this command is the
following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">Read</span> <span class="n">motors</span> <span class="n">position</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">motors</span> <span class="n">which</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">actually</span> <span class="n">moving</span>

<span class="o">-</span> <span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="nb">all</span> <span class="n">motors</span>
    <span class="o">-</span> <span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">The</span> <span class="n">new</span> <span class="n">position</span> <span class="n">just</span> <span class="n">read</span> <span class="ow">is</span> <span class="n">different</span> <span class="n">than</span> <span class="n">the</span> <span class="n">old</span> <span class="n">one</span>
       <span class="o">-</span> <span class="n">Mark</span> <span class="n">the</span> <span class="n">motor</span> <span class="k">as</span> <span class="n">storable</span>
    <span class="o">-</span> <span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>
<span class="o">-</span> <span class="o">/</span><span class="n">ENDFOR</span><span class="o">/</span>

<span class="o">-</span> <span class="n">Store</span> <span class="ow">in</span> <span class="n">DB</span> <span class="n">position</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">storable</span> <span class="n">motors</span>
<span class="o">-</span> <span class="n">Memorize</span> <span class="n">motors</span> <span class="n">position</span>
</pre></div>
</div>
<p>In order to minimize the number of calls done on the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> database,
we need to add to the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> database software the ability to store x
properties of one attribute of y devices into the database in one call
(or may be simply the same property of one attribute of several
device).</p>
</div>
<div class="section" id="scanning">
<h3>Scanning<a class="headerlink" href="#scanning" title="Permalink to this headline">¶</a></h3>
<p>To be filled in</p>
</div>
<div class="section" id="experiment-management">
<h3>Experiment management<a class="headerlink" href="#experiment-management" title="Permalink to this headline">¶</a></h3>
<p>To be filled in</p>
</div>
</div>
<div class="section" id="the-pool-device-tango-interface">
<h2>The pool device <a class="reference external" href="http://www.tango-controls.org/">Tango</a> interface<a class="headerlink" href="#the-pool-device-tango-interface" title="Permalink to this headline">¶</a></h2>
<p>The pool is implemented as a C++ <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device server and therefore
supports a set of commands/attributes. It has several attributes to
get object (motor, pseudo-motor, controller) list. These lists are
managed as attributes in order to have events on them when a new
object (motor, controller…) is created/deleted.</p>
<div class="section" id="device-pool-commands">
<h3>Device pool commands<a class="headerlink" href="#device-pool-commands" title="Permalink to this headline">¶</a></h3>
<p>XXX: Unknown inset LatexCommand label{sub:Device-pool-commands}:</p>
<p>On top of the three classical <a class="reference external" href="http://www.tango-controls.org/">Tango</a> commands (State, Status and Init),
the pool device supports the commands summarized in the following
table:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 24%" />
<col style="width: 30%" />
<col style="width: 26%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Device type</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Input data type</p></th>
<th class="head"><p>Output data type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>related</p></td>
<td><p>InitController</p></td>
<td><p>Tango::DevString</p></td>
<td><p>void</p></td>
</tr>
<tr class="row-odd"><td><p>commands</p></td>
<td><p>ReloadControllerCode
SendToController</p></td>
<td><p>Tango::DevString
Tango::DevVarStringArray</p></td>
<td><p>void
Tango::DevString</p></td>
</tr>
<tr class="row-even"><td><p>Motor</p></td>
<td><p>CreateMotor</p></td>
<td><p>Tango::DevVarLongStringArray</p></td>
<td><p>void</p></td>
</tr>
<tr class="row-odd"><td><p>related commands</p></td>
<td><p>DeleteMotor</p></td>
<td><p>Tango::DevString</p></td>
<td><p>void</p></td>
</tr>
<tr class="row-even"><td><p>Motor group</p></td>
<td><p>CreateMotorGroup</p></td>
<td><p>Tango::DevVarStringArray</p></td>
<td><p>void</p></td>
</tr>
<tr class="row-odd"><td><p>related commands</p></td>
<td><p>DeleteMotorGroup
GetPseudoMotorInfo</p></td>
<td><p>Tango::DevString
Tango::DevVarStringArray</p></td>
<td><p>void
Tango::DevVarStringArray</p></td>
</tr>
<tr class="row-even"><td><p>Pseudo motor</p></td>
<td><p>CreatePseudoMotor</p></td>
<td><p>Tango::DevVarStringArray</p></td>
<td><p>void</p></td>
</tr>
<tr class="row-odd"><td><p>related commands</p></td>
<td><p>DeletePseudoMotor
ReloadPseudoMotorCode
GetConstraintClassInfo
CreateConstraint</p></td>
<td><p>Tango::DevString
Tango::DevString
Tango::DevString
Tango::DevVarStringArray</p></td>
<td><p>void
void
Tango::DevVarStringArray
void</p></td>
</tr>
<tr class="row-even"><td><p>User Constraint</p></td>
<td><p>DeleteConstraint</p></td>
<td><p>Tango::DevString</p></td>
<td><p>void</p></td>
</tr>
<tr class="row-odd"><td><p>related</p></td>
<td><p>EvaluateConstraint</p></td>
<td><p>Tango::DevString</p></td>
<td><p>Tango::DevBoolean</p></td>
</tr>
<tr class="row-even"><td><p>commands</p></td>
<td><p>GetConstraint
ReloadConstraintCode</p></td>
<td><p>Tango::DevString
Tango::DevString</p></td>
<td><p>Tango::DevVarLongArray
void</p></td>
</tr>
<tr class="row-odd"><td><p>Experiment Channel</p></td>
<td><p>CreateExpChannel</p></td>
<td><p>Tango::DevVarStringArray</p></td>
<td><p>void</p></td>
</tr>
<tr class="row-even"><td><p>related commands</p></td>
<td><p>DeleteExpChannel</p></td>
<td><p>Tango::DevString</p></td>
<td><p>void</p></td>
</tr>
<tr class="row-odd"><td><p>Measurement group</p></td>
<td><p>CreateMeasurementGroup</p></td>
<td><p>Tango::DevVarStringArray</p></td>
<td><p>void</p></td>
</tr>
<tr class="row-even"><td><p>related commands</p></td>
<td><p>DeleteMeasurementGroup</p></td>
<td><p>Tango::DevString</p></td>
<td><p>void</p></td>
</tr>
<tr class="row-odd"><td><p>Dyn loaded Tango</p></td>
<td><p>LoadTangoClass</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>class related</p></td>
<td><p>UnloadTangoClass</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>commands</p></td>
<td><p>ReloadTangoClass</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>Dyn. created</p></td>
<td><p>CreateXXX</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>commands</p></td>
<td><p>DeleteXXX</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>Miscellaneous</p></td>
<td><p>ArchiveMotorPosition</p></td>
<td><p>void</p></td>
<td><p>void</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>CreateController</strong> : This command creates a controller object. It has four arguments (all
strings) which are:</p>
<blockquote>
<div><ol class="arabic">
<li><p>The controller device type: Actually three types are supported as
device type. They are:</p>
<blockquote>
<div><ul class="simple">
<li><p>“Motor” (case independent) for motor device</p></li>
<li><p>“CounterTimer” (case independent) for counter timer device</p></li>
<li><p>“ZeroDExpChannel” (case independent) for zero dimension experiment
channel device</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Controller code file name: For C++ controller, this is the name of the
controller shared library file. For Python controller, this is the
name of the controller module. This parameter is only a file name, not
a path. The path is automatically taken from the pool device <strong>PooPath</strong> property. It is not necessary to change your LD_LIBRARY_PATH or
PYTHONPATH environment variable. Everything is taken from the PoolPath
property.</p></li>
<li><p>Controller class name: This is the name of the class implementing the
controller. This class has to be implemented within the controller
shared library or Python module passed as previous argument</p></li>
<li><p>Instance name: It is a string which allows the device pool to deal
with several instance of the same controller class. The pool checks
that this name is uniq within a control system.</p></li>
</ol>
</div></blockquote>
</li>
</ul>
<p>The list of created controllers is kept in one of the pool device
property and at next startup time, all controllers will be
automatically re-created. If you have several pool device within a
control system (the same TANGO_HOST), it is not possible to have two
times the same controller defines on different pool device. Even if
the full controller name is &lt;Controller file name&gt;.&lt;Controller class
name&gt;/&lt;Instance name&gt;, each created controller has an associated name
which is:</p>
<blockquote>
<div><p>&lt;Instance name&gt;</p>
</div></blockquote>
<p>which has to be used when the controller name is requested. This name
is case independent.</p>
<ul>
<li><p><strong>DeleteController</strong> : This command has only one input argument which is the controller
name (as defined previously). It is not possible to delete a
controller with attached device(s). You first have to delete
controller’s device(s).</p></li>
<li><p><strong>InitController</strong> : This command is used to (re)-initialize a controller if the
controller initialization done at pool startup time has failed. At
startup time, the device pool creates controller devices even if the
controller initialization has failed. All controller devices are set
to the FAULT state. This command will try to re-create the controller
object and if successful, send an “Init” command to every controller
devices. Its input argument is the controller name.</p></li>
<li><p><strong>GetControllerInfo</strong> : This command has three or four input parameters which are:
XXX: Unknown inset LatexCommand label{ite:GetControllerInfo:}:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>The controller device type</p></li>
<li><p>The controller code file name: For C++ controller, this is the name of
the controller shared library file. For Python controller, this is the
name of the controller module. This parameter is only a file name, not
a path. The path is automatically taken from the pool device <strong>PooPath</strong> property.</p></li>
<li><p>The controller class name: This is the name of the class implementing
the controller. This class has to be implemented within the controller
shared library or Python module passed as previous argument</p></li>
<li><p>The controller instance name: This parameter is optional. If you do
not specify it, the command will return information concerning
controller properties as defined at the class level. If you defined
it, the command will return information concerning controller
properties for this specific controller instance.</p></li>
</ol>
</div></blockquote>
</li>
</ul>
<p>It returns to the caller all the informations related to controller
properties as defined in the controller code and/or in the Tango
database. The following format is used to return these informations:</p>
<ol class="arabic">
<li><p>The string describing the controller (or an empty string if not
defined)</p></li>
<li><p>Number of controller properties</p></li>
<li><p>For each property:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>The property name</p></li>
<li><p>The property data type</p></li>
<li><p>The property description</p></li>
<li><p>The property default value (Empty string if not defined)</p></li>
</ol>
</div></blockquote>
</li>
</ol>
<ul>
<li><p><strong>ReloadControllerCode</strong> : The controller code is contains in a shared library dynamically
loaded or in a Python module. The aim of this command is to unlink the
pool to the shared library and to reload it (or Reload the Python
module). The command argument is a string which is the controller file
name as defined for the CreateController command. For motor
controller, it is not possible to do this command if one of the motor
attached to controller(s) using the code within the file is actually
moving. All motor(s) attached to every controller(s) using this file
is switched to FAULT state during this command execution. Once the
code is reloaded, an “Init” command is sent to every controller
devices.</p></li>
<li><p><strong>SendToController</strong> : Send data to a controller. The first element of the input argument
array is the controller name. The second one is the string to be sent
to the controller. This command returns the controller answer or an
empty string is the controller does not have answer.</p></li>
<li><p><strong>CreateMotor</strong> : This command creates a new motor. It has three arguments which are:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>The motor name (a string). This is a <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device alias. It is not
allowed to have ‘/’ character within this name. It is a case
independent name.</p></li>
<li><p>The motor controller name (a string)</p></li>
<li><p>The axe number within the controller</p></li>
</ol>
</div></blockquote>
</li>
</ul>
<p>The motor is created as a <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device and automatically registered in
the database. At next startup time, all motors will be automatically
re-created. A <a class="reference external" href="http://www.tango-controls.org/">Tango</a> name is assigned to every motor. This name is a
<a class="reference external" href="http://www.tango-controls.org/">Tango</a> device name (3 fields) and follow the syntax:</p>
<blockquote>
<div><p>motor/controller_instance_name/axe_number</p>
</div></blockquote>
<p>in lower case letters.</p>
<ul>
<li><p><strong>DeleteMotor</strong> : This command has only one argument which is the motor name as given
in the first argument of the CreateMotor command. The device is
automatically unregistered from the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> database and is not
accessible any more even for client already connected to it.</p></li>
<li><p><strong>CreateMotorGroup</strong> : This command creates a new motor group. It has N arguments which
are:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>The motor group name (a string). This is a <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device alias. It is
not allowed to have ‘/’ character within this name. It is a case
independent name.</p></li>
<li><p>The list of motor element of the group (motor name or another group
name or pseudo-motor name)</p></li>
</ol>
</div></blockquote>
</li>
</ul>
<p>The motor group is created as a <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device and automatically
registered in the database. At next startup time, all motor groups
will be automatically re-created. A <a class="reference external" href="http://www.tango-controls.org/">Tango</a> name is assigned to every
motor group. This name is a <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device name (3 fields) and follow
the syntax:</p>
<blockquote>
<div><p>mg/ds_instance_name/motor_group_name</p>
</div></blockquote>
<p>in lower case letters.</p>
<ul>
<li><p><strong>DeleteMotorGroup</strong> : This command has only one argument which is the motor group name as
given in the first argument of the CreateMotorGroup command. The
device is automatically unregistered from the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> database and is
not accessible any more even for client already connected to it. This
command is not allowed if another motor group is using the motor group
to be deleted.</p></li>
<li><p><strong>GetPseudoMotorInfo</strong> :
XXX: Unknown inset LatexCommand label{sub:GetPseudoMotorClassInfo}:
: This command has one input argument (a string):</p>
<blockquote>
<div><p><strong>&lt;module_name&gt;.&lt;class_name&gt;</strong></p>
<p>The command returns a list of strings representing the pseudo motor
system information with the following meaning:</p>
<p>pseudo_info[0] - textual description of the pseudo motor class.</p>
<p>pseudo_info[1] - (=M) the number of motors required by this pseudo
motor class.</p>
<p>pseudo_info[2] - (=N) the number of pseudo motors that the pseudo
motor system aggregates.</p>
<p>pseudo_info[3] - the number of parameters required by the pseudo motor
system.</p>
<p>pseudo_info[4..N+4] - the textual description of the roles of the N
motors.</p>
<p>pseudo_info[N+5..N+M+5] - the textual description of the roles of the
M pseudo motors.</p>
<p>pseudo_info[N+M+6..N+M+P+6] - the textual description of the P
parameters.</p>
</div></blockquote>
</li>
</ul>
<p><strong>example</strong> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GetPseudoMotorInfo</span><span class="p">(</span><span class="s1">&#39;PseudoLib.Slit&#39;</span><span class="p">)</span>

<span class="n">could</span> <span class="n">have</span> <span class="k">as</span> <span class="n">a</span> <span class="k">return</span><span class="p">:</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s2">&quot;A Slit system for controlling gap and offset pseudo motors.&quot;</span><span class="p">,</span>
<span class="s2">&quot;2&quot;</span><span class="p">,</span>
<span class="s2">&quot;2&quot;</span><span class="p">,</span>
<span class="s2">&quot;0&quot;</span><span class="p">,</span>
<span class="s2">&quot;Motor on blade 1&quot;</span><span class="p">,</span>
<span class="s2">&quot;Motor on blade 2&quot;</span><span class="p">,</span>
<span class="s2">&quot;Gap&quot;</span><span class="p">,</span>
<span class="s2">&quot;Offset&quot;</span><span class="p">]</span>
</pre></div>
</div>
<ul>
<li><p><strong>CreatePseudoMotor</strong> :This command has a variable number of input arguments (all strings):</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>the python file which contains the pseudo motor python code.</p></li>
<li><p>the class name representing the pseudo motor system.</p></li>
<li><p>the N pseudo motor names. These will be the pseudo motor alias for the
corresponding pseudo motor tango devices.</p></li>
<li><p>the M motor names. These names are the existing tango motor alias.</p></li>
</ol>
<p>N and M must conform to the class name information. See
XXX: Unknown inset LatexCommand ref{sub:GetPseudoMotorClassInfo}:
to find how to get class information.</p>
<p>For each given pseudo motor name a <a class="reference external" href="http://www.tango-controls.org/">Tango</a> pseudo motor device is
created and automatically registered in the database. At next startup time, all pseudo motors will be automatically re-
created. A <a class="reference external" href="http://www.tango-controls.org/">Tango</a> name is assigned to every pseudo motor. This name is
a <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device name (3 fields) and follow the syntax:</p>
<blockquote>
<div><p>pm/python_module_name.class_name/pseudo_motor_name</p>
</div></blockquote>
<p>For each <a class="reference external" href="http://www.tango-controls.org/">Tango</a> pseudo motor device the device pool will also create a
corresponding alias named pseudo_motor_name.</p>
<p>If a motor group <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device with the given motor names doesn’t exist
then the device pool will also create a motor group with the following
name:</p>
<p>mg/tango_device_server_instance_name/_pm_&lt;internal motor group number&gt;</p>
<p>This motor group is built for internal Pool usage. It is not intended
that the pseudo motor is accessed directly through this motor group.
However, if needed elsewhere, it can be accessed as the usual motor
group without any special restrictions.</p>
</div></blockquote>
</li>
</ul>
<p><strong>example:</strong></p>
<p>CreatePseudoMotor(‘PseudoLib.py’,’Slit’,’gap01’,’offset01’,’blade01’,’
blade02’)</p>
<ul>
<li><p><strong>DeletePseudoMotor</strong> : This command has only one argument which is the pseudo motor
identifier. The device is automatically unregistered from the Tango
database and is not accessible any more even for client already
connected to it. This command is not allowed if a motor group is using
the pseudo motor to be deleted.</p></li>
<li><p><strong>ReloadPseudoMotorCode</strong> :The calculation code is contains in a dynamically loaded Python
module. The aim of this command is to reload the Python module. The
command argument is a string which is the python module as defined for
the CreatePseudoMotor and GetPseudoMotorInfo commands. It is not
possible to do this command if one of the motor attached to pseudo
motor system(s) using code within the file is actually moving. All
pseudo motor(s) using this file are switched to FAULT state during
this command execution.</p></li>
<li><p><strong>CreateExpChannel</strong> : This command creates a new experiment channel. It has three
arguments which are:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>The experiment channel name (a string). This is a <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device alias.
It is not allowed to have ‘/’ character within this name. It is a case
independent name.</p></li>
<li><p>The experiment channel controller name (a string)</p></li>
<li><p>The index number within the controller</p></li>
</ol>
</div></blockquote>
</li>
</ul>
<p>The experiment channel is created as a <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device and automatically
registered in the database. At next startup time, all created
experiment channels will be automatically re-created. A <a class="reference external" href="http://www.tango-controls.org/">Tango</a> name is
assigned to every experiment channel. This name is a <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device name
(3 fields) and follow the syntax:</p>
<blockquote>
<div><p>expchan/controller_instance_name/index_number</p>
</div></blockquote>
<p>in lower case letters. The precise type of the experiment channel
(Counter/Timer, ZeroD, OneD…) is retrieved by the pool device from
the controller given as command second parameter.</p>
<ul>
<li><p><strong>DeleteExpChannel</strong> : This command has only one argument which is the experiment channel
name as given in the first argument of the CreateExpChannel command.
The device is automatically unregistered from the <a class="reference external" href="http://www.tango-controls.org/">Tango</a> database and
is not accessible any more even for client already connected to it.</p></li>
<li><p><strong>GetConstraintClassInfo</strong> : This command has one input parameter (a string) which is the
constraint class name. It returns to the caller all the information
related to constraint dependencies and to constraint properties as
defined in the constraint code. The following format is used to return
properties:</p>
<blockquote>
<div><ul>
<li><p>Depending attributes number</p>
<blockquote>
<div><ul class="simple">
<li><p>Depending attribute name</p></li>
<li><p>Depending attribute description</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Depending devices number</p>
<blockquote>
<div><ul class="simple">
<li><p>Depending device name</p></li>
<li><p>Depending device description</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Class property number</p>
<blockquote>
<div><ul class="simple">
<li><p>Class property name</p></li>
<li><p>Class property description</p></li>
<li><p>Class property default value (Set to “NotDef” if not defined)</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Instance property number</p>
<blockquote>
<div><ul class="simple">
<li><p>Instance property name</p></li>
<li><p>Instance property description</p></li>
<li><p>Instance property default value (Set to “NotDef” if not defined)</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
<li><p><strong>CreateMeasurementGroup</strong> : This command creates a new measurement group. It has N arguments
which are:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>The measurement group name (a string). This is a <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device alias.
It is not allowed to have ‘/’ character within this name. It is a case
independent name.</p></li>
<li><p>The list of channel elements of the group (Counter/Timer, 0D, 1D or 2D
experiment channel)</p></li>
</ol>
</div></blockquote>
</li>
</ul>
<p>The measurement group is created as a <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device and automatically
registered in the database. At next startup time, all measurement
groups will be automatically re-created. A <a class="reference external" href="http://www.tango-controls.org/">Tango</a> name is assigned to
every measurement group. This name is a <a class="reference external" href="http://www.tango-controls.org/">Tango</a> device name (3 fields)
and follow the syntax:</p>
<blockquote>
<div><p>mntgrp/ds_instance_name/measurement_group_name</p>
</div></blockquote>
<p>in lower case letters.</p>
<ul>
<li><p><strong>DeleteMeasurementGroup</strong> : This command has only one argument which is the measurement group
name as given in the first argument of the CreateMeasurementGroup
command. The device is automatically unregistered from the Tango
database and is not accessible any more even for client already
connected to it.</p></li>
<li><p><strong>AddConstraint</strong> : This command creates a user constraint object. It has several
arguments (all strings) which are:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Constraint code file name: The name of the constraint module. This
parameter is only a file name, not a path. The path is automatically
taken from the pool PooPath property.</p></li>
<li><p>Constraint class name: This is the name of the class implementing the
controller. This class has to be implemented within the controller
shared library or Python module passed as previous argument</p></li>
<li><p>Instance name: It is a string which allows the device pool to deal
with several instance of the same controller class.</p></li>
<li><p>The object to which the constraint belongs. It has to be a writable
attribute name (actually only a motor position)</p></li>
<li><p>The list of depending objects. (Variable length list which may be
empty)</p></li>
</ol>
</div></blockquote>
</li>
</ul>
<p>The list of created constraints is kept in one of the pool device
property and at next startup time, all constraints will be
automatically re-created. It is possible to create several constraint
on the same object. They will be executed in the order of their
creation. Each created constraint has a associated name which is:</p>
<blockquote>
<div><p>&lt;Constraint class name&gt;/&lt;Instance name&gt;</p>
</div></blockquote>
<ul class="simple">
<li><p><strong>DeleteConstraint</strong> : This command has only one argument which is the constraint name as
define previously.</p></li>
<li><p><strong>EvaluateConstraint</strong> : This command has only one argument which is the constraint name. It
runs the “evaluate” method of the constraint and sends the return
value to the caller</p></li>
<li><p><strong>GetConstraint</strong> : The input parameter of this command is the name of a <a class="reference external" href="http://www.tango-controls.org/">Tango</a> object.
Actually, it has to be the name of one of the motor Position
attribute. The command returns the list of Constraint ID attached to
this object.</p></li>
<li><p><strong>ReloadConstraintCode</strong> : The constraint code is contains in a Python module. The aim of this
command is to reload the Python module. The command argument is a
string which is the constraint file name as defined for
theAddConstraint command. All object(s) using this constraint are
switched to FAULT state during this command execution.</p></li>
<li><p><strong>LoadTangoClass</strong> :</p></li>
<li><p><strong>UnloadTangoClass</strong> :</p></li>
<li><p><strong>ReloadTangoClass</strong> :</p></li>
<li><p><strong>CreateXXX</strong> :</p></li>
<li><p><strong>DeleteXXX:</strong></p></li>
<li><p><strong>ArchiveMotorPosition</strong> : Send new motor(s) position to the database. This command will be
polled with a default polling period of 10 seconds.</p></li>
</ul>
<p>The classical <a class="reference external" href="http://www.tango-controls.org/">Tango</a> <strong>Init</strong> command destroys all constructed controller(s) and re-create them
reloading their code. Then, it sends an “Init” command to every
controlled objects (motor, pseudo-motor and motor group) belonging to
the pool device. Motor(s) are switched to FAULT state when controller
are destroyed.</p>
<p>The pool device knows only two states which are ON and ALARM. The pool
device is in ALARM state if one of its controller failed during its
initialization phase. It is in ON state when all controllers are
correctly constructed. In case the pool device in in ALARM state, its
status indicates which controller is faulty.</p>
</div>
<div class="section" id="device-pool-attributes">
<h3>Device pool attributes<a class="headerlink" href="#device-pool-attributes" title="Permalink to this headline">¶</a></h3>
<p>XXX: Unknown inset LatexCommand label{sub:Device-pool-attributes}:</p>
<p>The device pool supports the following attributes:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 36%" />
<col style="width: 30%" />
<col style="width: 20%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Data type</p></th>
<th class="head"><p>Data format</p></th>
<th class="head"><p>Writable</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ControllerList</p></td>
<td><p>Tango::DevString</p></td>
<td><p>Spectrum</p></td>
<td><p>R</p></td>
</tr>
<tr class="row-odd"><td><p>ControllerClassList</p></td>
<td><p>Tango::DevString</p></td>
<td><p>Spectrum</p></td>
<td><p>R</p></td>
</tr>
<tr class="row-even"><td><p>MotorList</p></td>
<td><p>Tango::DevString</p></td>
<td><p>Spectrum</p></td>
<td><p>R</p></td>
</tr>
<tr class="row-odd"><td><p>MotorGroupList</p></td>
<td><p>Tango::DevString</p></td>
<td><p>Spectrum</p></td>
<td><p>R</p></td>
</tr>
<tr class="row-even"><td><p>PseudoMotorList</p></td>
<td><p>Tango::DevString</p></td>
<td><p>Spectrum</p></td>
<td><p>R</p></td>
</tr>
<tr class="row-odd"><td><p>PseudoMotorClassList</p></td>
<td><p>Tango::DevString</p></td>
<td><p>Spectrum</p></td>
<td><p>R</p></td>
</tr>
<tr class="row-even"><td><p>ExpChannelList</p></td>
<td><p>Tango::DevString</p></td>
<td><p>Spectrum</p></td>
<td><p>R</p></td>
</tr>
<tr class="row-odd"><td><p>MeasurementGroupList</p></td>
<td><p>Tango::DevString</p></td>
<td><p>Spectrum</p></td>
<td><p>R</p></td>
</tr>
<tr class="row-even"><td><p>ConstraintList</p></td>
<td><p>Tango::DevString</p></td>
<td><p>Spectrum</p></td>
<td><p>R</p></td>
</tr>
<tr class="row-odd"><td><p>ConstraintClassList</p></td>
<td><p>Tango::DevString</p></td>
<td><p>Spectrum</p></td>
<td><p>R</p></td>
</tr>
<tr class="row-even"><td><p>SimulationMode</p></td>
<td><p>Tango::DevBoolean</p></td>
<td><p>Scalar</p></td>
<td><p>R/W</p></td>
</tr>
<tr class="row-odd"><td><p>XXXList</p></td>
<td><p>Tango::DevString</p></td>
<td><p>Spectrum</p></td>
<td><p>R</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>ControllerList</strong> : This is a read only spectrum string attribute. Each spectrum element
is the name of one controller following the syntax:</p>
<blockquote>
<div><p>&lt;instance_name&gt; - &lt;Ctrl file&gt;.&lt;controller_class_name/instance_name&gt; -
&lt;Device type&gt; &lt;Controller language&gt; Ctrl (&lt;Ctrl file&gt;)</p>
</div></blockquote>
</li>
<li><p><strong>ControllerClassList</strong> : This is a read only spectrum string attribute. Each spectrum element
is the name of one of the available controller class that the user can
create. To build this list, the pool device server is using a property
called <strong>PoolPath</strong> which defines the path where all files containing controller code
should be (Python and C++ controllers). The syntax used for this
PoolPath property is similar to the syntax used for Unix PATH
environment variable (list of absolute path separated by the “:”
character). Each returned string has the following syntax:</p>
<blockquote>
<div><p>Type: &lt;Ctrl dev type&gt; - Class: &lt;Ctrl class name&gt; - File: &lt;Abs ctrl
file path&gt;</p>
</div></blockquote>
</li>
<li><p><strong>MotorList</strong> : This is a read only spectrum string attribute. Each spectrum element
is the name of one motor known by this pool. The syntax is:</p>
<blockquote>
<div><p>&lt;Motor name&gt; (&lt;Motor tango name&gt;)</p>
</div></blockquote>
</li>
<li><p><strong>MotorGroupList</strong> : This is a read only spectrum string attribute. Each spectrum element
is the name of one motor group known by this pool. The syntax is:</p>
<blockquote>
<div><p>&lt;Motor group name&gt; (&lt;Motor group tango name&gt;) Motor list: &lt;List of
group members&gt; (&lt;List of physical motors in the group&gt;)</p>
</div></blockquote>
<p>The last information is displayed only if the physical group structure
differs from the logical one (pseudo-motor or other group used as
group member)</p>
</li>
<li><p><strong>PseudoMotorList</strong> :This is a read only spectrum string attribute. Each spectrum element
is the name of one motor known by this pool. The syntax is:</p>
<blockquote>
<div><p>&lt;pseudo motor name&gt; (&lt;pseudo motor tango name&gt;) Motor List: &lt;motor
name&gt;1,…,&lt;motor name&gt;M</p>
</div></blockquote>
</li>
<li><p><strong>ExpChannelList</strong> : This is a read only spectrum string attribute. Each spectrum element
is the name of one experiment channel known by this pool. The syntax
is:</p>
<p>&lt;Exp Channel name&gt; (&lt;Channel tango name&gt;) &lt;Experiment channel type&gt;</p>
<p>The string describing the experiment channel type may be:</p>
<blockquote>
<div><ul class="simple">
<li><p>Counter/Timer Experiment Channel</p></li>
<li><p>Zero D Experiment Channel</p></li>
</ul>
</div></blockquote>
</li>
<li><p><strong>MeasurementGroupList</strong> : This is a read only spectrum string attribute. Each spectrum element
is the name of one measurement group known by the pool. The syntax is:</p>
<blockquote>
<div><p>&lt;Measurement group name&gt; (&lt;Measurement group tango name&gt;) Experiment
Channel list: &lt;List of group members&gt;</p>
</div></blockquote>
</li>
<li><p><strong>PseudoMotorClassList</strong> :This is a read only spectrum string attribute. Each spectrum element
is the name of a valid Pseudo python system class. The syntax is:</p>
<blockquote>
<div><p>&lt;python module name&gt;.&lt;python class name&gt;</p>
</div></blockquote>
<p>. The python files to be found depend on the current value of the pool
path. See
XXX: Unknown inset LatexCommand ref{sub:PoolPath}:</p>
</li>
<li><p><strong>ConstraintClassList</strong> : This is a read only spectrum string attribute. Each spectrum element
is the name of one of the available constraint class that the user can
create. To build this list, the pool device server is using a property
called <strong>PoolPath</strong> which defines the path where all files containing constraint code
should be. The syntax used for this property is similar to the syntax
used for Unix PATH environment variable (list of absolute path
separated by the “:” character). To find constraint classes, the pool
will look into all Python files (those with a .py suffix) for classes
definition which inherit from a base class called <strong>PoolConstraint</strong> .</p></li>
<li><p><strong>ConstraintList</strong> : This is a read only spectrum string attribute. each spectrum element
is one of the constraint actually registered in the pool. The syntax
of each string is:</p>
<blockquote>
<div><p>&lt;Constraint class name/instance name&gt; - &lt;associated to&gt; - &lt;depending
on attribute(s) - &lt;depending on device(s)&gt;</p>
</div></blockquote>
</li>
<li><p><strong>SimulationMode</strong> : This is a read-write scalar boolean attribute. If set to true, all
the pool device(s) are switched to Simulation mode. This means that
all commands received by pool device(s) will not be forwarded to the
associated controllers.</p></li>
<li><p><strong>XXXList</strong> :</p></li>
</ul>
</div>
<div class="section" id="device-pool-property">
<h3>Device pool property<a class="headerlink" href="#device-pool-property" title="Permalink to this headline">¶</a></h3>
<p>The pool device supports the following property:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 47%" />
<col style="width: 31%" />
<col style="width: 22%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Property name</p></th>
<th class="head"><p>Property data type</p></th>
<th class="head"><p>Default value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>PoolPath</p></td>
<td><p>String</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>DefaultMotPos_AbsChange</p></td>
<td><p>Double</p></td>
<td><p>5</p></td>
</tr>
<tr class="row-even"><td><p>DefaultMotGrpPos_AbsChange</p></td>
<td><p>Double</p></td>
<td><p>5</p></td>
</tr>
<tr class="row-odd"><td><p>DefaultCtVal_AbsChange</p></td>
<td><p>Double</p></td>
<td><p>5</p></td>
</tr>
<tr class="row-even"><td><p>DefaultZeroDVal_AbsChange</p></td>
<td><p>Double</p></td>
<td><p>5</p></td>
</tr>
<tr class="row-odd"><td><p>DefaultCtGrpVal_AbsChange</p></td>
<td><p>Double</p></td>
<td><p>5</p></td>
</tr>
<tr class="row-even"><td><p>DefaultZeroDGrpVal_AbsChange</p></td>
<td><p>Double</p></td>
<td><p>5</p></td>
</tr>
<tr class="row-odd"><td><p>GhostGroup_PollingPeriod</p></td>
<td><p>String</p></td>
<td><p>5000</p></td>
</tr>
<tr class="row-even"><td><p>MotThreadLoop_SleepTime</p></td>
<td><p>Long</p></td>
<td><p>10</p></td>
</tr>
<tr class="row-odd"><td><p>NbStatePerRead</p></td>
<td><p>Long</p></td>
<td><p>10</p></td>
</tr>
<tr class="row-even"><td><p>ZeroDNbReadPerEvent</p></td>
<td><p>Long</p></td>
<td><p>5</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p><strong>PoolPath</strong> :
XXX: Unknown inset LatexCommand label{sub:PoolPath}:
The path (same syntax than the Unix PATH environment variable) where
the pool software is able to locate Controller software, Pseudo-motor
software or Constraint software for both Python or C++ languages</p></li>
<li><p><strong>DefaultMotPos_AbsChange</strong> : The default value used to trigger change event when the position
attribute is changing (the associated motor is moving). This property
has a hard-coded default value set to 5</p></li>
<li><p><strong>DefaultMotGrpPos_AbsChange</strong> : The default value used to trigger change event when the group device
position attribute is changing. This property has a hard-coded default
value set to 5</p></li>
<li><p><strong>DefaultCtVal_AbsChange</strong> : The default value used to trigger change event when the
counter/timer attribute is changing (the counter is counting or the
timer is timing). This property has a hard-coded default value set to
5</p></li>
<li><p><strong>DefaultZeroDVal_AbsChange</strong> : The default value used to trigger change event when the Zero
Dimension Experiment Channel is acquiring data. This property has a
hard-coded default value set to 5</p></li>
<li><p><strong>DefaultCtGrpVal_AbsChange</strong> : The default value used to trigger change event when the
counter/timer attribute(s) of a measurement group is(are) changing
(the counter is counting or the timer is timing). This property has a
hard-coded default value set to 5</p></li>
<li><p><strong>DefaultZeroDGrpVal_AbsChange</strong> : The default value used to trigger change event when the Zero
Dimension Experiment Channel(s) of a measurement group is(are)
acquiring data. This property has a hard-coded default value set to 5</p></li>
<li><p><strong>GhostGroup_PollingPeriod</strong> : The ghost motor/measurement group polling period in mS. This
property has a default value of 5000 (5 sec)</p></li>
<li><p><strong>MotThreadLoop_SleepTime</strong> : The time (in mS) during which the motion thread will sleep between
two consecutive motor state request. The default value is 10</p></li>
<li><p><strong>NbStatePerRead</strong> : The number of motor state request between each position attribute
reading done by the motion thread. The default value is 10. This means
that during a motion, the motor position is read by the thread every
100 mS (10 * 10)</p></li>
<li><p><strong>ZeroDNbReadPerEvent</strong> : The number of times the Zero D Experiment Channel value is read by
the acquisition thread between firing a change event. The event will
be effectively fired to the interested clients according to the
CumulatedValue attribute “Absolute Change” property value.</p></li>
<li><p><strong>Controller</strong> : An internally managed property which allow the pool device to
remember which controller has been created.</p></li>
</ul>
</div>
</div>
<div class="section" id="creating-device">
<h2>Creating device<a class="headerlink" href="#creating-device" title="Permalink to this headline">¶</a></h2>
<p>This chapter gives details on what has to be done to create device
using the device pool in order to check the work to be done by a
Sardana configuration tool.</p>
<div class="section" id="creating-motor">
<h3>Creating motor<a class="headerlink" href="#creating-motor" title="Permalink to this headline">¶</a></h3>
<p>The following is the action list which has to be done when you want to
create a new motor:</p>
<ol class="arabic">
<li><p>Display the list of all the controller the pool already has.</p></li>
<li><p>Select one of this controller</p></li>
<li><p>If the user selects a new controller</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Read the attribute ControllerClassList to get the list of Controller
installed in your system</p></li>
<li><p>Select one of the controller class</p></li>
<li><p>With the GetControllerInfo command, get the list of controller
properties</p></li>
<li><p>Give a controller instance name</p></li>
<li><p>Display and eventually change the controller properties (if any)</p></li>
<li><p>Create the controller object using the CreateController pool command</p></li>
</ol>
</div></blockquote>
</li>
<li><p>Give a motor name and a motor axis number in the selected controller</p></li>
<li><p>Create the motor with the CreateMotor pool command</p></li>
<li><p>Read the attribute list of the newly created motor</p></li>
<li><p>Display and eventually change the motor attributes related to motor
features and eventually to extra-features</p></li>
</ol>
</div>
<div class="section" id="creating-motor-group">
<h3>Creating motor group<a class="headerlink" href="#creating-motor-group" title="Permalink to this headline">¶</a></h3>
<p>The following is the action list which has to be done when creating a
motor group</p>
<ol class="arabic simple">
<li><p>Give a name to the motor group</p></li>
<li><p>Display the list of all registered motors (attribute MotorList), all
registered motor groups (attribute MotorGroupList), all registered
pseudo motors (attribute PseudoMotorList) and select those which have
to be member of the group.</p></li>
<li><p>Create the group (command CreateMotorGroup)</p></li>
</ol>
</div>
<div class="section" id="creating-a-pseudo-motor-system">
<h3>Creating a pseudo motor system<a class="headerlink" href="#creating-a-pseudo-motor-system" title="Permalink to this headline">¶</a></h3>
<p>The following is the action list which has to be done when you want to
create a new pseudo motor:</p>
<ol class="arabic">
<li><p>Display the list of all available pseudo motor system classes and
select one of them</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>if there is no proper pseudo system class write one in Python</p></li>
<li><p>update the PoolPath Pool property if necessary</p></li>
</ol>
</div></blockquote>
</li>
<li><p>Get the selected pseudo motor system class information</p></li>
<li><p>Give names to the pseudo motors involved in the selected pseudo motor
system</p></li>
<li><p>Create the motor(s) which are involved (if they have are not created
yet: See
XXX: Unknown inset LatexCommand ref{sub:Creating-motor}:
) and assign the coresponding roles</p></li>
<li><p>Create the pseudo motor system (command CreatePseudoMotor)</p></li>
</ol>
</div>
<div class="section" id="creating-a-user-constraint">
<h3>Creating a user constraint<a class="headerlink" href="#creating-a-user-constraint" title="Permalink to this headline">¶</a></h3>
<p>The following is the action list which has to be done when you want to
create a new user constraint:</p>
<ol class="arabic">
<li><p>Display the list of all the constraint the pool already has.</p></li>
<li><p>Select one of this constraint</p></li>
<li><p>If the user selects a new constraint</p>
<blockquote>
<div><ol class="arabic">
<li><p>Read the attribute ConstraintClassList to get the list of Constraint
installed in your system</p></li>
<li><p>Select one of the constraint class</p></li>
<li><p>With the GetConstraintClassInfo command, get the list of constraint
dependencies and properties</p></li>
<li><p>Give a constraint instance name</p></li>
<li><p>If it is the first constraint of this class</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Display and eventually change the constraint class properties (if any)</p></li>
</ol>
</div></blockquote>
</li>
</ol>
</div></blockquote>
</li>
<li><p>Display and eventually change the constraint depending attribute (if
any)</p></li>
<li><p>Display and eventually change the constraint depending device (if any)</p></li>
<li><p>Display and eventually change the constraint instance properties (if
any)</p></li>
<li><p>Create the constraint object using the CreateConstraint pool command</p></li>
</ol>
</div>
</div>
<div class="section" id="some-words-on-internal-implementation">
<h2>Some words on internal implementation<a class="headerlink" href="#some-words-on-internal-implementation" title="Permalink to this headline">¶</a></h2>
<p>This chapter gives some details on some part of the pool
implementation in order to clarify reader ideas</p>
<div class="section" id="moving-motor">
<h3>Moving motor<a class="headerlink" href="#moving-motor" title="Permalink to this headline">¶</a></h3>
<p>Moving a motor means writing its Position attribute. In Tango, it is
already splitted in two actions which are:</p>
<ol class="arabic simple">
<li><p>Call a Motor class method called “is_allowed”</p></li>
<li><p>Call a Motor class method called “write_Position”</p></li>
</ol>
<p>The second method will be executed only if the first one returns true.
The move order is sent to the motor (via the controller) in the code
of the second method.</p>
<div class="section" id="the-is-allowed-method">
<h4>The is_allowed method<a class="headerlink" href="#the-is-allowed-method" title="Permalink to this headline">¶</a></h4>
<p>The code implemented in this method follow the algorithm:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">There</span> <span class="n">are</span> <span class="nb">any</span> <span class="n">Pseudo</span> <span class="n">Motor</span> <span class="n">using</span> <span class="n">the</span> <span class="n">motor</span>
   <span class="o">-</span> <span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">All</span> <span class="n">these</span> <span class="n">Pseudo</span> <span class="n">Motors</span>
      <span class="o">-</span> <span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">They</span> <span class="n">have</span> <span class="n">some</span> <span class="n">limits</span> <span class="n">defined</span>
         <span class="o">-</span> <span class="n">Compute</span> <span class="n">new</span> <span class="n">Pseudo</span> <span class="n">Motor</span> <span class="n">position</span> <span class="k">if</span> <span class="n">motor</span> <span class="n">moved</span> <span class="n">to</span> <span class="n">the</span> <span class="n">desired</span> <span class="n">value</span>
         <span class="o">-</span> <span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">The</span> <span class="n">computed</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">outside</span> <span class="n">the</span> <span class="n">authorized</span> <span class="n">window</span>
             <span class="o">-</span> <span class="n">Return</span> <span class="kc">False</span>
         <span class="o">-</span> <span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>
      <span class="o">-</span> <span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>
   <span class="o">-</span> <span class="o">/</span><span class="n">ENDFOR</span><span class="o">/</span>
<span class="o">-</span> <span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>

<span class="o">-</span> <span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">There</span> <span class="n">are</span> <span class="n">some</span> <span class="n">user</span> <span class="n">constraint</span> <span class="n">attached</span> <span class="n">to</span> <span class="n">the</span> <span class="n">motor</span>
  <span class="o">-</span> <span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">user</span> <span class="n">constraint</span>
      <span class="o">-</span> <span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">The</span> <span class="n">constraint</span> <span class="n">has</span> <span class="n">some</span> <span class="n">depending</span> <span class="n">attribute</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
         <span class="o">-</span> <span class="n">Read</span> <span class="n">these</span> <span class="n">attributes</span>
      <span class="o">-</span> <span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>
      <span class="o">-</span> <span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">If</span> <span class="n">the</span> <span class="n">execution</span> <span class="n">of</span> <span class="n">the</span> <span class="n">contraint</span> <span class="s2">&quot;Evaluate&quot;</span> <span class="n">method</span> <span class="n">returns</span> <span class="kc">False</span>
         <span class="o">-</span> <span class="n">Return</span> <span class="kc">False</span>
      <span class="o">-</span> <span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>
  <span class="o">-</span> <span class="o">/</span><span class="n">ENDFOR</span><span class="o">/</span>
<span class="o">-</span> <span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>

<span class="o">-</span> <span class="n">Return</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<div class="section" id="the-write-position-method">
<h4>The write_Position method<a class="headerlink" href="#the-write-position-method" title="Permalink to this headline">¶</a></h4>
<p>The code implemented in this method follows the algorithm:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">Compute</span> <span class="n">the</span> <span class="n">dial</span> <span class="n">position</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">user</span> <span class="n">position</span>
<span class="o">-</span> <span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">A</span> <span class="n">backlash</span> <span class="ow">is</span> <span class="n">defined</span> <span class="k">for</span> <span class="n">this</span> <span class="n">motor</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">controller</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">manage</span> <span class="n">it</span>
    <span class="o">-</span> <span class="n">Update</span> <span class="n">motor</span> <span class="n">desired</span> <span class="n">position</span> <span class="n">according</span> <span class="n">to</span> <span class="n">motion</span> <span class="n">direction</span> <span class="ow">and</span> <span class="n">backlash</span> <span class="n">value</span>
<span class="o">-</span> <span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>
<span class="o">-</span> <span class="n">Start</span> <span class="n">a</span> <span class="n">thread</span> <span class="n">sending</span> <span class="n">it</span> <span class="n">which</span> <span class="n">motor</span> <span class="n">has</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span> <span class="n">which</span> <span class="n">position</span>
<span class="o">-</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">thread</span> <span class="n">acknowledge</span>
<span class="o">-</span> <span class="n">Return</span> <span class="n">to</span> <span class="n">caller</span>
</pre></div>
</div>
<p>The motion thread will execute the following algorithm:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">motion</span>
     <span class="o">-</span> <span class="n">Lock</span> <span class="n">the</span> <span class="n">controller</span> <span class="nb">object</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">PreStartAll</span><span class="p">()</span>
<span class="o">-</span> <span class="o">/</span><span class="n">ENDFOR</span><span class="o">/</span>

<span class="o">-</span> <span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">motor</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">motion</span>
     <span class="o">-</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">PreStartOne</span><span class="p">(</span><span class="n">motor</span> <span class="n">to</span> <span class="n">move</span><span class="p">,</span> <span class="n">new</span> <span class="n">position</span><span class="p">)</span>
     <span class="o">-</span> <span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">ret</span> <span class="ow">is</span> <span class="n">true</span>
          <span class="o">-</span> <span class="n">Call</span> <span class="n">StartOne</span><span class="p">(</span><span class="n">motor</span> <span class="n">to</span> <span class="n">move</span><span class="p">,</span> <span class="n">new</span> <span class="n">position</span><span class="p">)</span>
     <span class="o">-</span> <span class="o">/</span><span class="n">ELSE</span><span class="o">/</span>
          <span class="o">-</span> <span class="n">Inform</span> <span class="n">write_Position</span> <span class="n">that</span> <span class="n">an</span> <span class="n">error</span> <span class="n">occurs</span>
          <span class="o">-</span> <span class="n">Send</span> <span class="n">acknowledge</span> <span class="n">to</span> <span class="n">write_Position</span> <span class="n">method</span>
     <span class="o">-</span> <span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>
<span class="o">-</span> <span class="o">/</span><span class="n">ENDFOR</span><span class="o">/</span>

<span class="o">-</span> <span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">motor</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">motion</span>
     <span class="o">-</span> <span class="n">Set</span> <span class="n">motor</span> <span class="n">state</span> <span class="n">to</span> <span class="n">MOVING</span> <span class="ow">and</span> <span class="n">send</span> <span class="n">a</span> <span class="n">Tango_</span> <span class="n">event</span> <span class="n">to</span> <span class="n">the</span> <span class="n">requesting</span> <span class="n">client</span>
<span class="o">-</span> <span class="o">/</span><span class="n">ENDFOR</span><span class="o">/</span>

<span class="o">-</span> <span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">motion</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">StartAll</span><span class="p">()</span>
     <span class="o">-</span> <span class="n">Unlock</span> <span class="n">the</span> <span class="n">controller</span> <span class="nb">object</span>
<span class="o">-</span> <span class="o">/</span><span class="n">ENDFOR</span><span class="o">/</span>

<span class="o">-</span> <span class="n">Send</span> <span class="n">acknowledge</span> <span class="n">to</span> <span class="n">the</span> <span class="n">write_Position</span> <span class="n">method</span>

<span class="o">-</span> <span class="o">/</span><span class="n">WHILE</span><span class="o">/</span> <span class="n">One</span> <span class="n">of</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">state</span> <span class="ow">is</span> <span class="n">MOVING</span> <span class="p">(</span><span class="n">From</span> <span class="n">controller</span><span class="p">)</span>
     <span class="o">-</span> <span class="n">Sleep</span> <span class="k">for</span> <span class="mi">10</span> <span class="n">mS</span>

     <span class="o">-</span> <span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">One</span> <span class="n">of</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">motion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">moving</span> <span class="nb">any</span> <span class="n">more</span>
        <span class="o">-</span> <span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">This</span> <span class="n">motor</span> <span class="n">has</span> <span class="n">backlash</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">motion</span> <span class="ow">is</span> <span class="ow">in</span> <span class="n">the</span> <span class="s2">&quot;wrong&quot;</span> <span class="n">direction</span>
            <span class="o">-</span> <span class="n">Ask</span> <span class="k">for</span> <span class="n">a</span> <span class="n">backlash</span> <span class="n">motion</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">other</span> <span class="n">direction</span>
              <span class="p">(</span><span class="n">Easy</span> <span class="n">to</span> <span class="n">write</span><span class="p">,</span> <span class="ow">not</span> <span class="k">as</span> <span class="n">easy</span> <span class="n">to</span> <span class="n">do</span><span class="o">...</span><span class="p">)</span>
        <span class="o">-</span> <span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>
        <span class="o">-</span> <span class="n">Send</span> <span class="n">a</span> <span class="n">Tango_</span> <span class="n">event</span> <span class="n">on</span> <span class="n">the</span> <span class="n">state</span> <span class="n">attribute</span> <span class="n">to</span> <span class="n">the</span> <span class="n">requesting</span> <span class="n">client</span>
        <span class="o">-</span> <span class="n">Leave</span> <span class="n">the</span> <span class="n">loop</span>
     <span class="o">-</span> <span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>

     <span class="o">-</span> <span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">time</span> <span class="n">to</span> <span class="n">read</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">position</span>
        <span class="o">-</span> <span class="n">Read</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">position</span>
        <span class="o">-</span> <span class="n">Send</span> <span class="n">a</span> <span class="n">change</span> <span class="n">event</span> <span class="n">on</span> <span class="n">the</span> <span class="n">Position</span> <span class="n">attribute</span> <span class="n">to</span> <span class="n">the</span> <span class="n">requested</span> <span class="n">client</span> <span class="k">if</span>
          <span class="n">the</span> <span class="n">change</span> <span class="n">event</span> <span class="n">criterion</span> <span class="ow">is</span> <span class="n">true</span>
     <span class="o">-</span> <span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>
<span class="o">-</span> <span class="o">/</span><span class="n">ENDWHILE</span><span class="o">/</span>

<span class="o">-</span> <span class="n">Sleep</span> <span class="k">for</span> <span class="n">the</span> <span class="n">time</span> <span class="n">defined</span> <span class="n">by</span> <span class="n">the</span> <span class="n">motor</span> <span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="n">Sleep_bef_last_read</span> <span class="nb">property</span>
<span class="o">-</span> <span class="n">Read</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">position</span>
<span class="o">-</span> <span class="n">Send</span> <span class="n">a</span> <span class="n">forced</span> <span class="n">change</span> <span class="n">event</span> <span class="n">on</span> <span class="n">the</span> <span class="n">Position</span> <span class="n">attribute</span> <span class="n">to</span> <span class="n">the</span> <span class="n">requesting</span> <span class="n">client</span>
  <span class="k">with</span> <span class="n">the</span> <span class="n">value</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">the</span> <span class="n">one</span> <span class="n">just</span> <span class="n">read</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="data-acquisition">
<h3>Data acquisition<a class="headerlink" href="#data-acquisition" title="Permalink to this headline">¶</a></h3>
<p>Data aquisition is triggered by invoking a Start command on the
measurement group. The code implemented implements the following
algorithm.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="ow">in</span> <span class="n">timer</span> <span class="n">mode</span>
    <span class="o">-</span> <span class="n">Write</span> <span class="n">CumulationTime</span> <span class="n">on</span> <span class="nb">all</span> <span class="mi">0</span><span class="n">D</span> <span class="n">channels</span> <span class="k">with</span> <span class="n">Integration_time</span> <span class="n">value</span>
<span class="o">/</span><span class="n">ELIF</span><span class="o">/</span> <span class="ow">in</span> <span class="n">monitor</span> <span class="n">mode</span>
    <span class="o">-</span> <span class="n">Write</span> <span class="n">CumulationTime</span> <span class="n">on</span> <span class="nb">all</span> <span class="mi">0</span><span class="n">D</span> <span class="n">channels</span> <span class="k">with</span> <span class="mi">0</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span> <span class="n">value</span>
<span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="mi">0</span><span class="n">D</span> <span class="n">channel</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">data</span> <span class="n">aquisition</span>
    <span class="o">-</span> <span class="n">Load</span> <span class="n">configuration</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">-</span> <span class="n">Start</span> <span class="n">a</span> <span class="n">CounterTimer</span> <span class="n">thread</span> <span class="k">with</span> <span class="n">channels</span> <span class="n">involved</span><span class="p">,</span> <span class="n">master</span> <span class="n">channel</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">proper</span> <span class="n">value</span> <span class="n">to</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">on</span> <span class="n">it</span>
<span class="o">-</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">CounterTimer</span> <span class="n">thread</span> <span class="n">acknowledge</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="mi">0</span><span class="n">D</span> <span class="n">channel</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">data</span> <span class="n">aquisition</span>
    <span class="o">-</span> <span class="n">Send</span> <span class="n">Start</span> <span class="n">command</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">-</span> <span class="n">Return</span> <span class="n">to</span> <span class="n">caller</span>
</pre></div>
</div>
<p>The Counter/Timer thread will execute the following algorithm:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">Calculate</span> <span class="n">the</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">controllers</span> <span class="n">involved</span> <span class="ow">and</span> <span class="n">determine</span> <span class="n">which</span> <span class="n">controller</span> <span class="n">has</span> <span class="n">the</span> <span class="n">master</span> <span class="n">channel</span>
<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">channel</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">data</span> <span class="n">aquisition</span>
    <span class="o">-</span> <span class="n">Lock</span> <span class="n">the</span> <span class="n">channel</span> <span class="nb">object</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">data</span> <span class="n">acquisition</span>
    <span class="o">-</span> <span class="n">Lock</span> <span class="n">the</span> <span class="n">controller</span> <span class="nb">object</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">channel</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">data</span> <span class="n">acquisition</span>
    <span class="o">-</span> <span class="n">Load</span> <span class="n">configuration</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">-</span> <span class="n">Load</span> <span class="n">the</span> <span class="n">master</span> <span class="n">channel</span> <span class="o">-</span> <span class="n">timer</span><span class="p">(</span><span class="n">monitor</span><span class="p">)</span> <span class="o">-</span> <span class="k">with</span> <span class="n">the</span> <span class="n">integration</span> <span class="n">time</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">data</span> <span class="n">acquisition</span>
    <span class="o">-</span> <span class="n">Call</span> <span class="n">PreStartAllCT</span><span class="p">()</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">channel</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="k">except</span> <span class="k">for</span> <span class="n">the</span> <span class="n">master</span> <span class="n">channel</span><span class="p">,</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">data</span> <span class="n">acquisition</span><span class="p">,</span>
    <span class="o">-</span> <span class="n">Call</span> <span class="n">PreStartOneCT</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
    <span class="o">-</span> <span class="n">Call</span> <span class="n">StartOneCT</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">data</span> <span class="n">aquisition</span>
    <span class="o">-</span> <span class="n">Call</span> <span class="n">StartAllCT</span><span class="p">()</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">-</span> <span class="n">Call</span> <span class="n">PreStartAllCT</span><span class="p">()</span> <span class="n">on</span> <span class="n">the</span> <span class="n">controller</span> <span class="n">which</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">master</span> <span class="n">channel</span>
<span class="o">-</span> <span class="n">Call</span> <span class="n">PreStartOneCT</span><span class="p">(</span><span class="n">master</span> <span class="n">channel</span><span class="p">)</span>
<span class="o">-</span> <span class="n">Call</span> <span class="n">StartOneCT</span><span class="p">(</span><span class="n">master</span> <span class="n">channel</span><span class="p">)</span>
<span class="o">-</span> <span class="n">Call</span> <span class="n">StartAllCT</span><span class="p">()</span> <span class="n">on</span> <span class="n">the</span> <span class="n">controller</span> <span class="n">which</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">master</span> <span class="n">channel</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">data</span> <span class="n">aquisition</span>
    <span class="o">-</span> <span class="n">Unlock</span> <span class="n">the</span> <span class="n">controller</span> <span class="nb">object</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">channel</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">data</span> <span class="n">aquisition</span>
    <span class="o">-</span> <span class="n">Unlock</span> <span class="n">the</span> <span class="n">channel</span> <span class="nb">object</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">-</span> <span class="n">Send</span> <span class="n">acknowledge</span> <span class="n">to</span> <span class="n">the</span> <span class="n">Start</span> <span class="n">method</span>

<span class="o">/</span><span class="n">WHILE</span><span class="o">/</span> <span class="n">master</span> <span class="n">channel</span> <span class="n">state</span> <span class="ow">is</span> <span class="n">MOVING</span> <span class="p">(</span><span class="n">From</span> <span class="n">controller</span><span class="p">)</span>
     <span class="o">-</span> <span class="n">Sleep</span> <span class="k">for</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">sleepTime</span> <span class="n">mS</span>

     <span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">If</span> <span class="n">master</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">moving</span> <span class="nb">any</span> <span class="n">more</span>
        <span class="o">-</span> <span class="n">Stop</span> <span class="nb">all</span> <span class="n">channels</span>
        <span class="o">-</span> <span class="n">Send</span> <span class="n">a</span> <span class="n">Tango</span> <span class="n">event</span> <span class="n">on</span> <span class="n">the</span> <span class="n">state</span> <span class="n">attribute</span> <span class="n">to</span> <span class="n">the</span> <span class="n">requesting</span> <span class="n">client</span>
        <span class="o">-</span> <span class="n">Leave</span> <span class="n">the</span> <span class="n">loop</span>
     <span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>

     <span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">time</span> <span class="n">to</span> <span class="n">read</span> <span class="n">the</span> <span class="n">channel</span> <span class="n">values</span>
        <span class="o">-</span> <span class="n">Read</span> <span class="n">the</span> <span class="n">channel</span> <span class="n">values</span>
        <span class="o">-</span> <span class="n">Send</span> <span class="n">a</span> <span class="n">change</span> <span class="n">event</span> <span class="n">on</span> <span class="n">each</span> <span class="n">value</span> <span class="n">attribute</span> <span class="n">to</span> <span class="n">the</span> <span class="n">requested</span> <span class="n">client</span> <span class="k">if</span>
          <span class="n">the</span> <span class="n">change</span> <span class="n">event</span> <span class="n">criterion</span> <span class="ow">is</span> <span class="n">true</span>
     <span class="o">/</span><span class="n">ENDIF</span><span class="o">/</span>
<span class="o">/</span><span class="n">ENDWHILE</span><span class="o">/</span>

<span class="o">-</span> <span class="n">Read</span> <span class="n">the</span> <span class="n">channel</span> <span class="n">values</span>
<span class="o">-</span> <span class="n">Send</span> <span class="n">a</span> <span class="n">forced</span> <span class="n">change</span> <span class="n">event</span> <span class="n">on</span> <span class="n">each</span> <span class="n">value</span> <span class="n">attribute</span> <span class="n">to</span> <span class="n">the</span> <span class="n">requesting</span> <span class="n">client</span>
  <span class="k">with</span> <span class="n">the</span> <span class="n">value</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">the</span> <span class="n">one</span> <span class="n">just</span> <span class="n">read</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Except where otherwise noted, content on this site is
licensed under a Creative Commons Attribution 3.0 License

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>