

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Writing macros &mdash; sardana 3.0.2-alpha documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="sardana 3.0.2-alpha documentation" href="../../index.html"/>
        <link rel="up" title="Writing macros" href="index.html"/>
        <link rel="next" title="Scan Framework" href="scan_framework.html"/>
        <link rel="prev" title="Writing macros" href="index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> sardana
          

          
            
            <img src="../../_static/logo.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference external" href="http://www.sardana-controls.org">Home Page</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/sardana-org/sardana">Project Page</a></li>
<li class="toctree-l1"><a class="reference external" href="http://pypi.python.org/pypi/sardana">Download from PyPI</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../docs.html">Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../users/index.html">User&#8217;s Guide</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Developer&#8217;s Guide</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../overview/index.html">Overview</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Writing macros</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">General macro development</a></li>
<li class="toctree-l4"><a class="reference internal" href="scan_framework.html">Scan macro development</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../howto_controllers/index.html">Writing controllers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../howto_recorders.html">Writing recorders</a></li>
<li class="toctree-l3"><a class="reference internal" href="../howto_test/index.html">Sardana Testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/api_sardana.html">API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide_migration.html">Migration guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/examples.html">Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide_coding.html">Development guidelines</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../sep/index.html">Sardana Enhancement Proposals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_versions.html">Docs for other Sardana versions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana-plugins">Plugins Catalogue</a></li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana/wiki">Wiki</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">sardana</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../docs.html">Sardana 3.0 Documentation</a> &raquo;</li>
      
          <li><a href="../index.html">Developer&#8217;s Guide</a> &raquo;</li>
      
          <li><a href="index.html">Writing macros</a> &raquo;</li>
      
    <li>Writing macros</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/devel/howto_macros/macros_general.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="writing-macros">
<span id="sardana-macros-howto"></span><h1>Writing macros<a class="headerlink" href="#writing-macros" title="Permalink to this headline">¶</a></h1>
<p>This chapter provides the necessary information to write macros in sardana. The
complete macro <a class="reference internal" href="../../glossary.html#term-api"><span class="xref std std-term">API</span></a> can be found <a class="reference internal" href="../api/api_macro.html#sardana-macro-api"><span class="std std-ref">here</span></a>.</p>
<div class="section" id="what-is-a-macro">
<h2>What is a macro<a class="headerlink" href="#what-is-a-macro" title="Permalink to this headline">¶</a></h2>
<p>A macro in sardana describes a specific procedure that can be executed at any
time. Macros run inside the <em>sardana sandbox</em>. This simply means that each time
you run a macro, the system makes sure the necessary environment for it to run
safely is ready.</p>
<p>Macros can only be written in <a class="reference external" href="http://www.python.org/">Python</a>. A macro can be a <a class="reference internal" href="../../glossary.html#term-function"><span class="xref std std-term">function</span></a> or a
<a class="reference internal" href="../../glossary.html#term-class"><span class="xref std std-term">class</span></a>. In order for a <a class="reference internal" href="../../glossary.html#term-function"><span class="xref std std-term">function</span></a> to be recognized as a macro, it
<strong>must</strong> be properly <em>labeled</em> as a macro (this is done with a special
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.macro" title="sardana.macroserver.macro.macro"><code class="xref py py-class docutils literal"><span class="pre">macro</span></code></a> <em>decorator</em>. Details are explaind below). In the same way, for a
<a class="reference internal" href="../../glossary.html#term-class"><span class="xref std std-term">class</span></a> to be recognized as a macro, it must inherit from a
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro" title="sardana.macroserver.macro.Macro"><code class="xref py py-class docutils literal"><span class="pre">Macro</span></code></a> super-class. Macros are case sensitive. This means that
<em>helloworld</em> is a different macro than <em>HelloWorld</em>.</p>
<p>The choice between writing a macro <a class="reference internal" href="../../glossary.html#term-function"><span class="xref std std-term">function</span></a> or a macro <a class="reference internal" href="../../glossary.html#term-class"><span class="xref std std-term">class</span></a>
depends not only on the type of procedure you want to write, but also (and
probably, most importantly) on the type of programming you are most confortable
with.</p>
<p>If you are a scientist, and you have a programming background on a functional
language (like fortran, matlab, <a class="reference external" href="http://www.certif.com/">SPEC</a>), then you might prefer to write macro
functions. Computer scientists (young ones, specially), on the other hand,
often have a background on object oriented languages (Java, C++, C#) and feel
more confortable writing macro classes.</p>
<p>Classes tend to scale better with the size of a program or library. By writing
a macro class you can benefit from all advantages of object-oriented
programming. This means that, in theory:</p>
<blockquote>
<div><ul class="simple">
<li>it would reduce the amount of code you need to write</li>
<li>reduce the complexity of your code by dividing it into small,
reasonably independent and re-usable components, that talk to each other
using only well-defined interfaces</li>
<li>Improvement of productivity by using easily adaptable pre-defined
software components</li>
</ul>
</div></blockquote>
<p>In practice, however, and specially if you don&#8217;t come from a programming
background, writing classes requires a different way of thinking. It will also
require you to extend your knowledge in terms of syntax of a programming
language.</p>
<p>Furthermore, most tasks you will probably need to execute as macros, often don&#8217;t
fit the class paradigm that object-oriented languages offer. If you are
writing a sequencial procedure to run an experiment then you are probably
better of writing a python function which does the job plain and simple.</p>
<p>One reason to write a macro as a class is if, for example, you want to extend
the behaviour of the <a class="reference internal" href="../api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.mv" title="sardana.macroserver.macros.standard.mv"><code class="xref py py-class docutils literal"><span class="pre">mv</span></code></a> macro. In
this case, probably you would want to <em>extend</em> the existing macro by writing
your own macro class which <em>inherits</em> from the original macro and this way
benefit from most of the functionallity already existing in the original macro.</p>
</div>
<div class="section" id="what-should-and-should-not-be-a-macro">
<h2>What should and should not be a macro<a class="headerlink" href="#what-should-and-should-not-be-a-macro" title="Permalink to this headline">¶</a></h2>
<p>The idea of a macro is simply a piece of <a class="reference external" href="http://www.python.org/">Python</a> code that can be executed from
control system interface (<a class="reference internal" href="../../glossary.html#term-gui"><span class="xref std std-term">GUI</span></a>/<a class="reference internal" href="../../glossary.html#term-cli"><span class="xref std std-term">CLI</span></a>). Therefore, anything that
you don&#8217;t need to be executed by the interface should <strong>NOT</strong> be a macro.</p>
<p>When you have a big library of functions and classes, the approach to expose
them to sardana should be to first carefully decide which procedures should be
invoked by a <a class="reference internal" href="../../glossary.html#term-gui"><span class="xref std std-term">GUI</span></a>/<a class="reference internal" href="../../glossary.html#term-cli"><span class="xref std std-term">CLI</span></a> (namely the name of the procedure, which
parameters it should receive and if it returns any value). Then write the
macro(s) which invoke the code of the original library (see <a class="reference internal" href="#sardana-macro-using-external-libraries"><span class="std std-ref">Using
external python libraries</span></a>).
Avoid the temptation to convert the functions/classes of the original library
into macros because:</p>
<blockquote>
<div><ul class="simple">
<li>This will most certainly break your code (any code that calls a function
or class that has been converted to a macro will fail)</li>
<li>It will excessively polute the macro list (imagine a <a class="reference internal" href="../../glossary.html#term-gui"><span class="xref std std-term">GUI</span></a> with a
combo box to select which macro to execute. If you have hundreds of macros
it will take forever to find the one to execute even if they are in
alphabetical order)</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="how-to-start-writing-a-macro">
<h2>How to start writing a macro<a class="headerlink" href="#how-to-start-writing-a-macro" title="Permalink to this headline">¶</a></h2>
<p>Since macros are essencially <a class="reference external" href="http://www.python.org/">Python</a> code, they reside inside a <a class="reference external" href="http://www.python.org/">Python</a> file. In
sardana, we call a <a class="reference external" href="http://www.python.org/">Python</a> file which contains macros a <em>macro library</em>.</p>
<p>At the time of writing, the easiest way to create a new macro is from spock (we
are currently working on a macro editor <a class="reference internal" href="../../glossary.html#term-gui"><span class="xref std std-term">GUI</span></a>).</p>
<div class="section" id="preparing-your-text-editor">
<h3>Preparing your text editor<a class="headerlink" href="#preparing-your-text-editor" title="Permalink to this headline">¶</a></h3>
<p>Before launching spock it is important to decide which text editor you will use
to write your macros. Unless configured otherwise, spock will use the editor
specified by the system environment variable <span class="target" id="index-0"></span><code class="xref std std-envvar docutils literal"><span class="pre">EDITOR</span></code>. If this variable
is not set, it will default to vi under Linux/Unix and to notepad under
Windows. The following line explains how to set the <span class="target" id="index-1"></span><code class="xref std std-envvar docutils literal"><span class="pre">EDITOR</span></code>
environment variable to gedit under linux using bash shell:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">export</span> <span class="nv">EDITOR</span><span class="o">=</span>gedit
</pre></div>
</div>
<p>If you choose <em>gedit</em> it is important to properly configure it to write <a class="reference external" href="http://www.python.org/">Python</a>
code:</p>
<blockquote>
<div><p>Go to <span class="menuselection">Edit ‣ Preferences ‣ Editor</span> and select:</p>
<blockquote>
<div><ul class="simple">
<li><em>Tab width</em> : 4</li>
<li><em>Insert spaces instead of tabs</em></li>
</ul>
</div></blockquote>
<img alt="../../_images/gedit_config.png" src="../../_images/gedit_config.png" />
</div></blockquote>
<p>If you choose <em>kwrite</em> it is important to properly configure it to write <a class="reference external" href="http://www.python.org/">Python</a>
code:</p>
<blockquote>
<div><p>Go to <span class="menuselection">Settings ‣ Configure editor...</span> and choose
<em>Editing</em>:</p>
<blockquote>
<div><ul class="simple">
<li><dl class="first docutils">
<dt>In <em>General</em> tab:</dt>
<dd><ul class="first last">
<li><em>Tab width</em> : 4</li>
<li><em>Insert spaces instead of tabulators</em></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>In <em>Indentation</em> tab:</dt>
<dd><ul class="first last">
<li><em>Default indentation mode</em> : Python</li>
<li><em>Indentation width</em> : 4</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<img alt="../../_images/kwrite_config.png" src="../../_images/kwrite_config.png" />
</div></blockquote>
<p>Now you are ready to start writing your macro! Type <em>spock</em> on the command
line. Once you are in spock, you can use the
<code class="xref py py-class docutils literal"><span class="pre">edmac</span></code> to create/edit macros. Let&#8217;s
say you want to create a new macro called <em>hello_world</em> in a new macro library
called <em>salute</em>. Just type in:</p>
<div class="highlight-spock"><div class="highlight"><pre><span></span><span class="gp">LAB-01-D01 [1]: </span><span class="n">edmac</span> <span class="n">hello_world</span> <span class="n">salute</span>
<span class="go">Opening salute.hello_world...</span>
<span class="go">Editing...</span>
</pre></div>
</div>
<p>This will bring your favorite editor to life with a macro function template
code for the macro <em>hello_world</em>.</p>
<blockquote>
<div><img alt="../../_images/macro_edit.png" src="../../_images/macro_edit.png" />
</div></blockquote>
<p>The next chapter will explain how to fill this template with useful code. After
you finish editing the macro, save the file, exit the editor and go back to
spock. You&#8217;ll be asked if you want the new code to be load on the server. Just
answer &#8216;y&#8217;.</p>
<div class="highlight-spock"><div class="highlight"><pre><span></span><span class="gp">LAB-01-D01 [1]: </span><span class="n">edmac</span> <span class="n">hello_world</span> <span class="n">salute</span>
<span class="go">Openning salute.hello_world...</span>
<span class="go">Editing...</span>
<span class="go">Do you want to apply the new code on the server? [y] y</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="writing-a-macro-function">
<span id="macro-function-writing"></span><h2>Writing a macro function<a class="headerlink" href="#writing-a-macro-function" title="Permalink to this headline">¶</a></h2>
<p>As mentioned before, macros are just simple <a class="reference external" href="http://www.python.org/">Python</a> functions which have been
<em>labeled</em> as macros. In <a class="reference external" href="http://www.python.org/">Python</a>, these labels are called <em>decorators</em>. Here is
the macro function version of <em>Hello, World!</em>:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sardana.macroserver.macro</span> <span class="kn">import</span> <span class="n">macro</span>

<span class="nd">@macro</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is a hello world macro&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;Hello, World!&quot;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<dl class="docutils">
<dt><strong>line 1</strong></dt>
<dd>imports the <em>macro</em> symbol from the sardana macro package.
<code class="xref py py-mod docutils literal"><span class="pre">sardana.macroserver.macro</span></code> is the package which contains most symbols
you will require from sardana to write your macros.</dd>
<dt><strong>line 3</strong></dt>
<dd>this line <em>decorates</em> de following function as a macro. It is
<strong>crucial</strong> to use this decorator in order for your <a class="reference internal" href="../../glossary.html#term-function"><span class="xref std std-term">function</span></a> to be
recognized by sardana as a valid macro.</dd>
<dt><strong>line 4</strong></dt>
<dd>this line contains the hello_world <a class="reference internal" href="../../glossary.html#term-function"><span class="xref std std-term">function</span></a> definition. Every
macro needs <strong>at least</strong> one parameter. The first parameter is the macro
execution context. It is usually called <code class="docutils literal"><span class="pre">self</span></code> but you can name it
anything. This parameter gives you access to the entire context where the
macro is being run. Through it, you&#8217;ll be able to do all sorts of things,
from sending text to the output to ask for motors or even execute other
macros.</dd>
<dt><strong>line 5</strong></dt>
<dd>Documentation for this macro. You should <strong>always</strong> document your macro!</dd>
<dt><strong>line 6</strong></dt>
<dd>this line will print <em>Hello, World!</em> on your screen.</dd>
</dl>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If you already know a little about <a class="reference external" href="http://www.python.org/">Python</a> your are probably wondering why
not use <code class="docutils literal"><span class="pre">print(&quot;Hello,</span> <span class="pre">World!&quot;)</span></code>?</p>
<p>Remember that your macro will be executed by a Sardana server which may be
running in a different computer than the computer you are working on.
Executing a <em>normal print</em> would just print the text in the server.
Therefore you need to explicitly say you want the text on the computer you
are working and not the server. The way to do it is using
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.output" title="sardana.macroserver.macro.Macro.output"><code class="xref py py-meth docutils literal"><span class="pre">output()</span></code></a> instead of print.</p>
<p>If you prefer, you can use the context version of <a class="reference external" href="http://www.python.org/">Python</a> <a class="reference external" href="https://docs.python.org/dev/library/functions.html#print" title="(in Python v3.9)"><code class="xref py py-func docutils literal"><span class="pre">print()</span></code></a>
function (it is a bit more powerful than
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.output" title="sardana.macroserver.macro.Macro.output"><code class="xref py py-meth docutils literal"><span class="pre">output()</span></code></a>, and has a slightly
different syntax)</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sardana.macroserver.macro</span> <span class="kn">import</span> <span class="n">macro</span>

<span class="nd">@macro</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is an hello world macro&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;Hello, World!&quot;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p class="last">The following footnote describes how to discover your <a class="reference external" href="http://www.python.org/">Python</a>
version <a class="footnote-reference" href="#f2" id="id1">[2]</a>.</p>
</div>
<p>Remeber that a macro is, for all purposes, a normal <a class="reference external" href="http://www.python.org/">Python</a> <a class="reference internal" href="../../glossary.html#term-function"><span class="xref std std-term">function</span></a>.
This means you <strong>CAN</strong> inside a macro write <strong>ANY</strong> valid <a class="reference external" href="http://www.python.org/">Python</a> code. This
includes <a class="reference external" href="https://docs.python.org/dev/reference/compound_stmts.html#for" title="(in Python v3.9)"><code class="xref std std-keyword docutils literal"><span class="pre">for</span></code></a> and <a class="reference external" href="https://docs.python.org/dev/reference/compound_stmts.html#while" title="(in Python v3.9)"><code class="xref std std-keyword docutils literal"><span class="pre">while</span></code></a> loops, <a class="reference external" href="https://docs.python.org/dev/reference/compound_stmts.html#if" title="(in Python v3.9)"><code class="xref std std-keyword docutils literal"><span class="pre">if</span></code></a> ...
<a class="reference external" href="https://docs.python.org/dev/reference/compound_stmts.html#elif" title="(in Python v3.9)"><code class="xref std std-keyword docutils literal"><span class="pre">elif</span></code></a> ... <a class="reference external" href="https://docs.python.org/dev/reference/compound_stmts.html#else" title="(in Python v3.9)"><code class="xref std std-keyword docutils literal"><span class="pre">else</span></code></a> conditional execution, etc...</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy.fft</span>

<span class="nd">@macro</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">fft_my_wave</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">wave_device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDevice</span><span class="p">(</span><span class="s2">&quot;sys/tg_test/1&quot;</span><span class="p">)</span>
    <span class="n">wave</span> <span class="o">=</span> <span class="n">wave_device</span><span class="o">.</span><span class="n">wave</span>
    <span class="n">wave_fft</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">wave</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="adding-parameters-to-your-macro">
<h2>Adding parameters to your macro<a class="headerlink" href="#adding-parameters-to-your-macro" title="Permalink to this headline">¶</a></h2>
<p>Standard <a class="reference external" href="http://www.python.org/">Python</a> allows you to specify parameters to a function by placing comma
separated parameter names between the <code class="docutils literal"><span class="pre">()</span></code> in the function definition. The
macro <a class="reference internal" href="../../glossary.html#term-api"><span class="xref std std-term">API</span></a>, in adition, enforces you to specify some extra parameter
information. At first, this may look like a useless complication, but you will
apreciate clear benefits soon enough. Here are some of them:</p>
<blockquote>
<div><ul class="simple">
<li>error prevention: a macro will not be allowed to run if the given
parameter if of a wrong type</li>
<li><a class="reference internal" href="../../glossary.html#term-cli"><span class="xref std std-term">CLI</span></a>s like Spock will be able to offer autocomplete
facilities (press &lt;tab&gt; and list of allowed parameters show up)</li>
<li><a class="reference internal" href="../../glossary.html#term-gui"><span class="xref std std-term">GUI</span></a>s can display list of allowed parameter values in combo
boxes which gives increased usability and prevents errors</li>
<li>Documentation can be generated automatically</li>
</ul>
</div></blockquote>
<p>So, here is an example on how to define a macro that needs one parameter:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@macro</span><span class="p">([[</span><span class="s2">&quot;moveable&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;moveable to get position&quot;</span><span class="p">]])</span>
<span class="k">def</span> <span class="nf">where_moveable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moveable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This macro prints the current moveable position&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is now at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">moveable</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="n">moveable</span><span class="o">.</span><span class="n">getPosition</span><span class="p">())</span>
</pre></div>
</div>
<p>Here is another example on how to define a macro that needs two parameters:</p>
<blockquote>
<div><ul class="simple">
<li>Moveable (motor, pseudo motor)</li>
<li>Float (motor absolute position to go to)</li>
</ul>
</div></blockquote>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sardana.macroserver.macro</span> <span class="kn">import</span> <span class="n">macro</span><span class="p">,</span> <span class="n">Type</span>

<span class="nd">@macro</span><span class="p">([</span> <span class="p">[</span><span class="s2">&quot;moveable&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;moveable to move&quot;</span><span class="p">],</span>
         <span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;absolute position&quot;</span><span class="p">]</span> <span class="p">])</span>
<span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moveable</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This macro moves a moveable to the specified position&quot;&quot;&quot;</span>
    <span class="n">moveable</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is now at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">moveable</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="n">moveable</span><span class="o">.</span><span class="n">getPosition</span><span class="p">())</span>
</pre></div>
</td></tr></table></div>
<p>The parameter information is a <a class="reference external" href="https://docs.python.org/dev/library/stdtypes.html#list" title="(in Python v3.9)"><code class="xref py py-obj docutils literal"><span class="pre">list</span></code></a> of <a class="reference external" href="https://docs.python.org/dev/library/stdtypes.html#list" title="(in Python v3.9)"><code class="xref py py-obj docutils literal"><span class="pre">list</span></code></a>s. Each <a class="reference external" href="https://docs.python.org/dev/library/stdtypes.html#list" title="(in Python v3.9)"><code class="xref py py-obj docutils literal"><span class="pre">list</span></code></a>
being a composed of four elements:</p>
<blockquote>
<div><ul class="simple">
<li>parameter name</li>
<li>parameter type</li>
<li><dl class="first docutils">
<dt>parameter default value:</dt>
<dd><ul class="first last">
<li><code class="docutils literal"><span class="pre">None</span></code> means no default value</li>
<li><code class="docutils literal"><span class="pre">Optional</span></code> means that
<a class="reference internal" href="#sardana-macro-optional-parameters"><span class="std std-ref">the parameter value is optional</span></a></li>
</ul>
</dd>
</dl>
</li>
<li>parameter description</li>
</ul>
</div></blockquote>
<p>Here is a list of the most common allowed parameter types:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">Integer</span></code>: an integer number</li>
<li><code class="docutils literal"><span class="pre">Float</span></code>: a real number</li>
<li><code class="docutils literal"><span class="pre">Boolean</span></code>: a boolean True or False</li>
<li><code class="docutils literal"><span class="pre">String</span></code>: a string</li>
<li><code class="docutils literal"><span class="pre">Moveable</span></code>: a moveable element (motor, pseudo-motor)</li>
<li><code class="docutils literal"><span class="pre">Motor</span></code>: a pure motor</li>
<li><code class="docutils literal"><span class="pre">ExpChannel</span></code>: an experimental channel (counter/timer, 0D,
pseudo-counter, ...)</li>
<li><code class="docutils literal"><span class="pre">Controller</span></code>: a controller</li>
<li><code class="docutils literal"><span class="pre">ControllerClass</span></code>: an existing controller class plugin</li>
<li><code class="docutils literal"><span class="pre">MacroCode</span></code>: a macro</li>
<li><code class="docutils literal"><span class="pre">MeasurementGroup</span></code>: a measurement group</li>
<li><code class="docutils literal"><span class="pre">Any</span></code>: anything, really</li>
</ul>
</div></blockquote>
<p>The complete list of types distributed with sardana is made up by these five
simple types: <code class="docutils literal"><span class="pre">Integer</span></code>, <code class="docutils literal"><span class="pre">Float</span></code>, <code class="docutils literal"><span class="pre">Boolean</span></code>, <code class="docutils literal"><span class="pre">String</span></code>, <code class="docutils literal"><span class="pre">Any</span></code>, plus
all available sardana interfaces (<a class="reference internal" href="../api/sardana/sardanadefs.html#sardana.sardanadefs.Interface" title="sardana.sardanadefs.Interface"><code class="xref py py-obj docutils literal"><span class="pre">Interface</span></code></a>)</p>
<div class="section" id="optional-parameters">
<span id="sardana-macro-optional-parameters"></span><h3>Optional parameters<a class="headerlink" href="#optional-parameters" title="Permalink to this headline">¶</a></h3>
<p>A special parameter default value is the <code class="docutils literal"><span class="pre">Optional</span></code> keyword. A parameter
whose default value is set to <code class="docutils literal"><span class="pre">Optional</span></code> behaves just as one with a default
value, except that if the user does not provide a value explicitly, the
handling of its value is deferred to the run method (which gets <code class="docutils literal"><span class="pre">None</span></code> as
the parameter value). This allows for more complex handling of the value
(e.g. interactive prompting to the user, system introspection, reading from
files, etc.)</p>
<p>So, here is an example how to define and use the optional parameter:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sardana.macroserver.macro</span> <span class="kn">import</span> <span class="n">Macro</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">class</span> <span class="nc">count</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;itime&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;integration time&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;mntgrp&#39;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">MeasurementGroup</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="s1">&#39;MntGrp to use&#39;</span><span class="p">]</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itime</span><span class="p">,</span> <span class="n">mntgrp</span><span class="p">):</span>
        <span class="n">bkp_active_mntgrp</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mntgrp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">bkp_active_mntgrp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;ActiveMntGrp&#39;</span><span class="p">)</span>
                <span class="n">mntgrp_name</span> <span class="o">=</span> <span class="n">mntgrp</span><span class="o">.</span><span class="n">name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setEnv</span><span class="p">(</span><span class="s1">&#39;ActiveMntGrp&#39;</span><span class="p">,</span> <span class="n">mntgrp_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Use &quot;{0}&quot; measurement group&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mntgrp_name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ct</span><span class="p">(</span><span class="n">itime</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bkp_active_mntgrp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setEnv</span><span class="p">(</span><span class="s1">&#39;ActiveMntGrp&#39;</span><span class="p">,</span> <span class="n">bkp_active_mntgrp</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="repeat-parameters">
<span id="sardana-macro-repeat-parameters"></span><h3>Repeat parameters<a class="headerlink" href="#repeat-parameters" title="Permalink to this headline">¶</a></h3>
<p>A special parameter type is the repeat parameter (a.k.a. <em>ParamRepeat</em>,
originating from the <code class="docutils literal"><span class="pre">ParamRepeat</span></code> class which usage is deprecated).
The repeat parameter type is a list of parameter members. It is possible to
pass from zero to multiple repetitions of the repeat parameter items at the
execution time.</p>
<p>The repeat parameter definition allows to:</p>
<blockquote>
<div><ul class="simple">
<li>restrict the minimum and/or maximum number of repetitions</li>
<li>nest repeat parameters inside of another repeat parameters</li>
<li>define multiple repeat parameters in the same macro</li>
</ul>
</div></blockquote>
<p>Repeat parameter values are passed to the macro function in the form of a list.
If the repeat parameter definition contains just one member it is a plain list
of items.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@macro</span><span class="p">([[</span><span class="s2">&quot;moveables&quot;</span><span class="p">,</span> <span class="p">[</span>
             <span class="p">[</span><span class="s2">&quot;moveable&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;moveable to get position&quot;</span><span class="p">]</span>
             <span class="p">],</span>
             <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;list of moveables to get positions&quot;</span><span class="p">]])</span>
<span class="k">def</span> <span class="nf">where_moveables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moveables</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This macro prints the current moveables positions&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">moveable</span> <span class="ow">in</span> <span class="n">moveables</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is now at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">moveable</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="n">moveable</span><span class="o">.</span><span class="n">getPosition</span><span class="p">())</span>
</pre></div>
</td></tr></table></div>
<p>But if the repeat parameter definition contains more than one member
each item is an internal list of the members.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@macro</span><span class="p">([[</span><span class="s2">&quot;m_p_pairs&quot;</span><span class="p">,</span> <span class="p">[</span>
             <span class="p">[</span><span class="s2">&quot;moveable&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;moveable to be moved&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;absolute position&quot;</span><span class="p">]</span>
             <span class="p">],</span>
             <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;list of moveables and positions to be moved to&quot;</span><span class="p">]])</span>
<span class="k">def</span> <span class="nf">move_multiple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m_p_pairs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This macro moves moveables to the specified positions&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">moveable</span><span class="p">,</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">m_p_pairs</span><span class="p">:</span>
        <span class="n">moveable</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is now at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">moveable</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="n">moveable</span><span class="o">.</span><span class="n">getPosition</span><span class="p">())</span>
</pre></div>
</td></tr></table></div>
<p>A set of macro parameter examples can be found
<a class="reference internal" href="../examples/macro_parameter_examples.html#sardana-devel-macro-parameter-examples"><span class="std std-ref">here</span></a>.</p>
</div>
</div>
<div class="section" id="returning-a-macro-result">
<span id="sardana-macro-result"></span><h2>Returning a macro result<a class="headerlink" href="#returning-a-macro-result" title="Permalink to this headline">¶</a></h2>
<p>A macro can produce one or more results to be returned.
The macro <a class="reference internal" href="../../glossary.html#term-api"><span class="xref std std-term">API</span></a> enforces to specify certain information about
these result values.
Here&#8217;s an example of how to define and return the results:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">twice</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A macro that returns its input and twice its input.&quot;&quot;&quot;</span>

  <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="s2">&quot;value to be doubled&quot;</span> <span class="p">]</span> <span class="p">]</span>
  <span class="n">result_def</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="s2">&quot;input_value&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;the input value&quot;</span> <span class="p">],</span>
  <span class="p">[</span> <span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;the double of the given value&quot;</span> <span class="p">]</span> <span class="p">]</span>

  <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
      <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span>
      <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">ret</span>
</pre></div>
</td></tr></table></div>
<p>If a macro with a result is called from another macro the results can be
retrieved as shown in this example:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">get_result</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Different ways of getting the result of a macro&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

      <span class="n">mymacro</span><span class="p">,</span> <span class="n">pars</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createMacro</span><span class="p">(</span><span class="s2">&quot;twice 1&quot;</span><span class="p">)</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runMacro</span><span class="p">(</span><span class="n">mymacro</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execMacro</span><span class="p">(</span><span class="s2">&quot;twice 1&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">getResult</span><span class="p">())</span>

      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">twice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">getResult</span><span class="p">())</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="macro-context">
<span id="sardana-macro-context"></span><h2>Macro context<a class="headerlink" href="#macro-context" title="Permalink to this headline">¶</a></h2>
<p>One of the most powerfull features of macros is that the entire context of
sardana is at your disposal. Simply put, it means you have access to all
sardana elements by means of the first parameter on your macro (you can give
this parameter any name but usually, by convention it is called <code class="docutils literal"><span class="pre">self</span></code>).</p>
<p><code class="docutils literal"><span class="pre">self</span></code> provides access to an extensive catalog of functions you can use in
your macro to do all kinds of things, among others, to obtain the sardana
elements. The <a class="reference internal" href="../api/api_macro.html#sardana-macro-api"><span class="std std-ref">Macro API reference</span></a> describes all
these functions and the
<a class="reference internal" href="../api/sardana/taurus/core/tango/sardana.html#sardana-taurus-api"><span class="std std-ref">Sardana-Taurus extensions API reference</span></a>
describes the obtained sardana elements.</p>
<p>Let&#8217;s say you want to write a macro that explicitly moves a known <em>theta</em> motor
to a certain position. You could write a macro which receives the motor as
parameter but that would be a little silly since you already know beforehand
which motor you will move. Instead, a better solution would be to <em>ask</em> sardana
for a motor named &#8220;theta&#8221; and use it directly. Here is how you can acomplish
that:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@macro</span><span class="p">([[</span><span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;absolute position&quot;</span><span class="p">]])</span>
<span class="k">def</span> <span class="nf">move_theta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This macro moves theta to the specified position&quot;&quot;&quot;</span>
    <span class="n">th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMotor</span><span class="p">(</span><span class="s2">&quot;th&quot;</span><span class="p">)</span>
    <span class="n">th</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;Motor ended at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">moveable</span><span class="o">.</span><span class="n">getPosition</span><span class="p">())</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="calling-other-macros-from-inside-your-macro">
<span id="sardana-macro-calling"></span><h2>Calling other macros from inside your macro<a class="headerlink" href="#calling-other-macros-from-inside-your-macro" title="Permalink to this headline">¶</a></h2>
<p>One of the functions of the macro decorator is to pass the <em>knowledge</em> of all
existing macros to your macro. This way, without any special imports, your
macro will <em>know</em> about all other macros on the system even if they have been
written in other files.</p>
<p>Lets recreate the two previous macros (<em>where_moveable</em> and <em>move</em>) to execute
two of the macros that exist in the standard macro catalog
(<a class="reference internal" href="../api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.wm" title="sardana.macroserver.macros.standard.wm"><code class="xref py py-class docutils literal"><span class="pre">wm</span></code></a> and
<a class="reference internal" href="../api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.mv" title="sardana.macroserver.macros.standard.mv"><code class="xref py py-class docutils literal"><span class="pre">mv</span></code></a>)</p>
<p>Here is the new version of <em>where_moveable</em></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@macro</span><span class="p">([[</span><span class="s2">&quot;moveable&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;moveable to get position&quot;</span><span class="p">]])</span>
<span class="k">def</span> <span class="nf">where_moveable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moveable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This macro prints the current moveable position&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wm</span><span class="p">([</span><span class="n">moveable</span><span class="p">])</span> <span class="c1"># self.wm(moveable) backwards compatibility - see note</span>
</pre></div>
</div>
<p>... and the new version of <em>move</em></p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@macro</span><span class="p">([</span> <span class="p">[</span><span class="s2">&quot;moveable&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;moveable to move&quot;</span><span class="p">],</span>
         <span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;absolute position&quot;</span><span class="p">]</span> <span class="p">])</span>
<span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moveable</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This macro moves a moveable to the specified position&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mv</span><span class="p">([</span><span class="n">moveable</span><span class="p">,</span> <span class="n">position</span><span class="p">])</span> <span class="c1"># self.mv(moveable, position) backwards compatibility - see note</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is now at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">moveable</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="n">moveable</span><span class="o">.</span><span class="n">getPosition</span><span class="p">())</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Both <a class="reference internal" href="../api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.wm" title="sardana.macroserver.macros.standard.wm"><code class="xref py py-class docutils literal"><span class="pre">wm</span></code></a> and
<a class="reference internal" href="../api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.mv" title="sardana.macroserver.macros.standard.mv"><code class="xref py py-class docutils literal"><span class="pre">mv</span></code></a>
use <a class="reference internal" href="#sardana-macro-repeat-parameters"><span class="std std-ref">repeat parameters</span></a>.
From Sardana 2.0 the repeat parameter values must be passed as lists of
items. An item of a repeat parameter containing more than one member is a
list. In case when a macro defines only one repeat parameter
and it is the last parameter, for the backwards compatibility reasons, the
plain list of items&#8217; members is allowed.</p>
</div>
</div>
<div class="section" id="accessing-environment">
<span id="sardana-macro-environment"></span><h2>Accessing environment<a class="headerlink" href="#accessing-environment" title="Permalink to this headline">¶</a></h2>
<p>The sardana server provides a global space to store variables, called
<em>environment</em>. The <em>environment</em> is a <a class="reference external" href="https://docs.python.org/dev/glossary.html#term-dictionary" title="(in Python v3.9)"><span class="xref std std-term">dictionary</span></a> storing a value for
each variable. This <em>environment</em> is stored persistently so if the sardana
server is restarted the environment is properly restored.</p>
<p>Variables are case sensitive.</p>
<p>The value of an existing environment variable can be accessed using
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.getEnv" title="sardana.macroserver.macro.Macro.getEnv"><code class="xref py py-meth docutils literal"><span class="pre">getEnv()</span></code></a>. Setting the value of an environment variable is done
with <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.setEnv" title="sardana.macroserver.macro.Macro.setEnv"><code class="xref py py-meth docutils literal"><span class="pre">setEnv()</span></code></a>.</p>
<p>For example, we know the ascan macro increments a <code class="docutils literal"><span class="pre">ScanID</span></code> environment
variable each time it is executed. The following example executes a scan and
outputs the new <code class="docutils literal"><span class="pre">ScanID</span></code> value:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@macro</span><span class="p">([[</span><span class="s2">&quot;moveable&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;moveable to get position&quot;</span><span class="p">]])</span>
<span class="k">def</span> <span class="nf">fixed_ascan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moveable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This does an ascan starting at 0 ending at 100, in 10 intervals</span>
<span class="sd">    with integration time of 0.1s&quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">ascan</span><span class="p">(</span><span class="n">moveable</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="hll">    <span class="n">scan_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;ScanID&#39;</span><span class="p">)</span>
</span>    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;ScanID is now </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">scan_id</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="logging">
<span id="sardana-macro-logging"></span><h2>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h2>
<p>The Macro <a class="reference internal" href="../../glossary.html#term-api"><span class="xref std std-term">API</span></a> includes a set of methods that allow you to write log
messages with different levels:</p>
<table class="hlist"><tr><td><ul class="simple">
<li><a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.debug" title="sardana.macroserver.macro.Macro.debug"><code class="xref py py-meth docutils literal"><span class="pre">debug()</span></code></a></li>
<li><a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.info" title="sardana.macroserver.macro.Macro.info"><code class="xref py py-meth docutils literal"><span class="pre">info()</span></code></a></li>
</ul>
</td><td><ul class="simple">
<li><a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.warning" title="sardana.macroserver.macro.Macro.warning"><code class="xref py py-meth docutils literal"><span class="pre">warning()</span></code></a></li>
<li><a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.error" title="sardana.macroserver.macro.Macro.error"><code class="xref py py-meth docutils literal"><span class="pre">error()</span></code></a></li>
</ul>
</td><td><ul class="simple">
<li><a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.critical" title="sardana.macroserver.macro.Macro.critical"><code class="xref py py-meth docutils literal"><span class="pre">critical()</span></code></a></li>
<li><a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.log" title="sardana.macroserver.macro.Macro.log"><code class="xref py py-meth docutils literal"><span class="pre">log()</span></code></a></li>
</ul>
</td><td><ul class="simple">
<li><a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.output" title="sardana.macroserver.macro.Macro.output"><code class="xref py py-meth docutils literal"><span class="pre">output()</span></code></a></li>
</ul>
</td></tr></table>
<p>As you&#8217;ve seen, the special <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.output" title="sardana.macroserver.macro.Macro.output"><code class="xref py py-meth docutils literal"><span class="pre">output()</span></code></a> function has the same effect
as a print function (with slightly different arguments).</p>
<p>Log messages may have several destinations depending on how your sardana server
is configured. At least, one destination of each log message is the client(s)
(spock, GUI, other) which are connected to the server. Spock, for example,
handles the log messages by printing to the console with different colours. By
default, spock prints all log messages with level bigger than
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.debug" title="sardana.macroserver.macro.Macro.debug"><code class="xref py py-meth docutils literal"><span class="pre">debug()</span></code></a> (You can change this behaviour by typing <code class="docutils literal"><span class="pre">debug</span> <span class="pre">on</span></code> in
spock). Another typical destination for log messages is a log file.</p>
<p>Here is an example on how to write a logging information message:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@macro</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">lets_log</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting to execute </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;Hello, World!&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished to executing </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="reports">
<span id="sardana-macro-reporting"></span><h2>Reports<a class="headerlink" href="#reports" title="Permalink to this headline">¶</a></h2>
<p>Once the report facility has been properly configured, report messages can be
sent to the previously configured report file.</p>
<p>There are several differences between <a class="reference internal" href="#sardana-macro-reporting"><span class="std std-ref">reporting</span></a> and
<a class="reference internal" href="#sardana-macro-logging"><span class="std std-ref">logging</span></a>. The first difference is that log messages may
or may not be recorded, depending on the configured filters on the target
(example: log file). A report will always be recorded.</p>
<p>Another difference is that report messages are not sent to the clients. The idea
of a report is to silently record in a file that something as happened.</p>
<p>A third difference is that unlike logs, reports have no message level associated
to them (actually since internally the log library is used to report messages,
every report record as the predefined level <em>INFO</em> but this is just an
implementation detail).</p>
<p>A report message can be emited at any time in the macro using the
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.report" title="sardana.macroserver.macro.Macro.report"><code class="xref py py-meth docutils literal"><span class="pre">report()</span></code></a> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@macro</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">lets_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;this is an official report of macro &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
</span></pre></div>
</div>
<p>This would generate the following report message in the report file:</p>
<blockquote>
<div>INFO     2012-07-18 09:39:34,943: this is an official report of macro &#8216;lets_report&#8217;</div></blockquote>
</div>
<div class="section" id="advanced-macro-calls">
<span id="sardana-advanced-macro-calling"></span><h2>Advanced macro calls<a class="headerlink" href="#advanced-macro-calls" title="Permalink to this headline">¶</a></h2>
<p>As previously explained (see <a class="reference internal" href="#sardana-macro-calling"><span class="std std-ref">calling macros</span></a>), you can use
the Macro <a class="reference internal" href="../../glossary.html#term-api"><span class="xref std std-term">API</span></a> to call other macros from inside your own macro:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@macro</span><span class="p">([[</span><span class="s2">&quot;moveable&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;moveable to get position&quot;</span><span class="p">]])</span>
<span class="k">def</span> <span class="nf">fixed_ascan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moveable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This does an ascan starting at 0 ending at 100, in 10 intervals</span>
<span class="sd">    with integration time of 0.1s&quot;&quot;&quot;</span>
<span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">ascan</span><span class="p">(</span><span class="n">moveable</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
</span></pre></div>
</div>
<p>An explicit call to <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.execMacro" title="sardana.macroserver.macro.Macro.execMacro"><code class="xref py py-meth docutils literal"><span class="pre">execMacro()</span></code></a> would have the same effect:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@macro</span><span class="p">([[</span><span class="s2">&quot;moveable&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;moveable to get position&quot;</span><span class="p">]])</span>
<span class="k">def</span> <span class="nf">fixed_ascan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moveable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This does an ascan starting at 0 ending at 100, in 10 intervals</span>
<span class="sd">    with integration time of 0.1s&quot;&quot;&quot;</span>
<span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">execMacro</span><span class="p">(</span><span class="s1">&#39;ascan&#39;</span><span class="p">,</span> <span class="n">moveable</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;100&#39;</span><span class="p">,</span> <span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="s1">&#39;0.2&#39;</span><span class="p">)</span>
</span></pre></div>
</div>
<p>The advantage of using <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.execMacro" title="sardana.macroserver.macro.Macro.execMacro"><code class="xref py py-meth docutils literal"><span class="pre">execMacro()</span></code></a> is that it supports passing
parameters with different <em>flavors</em>:</p>
<blockquote>
<div><ul>
<li><p class="first">parameters as strings:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">execMacro</span><span class="p">(</span><span class="s1">&#39;ascan&#39;</span><span class="p">,</span> <span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;100&#39;</span><span class="p">,</span> <span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="s1">&#39;0.2&#39;</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">execMacro</span><span class="p">(</span><span class="s1">&#39;mv&#39;</span><span class="p">,</span> <span class="p">[[</span><span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="s1">&#39;0&#39;</span><span class="p">]])</span>
<span class="bp">self</span><span class="o">.</span><span class="n">execMacro</span><span class="p">(</span><span class="s1">&#39;mv&#39;</span><span class="p">,</span> <span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="c1"># backwards compatibility - see note</span>
</pre></div>
</div>
</li>
<li><p class="first">parameters as space separated string:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">execMacro</span><span class="p">(</span><span class="s1">&#39;ascan </span><span class="si">%s</span><span class="s1"> 0 100 10 0.2&#39;</span> <span class="o">%</span> <span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
<span class="bp">self</span><span class="o">.</span><span class="n">execMacro</span><span class="p">(</span><span class="s1">&#39;mv [[</span><span class="si">%s</span><span class="s1"> 0]]&#39;</span> <span class="o">%</span> <span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
<span class="bp">self</span><span class="o">.</span><span class="n">execMacro</span><span class="p">(</span><span class="s1">&#39;mv </span><span class="si">%s</span><span class="s1"> 0&#39;</span> <span class="o">%</span> <span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span> <span class="c1"># backwards compatibility - see note</span>
<span class="bp">self</span><span class="o">.</span><span class="n">execMacro</span><span class="p">(</span><span class="s1">&#39;mv [[</span><span class="si">%s</span><span class="s1"> 0][</span><span class="si">%s</span><span class="s1"> 20]]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="n">motor2</span><span class="o">.</span><span class="n">getName</span><span class="p">()))</span>
<span class="bp">self</span><span class="o">.</span><span class="n">execMacro</span><span class="p">(</span><span class="s1">&#39;mv </span><span class="si">%s</span><span class="s1"> 0 </span><span class="si">%s</span><span class="s1"> 20&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">motor</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="n">motor2</span><span class="o">.</span><span class="n">getName</span><span class="p">()))</span> <span class="c1"># backwards compatibility - see note</span>
</pre></div>
</td></tr></table></div>
</li>
<li><p class="first">parameters as concrete types:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">execMacro</span><span class="p">([</span><span class="s1">&#39;ascan&#39;</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
<span class="bp">self</span><span class="o">.</span><span class="n">execMacro</span><span class="p">([</span><span class="s1">&#39;mv&#39;</span><span class="p">,</span> <span class="p">[[</span><span class="n">motor</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]])</span>
<span class="bp">self</span><span class="o">.</span><span class="n">execMacro</span><span class="p">([</span><span class="s1">&#39;mv&#39;</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="c1"># backwards compatibility - see note</span>
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Macro <a class="reference internal" href="../api/sardana/macroserver/macros/standard.html#sardana.macroserver.macros.standard.mv" title="sardana.macroserver.macros.standard.mv"><code class="xref py py-class docutils literal"><span class="pre">mv</span></code></a>
use <a class="reference internal" href="#sardana-macro-repeat-parameters"><span class="std std-ref">repeat parameters</span></a>.
From Sardana 2.0 the repeat parameter values must be passed as lists of
items. An item of a repeat parameter containing more than one member is a
list.
In case when a macro defines only one repeat parameter
and it is the last parameter, for the backwards compatibility reasons, the
plain list of items&#8217; members is allowed.</p>
</div>
</div>
<div class="section" id="accessing-macro-data">
<h2>Accessing macro data<a class="headerlink" href="#accessing-macro-data" title="Permalink to this headline">¶</a></h2>
<p>Sometimes it is desirable to access data generated by the macro we just called.
For these cases, the Macro <a class="reference internal" href="../../glossary.html#term-api"><span class="xref std std-term">API</span></a> provides a pair of low level methods
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.createMacro" title="sardana.macroserver.macro.Macro.createMacro"><code class="xref py py-meth docutils literal"><span class="pre">createMacro()</span></code></a> and <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.runMacro" title="sardana.macroserver.macro.Macro.runMacro"><code class="xref py py-meth docutils literal"><span class="pre">runMacro()</span></code></a> together with
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.data" title="sardana.macroserver.macro.Macro.data"><code class="xref py py-meth docutils literal"><span class="pre">data()</span></code></a>.</p>
<p>Let&#8217;s say that you need access to the data generated by a scan. First you call
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.createMacro" title="sardana.macroserver.macro.Macro.createMacro"><code class="xref py py-meth docutils literal"><span class="pre">createMacro()</span></code></a> with the same parameter you would give to
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.execMacro" title="sardana.macroserver.macro.Macro.execMacro"><code class="xref py py-meth docutils literal"><span class="pre">execMacro()</span></code></a>. This will return a tuple composed from a macro object
and the result of the <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.prepare" title="sardana.macroserver.macro.Macro.prepare"><code class="xref py py-meth docutils literal"><span class="pre">prepare()</span></code></a> method. Afterward you call <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.runMacro" title="sardana.macroserver.macro.Macro.runMacro"><code class="xref py py-meth docutils literal"><span class="pre">runMacro()</span></code></a> giving
as parameter the macro object returned by <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.createMacro" title="sardana.macroserver.macro.Macro.createMacro"><code class="xref py py-meth docutils literal"><span class="pre">createMacro()</span></code></a>.
In the end, you can access the data generated by the macro
using <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.data" title="sardana.macroserver.macro.Macro.data"><code class="xref py py-meth docutils literal"><span class="pre">data()</span></code></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@macro</span><span class="p">([[</span><span class="s2">&quot;moveable&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;moveable to get position&quot;</span><span class="p">]])</span>
<span class="k">def</span> <span class="nf">fixed_ascan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moveable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This runs the ascan starting at 0 ending at 100, in 10 intervals</span>
<span class="sd">    with integration time of 0.1s&quot;&quot;&quot;</span>

<span class="hll">    <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createMacro</span><span class="p">(</span><span class="s1">&#39;ascan&#39;</span><span class="p">,</span> <span class="n">moveable</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;100&#39;</span><span class="p">,</span> <span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="s1">&#39;0.2&#39;</span><span class="p">)</span>
</span><span class="hll">    <span class="c1"># createMacro returns a tuple composed from a macro object</span>
</span><span class="hll">    <span class="c1"># and the result of the Macro.prepare method</span>
</span>    <span class="n">my_scan</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ret</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">runMacro</span><span class="p">(</span><span class="n">my_scan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">my_scan</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
<p>A set of macro call examples can be found
<a class="reference internal" href="../examples/macro_call_examples.html#sardana-devel-macro-call-examples"><span class="std std-ref">here</span></a>.</p>
</div>
<div class="section" id="writing-a-macro-class">
<span id="sardana-macro-class-writing"></span><h2>Writing a macro class<a class="headerlink" href="#writing-a-macro-class" title="Permalink to this headline">¶</a></h2>
<p>This chapter describes an advanced alternative to writing macros as <a class="reference external" href="http://www.python.org/">Python</a>
classes. If words like <em>inheritance</em>, <em>polimorphism</em> sound like a lawyer&#8217;s
horror movie then you probably should only read this if someone expert in
sardana already told you that the task you intend to do cannot be accomplished
by writing macro functions.</p>
<p>The simplest macro class that you can write <strong>MUST</strong> obey the following rules:</p>
<blockquote>
<div><ul class="simple">
<li>Inherit from <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro" title="sardana.macroserver.macro.Macro"><code class="xref py py-class docutils literal"><span class="pre">Macro</span></code></a></li>
<li>Implement the <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.run" title="sardana.macroserver.macro.Macro.run"><code class="xref py py-meth docutils literal"><span class="pre">run()</span></code></a> method</li>
</ul>
</div></blockquote>
<p>The <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.run" title="sardana.macroserver.macro.Macro.run"><code class="xref py py-meth docutils literal"><span class="pre">run()</span></code></a> method is the place where you write the code of your
macro. So, without further delay, here is the <em>Hello, World!</em> example:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sardana.macroserver.macro</span> <span class="kn">import</span> <span class="n">Macro</span>

<span class="k">class</span> <span class="nc">HelloWorld</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Hello, World! macro&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;Hello, World!&quot;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p id="sardana-macro-add-parameters">Let&#8217;s say you want to pass an integer parameter to your macro. All you have to
do is declare the parameter by using the <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.param_def" title="sardana.macroserver.macro.Macro.param_def"><code class="xref py py-attr docutils literal"><span class="pre">param_def</span></code></a> Macro member:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sardana.macroserver.macro</span> <span class="kn">import</span> <span class="n">Macro</span><span class="p">,</span> <span class="n">Type</span>

<span class="k">class</span> <span class="nc">twice</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Macro twice. Prints the double of the given value&quot;&quot;&quot;</span>

    <span class="n">param_def</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;value to be doubled&quot;</span> <span class="p">]</span> <span class="p">]</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As soon as you add a <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.param_def" title="sardana.macroserver.macro.Macro.param_def"><code class="xref py py-attr docutils literal"><span class="pre">param_def</span></code></a> you also need to
modify the <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.run" title="sardana.macroserver.macro.Macro.run"><code class="xref py py-meth docutils literal"><span class="pre">run()</span></code></a> method to support the new paramter(s).</p>
</div>
<p>A set of macro parameter examples can be found
<a class="reference internal" href="../examples/macro_parameter_examples.html#sardana-devel-macro-parameter-examples"><span class="std std-ref">here</span></a>.</p>
<div class="section" id="preparing-your-macro-for-execution">
<span id="sardana-macro-preparing"></span><h3>Preparing your macro for execution<a class="headerlink" href="#preparing-your-macro-for-execution" title="Permalink to this headline">¶</a></h3>
<p>Additionaly to the <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.run" title="sardana.macroserver.macro.Macro.run"><code class="xref py py-meth docutils literal"><span class="pre">run()</span></code></a> method, you may write a
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.prepare" title="sardana.macroserver.macro.Macro.prepare"><code class="xref py py-meth docutils literal"><span class="pre">prepare()</span></code></a> method where you may put code to prepare the macro for
execution (for example, checking pre-conditions for running the macro). By
default, the prepare method is an empty method. Here is an example on how to
prepare HelloWorld to run only after year 1989:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">sardana.macroserver.macro</span> <span class="kn">import</span> <span class="n">Macro</span>

<span class="k">class</span> <span class="nc">HelloWorld</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Hello, World! macro&quot;&quot;&quot;</span>

<span class="hll">    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span>        <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1990</span><span class="p">,</span><span class="mo">01</span><span class="p">,</span><span class="mo">01</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;HelloWorld can only run after year 1989&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;Hello, World!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="handling-macro-stop-and-abort">
<span id="sardana-macro-handling-macro-stop-and-abort"></span><h2>Handling macro stop and abort<a class="headerlink" href="#handling-macro-stop-and-abort" title="Permalink to this headline">¶</a></h2>
<p>While macro is being executed the user has a possibility to stop or abort it
at any time. The way of performing this operation may vary between the
client application being used, for example see <a class="reference internal" href="../../users/spock.html#sardana-spock-stopping"><span class="std std-ref">Stopping macros</span></a>
in Spock.</p>
<p>It may be desired to stop or abort objects in use when the macro
execution gets interrupted. This does not need to be implemented by
each of the macros. One simply needs to use a special <a class="reference internal" href="../../glossary.html#term-api"><span class="xref std std-term">API</span></a> to reserve
this objects in the macro context and the magic will happen to stop or abort
them when needed. For example if you get an object using the
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.getObj" title="sardana.macroserver.macro.Macro.getObj"><code class="xref py py-meth docutils literal"><span class="pre">getObj()</span></code></a> method it is automatically
reserved. It is also worth mentioning the difference between the
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.getMotion" title="sardana.macroserver.macro.Macro.getMotion"><code class="xref py py-meth docutils literal"><span class="pre">getMotion()</span></code></a> and
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.getMotor" title="sardana.macroserver.macro.Macro.getMotor"><code class="xref py py-meth docutils literal"><span class="pre">getMotor()</span></code></a> methods. The first one
will reserve the moveable while the second will not.</p>
<p>And of course we need to clarify the difference between the stop and the abort
operations. It is commonly agreed that stop is more gentle and
respectful than abort and is supposed to bring the system to a stable state
according to a particular protocol and respecting a nominal configuration e.g.
stop motors respecting the nominal deceleration time. While abort is
foreseen for more emergency situations and is supposed to bring the system
to a stable state as fast as possible e.g. stop motors instantly, possibly
loosing track of position.</p>
<p>While the reserved objects are stopped or aborted immediately after user&#8217;s
interruption, the macro execution is not. The macro will not stop until its
execution thread encounters the next <em>Macro API</em> call e.g.
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.output" title="sardana.macroserver.macro.Macro.output"><code class="xref py py-meth docutils literal"><span class="pre">output()</span></code></a> or
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.getMotor" title="sardana.macroserver.macro.Macro.getMotor"><code class="xref py py-meth docutils literal"><span class="pre">getMotor()</span></code></a>. There is also a special
method <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.checkPoint" title="sardana.macroserver.macro.Macro.checkPoint"><code class="xref py py-meth docutils literal"><span class="pre">checkPoint()</span></code></a> that does nothing
else but mark this place in your code as suitable for stopping or aborting.</p>
<p>If you want to execute a special procedure that should be executed in case
of user&#8217;s interruption you must override the
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.on_stop" title="sardana.macroserver.macro.Macro.on_stop"><code class="xref py py-meth docutils literal"><span class="pre">on_stop()</span></code></a> or
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.on_abort" title="sardana.macroserver.macro.Macro.on_abort"><code class="xref py py-meth docutils literal"><span class="pre">on_abort()</span></code></a> methods.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Currently it is not possible to use any of the <em>Macro API</em> calls
withing the <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.on_stop" title="sardana.macroserver.macro.Macro.on_stop"><code class="xref py py-meth docutils literal"><span class="pre">on_stop()</span></code></a> or
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.on_abort" title="sardana.macroserver.macro.Macro.on_abort"><code class="xref py py-meth docutils literal"><span class="pre">on_abort()</span></code></a>.</p>
</div>
</div>
<div class="section" id="adding-hooks-support">
<span id="sardana-macro-adding-hooks-support"></span><h2>Adding hooks support<a class="headerlink" href="#adding-hooks-support" title="Permalink to this headline">¶</a></h2>
<p>Your macros may accept to <a class="reference internal" href="../../users/macro_hooks.html#sardana-macros-hooks"><span class="std std-ref">attach an arbitrary</span></a>
code, a simple Python callable or even another macro, that will be executed
at given places. In Sardana this code are called <em>hooks</em>, and the places are
called <em>hook places</em>.</p>
<p>In order to allow attaching hooks to your macro you must <a class="reference internal" href="#sardana-macro-class-writing"><span class="std std-ref">write you
macro as a class</span></a> while at the same time
inheriting from the <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Hookable" title="sardana.macroserver.macro.Hookable"><code class="xref py py-class docutils literal"><span class="pre">Hookable</span></code></a> class.</p>
<p>The hook places can be defined in the <code class="docutils literal"><span class="pre">hints</span></code> class member dictionary with
the <code class="docutils literal"><span class="pre">allowsHooks</span></code> key and a tuple of strings with the hook places
identifiers:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">hookable_macro</span><span class="p">(</span><span class="n">Macro</span><span class="p">,</span> <span class="n">Hookable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A macro that accepts and executes hooks.&quot;&quot;&quot;</span>

    <span class="n">hints</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;allowsHooks&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;hook-place&quot;</span><span class="p">,</span> <span class="s2">&quot;another-hook-place&quot;</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getHooks</span><span class="p">(</span><span class="s2">&quot;hook-place&quot;</span><span class="p">):</span>
            <span class="n">hook</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;In between hook places&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getHooks</span><span class="p">(</span><span class="s2">&quot;another-hook-place&quot;</span><span class="p">):</span>
            <span class="n">hook</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>Hooks can be programmatically attached to a macro before its execution either
using the <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Hookable.hooks" title="sardana.macroserver.macro.Hookable.hooks"><code class="xref py py-attr docutils literal"><span class="pre">hooks</span></code></a> property or
using the <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Hookable.appendHook" title="sardana.macroserver.macro.Hookable.appendHook"><code class="xref py py-meth docutils literal"><span class="pre">appendHook()</span></code></a> method:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">hook_function</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">wrapping_macro</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A wrapping macro that attaches hooks to a hookable macro</span>
<span class="sd">    and executes it.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hookable_macro</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createMacro</span><span class="p">(</span><span class="s2">&quot;hookable_macro&quot;</span><span class="p">)</span>
        <span class="n">hook_macro</span> <span class="o">=</span> <span class="n">ExecMacroHook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;mv&quot;</span><span class="p">,</span> <span class="p">[[</span><span class="s2">&quot;mot01&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="n">hookable_macro</span><span class="o">.</span><span class="n">hooks</span> <span class="o">=</span> <span class="p">[(</span><span class="n">hook_macro</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;hook-place&quot;</span><span class="p">])]</span>
        <span class="n">hookable_macro</span><span class="o">.</span><span class="n">appendHook</span><span class="p">((</span><span class="n">hook_function</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;another-hook-place&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runMacro</span><span class="p">(</span><span class="n">hookable_macro</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Be aware of the following difference between setting the
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Hookable.hooks" title="sardana.macroserver.macro.Hookable.hooks"><code class="xref py py-attr docutils literal"><span class="pre">hooks</span></code></a> property and using the
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Hookable.appendHook" title="sardana.macroserver.macro.Hookable.appendHook"><code class="xref py py-meth docutils literal"><span class="pre">appendHook()</span></code></a> method.
Setting the property applies all hooks at once but may override
<a class="reference internal" href="../../users/macro_hooks.html#sardana-macros-hooks-general"><span class="std std-ref">general hooks</span></a> eventually attached to
the macro. Using the method appends just one hook but does not affect
the general hooks eventually attached to the macro.</p>
</div>
</div>
<div class="section" id="using-external-python-libraries">
<span id="sardana-macro-using-external-libraries"></span><h2>Using external python libraries<a class="headerlink" href="#using-external-python-libraries" title="Permalink to this headline">¶</a></h2>
<p>Macro libraries can use code e.g. call functions and instantiate classes
defined by external python libraries. In order to import the external libraries
inside the macro library, they must be available for the python interpreter
running the Sardana/MacroServer server
(see <a class="reference internal" href="../../users/getting_started/running_server.html#sardana-getting-started-running-server"><span class="std std-ref">Running server</span></a>).</p>
<p>This could be achieved in two ways:</p>
<blockquote>
<div><ul class="simple">
<li>Adding the directory containing the external library to the <em>PythonPath</em>
property of the MacroServer tango device (path separators can be <code class="docutils literal"><span class="pre">\n</span></code>
or <code class="docutils literal"><span class="pre">:</span></code>).</li>
<li>Adding the directory containing the external library to the <em>PYTHONPATH</em>
<a class="reference internal" href="../../glossary.html#term-os"><span class="xref std std-term">OS</span></a> environment variable of the Sardana/MacroServer process.</li>
</ul>
</div></blockquote>
<p>The external libraries can be reloaded at Sardana/MacroServer server
runtime using the <a class="reference internal" href="../api/sardana/macroserver/macros/expert.html#sardana.macroserver.macros.expert.rellib" title="sardana.macroserver.macros.expert.rellib"><code class="xref py py-class docutils literal"><span class="pre">rellib</span></code></a> macro.</p>
</div>
<div class="section" id="plotting">
<span id="sardana-macro-plotting"></span><h2>Plotting<a class="headerlink" href="#plotting" title="Permalink to this headline">¶</a></h2>
<p>Remember that your macro will be executed by a Sardana server which may be
running in a different computer than the computer you are working on. Executing
a normal plot (from <code class="xref py py-mod docutils literal"><span class="pre">matplotlib</span></code> or <a class="reference external" href="https://pythonhosted.org/guiqwt/index.html#module-guiqwt" title="(in guiqwt v3.0)"><code class="xref py py-mod docutils literal"><span class="pre">guiqwt</span></code></a>) would just try to show
a plot in the server machine. The macro <a class="reference internal" href="../../glossary.html#term-api"><span class="xref std std-term">API</span></a> provides a way to plot
graphics from inside your macro whenver the client that runs the macro
<em>understands</em> the plot request (don&#8217;t worry, spock does understand!)</p>
<p>The plotting <a class="reference internal" href="../../glossary.html#term-api"><span class="xref std std-term">API</span></a> is the same used by <a class="reference external" href="https://matplotlib.org/api/_as_gen/matplotlib.pyplot.html#module-matplotlib.pyplot" title="(in Matplotlib v3.1.1)"><code class="xref py py-mod docutils literal"><span class="pre">pyplot</span></code></a>. The
<a class="reference internal" href="../../glossary.html#term-api"><span class="xref std std-term">API</span></a> is accessible through the macro context (<code class="docutils literal"><span class="pre">self</span></code>). Here is an
example:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">linspace</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">quad</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">j0</span>

<span class="kn">from</span> <span class="nn">sardana.macroserver.macro</span> <span class="kn">import</span> <span class="n">macro</span>

<span class="k">def</span> <span class="nf">j0i</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Integral form of J_0(x)&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">integrand</span><span class="p">(</span><span class="n">phi</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">quad</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="nd">@macro</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">J0_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sample J0 at linspace(0, 20, 200)&quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">j0</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">x</span><span class="p">[::</span><span class="mi">10</span><span class="p">]</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">j0i</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$J_0(x)$&#39;</span><span class="p">)</span> <span class="c1">#</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$J_0^{integ}(x)$&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Verify $J_0(x)=\frac{1}{\pi}\int_0^{\pi}\cos(x \sin\phi)\,d\phi$&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;$x$&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>Running this macro from spock will result in something like:</p>
<blockquote>
<div><img alt="../../_images/macro_plotting1.png" src="../../_images/macro_plotting1.png" />
</div></blockquote>
<p>Just for fun, the following macro computes a fractal and plots it as an image:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>

<span class="nd">@macro</span><span class="p">([[</span><span class="s2">&quot;interactions&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;density&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]])</span>
<span class="k">def</span> <span class="nf">mandelbrot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interactions</span><span class="p">,</span> <span class="n">density</span><span class="p">):</span>

    <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span>
    <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">density</span><span class="p">),</span>
                          <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">density</span><span class="p">))</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1j</span> <span class="o">*</span> <span class="n">y</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">fractal</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">255</span>

    <span class="n">finteractions</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">interactions</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">interactions</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">*=</span> <span class="n">z</span>
        <span class="n">z</span> <span class="o">+=</span> <span class="n">c</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">fractal</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">fractal</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">254</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="n">finteractions</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fractal</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>And the resulting image (interactions=20, density=512):</p>
<div class="figure">
<img alt="../../_images/macro_fractal.png" src="../../_images/macro_fractal.png" />
</div>
<p>A set of macro plotting examples can be found
<a class="reference internal" href="../examples/macro_plotting_examples.html#sardana-devel-macro-plotting-examples"><span class="std std-ref">here</span></a>.</p>
<div class="section" id="known-plotting-limitations">
<h3>Known plotting limitations<a class="headerlink" href="#known-plotting-limitations" title="Permalink to this headline">¶</a></h3>
<p>When you plot from inside a macro with <code class="docutils literal"><span class="pre">self.pyplot.plot</span></code>, the sardana server
will &#8220;ask&#8221; spock to execute the desired function with the given parameters.
This means that the result of plotting (a sequence of
<code class="xref py py-class docutils literal"><span class="pre">Line2D</span></code>) is not available in the sardana server (since
the actual line is in spock). The result of any function call in
<code class="docutils literal"><span class="pre">self.pyplot</span></code> will always be None!</p>
<p>This means that the following code which works in a normal <a class="reference external" href="http://ipython.org/">IPython</a> console will
<strong>NOT</strong> work inside a macro:</p>
<div class="highlight-spock"><div class="highlight"><pre><span></span><span class="gp">LAB-01-D01 [1]: </span><span class="n">line</span> <span class="o">=</span> <span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

<span class="gp">LAB-01-D01 [2]: </span><span class="n">line</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p>Also consider that each time you plot the complete data to be plotted is sent
from the server to the client... so please avoid plotting arrays of 10,000,000
points!</p>
</div>
</div>
<div class="section" id="asking-for-user-input">
<span id="sardana-macro-input"></span><h2>Asking for user input<a class="headerlink" href="#asking-for-user-input" title="Permalink to this headline">¶</a></h2>
<p>It is possible to ask for user input inside a macro.</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p>Asking for input in the middle of long macros will cause the macro to
stop and wait for user input. If you write a long macro that might be
executed <em>in the middle of the night</em> please take the appropriate steps
to make sure you don&#8217;t arrive in the morning and you are faced with
a message box waiting for you to answer a question that could be avoided
with a proper <em>default value</em>. To make sure your macro can run in
<em>unattended</em> mode make sure that:</p>
<blockquote>
<div><ul class="simple">
<li>it implements the interactive <em>interface</em></li>
<li>every <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.input" title="sardana.macroserver.macro.Macro.input"><code class="xref py py-meth docutils literal"><span class="pre">input()</span></code></a> gives a <em>default_value</em>
<a class="reference internal" href="../../glossary.html#term-keyword-argument"><span class="xref std std-term">keyword argument</span></a></li>
</ul>
</div></blockquote>
<p class="last">(read on to see how to meet these requirements)</p>
</div>
<p>In pure <a class="reference external" href="http://www.python.org/">Python</a>, to ask for user input you can use the <code class="xref py py-func docutils literal"><span class="pre">raw_input()</span></code> (Python
2) / <a class="reference external" href="https://docs.python.org/dev/library/functions.html#input" title="(in Python v3.9)"><code class="xref py py-func docutils literal"><span class="pre">input()</span></code></a> (Python 3)</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">answer</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s1">&#39;--&gt; &#39;</span><span class="p">)</span>
<span class="go">--&gt; Monty Python&#39;s Flying Circus</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">answer</span>
<span class="go">&quot;Monty Python&#39;s Flying Circus&quot;</span>
</pre></div>
</div>
<p>The Macro <a class="reference internal" href="../../glossary.html#term-api"><span class="xref std std-term">API</span></a> provides a much more powerful version of
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.input" title="sardana.macroserver.macro.Macro.input"><code class="xref py py-meth docutils literal"><span class="pre">input()</span></code></a> since it can accept a wide variaty of options.</p>
<p>Similar to what happens with <a class="reference internal" href="#sardana-macro-plotting"><span class="std std-ref">Plotting</span></a>, when input is requested from
inside a macro, the question will be sent to the client (example: spock) which
ordered the macro to be executed. At this time the macro is stopped waiting for
the client to answer. The client must &#8220;ask&#8221; the user for a proper value and the
answer is sent back to the server which then resumes the macro execution.</p>
<p>Asking for user input is straightforward:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@macro</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">ask_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Macro function version to ask for user name&quot;&quot;&quot;</span>

<span class="hll">    <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;What&#39;s your name?&quot;</span><span class="p">)</span>
</span>    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;So, your name is &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>
</pre></div>
</div>
<p>Executing this macro will make spock popup an Input Dialog Box like this one:</p>
<blockquote>
<div><img alt="../../_images/macro_input.png" src="../../_images/macro_input.png" />
</div></blockquote>
<p>When you type your name and press <span class="guilabel"><span class="accelerator">O</span>K</span> the macro finishes printing
the output:</p>
<div class="highlight-spock"><div class="highlight"><pre><span></span><span class="gp">LAB-01-D01 [1]: </span><span class="n">ask_name</span>
<span class="gr">Non interactive macro &#39;ask_name&#39; is asking for input (please set this macro interactive to True)</span>
<span class="go">So, your name is &#39;Homer Simpson&#39;</span>
</pre></div>
</div>
<p>The macro prints a warning message saying that the macro was not declared as
<em>interactive</em>. All macros that request user input <strong>should</strong> be declared as
interactive. This is because the sardana server can run a macro in <em>unattended</em>
mode. When an interactive macro is run in <em>unattended</em> mode, all
<a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.input" title="sardana.macroserver.macro.Macro.input"><code class="xref py py-meth docutils literal"><span class="pre">input()</span></code></a> instructions that have a default value will return
automatically the default value without asking the user for input.</p>
<p>To declare a macro as interactive set the <code class="docutils literal"><span class="pre">interactive</span></code>
<a class="reference internal" href="../../glossary.html#term-keyword-argument"><span class="xref std std-term">keyword argument</span></a> in the macro decorator to <code class="docutils literal"><span class="pre">True</span></code>
(default value for <code class="docutils literal"><span class="pre">interactive</span></code> is <code class="docutils literal"><span class="pre">False</span></code>), like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="hll"><span class="nd">@macro</span><span class="p">(</span><span class="n">interactive</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">ask_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Macro function version to ask for user name&quot;&quot;&quot;</span>

    <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;What&#39;s your name?&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;So, your name is &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>
</pre></div>
</div>
<p>To declare a macro class as interactive set the <code class="docutils literal"><span class="pre">interactive</span></code> member to
<code class="docutils literal"><span class="pre">True</span></code> (default value for <code class="docutils literal"><span class="pre">interactive</span></code> is <code class="docutils literal"><span class="pre">False</span></code>), like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ask_name</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Macro class version to ask for user name&quot;&quot;&quot;</span>

<span class="hll">    <span class="n">interactive</span> <span class="o">=</span> <span class="bp">True</span>
</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;What&#39;s your name?&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;So, your name is &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>
</pre></div>
</div>
<p>a helper <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.imacro" title="sardana.macroserver.macro.imacro"><code class="xref py py-class docutils literal"><span class="pre">imacro</span></code></a> decorator and a <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.iMacro" title="sardana.macroserver.macro.iMacro"><code class="xref py py-class docutils literal"><span class="pre">iMacro</span></code></a> class exist which can
be used instead of the <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.macro" title="sardana.macroserver.macro.macro"><code class="xref py py-class docutils literal"><span class="pre">macro</span></code></a> decorator and <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro" title="sardana.macroserver.macro.Macro"><code class="xref py py-class docutils literal"><span class="pre">Macro</span></code></a> class to
transparently declare your macro as interactive:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="hll"><span class="kn">from</span> <span class="nn">sardana.macroserver.macro</span> <span class="kn">import</span> <span class="n">imacro</span><span class="p">,</span> <span class="n">iMacro</span>
</span>
<span class="c1"># interactive macro function version</span>

<span class="hll"><span class="nd">@imacro</span><span class="p">()</span>
</span><span class="k">def</span> <span class="nf">ask_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Macro function version to ask for user name&quot;&quot;&quot;</span>

    <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;What&#39;s your name?&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;So, your name is &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>

<span class="c1"># interactive macro class version</span>

<span class="hll"><span class="k">class</span> <span class="nc">ask_name</span><span class="p">(</span><span class="n">iMacro</span><span class="p">):</span>
</span>    <span class="sd">&quot;&quot;&quot;Macro class version to ask for user name&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;What&#39;s your name?&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;So, your name is &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>
</pre></div>
</div>
<p>The following sub-chapters explain the different options available for macro
user input.</p>
<div class="section" id="specifying-input-data-type">
<h3>Specifying input data type<a class="headerlink" href="#specifying-input-data-type" title="Permalink to this headline">¶</a></h3>
<p>The default return type of <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.input" title="sardana.macroserver.macro.Macro.input"><code class="xref py py-class docutils literal"><span class="pre">input</span></code></a> is <a class="reference external" href="https://docs.python.org/dev/library/stdtypes.html#str" title="(in Python v3.9)"><code class="xref py py-obj docutils literal"><span class="pre">str</span></code></a> which mimics the
pure <a class="reference external" href="http://www.python.org/">Python</a> input function. However, often you want to restrict the user input
to a specific data type like <code class="docutils literal"><span class="pre">Integer</span></code>, <code class="docutils literal"><span class="pre">Float</span></code> or even complex object like
<code class="docutils literal"><span class="pre">Moveable</span></code> or to a list of possible options.</p>
<p>The macro <a class="reference internal" href="../api/api_macro.html#sardana.macroserver.macro.Macro.input" title="sardana.macroserver.macro.Macro.input"><code class="xref py py-class docutils literal"><span class="pre">input</span></code></a> <a class="reference internal" href="../../glossary.html#term-api"><span class="xref std std-term">API</span></a> provides an easy way to do this by
specifying the concrete data type in the
<a class="reference internal" href="../../glossary.html#term-keyword-argument"><span class="xref std std-term">keyword argument</span></a> <em>data_type</em>. The following examples
shows how to ask for an <code class="docutils literal"><span class="pre">Integer</span></code>, a <code class="docutils literal"><span class="pre">Moveable</span></code>, and single/multiple
selection from a list of options:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sardana.macroserver.macro</span> <span class="kn">import</span> <span class="n">imacro</span><span class="p">,</span> <span class="n">Type</span>

<span class="nd">@imacro</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">ask_number_of_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;asks user for the number of points&quot;&quot;&quot;</span>

    <span class="n">nb_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;How many points?&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">Type</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;You selected </span><span class="si">%d</span><span class="s2"> points&quot;</span><span class="p">,</span> <span class="n">nb_points</span><span class="p">)</span>

<span class="nd">@imacro</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">ask_for_moveable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;asks user for a motor&quot;&quot;&quot;</span>

    <span class="n">moveable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;Which moveable?&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;You selected </span><span class="si">%s</span><span class="s2"> which is at </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">moveable</span><span class="p">,</span> <span class="n">moveable</span><span class="o">.</span><span class="n">getPosition</span><span class="p">())</span>

<span class="nd">@imacro</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">ask_for_car_brand</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;asks user for a car brand&quot;&quot;&quot;</span>

    <span class="n">car_brands</span> <span class="o">=</span> <span class="s2">&quot;Mazda&quot;</span><span class="p">,</span> <span class="s2">&quot;Citroen&quot;</span><span class="p">,</span> <span class="s2">&quot;Renault&quot;</span>
    <span class="n">car_brand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;Which car brand?&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">car_brands</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;You selected </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">car_brand</span><span class="p">)</span>

<span class="nd">@imacro</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">ask_for_multiple_car_brands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;asks user for several car brands&quot;&quot;&quot;</span>

    <span class="n">car_brands</span> <span class="o">=</span> <span class="s2">&quot;Mazda&quot;</span><span class="p">,</span> <span class="s2">&quot;Citroen&quot;</span><span class="p">,</span> <span class="s2">&quot;Renault&quot;</span><span class="p">,</span> <span class="s2">&quot;Ferrari&quot;</span><span class="p">,</span> <span class="s2">&quot;Porche&quot;</span><span class="p">,</span> <span class="s2">&quot;Skoda&quot;</span>
    <span class="n">car_brands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;Which car brand(s)?&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">car_brands</span><span class="p">,</span>
                            <span class="n">allow_multiple</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;You selected </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">car_brands</span><span class="p">))</span>
</pre></div>
</td></tr></table></div>
<p>... and these are the corresponding dialogs that will popup in spock:</p>
<blockquote>
<div><img alt="input_integer" class="align-middle" src="../../_images/macro_input_integer.png" /> <img alt="input_moveable" class="align-middle" src="../../_images/macro_input_moveable.png" /> <img alt="input_select_radio" class="align-middle" src="../../_images/macro_input_select_radio.png" />
<img alt="input_select_multiple" class="align-middle" src="../../_images/macro_input_select_multiple.png" /></div></blockquote>
</div>
<div class="section" id="providing-a-default-value">
<h3>Providing a default value<a class="headerlink" href="#providing-a-default-value" title="Permalink to this headline">¶</a></h3>
<p>Providing a default value is <strong>very important</strong> since it will allow your macro
to run in <em>unattended</em> mode. When given, the <em>default_value</em>
<a class="reference internal" href="../../glossary.html#term-keyword-argument"><span class="xref std std-term">keyword argument</span></a> value type must be compatible with
the <em>data_type</em> <a class="reference internal" href="../../glossary.html#term-keyword-argument"><span class="xref std std-term">keyword argument</span></a>. Providing a
default value is easy. The following examples repeat the previous data type
examples giving compatible default values:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sardana.macroserver.macro</span> <span class="kn">import</span> <span class="n">imacro</span><span class="p">,</span> <span class="n">Type</span>

<span class="nd">@imacro</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">ask_number_of_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;asks user for the number of points&quot;&quot;&quot;</span>

    <span class="n">nb_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;How many points?&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">Type</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
                           <span class="n">default_value</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;You selected </span><span class="si">%d</span><span class="s2"> points&quot;</span><span class="p">,</span> <span class="n">nb_points</span><span class="p">)</span>

<span class="nd">@imacro</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">ask_for_moveable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;asks user for a motor&quot;&quot;&quot;</span>

    <span class="n">moveable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;Which moveable?&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">,</span>
                          <span class="n">default_value</span><span class="o">=</span><span class="s2">&quot;gap01&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;You selected </span><span class="si">%s</span><span class="s2"> which is at </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">moveable</span><span class="p">,</span> <span class="n">moveable</span><span class="o">.</span><span class="n">getPosition</span><span class="p">())</span>

<span class="nd">@imacro</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">ask_for_car_brand</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;asks user for a car brand&quot;&quot;&quot;</span>

    <span class="n">car_brands</span> <span class="o">=</span> <span class="s2">&quot;Mazda&quot;</span><span class="p">,</span> <span class="s2">&quot;Citroen&quot;</span><span class="p">,</span> <span class="s2">&quot;Renault&quot;</span>
    <span class="n">car_brand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;Which car brand?&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">car_brands</span><span class="p">,</span>
                           <span class="n">default_value</span><span class="o">=</span><span class="n">car_brands</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;You selected </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">car_brand</span><span class="p">)</span>

<span class="nd">@imacro</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">ask_for_multiple_car_brands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;asks user for several car brands. Default is every other car brand</span>
<span class="sd">    in the list&quot;&quot;&quot;</span>

    <span class="n">car_brands</span> <span class="o">=</span> <span class="s2">&quot;Mazda&quot;</span><span class="p">,</span> <span class="s2">&quot;Citroen&quot;</span><span class="p">,</span> <span class="s2">&quot;Renault&quot;</span><span class="p">,</span> <span class="s2">&quot;Ferrari&quot;</span><span class="p">,</span> <span class="s2">&quot;Porche&quot;</span><span class="p">,</span> <span class="s2">&quot;Skoda&quot;</span>
    <span class="n">car_brands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;Which car brand(s)?&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">car_brands</span><span class="p">,</span>
                            <span class="n">allow_multiple</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                            <span class="n">default_value</span><span class="o">=</span><span class="n">car_brands</span><span class="p">[::</span><span class="mi">2</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;You selected </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">car_brands</span><span class="p">))</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="giving-a-title">
<h3>Giving a title<a class="headerlink" href="#giving-a-title" title="Permalink to this headline">¶</a></h3>
<p>By default, the Dialog window title will contain the name of the macro which
triggered user input. You can override the default behaviour with the
<a class="reference internal" href="../../glossary.html#term-keyword-argument"><span class="xref std std-term">keyword argument</span></a> <em>title</em>:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@imacro</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">ask_peak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;asks use for peak current of points with a custom title&quot;&quot;&quot;</span>

    <span class="n">peak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;What is the peak current?&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span>
                      <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Peak selection&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;You selected a peak of </span><span class="si">%f</span><span class="s2"> A&quot;</span><span class="p">,</span> <span class="n">peak</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>... and this is the corresponding dialog:</p>
<blockquote>
<div><img alt="input_float_title" class="align-middle" src="../../_images/macro_input_float_title.png" /></div></blockquote>
</div>
<div class="section" id="specifying-label-and-unit">
<h3>Specifying label and unit<a class="headerlink" href="#specifying-label-and-unit" title="Permalink to this headline">¶</a></h3>
<p>The <em>key</em> and <em>unit</em> <a class="reference internal" href="../../glossary.html#term-keyword-argument"><span class="xref std std-term">keyword arguments</span></a> can be used to
provide additional label and unit information respectively and prevent user
mistakes:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@imacro</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">ask_peak_v2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;asks use for peak current of points with a custom title,</span>
<span class="sd">    default value, label and units&quot;&quot;&quot;</span>

    <span class="n">label</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;peak&quot;</span><span class="p">,</span> <span class="s2">&quot;mA&quot;</span>
    <span class="n">peak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;What is the peak current?&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span>
                      <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Peak selection&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span>
                      <span class="n">default_value</span><span class="o">=</span><span class="mf">123.4</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;You selected a </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%f</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>... and this is the corresponding dialog:</p>
<blockquote>
<div><img alt="input_float_title_label_unit" class="align-middle" src="../../_images/macro_input_float_title_label_unit.png" /></div></blockquote>
</div>
<div class="section" id="limiting-ranges-setting-decimal-places-and-step-size">
<h3>Limiting ranges, setting decimal places and step size<a class="headerlink" href="#limiting-ranges-setting-decimal-places-and-step-size" title="Permalink to this headline">¶</a></h3>
<p>When numeric input is requested, it might be useful to prevent user input
outside a certain range. This can be achieved with the <em>minimum</em> and <em>maximum</em>
<a class="reference internal" href="../../glossary.html#term-keyword-argument"><span class="xref std std-term">keyword arguments</span></a>:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@imacro</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">ask_peak_v3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;asks use for peak current of points with a custom title,</span>
<span class="sd">    default value, label, units and ranges&quot;&quot;&quot;</span>

    <span class="n">label</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;peak&quot;</span><span class="p">,</span> <span class="s2">&quot;mA&quot;</span>
    <span class="n">peak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;What is the peak current?&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span>
                      <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Peak selection&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span>
                      <span class="n">default_value</span><span class="o">=</span><span class="mf">123.4</span><span class="p">,</span> <span class="n">minimum</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mf">200.0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;You selected a </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%f</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>An additional <em>step</em> <a class="reference internal" href="../../glossary.html#term-keyword-argument"><span class="xref std std-term">keyword argument</span></a> may help
increase usability by setting the step size in a input spin box:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@imacro</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">ask_peak_v4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;asks use for peak current of points with a custom title,</span>
<span class="sd">    default value, label, units, ranges and step size&quot;&quot;&quot;</span>

    <span class="n">label</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;peak&quot;</span><span class="p">,</span> <span class="s2">&quot;mA&quot;</span>
    <span class="n">peak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;What is the peak current?&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span>
                      <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Peak selection&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span>
                      <span class="n">default_value</span><span class="o">=</span><span class="mf">123.4</span><span class="p">,</span> <span class="n">minimum</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mf">200.0</span><span class="p">,</span>
                      <span class="n">step</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;You selected a </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%f</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>When asking for a decimal number, it might be useful to use the <em>decimals</em>
<a class="reference internal" href="../../glossary.html#term-keyword-argument"><span class="xref std std-term">keyword argument</span></a> to indicate how many decimal places
to show in a input spin box:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@imacro</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">ask_peak_v5</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;asks use for peak current of points with a custom title,</span>
<span class="sd">    default value, label, units, ranges, step size and decimal places&quot;&quot;&quot;</span>

    <span class="n">label</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;peak&quot;</span><span class="p">,</span> <span class="s2">&quot;mA&quot;</span>
    <span class="n">peak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;What is the peak current?&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span>
                      <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Peak selection&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span>
                      <span class="n">default_value</span><span class="o">=</span><span class="mf">123.4</span><span class="p">,</span> <span class="n">minimum</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mf">200.0</span><span class="p">,</span>
                      <span class="n">step</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;You selected a </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%f</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>A set of macro input examples can be found
<a class="reference internal" href="../examples/macro_input_examples.html#sardana-devel-macro-input-examples"><span class="std std-ref">here</span></a>.</p>
</div>
</div>
<div class="section" id="showing-progress-in-long-macros">
<h2>Showing progress in long macros<a class="headerlink" href="#showing-progress-in-long-macros" title="Permalink to this headline">¶</a></h2>
<p>Some of the macros you write may take a long time to execute. It could be useful
to provide frequent feedback on the current progress of your macro to prevent
users from thinking the system is blocked. The way to do this is by
<a class="reference external" href="https://docs.python.org/dev/reference/simple_stmts.html#yield" title="(in Python v3.9)"><code class="xref std std-keyword docutils literal"><span class="pre">yield</span></code></a>ing a new progress number in the ode everytime you want to
send a progress.</p>
<p>The following code shows an example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="nd">@macro</span><span class="p">([[</span><span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;time to sleep (s)&quot;</span><span class="p">]])</span>
<span class="k">def</span> <span class="nf">nap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration</span><span class="p">):</span>

    <span class="n">fduration</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">duration</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="hll">        <span class="k">yield</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">fduration</span> <span class="o">*</span> <span class="mi">100</span>
</span></pre></div>
</div>
<p>The important code here is line 9. Everytime the macro execution reaches this
line of code, basically it tells sardana to send a progress with the desired
value. By default, the value is interpreted has a percentage and should have
the range between 0.0 and 100.0.</p>
<p>Actually, even if your macro doesn&#8217;t explicitly send macro progress reports,
sardana always generates a 0.0 progress at the beginning of the macro and a
last 100.0 progress at the end so for example, in a <a class="reference internal" href="../../glossary.html#term-gui"><span class="xref std std-term">GUI</span></a>, the progress
bar showing the macro progress will always reach the end (unless an error
occurs) no matter how you program the progress.</p>
<p><img alt="macro_progress" class="align-middle" src="../../_images/macro_progress.png" /></p>
<p>It is possible to generate a progress that doesn&#8217;t fit the 0 - 100.0 range. The
above macro has been modified to send a progress with a customized range:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="nd">@macro</span><span class="p">([[</span><span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;time to sleep (s)&quot;</span><span class="p">]])</span>
<span class="k">def</span> <span class="nf">nap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration</span><span class="p">):</span>

<span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;range&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">duration</span><span class="p">]</span> <span class="p">}</span>
</span>
    <span class="n">fduration</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">duration</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="hll">        <span class="n">status</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
</span><span class="hll">        <span class="k">yield</span> <span class="n">status</span>
</span></pre></div>
</div>
<p>You may notice that this way, the range can be changed dynamically. A progress
bar in a <a class="reference internal" href="../../glossary.html#term-gui"><span class="xref std std-term">GUI</span></a> is programmed to adjust not only the current progress
value but also the ranges so it is safe to change them if necessary.</p>
</div>
<div class="section" id="simultaneous-actions">
<h2>Simultaneous actions<a class="headerlink" href="#simultaneous-actions" title="Permalink to this headline">¶</a></h2>
<p>There is a facility for parallel execution of operations within a macro. For the
motion and acquisition you can use the asynchronous methods from the
<code class="code docutils literal"><span class="pre">Motion</span></code> and <code class="code docutils literal"><span class="pre">MeasurementGroup</span></code> objects. For simultaneous execution
of any other tasks you can use the job manager.</p>
<p>When using this feature, you should keep a few things in mind:</p>
<ul class="simple">
<li>The job execution may not start immediately, as this depends on a worker
process availability (this is generally true also for the execution of the macro
itself)</li>
<li>Exceptions raised in a job will not be catched, and therefore will not stop
any reserved element; ideally you should implement your own exception handling
inside a job</li>
<li>You should pay careful attention to synchronization between the jobs and the
macro</li>
</ul>
<p><strong>Asynchronous motion and acquisition</strong></p>
<p>You can move the motor asynchronously by using the <code class="code docutils literal"><span class="pre">Motion</span></code> object:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@macro</span><span class="p">([[</span><span class="s2">&quot;mot&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Moveable</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;moveable&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;position&quot;</span><span class="p">]])</span>
<span class="k">def</span> <span class="nf">move_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mot</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
    <span class="n">motion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMotion</span><span class="p">([</span><span class="n">mot</span><span class="p">])</span>
<span class="hll">    <span class="n">_id</span> <span class="o">=</span> <span class="n">motion</span><span class="o">.</span><span class="n">startMove</span><span class="p">([</span><span class="n">pos</span><span class="p">])</span>
</span>    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The motion is now started.&quot;</span><span class="p">)</span>
<span class="hll">    <span class="n">motion</span><span class="o">.</span><span class="n">waitMove</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">_id</span><span class="p">)</span>
</span>    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The motion has finished.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In above example, the asynchronous movement is started using
<code class="code docutils literal"><span class="pre">Motion.startMove</span></code> method and then it is synchronized using
<code class="code docutils literal"><span class="pre">Motion.waitMove</span></code>. In between you can perform other operations, the
<code class="code docutils literal"><span class="pre">waitMove</span></code> call will wait for the motion to finish or return immediately
if it&#8217;s already finished. <code class="code docutils literal"><span class="pre">startMove</span></code> will return an identificator, that
can be later used to wait for the motion.</p>
<p>The <code class="code docutils literal"><span class="pre">MeasurementGroup</span></code> provides a similar interface for asynchronous
acquisition:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@macro</span><span class="p">([[</span><span class="s2">&quot;mg&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">MeasurementGroup</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;measurement group&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;it&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;integration time&quot;</span><span class="p">]])</span>
<span class="k">def</span> <span class="nf">acq_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mg</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>
    <span class="n">mg</span><span class="o">.</span><span class="n">putIntegrationTime</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
    <span class="n">mg</span><span class="o">.</span><span class="n">setNbStarts</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mg</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>
<span class="hll">    <span class="n">id_</span> <span class="o">=</span> <span class="n">mg</span><span class="o">.</span><span class="n">startCount</span><span class="p">()</span>
</span>    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The acquisition is now started.&quot;</span><span class="p">)</span>
<span class="hll">    <span class="n">mg</span><span class="o">.</span><span class="n">waitCount</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">_id</span><span class="p">)</span>
</span>    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The acquisition has finished.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>After the measurement group is configured for acquisition, you can start
asynchronous acquisition by using <code class="code docutils literal"><span class="pre">MeasurementGroup.startCount</span></code> method. To
synchronize the acquisition use <code class="code docutils literal"><span class="pre">MeasurementGroup.waitCount</span></code>. The usage is
analogous to asynchronous motion.</p>
<p>Take a look at the example macro libraries for some more examples.</p>
<p><strong>Arbitrary asynchronous operations</strong></p>
<p>There are two methods for asynchronous execution of arbitrary code. First one is
to use the MacroServer&#8217;s job manager:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Event</span>

<span class="k">class</span> <span class="nc">async_attached</span><span class="p">(</span><span class="n">Macro</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_job</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Doing something...&quot;</span><span class="p">)</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">_event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">getManager</span><span class="p">()</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="p">)</span>
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The job is now running.&quot;</span><span class="p">)</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;The job has finished (or timeout occured).&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In the <code class="code docutils literal"><span class="pre">run</span></code> method, first we create the <code class="code docutils literal"><span class="pre">Event</span></code> object which will
be used for the synchronization. Then we get the manager object and add a job to
it. The job begins to run when added. When the job finishes, it sets the
<code class="code docutils literal"><span class="pre">Event</span></code> to notify the macro. The macro waits for the event to become set.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">If you do not wait for the job to finish, you are running in the
&#8220;detached mode&#8221;. This is not recommended, as it requires more elaborated
synchronization methods. Use at your own risk!</p>
</div>
<p>The second method is to use standard Python <a class="reference external" href="https://docs.python.org/2/library/threading.html">threading</a> library.</p>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="f1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td>To find the absolute path for sardana&#8217;s source code type on the
command line <code class="docutils literal"><span class="pre">python3</span> <span class="pre">-c</span> <span class="pre">&quot;import</span> <span class="pre">sys,</span> <span class="pre">sardana;</span> <span class="pre">sys.stdout.write</span>
<span class="pre">(str(sardana.__path__))&quot;</span></code></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[2]</a></td><td>To check which version of <a class="reference external" href="http://www.python.org/">Python</a> you are using type on the command
line <code class="docutils literal"><span class="pre">python3</span> <span class="pre">-c</span> <span class="pre">&quot;import</span> <span class="pre">sys;</span> <span class="pre">sys.stdout.write(sys.version)&quot;</span></code></td></tr>
</tbody>
</table>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="scan_framework.html" class="btn btn-neutral float-right" title="Scan Framework" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="Writing macros" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Except where otherwise noted, content on this site is
licensed under a Creative Commons Attribution 3.0 License.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'3.0.2-alpha',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>