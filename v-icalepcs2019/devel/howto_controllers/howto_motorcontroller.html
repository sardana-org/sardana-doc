

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>How to write a motor controller &mdash; sardana 3.0.2-alpha documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="sardana 3.0.2-alpha documentation" href="../../index.html"/>
        <link rel="up" title="Writing controllers" href="index.html"/>
        <link rel="next" title="How to write a counter/timer controller" href="howto_countertimercontroller.html"/>
        <link rel="prev" title="What is a controller" href="howto_controller.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> sardana
          

          
            
            <img src="../../_static/logo.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference external" href="http://www.sardana-controls.org">Home Page</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/sardana-org/sardana">Project Page</a></li>
<li class="toctree-l1"><a class="reference external" href="http://pypi.python.org/pypi/sardana">Download from PyPI</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../docs.html">Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../users/index.html">User&#8217;s Guide</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Developer&#8217;s Guide</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../overview/index.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../howto_macros/index.html">Writing macros</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Writing controllers</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="howto_controller.html">What is a controller</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">How to write a motor controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_countertimercontroller.html">How to write a counter/timer controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_0dcontroller.html">How to write a 0D controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_1dcontroller.html">How to write a 1D controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_2dcontroller.html">How to write a 2D controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_triggergatecontroller.html">How to write a trigger/gate controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_ioregistercontroller.html">How to write an I/O register controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_pseudomotorcontroller.html">How to write a pseudo motor controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="howto_pseudocountercontroller.html">How to write a pseudo counter controller</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../howto_recorders.html">Writing recorders</a></li>
<li class="toctree-l3"><a class="reference internal" href="../howto_test/index.html">Sardana Testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/api_sardana.html">API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide_migration.html">Migration guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/examples.html">Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide_coding.html">Development guidelines</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../sep/index.html">Sardana Enhancement Proposals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_versions.html">Docs for other Sardana versions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana-plugins">Plugins Catalogue</a></li>
<li class="toctree-l1"><a class="reference external" href="http://github.com/sardana-org/sardana/wiki">Wiki</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">sardana</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../docs.html">Sardana 3.0 Documentation</a> &raquo;</li>
      
          <li><a href="../index.html">Developer&#8217;s Guide</a> &raquo;</li>
      
          <li><a href="index.html">Writing controllers</a> &raquo;</li>
      
    <li>How to write a motor controller</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/devel/howto_controllers/howto_motorcontroller.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="how-to-write-a-motor-controller">
<span id="sardana-motorcontroller-howto-basics"></span><h1>How to write a motor controller<a class="headerlink" href="#how-to-write-a-motor-controller" title="Permalink to this headline">¶</a></h1>
<div class="section" id="the-basics">
<h2>The basics<a class="headerlink" href="#the-basics" title="Permalink to this headline">¶</a></h2>
<p>An example of a hypothetical <em>Springfield</em> motor controller will be build
incrementally from scratch to aid in the explanation.</p>
<p>By now you should have read <a class="reference internal" href="../api/api_controller.html#sardana-controller-api"><span class="std std-ref">the general controller basics</span></a> chapter. You should
now have a MotorController with a proper constructor, add and delete axis methods:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">springfieldlib</span>

<span class="kn">from</span> <span class="nn">sardana.pool.controller</span> <span class="kn">import</span> <span class="n">MotorController</span>

<span class="k">class</span> <span class="nc">SpringfieldMotorController</span><span class="p">(</span><span class="n">MotorController</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SpringfieldMotorController</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># initialize hardware communication</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span> <span class="o">=</span> <span class="n">springfieldlib</span><span class="o">.</span><span class="n">SpringfieldMotorHW</span><span class="p">()</span>

        <span class="c1"># do some initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motors</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">AddDevice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motors</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">DeleteDevice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motor</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
</pre></div>
</div>
<p>The <em>get axis state</em> method has some details that will be explained below.</p>
<p>The examples use a <code class="xref py py-mod docutils literal"><span class="pre">springfieldlib</span></code> module which emulates a motor hardware
access library.</p>
<p>The <code class="xref py py-mod docutils literal"><span class="pre">springfieldlib</span></code> can be downloaded from
<a class="reference download internal" href="../../_downloads/springfieldlib.py" download=""><code class="xref download docutils literal"><span class="pre">here</span></code></a>.</p>
<p>The Springfield motor controller can be downloaded from
<a class="reference download internal" href="../../_downloads/sf_motor_ctrl.py" download=""><code class="xref download docutils literal"><span class="pre">here</span></code></a>.</p>
<p>The following code describes a minimal <em>Springfield</em> base motor controller
which is able to return both the state and position of a motor as well as move
a motor to the desired position:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpringfieldBaseMotorController</span><span class="p">(</span><span class="n">MotorController</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The most basic controller intended from demonstration purposes only.</span>
<span class="sd">    This is the absolute minimum you have to implement to set a proper motor</span>
<span class="sd">    controller able to get a motor position, get a motor state and move a</span>
<span class="sd">    motor.</span>

<span class="sd">    This example is so basic that it is not even directly described in the</span>
<span class="sd">    documentation&quot;&quot;&quot;</span>

    <span class="n">MaxDevice</span> <span class="o">=</span> <span class="mi">128</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SpringfieldBaseMotorController</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">inst</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span> <span class="o">=</span> <span class="n">springfieldlib</span><span class="o">.</span><span class="n">SpringfieldMotorHW</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">ReadOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the specified motor position&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">getPosition</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">StateOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the specified motor state&quot;&quot;&quot;</span>
        <span class="n">springfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">springfield</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">State</span><span class="o">.</span><span class="n">On</span><span class="p">,</span> <span class="s2">&quot;Motor is stopped&quot;</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">State</span><span class="o">.</span><span class="n">Moving</span><span class="p">,</span> <span class="s2">&quot;Motor is moving&quot;</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">State</span><span class="o">.</span><span class="n">Fault</span><span class="p">,</span> <span class="s2">&quot;Motor has an error&quot;</span>

    <span class="k">def</span> <span class="nf">StartOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Move the specified motor to the specified position&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">StopOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop the specified motor&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
</pre></div>
</div>
<p>This code is shown only to demonstrate the minimal controller <a class="reference internal" href="../../glossary.html#term-api"><span class="xref std std-term">API</span></a>.
The advanced motor controller chapters describe how to account for more complex
behaviour like reducing the number of hardware accesses or synchronize motion of
multiple motors.</p>
<div class="section" id="get-motor-state">
<span id="sardana-motorcontroller-howto-axis-state"></span><h3>Get motor state<a class="headerlink" href="#get-motor-state" title="Permalink to this headline">¶</a></h3>
<p>To get the state of a motor, sardana calls the
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.StateOne" title="sardana.pool.controller.Controller.StateOne"><code class="xref py py-meth docutils literal"><span class="pre">StateOne()</span></code></a> method. This method
receives an axis as parameter and should return either:</p>
<blockquote>
<div><ul class="simple">
<li>state (<a class="reference internal" href="../api/sardana/sardanadefs.html#sardana.sardanadefs.State" title="sardana.sardanadefs.State"><code class="xref py py-obj docutils literal"><span class="pre">State</span></code></a>) or</li>
<li><dl class="first docutils">
<dt>a sequence of two elements:</dt>
<dd><ul class="first last">
<li>state (<a class="reference internal" href="../api/sardana/sardanadefs.html#sardana.sardanadefs.State" title="sardana.sardanadefs.State"><code class="xref py py-obj docutils literal"><span class="pre">State</span></code></a>)</li>
<li>status (<a class="reference external" href="https://docs.python.org/dev/library/stdtypes.html#str" title="(in Python v3.9)"><code class="xref py py-obj docutils literal"><span class="pre">str</span></code></a>) <em>or</em> limit switches (<a class="reference external" href="https://docs.python.org/dev/library/functions.html#int" title="(in Python v3.9)"><code class="xref py py-obj docutils literal"><span class="pre">int</span></code></a>)</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>a sequence of three elements:</dt>
<dd><ul class="first last">
<li>state (<a class="reference internal" href="../api/sardana/sardanadefs.html#sardana.sardanadefs.State" title="sardana.sardanadefs.State"><code class="xref py py-obj docutils literal"><span class="pre">State</span></code></a>)</li>
<li>status (<a class="reference external" href="https://docs.python.org/dev/library/stdtypes.html#str" title="(in Python v3.9)"><code class="xref py py-obj docutils literal"><span class="pre">str</span></code></a>)</li>
<li>limit switches (<a class="reference external" href="https://docs.python.org/dev/library/functions.html#int" title="(in Python v3.9)"><code class="xref py py-obj docutils literal"><span class="pre">int</span></code></a>)</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<p>The state should be a member of <a class="reference internal" href="../api/sardana/sardanadefs.html#sardana.sardanadefs.State" title="sardana.sardanadefs.State"><code class="xref py py-obj docutils literal"><span class="pre">State</span></code></a> (For backward
compatibility reasons, it is also supported to return one of
<code class="xref py py-class docutils literal"><span class="pre">PyTango.DevState</span></code>). The status could be any string. The limit switches
is a integer with bits representing the three possible limits: home, upper
and lower. Sardana provides three constants which can be <em>or</em>ed together to
provide the desired limit switch:</p>
<table class="hlist"><tr><td><ul class="simple">
<li><a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.MotorController.NoLimitSwitch" title="sardana.pool.controller.MotorController.NoLimitSwitch"><code class="xref py py-attr docutils literal"><span class="pre">NoLimitSwitch</span></code></a></li>
</ul>
</td><td><ul class="simple">
<li><a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.MotorController.HomeLimitSwitch" title="sardana.pool.controller.MotorController.HomeLimitSwitch"><code class="xref py py-attr docutils literal"><span class="pre">HomeLimitSwitch</span></code></a></li>
</ul>
</td><td><ul class="simple">
<li><a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.MotorController.UpperLimitSwitch" title="sardana.pool.controller.MotorController.UpperLimitSwitch"><code class="xref py py-attr docutils literal"><span class="pre">UpperLimitSwitch</span></code></a></li>
</ul>
</td><td><ul class="simple">
<li><a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.MotorController.LowerLimitSwitch" title="sardana.pool.controller.MotorController.LowerLimitSwitch"><code class="xref py py-attr docutils literal"><span class="pre">LowerLimitSwitch</span></code></a></li>
</ul>
</td></tr></table>
<p>To say both home and lower limit switches are active (rare!) you can do:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">limit_switches</span> <span class="o">=</span> <span class="n">MotorController</span><span class="o">.</span><span class="n">HomeLimitSwitch</span> <span class="o">|</span> <span class="n">MotorController</span><span class="o">.</span><span class="n">LowerLimitSwitch</span>
</pre></div>
</div>
<p>If you don&#8217;t return a status, sardana will compose a status string with:</p>
<blockquote>
<div>&lt;axis name&gt; is in &lt;state name&gt;</div></blockquote>
<p>If you don&#8217;t return limit switches, sardana will assume all limit switches are
off.</p>
<p>Here is an example of the possible implementation of
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.StateOne" title="sardana.pool.controller.Controller.StateOne"><code class="xref py py-meth docutils literal"><span class="pre">StateOne()</span></code></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sardana</span> <span class="kn">import</span> <span class="n">State</span>

<span class="k">class</span> <span class="nc">SpringfieldMotorController</span><span class="p">(</span><span class="n">MotorController</span><span class="p">):</span>

    <span class="n">StateMap</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span> <span class="p">:</span> <span class="n">State</span><span class="o">.</span><span class="n">On</span><span class="p">,</span>
        <span class="mi">2</span> <span class="p">:</span> <span class="n">State</span><span class="o">.</span><span class="n">Moving</span><span class="p">,</span>
        <span class="mi">3</span> <span class="p">:</span> <span class="n">State</span><span class="o">.</span><span class="n">Fault</span><span class="p">,</span>
    <span class="p">}</span>

<span class="hll">    <span class="k">def</span> <span class="nf">StateOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
</span>        <span class="n">springfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">StateMap</span><span class="p">[</span> <span class="n">springfield</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">springfield</span><span class="o">.</span><span class="n">getStatus</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>

        <span class="n">limit_switches</span> <span class="o">=</span> <span class="n">MotorController</span><span class="o">.</span><span class="n">NoLimitSwitch</span>
        <span class="n">hw_limit_switches</span> <span class="o">=</span> <span class="n">springfield</span><span class="o">.</span><span class="n">getLimits</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hw_limit_switches</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">limit_switches</span> <span class="o">|=</span> <span class="n">MotorController</span><span class="o">.</span><span class="n">HomeLimitSwitch</span>
        <span class="k">if</span> <span class="n">hw_limit_switches</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">limit_switches</span> <span class="o">|=</span> <span class="n">MotorController</span><span class="o">.</span><span class="n">UpperLimitSwitch</span>
        <span class="k">if</span> <span class="n">hw_limit_switches</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">limit_switches</span> <span class="o">|=</span> <span class="n">MotorController</span><span class="o">.</span><span class="n">LowerLimitSwitch</span>
        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">limit_switches</span>
</pre></div>
</div>
</div>
<div class="section" id="get-motor-position">
<span id="sardana-motorcontroller-howto-value"></span><h3>Get motor position<a class="headerlink" href="#get-motor-position" title="Permalink to this headline">¶</a></h3>
<p>To get the motor position, sardana calls the
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Readable.ReadOne" title="sardana.pool.controller.Readable.ReadOne"><code class="xref py py-meth docutils literal"><span class="pre">ReadOne()</span></code></a> method. This method
receives an axis as parameter and should return a valid position. Sardana
interprets the returned position as a <a class="reference internal" href="../../glossary.html#term-dial-position"><span class="xref std std-term">dial position</span></a>.</p>
<p>Here is an example of the possible implementation of
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Readable.ReadOne" title="sardana.pool.controller.Readable.ReadOne"><code class="xref py py-meth docutils literal"><span class="pre">ReadOne()</span></code></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpringfieldMotorController</span><span class="p">(</span><span class="n">MotorController</span><span class="p">):</span>

<span class="hll">    <span class="k">def</span> <span class="nf">ReadOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
</span>        <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">getPosition</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">position</span>
</pre></div>
</div>
</div>
<div class="section" id="move-a-motor">
<span id="sardana-motorcontroller-howto-move"></span><h3>Move a motor<a class="headerlink" href="#move-a-motor" title="Permalink to this headline">¶</a></h3>
<p>When an order comes for sardana to move a motor, sardana will call the
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Startable.StartOne" title="sardana.pool.controller.Startable.StartOne"><code class="xref py py-meth docutils literal"><span class="pre">StartOne()</span></code></a> method. This method receives
an axis and a position. The controller code should trigger the hardware motion.
The given position is always the <a class="reference internal" href="../../glossary.html#term-dial-position"><span class="xref std std-term">dial position</span></a>.</p>
<p>Here is an example of the possible implementation of
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Startable.StartOne" title="sardana.pool.controller.Startable.StartOne"><code class="xref py py-meth docutils literal"><span class="pre">StartOne()</span></code></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpringfieldMotorController</span><span class="p">(</span><span class="n">MotorController</span><span class="p">):</span>

<span class="hll">    <span class="k">def</span> <span class="nf">StartOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
</pre></div>
</div>
<p>As soon as <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Startable.StartOne" title="sardana.pool.controller.Startable.StartOne"><code class="xref py py-meth docutils literal"><span class="pre">StartOne()</span></code></a> is invoked,
sardana expects the motor to be moving. It enters a high frequency motion
loop which asks for the motor state through calls to
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.StateOne" title="sardana.pool.controller.Controller.StateOne"><code class="xref py py-meth docutils literal"><span class="pre">StateOne()</span></code></a>. It will keep the loop
running as long as the controller responds with <code class="docutils literal"><span class="pre">State.Moving</span></code>.
If <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.StateOne" title="sardana.pool.controller.Controller.StateOne"><code class="xref py py-meth docutils literal"><span class="pre">StateOne()</span></code></a> raises an exception
or returns something other than <code class="docutils literal"><span class="pre">State.Moving</span></code>, sardana will assume the motor
is stopped and exit the motion loop.</p>
<p>For a motion to work properly, it is therefore, <strong>very important</strong> that
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.StateOne" title="sardana.pool.controller.Controller.StateOne"><code class="xref py py-meth docutils literal"><span class="pre">StateOne()</span></code></a> responds correctly.</p>
</div>
<div class="section" id="stop-a-motor">
<span id="sardana-motorcontroller-howto-stop"></span><h3>Stop a motor<a class="headerlink" href="#stop-a-motor" title="Permalink to this headline">¶</a></h3>
<p>It is possible to stop a motor when it is moving. When sardana is ordered to
stop a motor motion, it invokes the <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Stopable.StopOne" title="sardana.pool.controller.Stopable.StopOne"><code class="xref py py-meth docutils literal"><span class="pre">StopOne()</span></code></a>
method. This method receives an axis parameter. The controller should make
sure the desired motor is <em>gracefully</em> stopped, if possible, respecting the
configured motion parameters (like deceleration and base_rate).</p>
<p>Here is an example of the possible implementation of
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Stopable.StopOne" title="sardana.pool.controller.Stopable.StopOne"><code class="xref py py-meth docutils literal"><span class="pre">StopOne()</span></code></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpringfieldMotorController</span><span class="p">(</span><span class="n">MotorController</span><span class="p">):</span>

<span class="hll">    <span class="k">def</span> <span class="nf">StopOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="abort-a-motor">
<span id="sardana-motorcontroller-howto-abort"></span><h3>Abort a motor<a class="headerlink" href="#abort-a-motor" title="Permalink to this headline">¶</a></h3>
<p>In a danger situation (motor moving a table about to hit a wall), it is
desirable to abort a motion <em>as fast as possible</em>. When sardana is ordered to
abort a motor motion, it invokes the <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Stopable.AbortOne" title="sardana.pool.controller.Stopable.AbortOne"><code class="xref py py-meth docutils literal"><span class="pre">AbortOne()</span></code></a>
method. This method receives an axis parameter. The controller should make
sure the desired motor is stopped as fast as it can be done, possibly losing
track of position.</p>
<p>Here is an example of the possible implementation of
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Stopable.AbortOne" title="sardana.pool.controller.Stopable.AbortOne"><code class="xref py py-meth docutils literal"><span class="pre">AbortOne()</span></code></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpringfieldMotorController</span><span class="p">(</span><span class="n">MotorController</span><span class="p">):</span>

<span class="hll">    <span class="k">def</span> <span class="nf">AbortOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The default implementation of <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Stopable.StopOne" title="sardana.pool.controller.Stopable.StopOne"><code class="xref py py-meth docutils literal"><span class="pre">StopOne()</span></code></a>
calls <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Stopable.AbortOne" title="sardana.pool.controller.Stopable.AbortOne"><code class="xref py py-meth docutils literal"><span class="pre">AbortOne()</span></code></a> so, if your
controller cannot distinguish stopping from aborting, it is sufficient
to implement <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Stopable.AbortOne" title="sardana.pool.controller.Stopable.AbortOne"><code class="xref py py-meth docutils literal"><span class="pre">AbortOne()</span></code></a>.</p>
</div>
</div>
<div class="section" id="standard-axis-attributes">
<span id="sardana-motorcontroller-howto-standard-axis-attributes"></span><h3>Standard axis attributes<a class="headerlink" href="#standard-axis-attributes" title="Permalink to this headline">¶</a></h3>
<p>By default, sardana expects every axis to have a set of attributes:</p>
<ul class="simple">
<li>acceleration</li>
<li>deceleration</li>
<li>velocity</li>
<li>base rate</li>
<li>steps per unit</li>
</ul>
<p>To set and retrieve the value of these attributes, sardana invokes pair of
methods: <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.GetAxisPar" title="sardana.pool.controller.Controller.GetAxisPar"><code class="xref py py-meth docutils literal"><span class="pre">GetAxisPar()</span></code></a>
/<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.SetAxisPar" title="sardana.pool.controller.Controller.SetAxisPar"><code class="xref py py-meth docutils literal"><span class="pre">SetAxisPar()</span></code></a></p>
<p>Here is an example of the possible implementation:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpringfieldMotorController</span><span class="p">(</span><span class="n">MotorController</span><span class="p">):</span>

<span class="hll">    <span class="k">def</span> <span class="nf">GetAxisPar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span>        <span class="n">springfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;acceleration&quot;</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">springfield</span><span class="o">.</span><span class="n">getAccelerationTime</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;deceleration&quot;</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">springfield</span><span class="o">.</span><span class="n">getDecelerationTime</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;base_rate&quot;</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">springfield</span><span class="o">.</span><span class="n">getMinVelocity</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;velocity&quot;</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">springfield</span><span class="o">.</span><span class="n">getMaxVelocity</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;step_per_unit&quot;</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">springfield</span><span class="o">.</span><span class="n">getStepPerUnit</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

<span class="hll">    <span class="k">def</span> <span class="nf">SetAxisPar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span>        <span class="n">springfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;acceleration&quot;</span><span class="p">:</span>
            <span class="n">springfield</span><span class="o">.</span><span class="n">setAccelerationTime</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;deceleration&quot;</span><span class="p">:</span>
            <span class="n">springfield</span><span class="o">.</span><span class="n">setDecelerationTime</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;base_rate&quot;</span><span class="p">:</span>
            <span class="n">springfield</span><span class="o">.</span><span class="n">setMinVelocity</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;velocity&quot;</span><span class="p">:</span>
            <span class="n">springfield</span><span class="o">.</span><span class="n">setMaxVelocity</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;step_per_unit&quot;</span><span class="p">:</span>
            <span class="n">springfield</span><span class="o">.</span><span class="n">setStepPerUnit</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="#sardana-motorcontroller-what-to-do"><span class="std std-ref">What to do when...</span></a></dt>
<dd>What to do when your hardware motor controller doesn&#8217;t support
steps per unit</dd>
</dl>
</div>
</div>
<div class="section" id="define-a-position">
<span id="sardana-motorcontroller-define-position"></span><h3>Define a position<a class="headerlink" href="#define-a-position" title="Permalink to this headline">¶</a></h3>
<p>Sometimes it is useful to reset the current position to a certain value.
Imagine you are writing a controller for a hardware controller which handles
stepper motors. When the hardware is asked for a motor position it will
probably answer some value from an internal register which is
incremented/decremented each time the motor goes up/down a step. Probably this
value as physical meaning so the usual procedure is to move the motor to a known
position (home switch, for example) and once there, set a meaningful position to
the current position. Some motor controllers support reseting the internal
register to the desired value. If your motor controller can do this the
implementation is as easy as writing the
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.MotorController.DefinePosition" title="sardana.pool.controller.MotorController.DefinePosition"><code class="xref py py-meth docutils literal"><span class="pre">DefinePosition()</span></code></a> and call the
proper code of your hardware library to do it:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpringfieldMotorController</span><span class="p">(</span><span class="n">MotorController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">DefinePosition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">setCurrentPosition</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p><a class="reference internal" href="#sardana-motorcontroller-what-to-do"><span class="std std-ref">What to do when...</span></a></p>
<blockquote class="last">
<div>What to do when your hardware motor controller doesn&#8217;t support
defining the position</div></blockquote>
</div>
</div>
<div class="section" id="what-to-do-when">
<span id="sardana-motorcontroller-what-to-do"></span><h3>What to do when...<a class="headerlink" href="#what-to-do-when" title="Permalink to this headline">¶</a></h3>
<p>This chapter describes common difficult situations you may face when writing
a motor controller in sardana, and possible solutions to solve them.</p>
<dl class="docutils">
<dt><em>my controller doesn&#8217;t support steps per unit</em></dt>
<dd><p class="first">Many (probably, most) hardware motor controllers don&#8217;t support steps per
unit at the hardware level. This means that your sardana controller should
be able to emulate steps per unit at the software level.
This can be easily done, but it requires you to make some changes in your
code.</p>
<p>We will assume now that the Springfield motor controller doesn&#8217;t support
steps per unit feature. The first that needs to be done is to modify the
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.AddDevice" title="sardana.pool.controller.Controller.AddDevice"><code class="xref py py-meth docutils literal"><span class="pre">AddDevice()</span></code></a> method so it is able to
to store the resulting conversion factor between the hardware read position
and the position the should be returned (the <em>step_per_unit</em>).
The <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Readable.ReadOne" title="sardana.pool.controller.Readable.ReadOne"><code class="xref py py-meth docutils literal"><span class="pre">ReadOne()</span></code></a> also needs to be
rewritten to make the proper calculation.
Finally <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.GetAxisPar" title="sardana.pool.controller.Controller.GetAxisPar"><code class="xref py py-meth docutils literal"><span class="pre">GetAxisPar()</span></code></a> /
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.SetAxisPar" title="sardana.pool.controller.Controller.SetAxisPar"><code class="xref py py-meth docutils literal"><span class="pre">SetAxisPar()</span></code></a> methods need to
be rewritten to properly get/set the step per unit value:</p>
<div class="last highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpringfieldMotorController</span><span class="p">(</span><span class="n">MotorController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">AddDevice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">step_per_unit</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ReadOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="n">step_per_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motor</span><span class="p">[</span><span class="n">axis</span><span class="p">][</span><span class="s2">&quot;step_per_unit&quot;</span><span class="p">]</span>
        <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">getPosition</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">position</span> <span class="o">/</span> <span class="n">step_per_unit</span>

    <span class="k">def</span> <span class="nf">GetAxisPar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">springfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;acceleration&quot;</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">springfield</span><span class="o">.</span><span class="n">getAccelerationTime</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;deceleration&quot;</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">springfield</span><span class="o">.</span><span class="n">getDecelerationTime</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;base_rate&quot;</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">springfield</span><span class="o">.</span><span class="n">getMinVelocity</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;velocity&quot;</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">springfield</span><span class="o">.</span><span class="n">getMaxVelocity</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;step_per_unit&quot;</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motor</span><span class="p">[</span><span class="n">axis</span><span class="p">][</span><span class="s2">&quot;step_per_unit&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">SetAxisPar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">springfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;acceleration&quot;</span><span class="p">:</span>
            <span class="n">springfield</span><span class="o">.</span><span class="n">setAccelerationTime</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;deceleration&quot;</span><span class="p">:</span>
            <span class="n">springfield</span><span class="o">.</span><span class="n">setDecelerationTime</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;base_rate&quot;</span><span class="p">:</span>
            <span class="n">springfield</span><span class="o">.</span><span class="n">setMinVelocity</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;velocity&quot;</span><span class="p">:</span>
            <span class="n">springfield</span><span class="o">.</span><span class="n">setMaxVelocity</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;step_per_unit&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_motor</span><span class="p">[</span><span class="n">axis</span><span class="p">][</span><span class="s2">&quot;step_per_unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</pre></div>
</div>
</dd>
<dt><em>my controller doesn&#8217;t support defining the position</em></dt>
<dd><p class="first">Some controllers may not be able to reset the position to a different value.
In these cases, your controller code should be able to emulate such a
feature. This can be easily done, but it requires you to make some changes
in your code.</p>
<p>We will now assume that the Springfield motor controller doesn&#8217;t support
steps per unit feature. The first thing that needs to be done is to modify the
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.AddDevice" title="sardana.pool.controller.Controller.AddDevice"><code class="xref py py-meth docutils literal"><span class="pre">AddDevice()</span></code></a> method so it is able
to store the resulting offset between the hardware read position and the
position the should be returned (the <em>define_position_offset</em>).
The <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Readable.ReadOne" title="sardana.pool.controller.Readable.ReadOne"><code class="xref py py-meth docutils literal"><span class="pre">ReadOne()</span></code></a> also needs to be
rewritten to take the <em>define_position_offset</em> into account.
Finally <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.MotorController.DefinePosition" title="sardana.pool.controller.MotorController.DefinePosition"><code class="xref py py-meth docutils literal"><span class="pre">DefinePosition()</span></code></a>
needs to be written to update the <em>define_position_offset</em> to the desired
value:</p>
<div class="last highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpringfieldMotorController</span><span class="p">(</span><span class="n">MotorController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">AddDevice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">define_position_offset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ReadOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="n">dp_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motor</span><span class="p">[</span><span class="n">axis</span><span class="p">][</span><span class="s2">&quot;define_position_offset&quot;</span><span class="p">]</span>
        <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">getPosition</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">position</span> <span class="o">+</span> <span class="n">dp_offset</span>

    <span class="k">def</span> <span class="nf">DefinePosition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="n">current_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">getPosition</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor</span><span class="p">[</span><span class="n">axis</span><span class="p">][</span><span class="s2">&quot;define_position_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">position</span> <span class="o">-</span> <span class="n">current_position</span>
</pre></div>
</div>
</dd>
</dl>
</div>
</div>
<div class="section" id="advanced-topics">
<h2>Advanced topics<a class="headerlink" href="#advanced-topics" title="Permalink to this headline">¶</a></h2>
<div class="section" id="timestamp-a-motor-position">
<span id="sardana-motorcontroller-howto-timestamp-position"></span><h3>Timestamp a motor position<a class="headerlink" href="#timestamp-a-motor-position" title="Permalink to this headline">¶</a></h3>
<p>When you read the position of a motor from the hardware sometimes it is
necessary to associate a timestamp with that position so you can track the
position of a motor in time.</p>
<p>If sardana is executed as a Tango device server, reading the position
attribute from the motor device triggers the execution of your controller&#8217;s
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Readable.ReadOne" title="sardana.pool.controller.Readable.ReadOne"><code class="xref py py-meth docutils literal"><span class="pre">ReadOne()</span></code></a> method. Tango responds with
the value your controller returns from the call to
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Readable.ReadOne" title="sardana.pool.controller.Readable.ReadOne"><code class="xref py py-meth docutils literal"><span class="pre">ReadOne()</span></code></a> and automatically assigns
a timestamp. However this timestamp has a certain delay since the time the
value was actually read from hardware and the time Tango generates the timestamp.</p>
<p>To avoid this, sardana supports returning in
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Readable.ReadOne" title="sardana.pool.controller.Readable.ReadOne"><code class="xref py py-meth docutils literal"><span class="pre">ReadOne()</span></code></a> an object that contains both
the value and the timestamp instead of the usual <a class="reference external" href="https://docs.python.org/dev/library/numbers.html#numbers.Number" title="(in Python v3.9)"><code class="xref py py-class docutils literal"><span class="pre">numbers.Number</span></code></a>.
The object must be an instance of <a class="reference internal" href="../api/sardana/sardanavalue.html#sardana.sardanavalue.SardanaValue" title="sardana.sardanavalue.SardanaValue"><code class="xref py py-class docutils literal"><span class="pre">SardanaValue</span></code></a>.</p>
<p>Here is an example of associating a timestamp in
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Readable.ReadOne" title="sardana.pool.controller.Readable.ReadOne"><code class="xref py py-meth docutils literal"><span class="pre">ReadOne()</span></code></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">sardana.pool.controller</span> <span class="kn">import</span> <span class="n">SardanaValue</span>

<span class="k">class</span> <span class="nc">SpringfieldMotorController</span><span class="p">(</span><span class="n">MotorController</span><span class="p">):</span>

   <span class="k">def</span> <span class="nf">ReadOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
       <span class="k">return</span> <span class="n">SardanaValue</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">getPosition</span><span class="p">(</span><span class="n">axis</span><span class="p">),</span>
                           <span class="n">timestamp</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
</pre></div>
</div>
<p>If your controller communicates with a Tango device, Sardana also supports
returning a <code class="xref py py-class docutils literal"><span class="pre">DeviceAttribute</span></code> object. Sardana will use this
object&#8217;s value and timestamp. Example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TangoMotorController</span><span class="p">(</span><span class="n">MotorController</span><span class="p">):</span>

   <span class="k">def</span> <span class="nf">ReadOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
       <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">read_attribute</span><span class="p">(</span><span class="s2">&quot;position&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="multiple-motion-synchronization">
<span id="sardana-motorcontroller-howto-mutiple-motion"></span><h3>Multiple motion synchronization<a class="headerlink" href="#multiple-motion-synchronization" title="Permalink to this headline">¶</a></h3>
<p>This chapter describes an extended <a class="reference internal" href="../../glossary.html#term-api"><span class="xref std std-term">API</span></a> that allows you to better
synchronize motions involing more than one motor, as well as optimize
hardware communication (in case the hardware interface also supports this).</p>
<p>Often it is the case that the experiment/procedure the user runs requires to
move more than one motor at the same time.
Imagine that the user requires motor at axis 1 to be moved to 100mm and motor
axis 2 to be moved to -20mm.
Your controller will receive two consecutive calls to
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Startable.StartOne" title="sardana.pool.controller.Startable.StartOne"><code class="xref py py-meth docutils literal"><span class="pre">StartOne()</span></code></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">StartOne</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">StartOne</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<p>and each StartOne will probably connect to the hardware (through serial line,
socket, <a class="reference external" href="http://www.tango-controls.org/">Tango</a> or <a class="reference external" href="http://www.aps.anl.gov/epics/">EPICS</a>) and ask the motor to be moved.
This will do the job but, there will be a slight desynchronization between the
two motors because hardware call of motor 1 will be done before hardware call
to motor 2.</p>
<p>Sardana provides an extended <em>start motion</em> which gives you the possibility
to improve the syncronization (and probably reduce communications) but your
hardware controller must somehow support this feature as well.</p>
<p>The complete start motion <a class="reference internal" href="../../glossary.html#term-api"><span class="xref std std-term">API</span></a> consists of four methods:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Startable.PreStartAll" title="sardana.pool.controller.Startable.PreStartAll"><code class="xref py py-meth docutils literal"><span class="pre">PreStartAll()</span></code></a></li>
<li><a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Startable.PreStartOne" title="sardana.pool.controller.Startable.PreStartOne"><code class="xref py py-meth docutils literal"><span class="pre">PreStartOne()</span></code></a></li>
<li><a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Startable.StartOne" title="sardana.pool.controller.Startable.StartOne"><code class="xref py py-meth docutils literal"><span class="pre">StartOne()</span></code></a></li>
<li><a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Startable.StartAll" title="sardana.pool.controller.Startable.StartAll"><code class="xref py py-meth docutils literal"><span class="pre">StartAll()</span></code></a></li>
</ul>
</div></blockquote>
<p>Except for <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Startable.StartOne" title="sardana.pool.controller.Startable.StartOne"><code class="xref py py-meth docutils literal"><span class="pre">StartOne()</span></code></a>, the
implemenation of all other start methods is optional and their default
implementation does nothing (<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Startable.PreStartOne" title="sardana.pool.controller.Startable.PreStartOne"><code class="xref py py-meth docutils literal"><span class="pre">PreStartOne()</span></code></a>
actually returns <code class="docutils literal"><span class="pre">True</span></code>).</p>
<p>So, actually, the complete algorithm for motor motion in sardana is:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">motion</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">PreStartAll</span><span class="p">()</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">motor</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">motion</span>
     <span class="o">-</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">PreStartOne</span><span class="p">(</span><span class="n">motor</span> <span class="n">to</span> <span class="n">move</span><span class="p">,</span> <span class="n">new</span> <span class="n">position</span><span class="p">)</span>
     <span class="o">-</span> <span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">true</span>
        <span class="o">/</span><span class="n">RAISE</span><span class="o">/</span> <span class="n">Cannot</span> <span class="n">start</span><span class="o">.</span> <span class="n">Motor</span> <span class="n">PreStartOne</span> <span class="n">returns</span> <span class="kc">False</span>
     <span class="o">-</span> <span class="o">/</span><span class="n">END</span> <span class="n">IF</span><span class="o">/</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">StartOne</span><span class="p">(</span><span class="n">motor</span> <span class="n">to</span> <span class="n">move</span><span class="p">,</span> <span class="n">new</span> <span class="n">position</span><span class="p">)</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">motion</span>
     <span class="o">-</span> <span class="n">Call</span> <span class="n">StartAll</span><span class="p">()</span>
<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>
</pre></div>
</div>
<p>So, for the example above where we move two motors, the complete sequence of
calls to the controller is:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">PreStartAll</span><span class="p">()</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">PreStartOne</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot start. Motor(1) PreStartOne returns False&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">PreStartOne</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot start. Motor(2) PreStartOne returns False&quot;</span><span class="p">)</span>

<span class="n">StartOne</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">StartOne</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">)</span>

<span class="n">StartAll</span><span class="p">()</span>
</pre></div>
</div>
<p>Sardana assures that the above sequence is never interrupted by other calls,
like a call from a different user to get motor state.</p>
<p>Suppose the springfield library tells us in the documentation that:</p>
<blockquote>
<div><p>... to move multiple motors at the same time use:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">moveMultiple</span><span class="p">(</span><span class="n">seq</span><span class="o">&lt;</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">axis</span><span class="p">,</span> <span class="n">position</span><span class="o">&gt;&gt;</span><span class="p">)</span>
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">moveMultiple</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">]])</span>
</pre></div>
</div>
</div></blockquote>
<p>We can modify our motor controller to take profit of this hardware feature:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpringfieldMotorController</span><span class="p">(</span><span class="n">MotorController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">PreStartAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># clear the local motion information dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_moveable_info</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">StartOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="c1"># store information about this axis motion</span>
        <span class="n">motion_info</span> <span class="o">=</span> <span class="n">axis</span><span class="p">,</span> <span class="n">position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_moveable_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">motion_info</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">StartAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">moveMultiple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_moveable_info</span><span class="p">)</span>
</pre></div>
</div>
<p>In case of stopping/aborting of the motors (or any other stoppable/abortable
elements) the synchronization may be as important as in case of starting
them. Let&#8217;s take an example of a motorized two-legged table and its
translational movement. A desynchronized stop/abort of the motors may introduce
an extra angle of the table that in very specific cases may be not desired e.g.
activation of the safety limits, closed loop errors, etc.</p>
<p>In this case the complete algorithm for stopping/aborting the motor motion in
sardana is:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">motion</span>

    <span class="o">-</span> <span class="n">Call</span> <span class="n">PreStopAll</span><span class="p">()</span>

    <span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">motor</span> <span class="n">of</span> <span class="n">the</span> <span class="n">given</span> <span class="n">controller</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">motion</span>
        <span class="o">-</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">PreStopOne</span><span class="p">(</span><span class="n">motor</span> <span class="n">to</span> <span class="n">stop</span><span class="p">)</span>
        <span class="o">-</span> <span class="o">/</span><span class="n">IF</span><span class="o">/</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">true</span>
            <span class="o">/</span><span class="n">RAISE</span><span class="o">/</span> <span class="n">Cannot</span> <span class="n">stop</span><span class="o">.</span> <span class="n">Motor</span> <span class="n">PreStopOne</span> <span class="n">returns</span> <span class="kc">False</span>
        <span class="o">-</span> <span class="o">/</span><span class="n">END</span> <span class="n">IF</span><span class="o">/</span>
        <span class="o">-</span> <span class="n">Call</span> <span class="n">StopOne</span><span class="p">(</span><span class="n">motor</span> <span class="n">to</span> <span class="n">stop</span><span class="p">)</span>
    <span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

    <span class="o">-</span> <span class="n">Call</span> <span class="n">StopAll</span><span class="p">()</span>

<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>
</pre></div>
</div>
<p>Each of the hardware controller method calls is protected in case of errors
so the stopping/aborting algorithm tries to stop/abort as many axes/controllers.</p>
<p>A similar principle applies when sardana asks for the state and position of
multiple axis. The two sets of methods are, in these cases:</p>
<table class="hlist"><tr><td><ul class="simple">
<li><a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.PreStateAll" title="sardana.pool.controller.Controller.PreStateAll"><code class="xref py py-meth docutils literal"><span class="pre">PreStateAll()</span></code></a></li>
<li><a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.PreStateOne" title="sardana.pool.controller.Controller.PreStateOne"><code class="xref py py-meth docutils literal"><span class="pre">PreStateOne()</span></code></a></li>
<li><a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.StateAll" title="sardana.pool.controller.Controller.StateAll"><code class="xref py py-meth docutils literal"><span class="pre">StateAll()</span></code></a></li>
<li><a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.StateOne" title="sardana.pool.controller.Controller.StateOne"><code class="xref py py-meth docutils literal"><span class="pre">StateOne()</span></code></a></li>
</ul>
</td><td><ul class="simple">
<li><a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Readable.PreReadAll" title="sardana.pool.controller.Readable.PreReadAll"><code class="xref py py-meth docutils literal"><span class="pre">PreReadAll()</span></code></a></li>
<li><a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Readable.PreReadOne" title="sardana.pool.controller.Readable.PreReadOne"><code class="xref py py-meth docutils literal"><span class="pre">PreReadOne()</span></code></a></li>
<li><a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Readable.ReadAll" title="sardana.pool.controller.Readable.ReadAll"><code class="xref py py-meth docutils literal"><span class="pre">ReadAll()</span></code></a></li>
<li><a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Readable.ReadOne" title="sardana.pool.controller.Readable.ReadOne"><code class="xref py py-meth docutils literal"><span class="pre">ReadOne()</span></code></a></li>
</ul>
</td></tr></table>
<p>The main differences between these sets of methods and the ones from start motion
is that <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.StateOne" title="sardana.pool.controller.Controller.StateOne"><code class="xref py py-meth docutils literal"><span class="pre">StateOne()</span></code></a> /
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Readable.ReadOne" title="sardana.pool.controller.Readable.ReadOne"><code class="xref py py-meth docutils literal"><span class="pre">ReadOne()</span></code></a> methods are called <strong>AFTER</strong>
the corresponding <a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Controller.StateAll" title="sardana.pool.controller.Controller.StateAll"><code class="xref py py-meth docutils literal"><span class="pre">StateAll()</span></code></a> /
<a class="reference internal" href="../api/sardana/pool/controller.html#sardana.pool.controller.Readable.ReadAll" title="sardana.pool.controller.Readable.ReadAll"><code class="xref py py-meth docutils literal"><span class="pre">ReadAll()</span></code></a> counterparts and they are
expeced to return the state/position of the requested axis.</p>
<p>The internal sardana algorithm to read position is:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">controller</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">reading</span> <span class="p">(</span><span class="n">executed</span> <span class="n">concurrently</span><span class="p">)</span>

     <span class="o">-</span> <span class="n">Call</span> <span class="n">PreReadAll</span><span class="p">()</span>

    <span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">motor</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">of</span> <span class="n">the</span> <span class="n">given</span> <span class="n">controller</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">reading</span>
         <span class="o">-</span> <span class="n">PreReadOne</span><span class="p">(</span><span class="n">motor</span> <span class="n">to</span> <span class="n">read</span><span class="p">)</span>
    <span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

    <span class="o">-</span> <span class="n">Call</span> <span class="n">ReadAll</span><span class="p">()</span>

    <span class="o">/</span><span class="n">FOR</span><span class="o">/</span> <span class="n">Each</span> <span class="n">motor</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">of</span> <span class="n">the</span> <span class="n">given</span> <span class="n">controller</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">reading</span>
         <span class="o">-</span> <span class="n">ReadOne</span><span class="p">(</span><span class="n">motor</span> <span class="n">to</span> <span class="n">read</span><span class="p">)</span>
    <span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>

<span class="o">/</span><span class="n">END</span> <span class="n">FOR</span><span class="o">/</span>
</pre></div>
</div>
<p>Here is an example assuming the springfield library tells us in the
documentation that:</p>
<blockquote>
<div><p>... to read the position of multiple motors at the same time use:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">getMultiplePosition</span><span class="p">(</span><span class="n">seq</span><span class="o">&lt;</span><span class="n">axis</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="o">&lt;</span><span class="n">axis</span><span class="p">,</span> <span class="n">position</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">positions</span> <span class="o">=</span> <span class="n">getMultiplePosition</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div></blockquote>
<p>The new improved code could look like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpringfieldMotorController</span><span class="p">(</span><span class="n">MotorController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">PreRealAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># clear the local position information dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_position_info</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">PreReadOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_position_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ReadAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">springfield</span><span class="o">.</span><span class="n">getMultiplePosition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_position_info</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ReadOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="howto_countertimercontroller.html" class="btn btn-neutral float-right" title="How to write a counter/timer controller" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="howto_controller.html" class="btn btn-neutral" title="What is a controller" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Except where otherwise noted, content on this site is
licensed under a Creative Commons Attribution 3.0 License.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'3.0.2-alpha',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>